<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>:root {
  --color: black;
  --bg: white;
  --head-bg: white;
  --link: #338;

  --blue: #ccf;
  --red: #fcc;
  --yellow: #ffc;
  --green: #cfc;
}

[data-theme='dark'] {
  --color: white;
  --bg: black;
  --head-bg: #333;
  --link: #aaf;

  --blue: #225;
  --red: #522;
  --yellow: #552;
  --green: #252;
}

html,
body {
  margin: 0;
  padding: 0;
  color: var(--color);
  background: var(--bg);
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: var(--head-bg);
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: var(--blue);
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: var(--red);
}
.files-list__file_medium {
  background: var(--yellow);
}
.files-list__file_high {
  background: var(--green);
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--bg);
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: var(--link);
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
  content: counter(line);
  margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: var(--green);
}
.code-line_uncovered {
  background: var(--red);
}

#theme-toggle-label {
  margin-left: 1ch;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","home","azureuser","Documents","Chronos","benches","storage_bench.rs"],"content":"use chronos::parser::Value;\nuse chronos::storage::{\n    create_storage_engine, Column, DataType, Row, StorageConfig, StorageEngine, TableSchema,\n};\nuse criterion::{black_box, criterion_group, criterion_main, BenchmarkId, Criterion};\nuse tempfile::TempDir;\n\nasync fn setup_storage(config: StorageConfig) -\u003e (Box\u003cdyn StorageEngine\u003e, TempDir) {\n    let temp_dir = TempDir::new().unwrap();\n    let config = match config {\n        StorageConfig::Sled { .. } =\u003e StorageConfig::Sled {\n            data_dir: temp_dir.path().to_str().unwrap().to_string(),\n        },\n    };\n\n    let mut engine = create_storage_engine(config).unwrap();\n    engine.init().await.unwrap();\n\n    (engine, temp_dir)\n}\n\nasync fn create_sensor_table(engine: \u0026mut Box\u003cdyn StorageEngine\u003e) {\n    let schema = TableSchema {\n        name: \"sensors\".to_string(),\n        columns: vec![\n            Column {\n                name: \"sensor_id\".to_string(),\n                data_type: DataType::Int,\n            },\n            Column {\n                name: \"timestamp\".to_string(),\n                data_type: DataType::Int,\n            },\n            Column {\n                name: \"temperature\".to_string(),\n                data_type: DataType::Float,\n            },\n            Column {\n                name: \"humidity\".to_string(),\n                data_type: DataType::Float,\n            },\n        ],\n        ttl_seconds: None,\n    };\n\n    engine.create_table(\"sensors\", schema).await.unwrap();\n}\n\nasync fn create_sensor_table_with_ttl(engine: \u0026mut Box\u003cdyn StorageEngine\u003e, ttl_seconds: u64) {\n    let schema = TableSchema {\n        name: \"sensors_ttl\".to_string(),\n        columns: vec![\n            Column {\n                name: \"sensor_id\".to_string(),\n                data_type: DataType::Int,\n            },\n            Column {\n                name: \"timestamp\".to_string(),\n                data_type: DataType::Int,\n            },\n            Column {\n                name: \"temperature\".to_string(),\n                data_type: DataType::Float,\n            },\n            Column {\n                name: \"humidity\".to_string(),\n                data_type: DataType::Float,\n            },\n        ],\n        ttl_seconds: Some(ttl_seconds),\n    };\n\n    engine.create_table(\"sensors_ttl\", schema).await.unwrap();\n}\n\nfn generate_sensor_rows(count: usize) -\u003e Vec\u003cRow\u003e {\n    (0..count)\n        .map(|i| {\n            let mut row = Row::new();\n            row.insert(\"sensor_id\".to_string(), Value::Integer(i as i64));\n            row.insert(\n                \"timestamp\".to_string(),\n                Value::Integer(1700000000 + i as i64),\n            );\n            row.insert(\n                \"temperature\".to_string(),\n                Value::Float(20.0 + (i % 30) as f64),\n            );\n            row.insert(\"humidity\".to_string(), Value::Float(40.0 + (i % 40) as f64));\n            row\n        })\n        .collect()\n}\n\nfn benchmark_insert(c: \u0026mut Criterion) {\n    let runtime = tokio::runtime::Runtime::new().unwrap();\n    let mut group = c.benchmark_group(\"insert\");\n    for size in [100, 1000] {\n        group.bench_with_input(BenchmarkId::new(\"sled\", size), \u0026size, |b, \u0026size| {\n            b.to_async(\u0026runtime).iter(|| async {\n                let (mut engine, _temp) = setup_storage(StorageConfig::Sled {\n                    data_dir: \"./bench_data\".to_string(),\n                })\n                .await;\n\n                create_sensor_table(\u0026mut engine).await;\n\n                let rows = generate_sensor_rows(size);\n                engine.insert(\"sensors\", rows).await.unwrap();\n\n                black_box(engine);\n            });\n        });\n    }\n\n    group.finish();\n}\n\nfn benchmark_insert_small_batches(c: \u0026mut Criterion) {\n    let runtime = tokio::runtime::Runtime::new().unwrap();\n    let mut group = c.benchmark_group(\"insert_small_batches\");\n    let total_rows: usize = 1000;\n\n    for \u0026batch_size in \u0026[1_usize, 10_usize, 100_usize] {\n        group.bench_with_input(\n            BenchmarkId::new(\"sled_batch\", batch_size),\n            \u0026batch_size,\n            |b, \u0026batch_size| {\n                b.to_async(\u0026runtime).iter(|| async move {\n                    let (mut engine, _temp) = setup_storage(StorageConfig::Sled {\n                        data_dir: \"./bench_data\".to_string(),\n                    })\n                    .await;\n\n                    create_sensor_table(\u0026mut engine).await;\n\n                    let rows = generate_sensor_rows(total_rows);\n                    for chunk in rows.chunks(batch_size) {\n                        engine.insert(\"sensors\", chunk.to_vec()).await.unwrap();\n                    }\n\n                    black_box(engine);\n                });\n            },\n        );\n    }\n\n    group.finish();\n}\n\nfn benchmark_insert_small_batches_ttl(c: \u0026mut Criterion) {\n    let runtime = tokio::runtime::Runtime::new().unwrap();\n    let mut group = c.benchmark_group(\"insert_small_batches_ttl\");\n    let total_rows: usize = 1000;\n\n    for \u0026batch_size in \u0026[1_usize, 10_usize, 100_usize] {\n        group.bench_with_input(\n            BenchmarkId::new(\"sled_ttl_batch\", batch_size),\n            \u0026batch_size,\n            |b, \u0026batch_size| {\n                b.to_async(\u0026runtime).iter(|| async move {\n                    let (mut engine, _temp) = setup_storage(StorageConfig::Sled {\n                        data_dir: \"./bench_data\".to_string(),\n                    })\n                    .await;\n\n                    create_sensor_table_with_ttl(\u0026mut engine, 24 * 60 * 60).await;\n\n                    let rows = generate_sensor_rows(total_rows);\n                    for chunk in rows.chunks(batch_size) {\n                        engine.insert(\"sensors_ttl\", chunk.to_vec()).await.unwrap();\n                    }\n\n                    black_box(engine);\n                });\n            },\n        );\n    }\n\n    group.finish();\n}\n\nfn benchmark_insert_ttl(c: \u0026mut Criterion) {\n    let runtime = tokio::runtime::Runtime::new().unwrap();\n    let mut group = c.benchmark_group(\"insert_ttl\");\n    for size in [100, 1000] {\n        group.bench_with_input(BenchmarkId::new(\"sled_ttl\", size), \u0026size, |b, \u0026size| {\n            b.to_async(\u0026runtime).iter(|| async {\n                let (mut engine, _temp) = setup_storage(StorageConfig::Sled {\n                    data_dir: \"./bench_data\".to_string(),\n                })\n                .await;\n\n                // Table with a relatively long TTL so that TTL index is\n                // maintained on insert, but cleanup work is not part of the\n                // benchmark.\n                create_sensor_table_with_ttl(\u0026mut engine, 24 * 60 * 60).await;\n\n                let rows = generate_sensor_rows(size);\n                engine.insert(\"sensors_ttl\", rows).await.unwrap();\n\n                black_box(engine);\n            });\n        });\n    }\n\n    group.finish();\n}\n\nfn benchmark_query(c: \u0026mut Criterion) {\n    let runtime = tokio::runtime::Runtime::new().unwrap();\n    let mut group = c.benchmark_group(\"query\");\n\n    for size in [100, 1000] {\n        group.bench_with_input(\n            BenchmarkId::new(\"sled_full_scan\", size),\n            \u0026size,\n            |b, \u0026size| {\n                b.to_async(\u0026runtime).iter(|| async {\n                    let (mut engine, _temp) = setup_storage(StorageConfig::Sled {\n                        data_dir: \"./bench_data\".to_string(),\n                    })\n                    .await;\n\n                    create_sensor_table(\u0026mut engine).await;\n\n                    let rows = generate_sensor_rows(size);\n                    engine.insert(\"sensors\", rows).await.unwrap();\n\n                    let results = engine.query(\"sensors\", None).await.unwrap();\n\n                    black_box(results);\n                });\n            },\n        );\n    }\n\n    group.finish();\n}\n\ncriterion_group!(\n    benches,\n    benchmark_insert,\n    benchmark_insert_ttl,\n    benchmark_insert_small_batches,\n    benchmark_insert_small_batches_ttl,\n    benchmark_query,\n);\ncriterion_main!(benches);\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","build.rs"],"content":"fn main() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    tonic_build::compile_protos(\"proto/raft.proto\")?;\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","examples","raft_write_load.rs"],"content":"use std::time::Instant;\n\nuse chronos::network::SqlClient;\n\n/// Simple load generator that exercises the full distributed write path:\n/// client -\u003e gRPC -\u003e SqlServer -\u003e Executor -\u003e Raft -\u003e Sled storage.\n///\n/// Usage (from repo root):\n///\n///   # run a Raft leader node first, e.g. on 127.0.0.1:8000\n///   RUST_LOG=chronos=warn cargo run --release -- node \\\n///     --id node1 --data-dir data --address 127.0.0.1:8000\n///\n///   # then run this load generator and measure CPU/RAM with /usr/bin/time -v\n///   /usr/bin/time -v cargo run --release --example raft_write_load -- \\\n///     --leader 127.0.0.1:8000 --ops 10000 --batch-size 1\n///\n/// The process will print total duration and approximate ops/sec; detailed\n/// CPU and memory usage come from `/usr/bin/time -v`.\n#[tokio::main]\nasync fn main() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    let mut leader = \"127.0.0.1:8000\".to_string();\n    let mut ops: u64 = 10_000;\n    let mut batch_size: u64 = 1;\n\n    // Very simple CLI parsing: --leader, --ops, --batch-size\n    let mut args = std::env::args().skip(1);\n    while let Some(arg) = args.next() {\n        match arg.as_str() {\n            \"--leader\" =\u003e {\n                if let Some(v) = args.next() {\n                    leader = v;\n                }\n            }\n            \"--ops\" =\u003e {\n                if let Some(v) = args.next() {\n                    if let Ok(n) = v.parse::\u003cu64\u003e() {\n                        ops = n;\n                    }\n                }\n            }\n            \"--batch-size\" =\u003e {\n                if let Some(v) = args.next() {\n                    if let Ok(n) = v.parse::\u003cu64\u003e() {\n                        batch_size = n.max(1);\n                    }\n                }\n            }\n            _ =\u003e {}\n        }\n    }\n\n    println!(\n        \"Starting raft_write_load: leader={}, ops={}, batch_size={}\",\n        leader, ops, batch_size\n    );\n\n    let mut client = SqlClient::new(\u0026leader);\n    client.connect().await?;\n\n    // Ensure table exists; ignore \"already exists\" and just log other errors.\n    let create_sql = \"CREATE TABLE sensors (id INT, temperature FLOAT);\";\n    match client.execute_sql(create_sql).await {\n        Ok(resp) =\u003e {\n            if !resp.success {\n                eprintln!(\"CREATE TABLE error: {}\", resp.error);\n            }\n        }\n        Err(e) =\u003e {\n            eprintln!(\"CREATE TABLE RPC error: {}\", e);\n        }\n    }\n\n    let start = Instant::now();\n    let mut i: u64 = 0;\n    let mut success: u64 = 0;\n    let mut errors: u64 = 0;\n    let mut not_leader_errors: u64 = 0;\n    let mut other_errors: u64 = 0;\n\n    while i \u003c ops {\n        let sql = format!(\n            \"INSERT INTO sensors (id, temperature) VALUES ({}, {});\",\n            i,\n            20.0 + (i % 10) as f64\n        );\n\n        match client.execute_sql(\u0026sql).await {\n            Ok(resp) =\u003e {\n                if resp.success {\n                    success += 1;\n                } else {\n                    eprintln!(\"INSERT error at op {}: {}\", i, resp.error);\n                    errors += 1;\n                    if resp.error.contains(\"Not the leader\") {\n                        not_leader_errors += 1;\n                    } else {\n                        other_errors += 1;\n                    }\n                }\n            }\n            Err(e) =\u003e {\n                eprintln!(\"INSERT RPC error at op {}: {}\", i, e);\n                errors += 1;\n                other_errors += 1;\n            }\n        }\n\n        i += 1;\n\n        if i.is_multiple_of(batch_size) {\n            println!(\"completed {} operations\", i);\n        }\n    }\n\n    let elapsed = start.elapsed();\n    let secs = elapsed.as_secs_f64();\n    let ops_f = ops as f64;\n    let throughput = if secs \u003e 0.0 { ops_f / secs } else { 0.0 };\n\n    println!(\n        \"Done: {} ops in {:.3} s (â‰ˆ {:.1} ops/s), success={}, errors={}, not_leader_errors={}, other_errors={}\",\n        ops, secs, throughput, success, errors, not_leader_errors, other_errors\n    );\n\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","examples","storage_demo.rs"],"content":"use anyhow::Result;\nuse chronos::parser::Value;\nuse chronos::storage::{\n    create_storage_engine, Column, DataType, Filter, FilterOp, Row, StorageConfig, TableSchema,\n};\n\n#[tokio::main]\nasync fn main() -\u003e Result\u003c()\u003e {\n    env_logger::init();\n\n    println!(\"Chronos Storage Engine Demo\\n\");\n\n    let config = StorageConfig::Sled {\n        data_dir: \"./demo_data\".to_string(),\n    };\n\n    let mut engine = create_storage_engine(config)?;\n    engine.init().await?;\n\n    println!(\"Storage engine initialized\\n\");\n\n    let schema = TableSchema {\n        name: \"iot_sensors\".to_string(),\n        columns: vec![\n            Column {\n                name: \"device_id\".to_string(),\n                data_type: DataType::String,\n            },\n            Column {\n                name: \"timestamp\".to_string(),\n                data_type: DataType::Int,\n            },\n            Column {\n                name: \"temperature\".to_string(),\n                data_type: DataType::Float,\n            },\n            Column {\n                name: \"humidity\".to_string(),\n                data_type: DataType::Float,\n            },\n            Column {\n                name: \"location\".to_string(),\n                data_type: DataType::String,\n            },\n        ],\n        ttl_seconds: None,\n    };\n\n    engine.create_table(\"iot_sensors\", schema).await?;\n    println!(\"Created table 'iot_sensors'\\n\");\n\n    let sensor_data = vec![\n        create_sensor_row(\"SENSOR_001\", 1700000000, 22.5, 65.0, \"Factory_Floor_A\"),\n        create_sensor_row(\"SENSOR_002\", 1700000001, 23.1, 62.5, \"Factory_Floor_A\"),\n        create_sensor_row(\"SENSOR_003\", 1700000002, 21.8, 68.0, \"Factory_Floor_B\"),\n        create_sensor_row(\"SENSOR_001\", 1700000003, 22.9, 64.5, \"Factory_Floor_A\"),\n        create_sensor_row(\"SENSOR_004\", 1700000004, 25.2, 70.0, \"Warehouse\"),\n    ];\n\n    engine.insert(\"iot_sensors\", sensor_data).await?;\n    println!(\"Inserted 5 sensor readings\\n\");\n\n    println!(\"All sensor readings:\");\n    let all_data = engine.query(\"iot_sensors\", None).await?;\n    print_sensor_data(\u0026all_data);\n\n    println!(\"\\nSensors with temperature \u003e 23.0 C:\");\n    let filter = Filter {\n        column: \"temperature\".to_string(),\n        op: FilterOp::Gt,\n        value: Value::Float(23.0),\n    };\n    let filtered_data = engine.query(\"iot_sensors\", Some(filter)).await?;\n    print_sensor_data(\u0026filtered_data);\n\n    engine.create_index(\"iot_sensors\", \"device_id\").await?;\n    println!(\"\\nCreated index on 'device_id'\\n\");\n\n    engine.checkpoint().await?;\n    println!(\"Data checkpointed to disk\\n\");\n\n    let tables = engine.list_tables().await?;\n    println!(\"Tables in database: {:?}\\n\", tables);\n\n    engine.close().await?;\n    println!(\"Storage engine closed\");\n\n    Ok(())\n}\n\nfn create_sensor_row(\n    device_id: \u0026str,\n    timestamp: i64,\n    temperature: f64,\n    humidity: f64,\n    location: \u0026str,\n) -\u003e Row {\n    let mut row = Row::new();\n    row.insert(\n        \"device_id\".to_string(),\n        Value::String(device_id.to_string()),\n    );\n    row.insert(\"timestamp\".to_string(), Value::Integer(timestamp));\n    row.insert(\"temperature\".to_string(), Value::Float(temperature));\n    row.insert(\"humidity\".to_string(), Value::Float(humidity));\n    row.insert(\"location\".to_string(), Value::String(location.to_string()));\n    row\n}\n\nfn print_sensor_data(rows: \u0026[Row]) {\n    for row in rows {\n        println!(\n            \"  Device: {:?}, Temp: {:?} C, Humidity: {:?}%, Location: {:?}\",\n            row.get(\"device_id\"),\n            row.get(\"temperature\"),\n            row.get(\"humidity\"),\n            row.get(\"location\")\n        );\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","src","common","mod.rs"],"content":"// Common utilities and shared code\n\npub mod timestamp;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","src","common","timestamp.rs"],"content":"use serde::{Deserialize, Serialize};\nuse uhlc::{Timestamp as HlcTimestamp, HLC};\n\n#[derive(Clone, Copy, Debug, PartialEq, Eq, PartialOrd, Ord, Serialize, Deserialize)]\npub struct HybridTimestamp {\n    pub ts: HlcTimestamp,\n    pub node_id: u64,\n}\n\npub struct Clock {\n    hlc: HLC,\n    node_id: u64,\n}\n\nimpl Clock {\n    /// Create a new clock bound to a specific node id.\n    pub fn new(node_id: u64) -\u003e Self {\n        Self {\n            hlc: HLC::default(),\n            node_id,\n        }\n    }\n\n    /// Generate a new local timestamp for an outgoing operation.\n    pub fn now(\u0026self) -\u003e HybridTimestamp {\n        HybridTimestamp {\n            ts: self.hlc.new_timestamp(),\n            node_id: self.node_id,\n        }\n    }\n\n    /// Merge this clock with a remote timestamp and return an updated local timestamp.\n    ///\n    /// This should be called when receiving operations from other nodes.\n    pub fn merge(\u0026self, remote: \u0026HybridTimestamp) -\u003e Result\u003cHybridTimestamp, String\u003e {\n        self.hlc.update_with_timestamp(\u0026remote.ts)?;\n        Ok(self.now())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn monotonic_timestamps_increase() {\n        let clock = Clock::new(1);\n        let t1 = clock.now();\n        let t2 = clock.now();\n        assert!(t2.ts \u003e t1.ts);\n        assert_eq!(t1.node_id, 1);\n        assert_eq!(t2.node_id, 1);\n    }\n\n    #[test]\n    fn merge_with_remote_timestamp_produces_newer_ts() {\n        let local = Clock::new(1);\n        let remote_clock = Clock::new(2);\n\n        let remote_ts = remote_clock.now();\n        let merged_ts = local.merge(\u0026remote_ts).expect(\"merge failed\");\n\n        assert!(merged_ts.ts \u003e remote_ts.ts);\n        assert_eq!(merged_ts.node_id, 1);\n    }\n}\n","traces":[{"line":17,"address":[16146496],"length":1,"stats":{"Line":2}},{"line":19,"address":[16044520],"length":1,"stats":{"Line":2}},{"line":25,"address":[16146576],"length":1,"stats":{"Line":2}},{"line":27,"address":[15935559],"length":1,"stats":{"Line":2}},{"line":28,"address":[19759360],"length":1,"stats":{"Line":2}},{"line":35,"address":[18503568],"length":1,"stats":{"Line":1}},{"line":36,"address":[15935669],"length":1,"stats":{"Line":1}},{"line":37,"address":[12225148],"length":1,"stats":{"Line":1}}],"covered":8,"coverable":8},{"path":["/","home","azureuser","Documents","Chronos","src","config.rs"],"content":"use serde::{Deserialize, Serialize};\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Config {\n    pub node_id: u64,\n    pub http_port: u16,\n    pub raft_port: u16,\n    pub peers: Vec\u003cPeerConfig\u003e,\n    pub storage: StorageConfig,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct PeerConfig {\n    pub id: u64,\n    pub address: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(tag = \"type\")]\npub enum StorageConfig {\n    #[serde(rename = \"sled\")]\n    Sled { data_dir: String },\n}\n\nimpl Default for StorageConfig {\n    fn default() -\u003e Self {\n        StorageConfig::Sled {\n            data_dir: \"./data\".to_string(),\n        }\n    }\n}\n\nimpl Default for Config {\n    fn default() -\u003e Self {\n        Self {\n            node_id: 1,\n            http_port: 8080,\n            raft_port: 9090,\n            peers: vec![],\n            storage: StorageConfig::default(),\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn storage_config_default_uses_sled_data_dir() {\n        let cfg = StorageConfig::default();\n        match cfg {\n            StorageConfig::Sled { data_dir } =\u003e {\n                assert_eq!(data_dir, \"./data\");\n            }\n        }\n    }\n\n    #[test]\n    fn config_default_values_are_sensible() {\n        let cfg = Config::default();\n        assert_eq!(cfg.node_id, 1);\n        assert_eq!(cfg.http_port, 8080);\n        assert_eq!(cfg.raft_port, 9090);\n        assert!(cfg.peers.is_empty());\n\n        match cfg.storage {\n            StorageConfig::Sled { data_dir } =\u003e {\n                assert_eq!(data_dir, \"./data\");\n            }\n        }\n    }\n}\n","traces":[{"line":25,"address":[29815113,29817263],"length":1,"stats":{"Line":0}},{"line":26,"address":[14249360],"length":1,"stats":{"Line":1}},{"line":28,"address":[14168733],"length":1,"stats":{"Line":2}},{"line":33,"address":[29622120,29622483,29620245],"length":1,"stats":{"Line":0}},{"line":34,"address":[14258186,14258016,14258180],"length":1,"stats":{"Line":1}},{"line":39,"address":[19360471,19359874],"length":1,"stats":{"Line":1}},{"line":40,"address":[15002029],"length":1,"stats":{"Line":1}}],"covered":5,"coverable":7},{"path":["/","home","azureuser","Documents","Chronos","src","embedded.rs"],"content":"use tokio::sync::Mutex;\n\nuse crate::executor::{Executor, ExecutorError, QueryResult};\nuse crate::parser::{Ast, Parser};\n\n/// Embedded, in-process Chronos instance for edge applications.\n///\n/// This runs entirely in-process without starting a gRPC server or Raft\n/// node. It uses the same SQL parser and Executor as the main node\n/// binary, backed by the configured storage engine (currently Sled).\npub struct ChronosEmbedded {\n    executor: Mutex\u003cExecutor\u003e,\n}\n\nimpl ChronosEmbedded {\n    /// Create a new embedded Chronos instance using the given data directory.\n    ///\n    /// The data directory is passed through to the underlying Executor and\n    /// storage engine. If the directory does not exist, it will be created\n    /// by the storage layer.\n    pub async fn new(data_dir: \u0026str) -\u003e Self {\n        let executor = Executor::new(data_dir).await;\n        Self {\n            executor: Mutex::new(executor),\n        }\n    }\n\n    /// Execute a SQL statement against the embedded database.\n    ///\n    /// This parses the SQL string into an AST and then forwards it to the\n    /// underlying Executor. Parser errors are mapped into `ExecutorError`.\n    pub async fn execute(\u0026self, sql: \u0026str) -\u003e Result\u003cQueryResult, ExecutorError\u003e {\n        let ast: Ast =\n            Parser::parse(sql).map_err(|e| ExecutorError::ExecutionError(e.to_string()))?;\n\n        let mut exec = self.executor.lock().await;\n        exec.execute(ast).await\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[tokio::test]\n    async fn embedded_create_insert_select() {\n        let temp_dir = tempfile::TempDir::new().unwrap();\n        let path = temp_dir.path().to_str().unwrap();\n\n        let db = ChronosEmbedded::new(path).await;\n\n        db.execute(\"CREATE TABLE sensors (id INT, temperature FLOAT);\")\n            .await\n            .expect(\"create table\");\n\n        db.execute(\"INSERT INTO sensors (id, temperature) VALUES (1, 25.5);\")\n            .await\n            .expect(\"insert row\");\n\n        let result = db\n            .execute(\"SELECT id, temperature FROM sensors;\")\n            .await\n            .expect(\"select rows\");\n\n        assert_eq!(result.columns, vec![\"id\", \"temperature\"]);\n        assert_eq!(result.rows.len(), 1);\n        assert_eq!(result.rows[0].len(), 2);\n    }\n}\n","traces":[{"line":21,"address":[18415684,18415595,18415834,18416260,18415552,18415726],"length":1,"stats":{"Line":4}},{"line":22,"address":[13073051,13072953,13072987,13073133],"length":1,"stats":{"Line":3}},{"line":24,"address":[19671979],"length":1,"stats":{"Line":1}},{"line":32,"address":[15967744,15968592,15969167,15967909,15967796,15969114],"length":1,"stats":{"Line":4}},{"line":33,"address":[13075264,13073791,13075287,13073674],"length":1,"stats":{"Line":2}},{"line":36,"address":[13074364,13074218,13074154,13073708],"length":1,"stats":{"Line":2}},{"line":37,"address":[15958821,15958534,15958459,15957586],"length":1,"stats":{"Line":3}}],"covered":7,"coverable":7},{"path":["/","home","azureuser","Documents","Chronos","src","executor","error.rs"],"content":"use thiserror::Error;\n\n#[derive(Error, Debug)]\npub enum ExecutorError {\n    #[error(\"Storage error: {0}\")]\n    StorageError(String),\n\n    #[error(\"Execution error: {0}\")]\n    ExecutionError(String),\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","src","executor","mod.rs"],"content":"mod error;\n\nuse std::collections::HashMap;\nuse std::time::{SystemTime, UNIX_EPOCH};\n\nuse crate::common::timestamp::HybridTimestamp;\nuse crate::parser::{\n    Ast, ColumnDefinition, Condition, DataType as ParserDataType, Operator, Statement, TtlSpec,\n    Value,\n};\nuse crate::storage::offline_queue::PersistentQueuedOperation;\nuse crate::storage::{\n    create_storage_engine, Column, DataType, Filter, FilterOp, Row, StorageConfig, StorageEngine,\n    TableSchema,\n};\nuse tokio::sync::Mutex;\n\npub use self::error::ExecutorError;\n\n#[derive(Clone, Copy, Debug, bincode::Encode, bincode::Decode)]\nstruct AggBucket {\n    // Identifier for the time bucket (epoch minute index).\n    start_minute: u64,\n    sum: f64,\n    count: u64,\n}\n\nimpl AggBucket {\n    fn new() -\u003e Self {\n        Self {\n            start_minute: 0,\n            sum: 0.0,\n            count: 0,\n        }\n    }\n}\n\n#[derive(Debug)]\nstruct ColumnAggState {\n    // Fixed-size ring buffer of 60 one-minute buckets for a 1-hour window.\n    minute_buckets: Vec\u003cAggBucket\u003e,\n    // Fixed-size ring buffer of 24 one-hour buckets for a 24-hour window.\n    hour_buckets: Vec\u003cAggBucket\u003e,\n    // Fixed-size ring buffer of 7 one-day buckets for a 7-day window.\n    day_buckets: Vec\u003cAggBucket\u003e,\n}\n\nimpl ColumnAggState {\n    fn new() -\u003e Self {\n        Self {\n            minute_buckets: vec![AggBucket::new(); 60],\n            hour_buckets: vec![AggBucket::new(); 24],\n            day_buckets: vec![AggBucket::new(); 7],\n        }\n    }\n\n    fn update(\u0026mut self, now_secs: u64, value: f64) {\n        Self::update_buckets(\u0026mut self.minute_buckets, now_secs, value, 60);\n        Self::update_buckets(\u0026mut self.hour_buckets, now_secs, value, 60 * 60);\n        Self::update_buckets(\u0026mut self.day_buckets, now_secs, value, 24 * 60 * 60);\n    }\n\n    fn avg_last_1h(\u0026self, now_secs: u64) -\u003e Option\u003cf64\u003e {\n        Self::avg_over_window(\u0026self.minute_buckets, now_secs, 60, 60)\n    }\n\n    fn avg_last_24h(\u0026self, now_secs: u64) -\u003e Option\u003cf64\u003e {\n        Self::avg_over_window(\u0026self.hour_buckets, now_secs, 24, 60 * 60)\n    }\n\n    fn avg_last_7d(\u0026self, now_secs: u64) -\u003e Option\u003cf64\u003e {\n        Self::avg_over_window(\u0026self.day_buckets, now_secs, 7, 24 * 60 * 60)\n    }\n\n    fn update_buckets(buckets: \u0026mut [AggBucket], now_secs: u64, value: f64, bucket_span_secs: u64) {\n        let bucket_index = now_secs / bucket_span_secs;\n        let len = buckets.len() as u64;\n        if len == 0 {\n            return;\n        }\n        let idx = (bucket_index % len) as usize;\n        let bucket = \u0026mut buckets[idx];\n\n        if bucket.start_minute != bucket_index {\n            bucket.start_minute = bucket_index;\n            bucket.sum = 0.0;\n            bucket.count = 0;\n        }\n\n        bucket.sum += value;\n        bucket.count += 1;\n    }\n\n    fn avg_over_window(\n        buckets: \u0026[AggBucket],\n        now_secs: u64,\n        window_buckets: u64,\n        bucket_span_secs: u64,\n    ) -\u003e Option\u003cf64\u003e {\n        if buckets.is_empty() || window_buckets == 0 {\n            return None;\n        }\n\n        let current_index = now_secs / bucket_span_secs;\n        let len = buckets.len() as u64;\n        let mut sum = 0.0;\n        let mut count = 0u64;\n\n        for offset in 0..window_buckets {\n            let index = current_index.saturating_sub(offset);\n            let idx = (index % len) as usize;\n            let bucket = \u0026buckets[idx];\n            if bucket.start_minute == index {\n                sum += bucket.sum;\n                count = count.saturating_add(bucket.count);\n            }\n        }\n\n        if count == 0 {\n            None\n        } else {\n            Some(sum / count as f64)\n        }\n    }\n}\n\n#[derive(Debug)]\nstruct TableAggState {\n    columns: HashMap\u003cString, ColumnAggState\u003e,\n}\n\nimpl TableAggState {\n    fn new() -\u003e Self {\n        Self {\n            columns: HashMap::new(),\n        }\n    }\n\n    fn update_row(\u0026mut self, now_secs: u64, row: \u0026Row) {\n        for (col_name, value) in \u0026row.values {\n            if let Value::Float(f) = value {\n                let entry = self\n                    .columns\n                    .entry(col_name.clone())\n                    .or_insert_with(ColumnAggState::new);\n                entry.update(now_secs, *f);\n            }\n        }\n    }\n\n    fn avg_last_1h(\u0026self, now_secs: u64, column: \u0026str) -\u003e Option\u003cf64\u003e {\n        let state = self.columns.get(column)?;\n        state.avg_last_1h(now_secs)\n    }\n\n    fn avg_last_24h(\u0026self, now_secs: u64, column: \u0026str) -\u003e Option\u003cf64\u003e {\n        let state = self.columns.get(column)?;\n        state.avg_last_24h(now_secs)\n    }\n\n    fn avg_last_7d(\u0026self, now_secs: u64, column: \u0026str) -\u003e Option\u003cf64\u003e {\n        let state = self.columns.get(column)?;\n        state.avg_last_7d(now_secs)\n    }\n}\n\n#[derive(Debug)]\nstruct WindowAggState {\n    tables: HashMap\u003cString, TableAggState\u003e,\n}\n\nimpl WindowAggState {\n    fn new() -\u003e Self {\n        Self {\n            tables: HashMap::new(),\n        }\n    }\n\n    fn update_row(\u0026mut self, table: \u0026str, now_secs: u64, row: \u0026Row) {\n        let table_state = self\n            .tables\n            .entry(table.to_string())\n            .or_insert_with(TableAggState::new);\n        table_state.update_row(now_secs, row);\n    }\n\n    fn avg_last_1h(\u0026self, table: \u0026str, column: \u0026str, now_secs: u64) -\u003e Option\u003cf64\u003e {\n        let table_state = self.tables.get(table)?;\n        table_state.avg_last_1h(now_secs, column)\n    }\n\n    fn avg_last_24h(\u0026self, table: \u0026str, column: \u0026str, now_secs: u64) -\u003e Option\u003cf64\u003e {\n        let table_state = self.tables.get(table)?;\n        table_state.avg_last_24h(now_secs, column)\n    }\n\n    fn avg_last_7d(\u0026self, table: \u0026str, column: \u0026str, now_secs: u64) -\u003e Option\u003cf64\u003e {\n        let table_state = self.tables.get(table)?;\n        table_state.avg_last_7d(now_secs, column)\n    }\n}\n\npub struct QueryResult {\n    pub columns: Vec\u003cString\u003e,\n    pub rows: Vec\u003cVec\u003cValue\u003e\u003e,\n}\n\nimpl QueryResult {\n    pub fn empty() -\u003e Self {\n        Self {\n            columns: Vec::new(),\n            rows: Vec::new(),\n        }\n    }\n}\n\npub struct Executor {\n    storage: Box\u003cdyn StorageEngine\u003e,\n    raft_node: Option\u003cstd::sync::Weak\u003cMutex\u003ccrate::raft::RaftNode\u003e\u003e\u003e,\n    in_transaction: bool,\n    transaction_buffer: Vec\u003cStatement\u003e,\n    agg_state: WindowAggState,\n    agg_tree: sled::Tree,\n}\n\nimpl Executor {\n    pub async fn new(data_dir: \u0026str) -\u003e Self {\n        let config = StorageConfig::Sled {\n            data_dir: data_dir.to_string(),\n        };\n        let mut storage = create_storage_engine(config).expect(\"Failed to create storage engine\");\n\n        // Initialize storage\n        storage.init().await.expect(\"Failed to initialize storage\");\n\n        // Open a dedicated sled tree for aggregation state snapshots.\n        let agg_db = sled::open(format!(\"{}/agg_state\", data_dir))\n            .expect(\"Failed to open aggregation state DB\");\n        let agg_tree = agg_db\n            .open_tree(\"__agg_state__\")\n            .expect(\"Failed to open aggregation state tree\");\n\n        let mut this = Self {\n            storage,\n            raft_node: None,\n            in_transaction: false,\n            transaction_buffer: Vec::new(),\n            agg_state: WindowAggState::new(),\n            agg_tree,\n        };\n\n        this.load_agg_state_from_sled();\n\n        this\n    }\n\n    pub fn set_raft_node(\u0026mut self, node: std::sync::Weak\u003cMutex\u003ccrate::raft::RaftNode\u003e\u003e) {\n        self.raft_node = Some(node);\n    }\n\n    pub fn avg_last_1h(\u0026self, table: \u0026str, column: \u0026str) -\u003e Option\u003cf64\u003e {\n        let now_secs = SystemTime::now()\n            .duration_since(UNIX_EPOCH)\n            .unwrap_or_default()\n            .as_secs();\n        self.agg_state.avg_last_1h(table, column, now_secs)\n    }\n\n    pub fn avg_last_24h(\u0026self, table: \u0026str, column: \u0026str) -\u003e Option\u003cf64\u003e {\n        let now_secs = SystemTime::now()\n            .duration_since(UNIX_EPOCH)\n            .unwrap_or_default()\n            .as_secs();\n        self.agg_state.avg_last_24h(table, column, now_secs)\n    }\n\n    pub fn avg_last_7d(\u0026self, table: \u0026str, column: \u0026str) -\u003e Option\u003cf64\u003e {\n        let now_secs = SystemTime::now()\n            .duration_since(UNIX_EPOCH)\n            .unwrap_or_default()\n            .as_secs();\n        self.agg_state.avg_last_7d(table, column, now_secs)\n    }\n\n    pub async fn execute(\u0026mut self, ast: Ast) -\u003e Result\u003cQueryResult, ExecutorError\u003e {\n        // In a distributed setting, we should check if this is a read-only query\n        // Read-only queries can be executed directly, but write queries should go through Raft\n        let is_read_only = matches!(\n            \u0026ast,\n            Ast::Statement(\n                Statement::Select { .. }\n                    | Statement::SelectAgg1h { .. }\n                    | Statement::SelectAgg24h { .. }\n                    | Statement::SelectAgg7d { .. }\n                    | Statement::SelectCount { .. }\n                    | Statement::SelectSum { .. }\n                    | Statement::SelectAvg { .. }\n                    | Statement::SelectMin { .. }\n                    | Statement::SelectMax { .. }\n                    | Statement::SelectJoin { .. }\n                    | Statement::SelectGroupCount { .. }\n            )\n        );\n\n        if is_read_only {\n            // Read-only queries: if in distributed mode, prefer serving on the leader.\n            if let Some(node_weak) = \u0026self.raft_node {\n                if let Some(node) = node_weak.upgrade() {\n                    let (is_leader, lease_ok) = {\n                        let node = node.lock().await;\n                        (node.is_leader(), node.can_serve_read_locally())\n                    };\n                    if !is_leader {\n                        return Err(ExecutorError::ExecutionError(\"Not the leader\".to_string()));\n                    }\n                    // If leader: lease_ok can be used for observability; reads proceed regardless.\n                    let _ = lease_ok;\n                }\n            }\n\n            match ast {\n                Ast::Statement(stmt) =\u003e self.execute_statement(stmt).await,\n            }\n        } else {\n            // Write queries should go through Raft\n            if let Some(node_weak) = \u0026self.raft_node {\n                if let Some(node) = node_weak.upgrade() {\n                    let is_leader = {\n                        let node = node.lock().await;\n                        node.is_leader()\n                    };\n\n                    // Check if this node is the leader\n                    if !is_leader {\n                        return Err(ExecutorError::ExecutionError(\"Not the leader\".to_string()));\n                    }\n\n                    // Serialize the command\n                    let command = bincode::encode_to_vec(\u0026ast, bincode::config::standard())\n                        .map_err(|e| {\n                            ExecutorError::ExecutionError(format!(\"Serialization error: {e}\"))\n                        })?;\n\n                    // Submit to Raft and wait for the log entry to be\n                    // committed and applied locally on the leader. This\n                    // ensures the write is durably replicated before we\n                    // return to the client.\n                    let rx = {\n                        let mut node = node.lock().await;\n                        node.submit_command(command).map_err(|e| {\n                            ExecutorError::ExecutionError(format!(\"Raft error: {e}\"))\n                        })?\n                    };\n\n                    let commit_res =\n                        tokio::time::timeout(std::time::Duration::from_secs(10), rx).await;\n\n                    match commit_res {\n                        Ok(Ok(())) =\u003e {\n                            // committed and applied\n                        }\n                        Ok(Err(e)) =\u003e {\n                            return Err(ExecutorError::ExecutionError(format!(\n                                \"Raft commit wait error: {e}\",\n                            )));\n                        }\n                        Err(_elapsed) =\u003e {\n                            return Err(ExecutorError::ExecutionError(\n                                \"Timeout waiting for Raft commit\".to_string(),\n                            ));\n                        }\n                    }\n\n                    // Once committed and applied via the Raft state machine,\n                    // we can execute a read-only view if needed. For now,\n                    // return an empty result for pure writes.\n                    Ok(QueryResult::empty())\n                } else {\n                    // Raft node has been dropped\n                    Err(ExecutorError::ExecutionError(\n                        \"Raft node not available\".to_string(),\n                    ))\n                }\n            } else {\n                // No Raft node, execute directly (single-node mode)\n                match ast {\n                    Ast::Statement(stmt) =\u003e self.execute_statement(stmt).await,\n                }\n            }\n        }\n    }\n\n    // This method is called by the Raft state machine when a command is committed\n    pub async fn apply_command(\u0026mut self, command: \u0026[u8]) -\u003e Result\u003c(), ExecutorError\u003e {\n        // Deserialize the command\n        let (ast, _): (Ast, usize) =\n            bincode::decode_from_slice(command, bincode::config::standard()).map_err(|e| {\n                ExecutorError::ExecutionError(format!(\"Deserialization error: {e}\"))\n            })?;\n        if let Ast::Statement(Statement::CreateTable { table_name, .. }) = \u0026ast {\n            let schema_exists = self\n                .storage\n                .get_schema(table_name)\n                .await\n                .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n            if schema_exists.is_some() {\n                return Ok(());\n            }\n        }\n\n        match ast {\n            Ast::Statement(stmt) =\u003e {\n                self.execute_statement(stmt).await?;\n                Ok(())\n            }\n        }\n    }\n\n    async fn execute_statement(\u0026mut self, stmt: Statement) -\u003e Result\u003cQueryResult, ExecutorError\u003e {\n        match stmt {\n            Statement::Begin =\u003e {\n                if self.in_transaction {\n                    return Err(ExecutorError::ExecutionError(\n                        \"Already in a transaction\".to_string(),\n                    ));\n                }\n                self.in_transaction = true;\n                self.transaction_buffer.clear();\n                Ok(QueryResult {\n                    columns: vec![\"result\".to_string()],\n                    rows: vec![vec![Value::String(\"Transaction started\".to_string())]],\n                })\n            }\n            Statement::Commit =\u003e {\n                if !self.in_transaction {\n                    return Err(ExecutorError::ExecutionError(\n                        \"Not in a transaction\".to_string(),\n                    ));\n                }\n\n                // To avoid borrow checker issues (E0499), we first collect the statements\n                // into a new Vec. This releases the mutable borrow on `self.transaction_buffer`\n                // before we start calling `self.execute_immediate` which borrows `self` again.\n                let stmts_to_execute: Vec\u003cStatement\u003e = self.transaction_buffer.drain(..).collect();\n\n                for buffered_stmt in stmts_to_execute {\n                    // Note: This is a simplified commit. A real implementation would need a way to roll back\n                    // partially applied changes if one of the statements fails.\n                    self.execute_immediate(buffered_stmt).await?;\n                }\n\n                self.in_transaction = false;\n                Ok(QueryResult {\n                    columns: vec![\"result\".to_string()],\n                    rows: vec![vec![Value::String(\"Transaction committed\".to_string())]],\n                })\n            }\n            Statement::Rollback =\u003e {\n                if !self.in_transaction {\n                    return Err(ExecutorError::ExecutionError(\n                        \"Not in a transaction\".to_string(),\n                    ));\n                }\n                self.in_transaction = false;\n                self.transaction_buffer.clear();\n                Ok(QueryResult {\n                    columns: vec![\"result\".to_string()],\n                    rows: vec![vec![Value::String(\"Transaction rolled back\".to_string())]],\n                })\n            }\n            // For any other statement\n            _ =\u003e {\n                if self.in_transaction {\n                    // Buffer the statement instead of executing it\n                    self.transaction_buffer.push(stmt);\n                    Ok(QueryResult {\n                        columns: vec![\"result\".to_string()],\n                        rows: vec![vec![Value::String(\"Statement buffered\".to_string())]],\n                    })\n                } else {\n                    // If not in a transaction, execute immediately\n                    self.execute_immediate(stmt).await\n                }\n            }\n        }\n    }\n\n    /// Executes a statement directly against the storage engine, bypassing transaction logic.\n    async fn execute_immediate(\u0026mut self, stmt: Statement) -\u003e Result\u003cQueryResult, ExecutorError\u003e {\n        match stmt {\n            Statement::CreateTable {\n                table_name,\n                columns,\n                ttl,\n            } =\u003e {\n                let schema = self.convert_to_table_schema(\u0026table_name, \u0026columns, ttl);\n\n                self.storage\n                    .create_table(\u0026table_name, schema)\n                    .await\n                    .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n\n                Ok(QueryResult {\n                    columns: vec![\"result\".to_string()],\n                    rows: vec![vec![Value::String(format!(\"Table {table_name} created\"))]],\n                })\n            }\n            Statement::Insert {\n                table_name,\n                columns,\n                values,\n            } =\u003e {\n                let row = self\n                    .convert_to_row(\u0026table_name, columns.as_deref(), \u0026values)\n                    .await?;\n                let now_secs = SystemTime::now()\n                    .duration_since(UNIX_EPOCH)\n                    .unwrap()\n                    .as_secs();\n\n                self.agg_state.update_row(\u0026table_name, now_secs, \u0026row);\n                self.persist_agg_buckets(\u0026table_name, now_secs, \u0026row);\n\n                self.storage\n                    .insert(\u0026table_name, vec![row])\n                    .await\n                    .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n\n                Ok(QueryResult {\n                    columns: vec![\"result\".to_string()],\n                    rows: vec![vec![Value::String(format!(\"Inserted into {table_name}\"))]],\n                })\n            }\n            Statement::Select {\n                table_name,\n                columns,\n                conditions,\n            } =\u003e {\n                let filter = self.convert_to_filter(conditions.as_ref());\n\n                let rows = self\n                    .storage\n                    .query(\u0026table_name, filter)\n                    .await\n                    .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n\n                self.convert_rows_to_query_result(\u0026columns, rows)\n            }\n            Statement::SelectJoin {\n                left_table,\n                right_table,\n                join_column,\n                columns,\n                conditions,\n            } =\u003e {\n                let left_filter = self.convert_to_filter(conditions.as_ref());\n\n                let left_rows = self\n                    .storage\n                    .query(\u0026left_table, left_filter)\n                    .await\n                    .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n\n                let right_rows = self\n                    .storage\n                    .query(\u0026right_table, None)\n                    .await\n                    .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n\n                let mut joined: Vec\u003cRow\u003e = Vec::new();\n\n                for l in \u0026left_rows {\n                    let lk = match l.get(\u0026join_column) {\n                        Some(v) =\u003e v,\n                        None =\u003e continue,\n                    };\n\n                    for r in \u0026right_rows {\n                        let rk = match r.get(\u0026join_column) {\n                            Some(v) =\u003e v,\n                            None =\u003e continue,\n                        };\n\n                        if lk == rk {\n                            let mut merged = l.clone();\n                            for (k, v) in \u0026r.values {\n                                merged.values.insert(k.clone(), v.clone());\n                            }\n                            joined.push(merged);\n                        }\n                    }\n                }\n\n                self.convert_rows_to_query_result(\u0026columns, joined)\n            }\n            Statement::Update {\n                table_name,\n                assignments,\n                conditions,\n            } =\u003e {\n                // Simplified: fetch, modify, delete old, insert new\n                let filter = self.convert_to_filter(conditions.as_ref());\n\n                let mut rows = self\n                    .storage\n                    .query(\u0026table_name, filter.clone())\n                    .await\n                    .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n\n                // Apply assignments\n                for row in \u0026mut rows {\n                    for assignment in \u0026assignments {\n                        row.values\n                            .insert(assignment.column_name.clone(), assignment.value.clone());\n                    }\n                }\n\n                // Delete old rows if filter exists\n                if let Some(f) = filter {\n                    self.storage\n                        .delete(\u0026table_name, f)\n                        .await\n                        .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n                }\n\n                // Insert updated rows\n                self.storage\n                    .insert(\u0026table_name, rows)\n                    .await\n                    .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n\n                Ok(QueryResult {\n                    columns: vec![\"result\".to_string()],\n                    rows: vec![vec![Value::String(format!(\"Updated rows in {table_name}\"))]],\n                })\n            }\n            Statement::Delete {\n                table_name,\n                conditions,\n            } =\u003e {\n                let filter = self.convert_to_filter(conditions.as_ref()).ok_or_else(|| {\n                    ExecutorError::ExecutionError(\"DELETE requires WHERE clause\".to_string())\n                })?;\n\n                let deleted = self\n                    .storage\n                    .delete(\u0026table_name, filter)\n                    .await\n                    .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n\n                Ok(QueryResult {\n                    columns: vec![\"result\".to_string()],\n                    rows: vec![vec![Value::String(format!(\n                        \"Deleted {deleted} rows from {table_name}\"\n                    ))]],\n                })\n            }\n            Statement::CreateIndex {\n                index_name: _,\n                table_name,\n                column_name,\n            } =\u003e {\n                self.storage\n                    .create_index(\u0026table_name, \u0026column_name)\n                    .await\n                    .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n\n                Ok(QueryResult {\n                    columns: vec![\"result\".to_string()],\n                    rows: vec![vec![Value::String(format!(\n                        \"Index created on {table_name}.{column_name}\"\n                    ))]],\n                })\n            }\n\n            Statement::SelectAgg1h {\n                table_name,\n                column_name,\n            } =\u003e {\n                let col_label = format!(\"avg_1h({})\", column_name);\n                let value = self\n                    .avg_last_1h(\u0026table_name, \u0026column_name)\n                    .map(Value::Float)\n                    .unwrap_or(Value::Null);\n\n                Ok(QueryResult {\n                    columns: vec![col_label],\n                    rows: vec![vec![value]],\n                })\n            }\n\n            Statement::SelectCount {\n                table_name,\n                column,\n                conditions,\n            } =\u003e {\n                let filter = self.convert_to_filter(conditions.as_ref());\n\n                let rows = self\n                    .storage\n                    .query(\u0026table_name, filter)\n                    .await\n                    .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n\n                let count = if let Some(col) = column {\n                    rows.iter()\n                        .filter_map(|row| row.get(\u0026col))\n                        .filter(|v| !matches!(v, Value::Null))\n                        .count() as i64\n                } else {\n                    rows.len() as i64\n                };\n\n                Ok(QueryResult {\n                    columns: vec![\"count\".to_string()],\n                    rows: vec![vec![Value::Integer(count)]],\n                })\n            }\n\n            Statement::SelectSum {\n                table_name,\n                column_name,\n                conditions,\n            } =\u003e {\n                let filter = self.convert_to_filter(conditions.as_ref());\n\n                let rows = self\n                    .storage\n                    .query(\u0026table_name, filter)\n                    .await\n                    .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n\n                let mut sum = 0.0f64;\n                let mut count = 0u64;\n\n                for row in \u0026rows {\n                    if let Some(v) = row.get(\u0026column_name) {\n                        match v {\n                            Value::Integer(i) =\u003e {\n                                sum += *i as f64;\n                                count += 1;\n                            }\n                            Value::Float(f) =\u003e {\n                                sum += *f;\n                                count += 1;\n                            }\n                            _ =\u003e {}\n                        }\n                    }\n                }\n\n                let label = format!(\"sum({})\", column_name);\n                let value = if count == 0 {\n                    Value::Null\n                } else {\n                    Value::Float(sum)\n                };\n\n                Ok(QueryResult {\n                    columns: vec![label],\n                    rows: vec![vec![value]],\n                })\n            }\n\n            Statement::SelectAvg {\n                table_name,\n                column_name,\n                conditions,\n            } =\u003e {\n                let filter = self.convert_to_filter(conditions.as_ref());\n\n                let rows = self\n                    .storage\n                    .query(\u0026table_name, filter)\n                    .await\n                    .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n\n                let mut sum = 0.0f64;\n                let mut count = 0u64;\n\n                for row in \u0026rows {\n                    if let Some(v) = row.get(\u0026column_name) {\n                        match v {\n                            Value::Integer(i) =\u003e {\n                                sum += *i as f64;\n                                count += 1;\n                            }\n                            Value::Float(f) =\u003e {\n                                sum += *f;\n                                count += 1;\n                            }\n                            _ =\u003e {}\n                        }\n                    }\n                }\n\n                let label = format!(\"avg({})\", column_name);\n                let value = if count == 0 {\n                    Value::Null\n                } else {\n                    Value::Float(sum / count as f64)\n                };\n\n                Ok(QueryResult {\n                    columns: vec![label],\n                    rows: vec![vec![value]],\n                })\n            }\n\n            Statement::SelectMin {\n                table_name,\n                column_name,\n                conditions,\n            } =\u003e {\n                let filter = self.convert_to_filter(conditions.as_ref());\n\n                let rows = self\n                    .storage\n                    .query(\u0026table_name, filter)\n                    .await\n                    .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n\n                let mut current: Option\u003cValue\u003e = None;\n\n                for row in \u0026rows {\n                    if let Some(v) = row.get(\u0026column_name) {\n                        match v {\n                            Value::Integer(_) | Value::Float(_) =\u003e {\n                                if let Some(ref cur) = current {\n                                    if v \u003c cur {\n                                        current = Some(v.clone());\n                                    }\n                                } else {\n                                    current = Some(v.clone());\n                                }\n                            }\n                            _ =\u003e {}\n                        }\n                    }\n                }\n\n                let label = format!(\"min({})\", column_name);\n                let value = current.unwrap_or(Value::Null);\n\n                Ok(QueryResult {\n                    columns: vec![label],\n                    rows: vec![vec![value]],\n                })\n            }\n\n            Statement::SelectMax {\n                table_name,\n                column_name,\n                conditions,\n            } =\u003e {\n                let filter = self.convert_to_filter(conditions.as_ref());\n\n                let rows = self\n                    .storage\n                    .query(\u0026table_name, filter)\n                    .await\n                    .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n\n                let mut current: Option\u003cValue\u003e = None;\n\n                for row in \u0026rows {\n                    if let Some(v) = row.get(\u0026column_name) {\n                        match v {\n                            Value::Integer(_) | Value::Float(_) =\u003e {\n                                if let Some(ref cur) = current {\n                                    if v \u003e cur {\n                                        current = Some(v.clone());\n                                    }\n                                } else {\n                                    current = Some(v.clone());\n                                }\n                            }\n                            _ =\u003e {}\n                        }\n                    }\n                }\n\n                let label = format!(\"max({})\", column_name);\n                let value = current.unwrap_or(Value::Null);\n\n                Ok(QueryResult {\n                    columns: vec![label],\n                    rows: vec![vec![value]],\n                })\n            }\n\n            Statement::SelectGroupCount {\n                table_name,\n                group_column,\n                conditions,\n            } =\u003e {\n                let filter = self.convert_to_filter(conditions.as_ref());\n\n                let rows = self\n                    .storage\n                    .query(\u0026table_name, filter)\n                    .await\n                    .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n\n                let mut groups: Vec\u003c(Value, i64)\u003e = Vec::new();\n\n                for row in \u0026rows {\n                    let key = row.get(\u0026group_column).cloned().unwrap_or(Value::Null);\n\n                    if let Some((_, count)) = groups.iter_mut().find(|(k, _)| *k == key) {\n                        *count += 1;\n                    } else {\n                        groups.push((key, 1));\n                    }\n                }\n\n                let columns = vec![group_column.clone(), \"count\".to_string()];\n                let result_rows = groups\n                    .into_iter()\n                    .map(|(k, c)| vec![k, Value::Integer(c)])\n                    .collect();\n\n                Ok(QueryResult {\n                    columns,\n                    rows: result_rows,\n                })\n            }\n\n            Statement::SelectAgg24h {\n                table_name,\n                column_name,\n            } =\u003e {\n                let col_label = format!(\"avg_24h({})\", column_name);\n                let value = self\n                    .avg_last_24h(\u0026table_name, \u0026column_name)\n                    .map(Value::Float)\n                    .unwrap_or(Value::Null);\n\n                Ok(QueryResult {\n                    columns: vec![col_label],\n                    rows: vec![vec![value]],\n                })\n            }\n\n            Statement::SelectAgg7d {\n                table_name,\n                column_name,\n            } =\u003e {\n                let col_label = format!(\"avg_7d({})\", column_name);\n                let value = self\n                    .avg_last_7d(\u0026table_name, \u0026column_name)\n                    .map(Value::Float)\n                    .unwrap_or(Value::Null);\n\n                Ok(QueryResult {\n                    columns: vec![col_label],\n                    rows: vec![vec![value]],\n                })\n            }\n\n            // Transaction statements should not reach here\n            Statement::Begin | Statement::Commit | Statement::Rollback =\u003e {\n                Err(ExecutorError::ExecutionError(\n                    \"Cannot execute transaction control statements directly\".to_string(),\n                ))\n            }\n        }\n    }\n\n    // Helper conversion methods\n    fn convert_to_table_schema(\n        \u0026self,\n        table_name: \u0026str,\n        columns: \u0026[ColumnDefinition],\n        ttl: Option\u003cTtlSpec\u003e,\n    ) -\u003e TableSchema {\n        TableSchema {\n            name: table_name.to_string(),\n            columns: columns\n                .iter()\n                .map(|col| Column {\n                    name: col.name.clone(),\n                    data_type: match col.data_type {\n                        ParserDataType::Int =\u003e DataType::Int,\n                        ParserDataType::Text | ParserDataType::String =\u003e DataType::String,\n                        ParserDataType::Float =\u003e DataType::Float,\n                        ParserDataType::Boolean =\u003e DataType::Boolean,\n                    },\n                })\n                .collect(),\n            ttl_seconds: ttl.map(|t| t.seconds),\n        }\n    }\n\n    async fn convert_to_row(\n        \u0026self,\n        table_name: \u0026str,\n        columns: Option\u003c\u0026[String]\u003e,\n        values: \u0026[Value],\n    ) -\u003e Result\u003cRow, ExecutorError\u003e {\n        let schema = self\n            .storage\n            .get_schema(table_name)\n            .await\n            .map_err(|e| ExecutorError::StorageError(e.to_string()))?\n            .ok_or_else(|| {\n                ExecutorError::ExecutionError(format!(\"Table {table_name} not found\"))\n            })?;\n\n        let mut row = Row::new();\n\n        if let Some(cols) = columns {\n            for (i, col_name) in cols.iter().enumerate() {\n                if i \u003c values.len() {\n                    row.insert(col_name.clone(), values[i].clone());\n                }\n            }\n        } else {\n            for (i, col) in schema.columns.iter().enumerate() {\n                if i \u003c values.len() {\n                    row.insert(col.name.clone(), values[i].clone());\n                }\n            }\n        }\n\n        Ok(row)\n    }\n\n    fn convert_to_filter(\u0026self, conditions: Option\u003c\u0026Vec\u003cCondition\u003e\u003e) -\u003e Option\u003cFilter\u003e {\n        conditions?.first().map(|cond| Filter {\n            column: cond.column_name.clone(),\n            op: match cond.operator {\n                Operator::Equals =\u003e FilterOp::Eq,\n                Operator::NotEquals =\u003e FilterOp::Ne,\n                Operator::LessThan =\u003e FilterOp::Lt,\n                Operator::LessThanOrEqual =\u003e FilterOp::Le,\n                Operator::GreaterThan =\u003e FilterOp::Gt,\n                Operator::GreaterThanOrEqual =\u003e FilterOp::Ge,\n            },\n            value: cond.value.clone(),\n        })\n    }\n\n    fn convert_rows_to_query_result(\n        \u0026self,\n        columns: \u0026[String],\n        rows: Vec\u003cRow\u003e,\n    ) -\u003e Result\u003cQueryResult, ExecutorError\u003e {\n        let col_names = if columns.contains(\u0026\"*\".to_string()) || columns.is_empty() {\n            if let Some(first_row) = rows.first() {\n                first_row.values.keys().cloned().collect()\n            } else {\n                vec![]\n            }\n        } else {\n            columns.to_vec()\n        };\n\n        let result_rows: Vec\u003cVec\u003cValue\u003e\u003e = rows\n            .iter()\n            .map(|row| {\n                col_names\n                    .iter()\n                    .filter_map(|col| row.get(col).cloned())\n                    .collect()\n            })\n            .collect();\n\n        Ok(QueryResult {\n            columns: col_names,\n            rows: result_rows,\n        })\n    }\n\n    pub async fn drain_offline_queue(\n        \u0026self,\n        limit: usize,\n    ) -\u003e Result\u003cVec\u003cPersistentQueuedOperation\u003e, ExecutorError\u003e {\n        self.storage\n            .drain_offline_queue(limit)\n            .await\n            .map_err(|e| ExecutorError::StorageError(e.to_string()))\n    }\n\n    pub async fn requeue_offline_ops(\n        \u0026self,\n        ops: Vec\u003cPersistentQueuedOperation\u003e,\n    ) -\u003e Result\u003c(), ExecutorError\u003e {\n        self.storage\n            .requeue_offline_ops(ops)\n            .await\n            .map_err(|e| ExecutorError::StorageError(e.to_string()))\n    }\n\n    pub async fn apply_storage_operation(\n        \u0026mut self,\n        op: crate::storage::wal::Operation,\n    ) -\u003e Result\u003c(), ExecutorError\u003e {\n        self.storage\n            .apply_operation(op)\n            .await\n            .map_err(|e| ExecutorError::StorageError(e.to_string()))\n    }\n\n    pub async fn cleanup_expired(\n        \u0026mut self,\n        now_secs: u64,\n        limit: usize,\n    ) -\u003e Result\u003cu64, ExecutorError\u003e {\n        self.storage\n            .cleanup_expired(now_secs, limit)\n            .await\n            .map_err(|e| ExecutorError::StorageError(e.to_string()))\n    }\n\n    pub async fn get_lww_timestamp(\n        \u0026self,\n        table: \u0026str,\n        key: \u0026[u8],\n    ) -\u003e Result\u003cOption\u003cHybridTimestamp\u003e, ExecutorError\u003e {\n        self.storage\n            .get_lww_ts(table, key)\n            .await\n            .map_err(|e| ExecutorError::StorageError(e.to_string()))\n    }\n\n    pub async fn set_lww_timestamp(\n        \u0026mut self,\n        table: \u0026str,\n        key: \u0026[u8],\n        ts: HybridTimestamp,\n    ) -\u003e Result\u003c(), ExecutorError\u003e {\n        self.storage\n            .set_lww_ts(table, key, ts)\n            .await\n            .map_err(|e| ExecutorError::StorageError(e.to_string()))\n    }\n\n    /// Apply a Raft log command that encodes an AST via bincode. This is\n    /// used by the Raft state machine apply worker to bring followers'\n    /// storage in sync with the leader.\n    pub async fn apply_raft_command(\u0026mut self, cmd: Vec\u003cu8\u003e) -\u003e Result\u003c(), ExecutorError\u003e {\n        let (ast, _): (Ast, usize) =\n            bincode::serde::decode_from_slice(\u0026cmd, bincode::config::standard())\n                .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n\n        // Special-case CREATE TABLE so that Raft apply is idempotent on\n        // followers and on nodes that might have executed the statement\n        // previously while acting as leader. If the table already exists,\n        // we treat this as a no-op instead of an error.\n        if let Ast::Statement(Statement::CreateTable { table_name, .. }) = \u0026ast {\n            let schema_exists = self\n                .storage\n                .get_schema(table_name)\n                .await\n                .map_err(|e| ExecutorError::StorageError(e.to_string()))?;\n            if schema_exists.is_some() {\n                return Ok(());\n            }\n        }\n\n        // We are only interested in the side effects of executing this\n        // statement (writes applied to storage, aggregates updated, etc.),\n        // not in returning rows to a client. Drop the QueryResult.\n        let _ = self.execute(ast).await?;\n        Ok(())\n    }\n}\n\nimpl Executor {\n    fn load_agg_state_from_sled(\u0026mut self) {\n        for item in self.agg_tree.iter() {\n            let Ok((key, value)) = item else { continue };\n            let key_str = match std::str::from_utf8(\u0026key) {\n                Ok(s) =\u003e s,\n                Err(_) =\u003e continue,\n            };\n\n            let mut parts = key_str.splitn(4, ':');\n            let table = match parts.next() {\n                Some(t) =\u003e t,\n                None =\u003e continue,\n            };\n            let column = match parts.next() {\n                Some(c) =\u003e c,\n                None =\u003e continue,\n            };\n            let window = match parts.next() {\n                Some(w) =\u003e w,\n                None =\u003e continue,\n            };\n            let index_str = match parts.next() {\n                Some(i) =\u003e i,\n                None =\u003e continue,\n            };\n\n            let bucket_index: u64 = match index_str.parse() {\n                Ok(v) =\u003e v,\n                Err(_) =\u003e continue,\n            };\n\n            let Ok((bucket, _)): Result\u003c(AggBucket, usize), _\u003e =\n                bincode::decode_from_slice(\u0026value, bincode::config::standard())\n            else {\n                continue;\n            };\n\n            let table_state = self\n                .agg_state\n                .tables\n                .entry(table.to_string())\n                .or_insert_with(TableAggState::new);\n            let col_state = table_state\n                .columns\n                .entry(column.to_string())\n                .or_insert_with(ColumnAggState::new);\n\n            match window {\n                \"1h\" =\u003e Self::restore_bucket(\u0026mut col_state.minute_buckets, bucket_index, bucket),\n                \"24h\" =\u003e Self::restore_bucket(\u0026mut col_state.hour_buckets, bucket_index, bucket),\n                \"7d\" =\u003e Self::restore_bucket(\u0026mut col_state.day_buckets, bucket_index, bucket),\n                _ =\u003e {}\n            }\n        }\n    }\n\n    fn restore_bucket(buckets: \u0026mut [AggBucket], bucket_index: u64, bucket: AggBucket) {\n        let len = buckets.len() as u64;\n        if len == 0 {\n            return;\n        }\n        let idx = (bucket_index % len) as usize;\n        buckets[idx] = bucket;\n    }\n\n    fn persist_agg_buckets(\u0026self, table: \u0026str, now_secs: u64, row: \u0026Row) {\n        let table_state = match self.agg_state.tables.get(table) {\n            Some(t) =\u003e t,\n            None =\u003e return,\n        };\n\n        for (col_name, value) in \u0026row.values {\n            if let Value::Float(_) = value {\n                let Some(col_state) = table_state.columns.get(col_name) else {\n                    continue;\n                };\n\n                Self::persist_window(\n                    \u0026self.agg_tree,\n                    table,\n                    col_name,\n                    \"1h\",\n                    now_secs,\n                    60,\n                    \u0026col_state.minute_buckets,\n                );\n                Self::persist_window(\n                    \u0026self.agg_tree,\n                    table,\n                    col_name,\n                    \"24h\",\n                    now_secs,\n                    60 * 60,\n                    \u0026col_state.hour_buckets,\n                );\n                Self::persist_window(\n                    \u0026self.agg_tree,\n                    table,\n                    col_name,\n                    \"7d\",\n                    now_secs,\n                    24 * 60 * 60,\n                    \u0026col_state.day_buckets,\n                );\n            }\n        }\n    }\n\n    fn persist_window(\n        tree: \u0026sled::Tree,\n        table: \u0026str,\n        column: \u0026str,\n        window: \u0026str,\n        now_secs: u64,\n        bucket_span_secs: u64,\n        buckets: \u0026[AggBucket],\n    ) {\n        let len = buckets.len() as u64;\n        if len == 0 {\n            return;\n        }\n\n        let bucket_index = now_secs / bucket_span_secs;\n        let idx = (bucket_index % len) as usize;\n        let bucket = buckets[idx];\n\n        let key = format!(\"{}:{}:{}:{}\", table, column, window, bucket_index);\n        if let Ok(bytes) = bincode::encode_to_vec(bucket, bincode::config::standard()) {\n            let _ = tree.insert(key.as_bytes(), bytes);\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn window_agg_basic_avg_last_1h() {\n        let mut state = WindowAggState::new();\n\n        let base_secs: u64 = 3_600_000;\n\n        // Insert first row at base time with value 10.0\n        let mut row1 = Row::new();\n        row1.insert(\"temp\".to_string(), Value::Float(10.0));\n        state.update_row(\"sensors\", base_secs, \u0026row1);\n\n        // Insert second row one minute later with value 20.0\n        let mut row2 = Row::new();\n        row2.insert(\"temp\".to_string(), Value::Float(20.0));\n        state.update_row(\"sensors\", base_secs + 60, \u0026row2);\n\n        let now_secs = base_secs + 60;\n        let avg = state\n            .avg_last_1h(\"sensors\", \"temp\", now_secs)\n            .expect(\"expected non-empty avg\");\n\n        assert!((avg - 15.0).abs() \u003c 1e-9);\n    }\n\n    #[test]\n    fn window_agg_ignores_data_older_than_1h() {\n        let mut state = WindowAggState::new();\n\n        let base_secs: u64 = 3_600_000;\n\n        // Very old row: 2 hours before base\n        let mut old_row = Row::new();\n        old_row.insert(\"temp\".to_string(), Value::Float(100.0));\n        state.update_row(\"sensors\", base_secs.saturating_sub(2 * 3600), \u0026old_row);\n\n        // Recent row at base time with value 10.0\n        let mut recent_row = Row::new();\n        recent_row.insert(\"temp\".to_string(), Value::Float(10.0));\n        state.update_row(\"sensors\", base_secs, \u0026recent_row);\n\n        let now_secs = base_secs;\n        let avg = state\n            .avg_last_1h(\"sensors\", \"temp\", now_secs)\n            .expect(\"expected non-empty avg\");\n\n        // Old row should have fallen out of the 1h window, so only 10.0 remains\n        assert!((avg - 10.0).abs() \u003c 1e-9);\n    }\n}\n","traces":[{"line":29,"address":[15997600],"length":1,"stats":{"Line":3}},{"line":49,"address":[18314522,18314176,18314516],"length":1,"stats":{"Line":3}},{"line":51,"address":[18314202],"length":1,"stats":{"Line":3}},{"line":52,"address":[15842435,15842483],"length":1,"stats":{"Line":6}},{"line":53,"address":[18314377,18314332],"length":1,"stats":{"Line":5}},{"line":57,"address":[18314544],"length":1,"stats":{"Line":3}},{"line":58,"address":[19570420],"length":1,"stats":{"Line":3}},{"line":59,"address":[15957844,15957722],"length":1,"stats":{"Line":3}},{"line":60,"address":[19570535,19570598,19570665],"length":1,"stats":{"Line":6}},{"line":63,"address":[15853968],"length":1,"stats":{"Line":1}},{"line":64,"address":[15986946],"length":1,"stats":{"Line":1}},{"line":67,"address":[18313088],"length":1,"stats":{"Line":0}},{"line":68,"address":[15854287,15854211],"length":1,"stats":{"Line":0}},{"line":71,"address":[15744992],"length":1,"stats":{"Line":0}},{"line":72,"address":[15745125,15745011],"length":1,"stats":{"Line":0}},{"line":75,"address":[15987264],"length":1,"stats":{"Line":3}},{"line":76,"address":[18313259,18313314],"length":1,"stats":{"Line":3}},{"line":77,"address":[15864770],"length":1,"stats":{"Line":3}},{"line":78,"address":[15956410],"length":1,"stats":{"Line":3}},{"line":81,"address":[15956490,15956444],"length":1,"stats":{"Line":3}},{"line":82,"address":[19569291,19569219,19569254],"length":1,"stats":{"Line":6}},{"line":84,"address":[13281290,13281393],"length":1,"stats":{"Line":6}},{"line":85,"address":[15956622],"length":1,"stats":{"Line":3}},{"line":86,"address":[19569361],"length":1,"stats":{"Line":3}},{"line":87,"address":[15865001],"length":1,"stats":{"Line":3}},{"line":90,"address":[15841667],"length":1,"stats":{"Line":3}},{"line":91,"address":[13281341,13281405,13281414],"length":1,"stats":{"Line":6}},{"line":94,"address":[13281440],"length":1,"stats":{"Line":1}},{"line":100,"address":[13281512],"length":1,"stats":{"Line":1}},{"line":101,"address":[18313677],"length":1,"stats":{"Line":0}},{"line":104,"address":[19569631,19569536],"length":1,"stats":{"Line":1}},{"line":105,"address":[15841935],"length":1,"stats":{"Line":1}},{"line":106,"address":[18313751],"length":1,"stats":{"Line":1}},{"line":107,"address":[15841952],"length":1,"stats":{"Line":1}},{"line":109,"address":[15745868,15745833],"length":1,"stats":{"Line":2}},{"line":110,"address":[15854970],"length":1,"stats":{"Line":1}},{"line":111,"address":[13281747,13281902,13281872],"length":1,"stats":{"Line":2}},{"line":112,"address":[15957144,15957219,15957179],"length":1,"stats":{"Line":2}},{"line":113,"address":[13281950,13282024],"length":1,"stats":{"Line":2}},{"line":114,"address":[18314133],"length":1,"stats":{"Line":1}},{"line":115,"address":[18314150],"length":1,"stats":{"Line":1}},{"line":119,"address":[15745968,15745985],"length":1,"stats":{"Line":1}},{"line":120,"address":[13281767],"length":1,"stats":{"Line":0}},{"line":122,"address":[19569763],"length":1,"stats":{"Line":1}},{"line":133,"address":[15853904],"length":1,"stats":{"Line":3}},{"line":135,"address":[15955918],"length":1,"stats":{"Line":3}},{"line":139,"address":[15743968],"length":1,"stats":{"Line":3}},{"line":140,"address":[18311958,18311989],"length":1,"stats":{"Line":6}},{"line":141,"address":[15840281,15840352],"length":1,"stats":{"Line":6}},{"line":144,"address":[15863644],"length":1,"stats":{"Line":3}},{"line":145,"address":[15853324],"length":1,"stats":{"Line":3}},{"line":146,"address":[13280107],"length":1,"stats":{"Line":3}},{"line":151,"address":[15744336],"length":1,"stats":{"Line":1}},{"line":152,"address":[18312327],"length":1,"stats":{"Line":1}},{"line":153,"address":[15986473],"length":1,"stats":{"Line":1}},{"line":156,"address":[15840816],"length":1,"stats":{"Line":0}},{"line":157,"address":[15840871],"length":1,"stats":{"Line":0}},{"line":158,"address":[13280614],"length":1,"stats":{"Line":0}},{"line":161,"address":[15955552],"length":1,"stats":{"Line":0}},{"line":162,"address":[15840695],"length":1,"stats":{"Line":0}},{"line":163,"address":[15840777],"length":1,"stats":{"Line":0}},{"line":173,"address":[15856608],"length":1,"stats":{"Line":4}},{"line":175,"address":[15866990],"length":1,"stats":{"Line":4}},{"line":179,"address":[15855952],"length":1,"stats":{"Line":3}},{"line":182,"address":[15988958],"length":1,"stats":{"Line":3}},{"line":183,"address":[13282764],"length":1,"stats":{"Line":3}},{"line":184,"address":[15958061],"length":1,"stats":{"Line":3}},{"line":187,"address":[15958080],"length":1,"stats":{"Line":1}},{"line":188,"address":[15843217],"length":1,"stats":{"Line":1}},{"line":189,"address":[15856221],"length":1,"stats":{"Line":1}},{"line":192,"address":[13283168],"length":1,"stats":{"Line":0}},{"line":193,"address":[18315377],"length":1,"stats":{"Line":0}},{"line":194,"address":[15843661],"length":1,"stats":{"Line":0}},{"line":197,"address":[19570992],"length":1,"stats":{"Line":0}},{"line":198,"address":[13283041],"length":1,"stats":{"Line":0}},{"line":199,"address":[15747357],"length":1,"stats":{"Line":0}},{"line":209,"address":[15954998,15954992,15954848],"length":1,"stats":{"Line":0}},{"line":211,"address":[15863230],"length":1,"stats":{"Line":0}},{"line":212,"address":[15863244],"length":1,"stats":{"Line":0}},{"line":227,"address":[17248398,17248507,17248552,17248923,17250126,17248352],"length":1,"stats":{"Line":12}},{"line":229,"address":[14693905],"length":1,"stats":{"Line":3}},{"line":231,"address":[14891727,14891792],"length":1,"stats":{"Line":7}},{"line":234,"address":[12997268],"length":1,"stats":{"Line":11}},{"line":237,"address":[14799432],"length":1,"stats":{"Line":3}},{"line":239,"address":[14790632],"length":1,"stats":{"Line":3}},{"line":247,"address":[14695008],"length":1,"stats":{"Line":4}},{"line":248,"address":[18518847],"length":1,"stats":{"Line":4}},{"line":252,"address":[14790971],"length":1,"stats":{"Line":4}},{"line":254,"address":[18519130],"length":1,"stats":{"Line":4}},{"line":257,"address":[15844432,15844485],"length":1,"stats":{"Line":0}},{"line":258,"address":[15748393,15748353,15748328],"length":1,"stats":{"Line":0}},{"line":261,"address":[15867040],"length":1,"stats":{"Line":0}},{"line":262,"address":[15989695],"length":1,"stats":{"Line":0}},{"line":263,"address":[15843841],"length":1,"stats":{"Line":0}},{"line":266,"address":[15856848],"length":1,"stats":{"Line":0}},{"line":269,"address":[15867456],"length":1,"stats":{"Line":0}},{"line":270,"address":[15748111],"length":1,"stats":{"Line":0}},{"line":271,"address":[15857169],"length":1,"stats":{"Line":0}},{"line":274,"address":[15748224],"length":1,"stats":{"Line":0}},{"line":277,"address":[19571616],"length":1,"stats":{"Line":0}},{"line":278,"address":[15958943],"length":1,"stats":{"Line":0}},{"line":279,"address":[15867329],"length":1,"stats":{"Line":0}},{"line":282,"address":[15857056],"length":1,"stats":{"Line":0}},{"line":285,"address":[15966595,15966560],"length":1,"stats":{"Line":14}},{"line":288,"address":[14777480,14777647],"length":1,"stats":{"Line":6}},{"line":289,"address":[18519685],"length":1,"stats":{"Line":3}},{"line":305,"address":[14791809],"length":1,"stats":{"Line":3}},{"line":307,"address":[14924550,14923614],"length":1,"stats":{"Line":3}},{"line":308,"address":[14894830,14895062],"length":1,"stats":{"Line":0}},{"line":309,"address":[14895792],"length":1,"stats":{"Line":0}},{"line":310,"address":[14925084,14924859,14924937,14923401],"length":1,"stats":{"Line":0}},{"line":311,"address":[14925478,14925390,14925311],"length":1,"stats":{"Line":0}},{"line":313,"address":[14698134],"length":1,"stats":{"Line":0}},{"line":314,"address":[17252714,17252782],"length":1,"stats":{"Line":0}},{"line":322,"address":[14925755,14924602,14923422,14925860],"length":1,"stats":{"Line":6}},{"line":326,"address":[14777683,14777816],"length":1,"stats":{"Line":3}},{"line":327,"address":[14801384,14801104],"length":1,"stats":{"Line":0}},{"line":329,"address":[14777571,14778169,14778281,14780285],"length":1,"stats":{"Line":0}},{"line":330,"address":[14794650,14794723],"length":1,"stats":{"Line":0}},{"line":334,"address":[14794774],"length":1,"stats":{"Line":0}},{"line":335,"address":[14372504,14372440],"length":1,"stats":{"Line":0}},{"line":339,"address":[14795062,14795195,14794819,14795108,14795502],"length":1,"stats":{"Line":0}},{"line":340,"address":[14897081,14900022,14899792],"length":1,"stats":{"Line":0}},{"line":341,"address":[14783730,14783670],"length":1,"stats":{"Line":0}},{"line":349,"address":[18523405,18519832,18523628,18523488],"length":1,"stats":{"Line":0}},{"line":350,"address":[14804967,14807184,14807414,14804886,14805145],"length":1,"stats":{"Line":0}},{"line":351,"address":[14900070,14900130],"length":1,"stats":{"Line":0}},{"line":355,"address":[14511491],"length":1,"stats":{"Line":0}},{"line":358,"address":[17255574,17255513],"length":1,"stats":{"Line":0}},{"line":363,"address":[18524931,18524794],"length":1,"stats":{"Line":0}},{"line":368,"address":[14928810],"length":1,"stats":{"Line":0}},{"line":369,"address":[14374193],"length":1,"stats":{"Line":0}},{"line":377,"address":[14898725],"length":1,"stats":{"Line":0}},{"line":380,"address":[14696861],"length":1,"stats":{"Line":0}},{"line":381,"address":[18520428],"length":1,"stats":{"Line":0}},{"line":387,"address":[14792012,14791778,14797417,14792709],"length":1,"stats":{"Line":8}},{"line":394,"address":[14295746,14296566,14295556,14295504,14295680,14297317],"length":1,"stats":{"Line":0}},{"line":396,"address":[14715061,14715332,14717600,14717830,14715190,14715898],"length":1,"stats":{"Line":0}},{"line":398,"address":[18445778,18445718],"length":1,"stats":{"Line":0}},{"line":400,"address":[18443536],"length":1,"stats":{"Line":0}},{"line":401,"address":[14701639,14702647,14701381,14702142,14702033,14702229,14701706],"length":1,"stats":{"Line":0}},{"line":403,"address":[18443883,18443643],"length":1,"stats":{"Line":0}},{"line":404,"address":[14619419,14620340,14620192,14620561,14620131],"length":1,"stats":{"Line":0}},{"line":405,"address":[14717458,14716341,14717440,14716259],"length":1,"stats":{"Line":0}},{"line":406,"address":[14297157,14297102],"length":1,"stats":{"Line":0}},{"line":407,"address":[14725773],"length":1,"stats":{"Line":0}},{"line":412,"address":[17174471],"length":1,"stats":{"Line":0}},{"line":413,"address":[14701537,14703169,14700973,14702524,14702657],"length":1,"stats":{"Line":0}},{"line":414,"address":[14819289],"length":1,"stats":{"Line":0}},{"line":419,"address":[17233216,17233286,17234958,17238323,17240344,17233558],"length":1,"stats":{"Line":12}},{"line":420,"address":[18502663],"length":1,"stats":{"Line":3}},{"line":422,"address":[14774764],"length":1,"stats":{"Line":0}},{"line":423,"address":[14354520],"length":1,"stats":{"Line":0}},{"line":424,"address":[14784012],"length":1,"stats":{"Line":0}},{"line":427,"address":[14353311],"length":1,"stats":{"Line":0}},{"line":428,"address":[14783994],"length":1,"stats":{"Line":0}},{"line":429,"address":[14877914],"length":1,"stats":{"Line":0}},{"line":430,"address":[17233864,17234979],"length":1,"stats":{"Line":0}},{"line":431,"address":[14761160,14761093,14761924],"length":1,"stats":{"Line":0}},{"line":435,"address":[14760643],"length":1,"stats":{"Line":0}},{"line":436,"address":[17235223],"length":1,"stats":{"Line":0}},{"line":437,"address":[14878259],"length":1,"stats":{"Line":0}},{"line":444,"address":[14762330,14762154],"length":1,"stats":{"Line":0}},{"line":446,"address":[14355020,14358344,14354937],"length":1,"stats":{"Line":0}},{"line":449,"address":[14631692,14631626,14631548],"length":1,"stats":{"Line":0}},{"line":452,"address":[14780279],"length":1,"stats":{"Line":0}},{"line":453,"address":[14912920],"length":1,"stats":{"Line":0}},{"line":454,"address":[14789436,14790470],"length":1,"stats":{"Line":0}},{"line":455,"address":[14882551,14882612,14883319],"length":1,"stats":{"Line":0}},{"line":459,"address":[14876817],"length":1,"stats":{"Line":0}},{"line":460,"address":[14681026],"length":1,"stats":{"Line":0}},{"line":461,"address":[14776635],"length":1,"stats":{"Line":0}},{"line":464,"address":[14355086],"length":1,"stats":{"Line":0}},{"line":465,"address":[14776685],"length":1,"stats":{"Line":0}},{"line":466,"address":[14786933],"length":1,"stats":{"Line":0}},{"line":467,"address":[17235759,17236835],"length":1,"stats":{"Line":0}},{"line":468,"address":[14777199,14777924,14777132],"length":1,"stats":{"Line":0}},{"line":473,"address":[17233630,17238298],"length":1,"stats":{"Line":3}},{"line":475,"address":[14880124],"length":1,"stats":{"Line":0}},{"line":476,"address":[14683600],"length":1,"stats":{"Line":0}},{"line":477,"address":[14682708,14683742],"length":1,"stats":{"Line":0}},{"line":478,"address":[14788543,14787836,14787775],"length":1,"stats":{"Line":0}},{"line":482,"address":[14631570],"length":1,"stats":{"Line":8}},{"line":489,"address":[15992128,15992163],"length":1,"stats":{"Line":12}},{"line":490,"address":[14708584],"length":1,"stats":{"Line":3}},{"line":491,"address":[14825182],"length":1,"stats":{"Line":3}},{"line":496,"address":[14303614,14305724],"length":1,"stats":{"Line":8}},{"line":498,"address":[14722790,14711434,14722859,14722946,14711654,14711753],"length":1,"stats":{"Line":19}},{"line":499,"address":[14725727,14725810,14725609],"length":1,"stats":{"Line":12}},{"line":500,"address":[14510994],"length":1,"stats":{"Line":11}},{"line":501,"address":[14772130,14772112,14737058,14736984],"length":1,"stats":{"Line":4}},{"line":503,"address":[14724001],"length":1,"stats":{"Line":4}},{"line":504,"address":[14737137,14738372],"length":1,"stats":{"Line":4}},{"line":505,"address":[14318290,14317396,14317460],"length":1,"stats":{"Line":8}},{"line":508,"address":[14303663],"length":1,"stats":{"Line":3}},{"line":513,"address":[14306506,14318620,14303757,14318698,14319854,14318768],"length":1,"stats":{"Line":12}},{"line":514,"address":[14306294,14303772],"length":1,"stats":{"Line":6}},{"line":515,"address":[14527836],"length":1,"stats":{"Line":9}},{"line":516,"address":[14870932,14870741,14870830,14870986],"length":1,"stats":{"Line":12}},{"line":517,"address":[17198013],"length":1,"stats":{"Line":3}},{"line":521,"address":[14739266],"length":1,"stats":{"Line":3}},{"line":522,"address":[14725237],"length":1,"stats":{"Line":3}},{"line":524,"address":[14725687,14726072,14726141,14725348,14725786,14726228,14727618],"length":1,"stats":{"Line":15}},{"line":525,"address":[14739843,14739523],"length":1,"stats":{"Line":6}},{"line":526,"address":[18450963,18468336,18468120,18467975,18468048],"length":1,"stats":{"Line":11}},{"line":527,"address":[14726122,14759600,14759618,14726196],"length":1,"stats":{"Line":3}},{"line":529,"address":[14741427],"length":1,"stats":{"Line":2}},{"line":530,"address":[14873456,14872147],"length":1,"stats":{"Line":3}},{"line":531,"address":[18469814,18468826,18468890],"length":1,"stats":{"Line":4}},{"line":534,"address":[14627806],"length":1,"stats":{"Line":3}},{"line":539,"address":[18454474,18451676],"length":1,"stats":{"Line":6}},{"line":541,"address":[17200930,17201094,17201007,17185651,17185552,17185308],"length":1,"stats":{"Line":15}},{"line":543,"address":[17185564,17185465,17185339],"length":1,"stats":{"Line":9}},{"line":544,"address":[14321659,14303208,14321858,14306944,14307013],"length":1,"stats":{"Line":9}},{"line":545,"address":[14321888,14351196,14321946,14351168],"length":1,"stats":{"Line":3}},{"line":547,"address":[14742315,14742429],"length":1,"stats":{"Line":6}},{"line":549,"address":[14826733],"length":1,"stats":{"Line":0}},{"line":556,"address":[14314080,14305067],"length":1,"stats":{"Line":0}},{"line":558,"address":[14836046,14836282,14836381,14845142,14845065,14845645,14845229],"length":1,"stats":{"Line":0}},{"line":560,"address":[14720150,14719933,14720051],"length":1,"stats":{"Line":0}},{"line":561,"address":[14647417,14627229,14647210,14638723,14638650],"length":1,"stats":{"Line":0}},{"line":562,"address":[14903360,14874843,14874925,14903378],"length":1,"stats":{"Line":0}},{"line":564,"address":[14647656,14648263,14648350,14647818,14647917,14648186],"length":1,"stats":{"Line":0}},{"line":566,"address":[17202406,17202263,17202386],"length":1,"stats":{"Line":0}},{"line":567,"address":[17181826,17202515,17202587,17202442,17202794],"length":1,"stats":{"Line":0}},{"line":568,"address":[18472094,18500386,18472012,18500368],"length":1,"stats":{"Line":0}},{"line":570,"address":[18472227],"length":1,"stats":{"Line":0}},{"line":572,"address":[14323890,14323981],"length":1,"stats":{"Line":0}},{"line":573,"address":[14754369,14753567],"length":1,"stats":{"Line":0}},{"line":574,"address":[17204199],"length":1,"stats":{"Line":0}},{"line":578,"address":[14731183],"length":1,"stats":{"Line":0}},{"line":579,"address":[17204400],"length":1,"stats":{"Line":0}},{"line":580,"address":[18473724],"length":1,"stats":{"Line":0}},{"line":584,"address":[14754788,14755260],"length":1,"stats":{"Line":0}},{"line":585,"address":[18473864,18473814],"length":1,"stats":{"Line":0}},{"line":586,"address":[14650096,14650153],"length":1,"stats":{"Line":0}},{"line":587,"address":[14732051,14731853,14731985],"length":1,"stats":{"Line":0}},{"line":589,"address":[18474122],"length":1,"stats":{"Line":0}},{"line":594,"address":[14648906,14648792],"length":1,"stats":{"Line":0}},{"line":596,"address":[14725045],"length":1,"stats":{"Line":0}},{"line":602,"address":[18463235,18453179],"length":1,"stats":{"Line":0}},{"line":604,"address":[14732628,14721028,14732551,14732715,14734059,14721267,14721366],"length":1,"stats":{"Line":0}},{"line":606,"address":[18463299,18463449,18463519],"length":1,"stats":{"Line":0}},{"line":607,"address":[14735532,14746520,14746727,14735459,14722951],"length":1,"stats":{"Line":0}},{"line":608,"address":[14651147,14651065,14678242,14678224],"length":1,"stats":{"Line":0}},{"line":611,"address":[14326543,14326630],"length":1,"stats":{"Line":0}},{"line":612,"address":[14756332,14756988],"length":1,"stats":{"Line":0}},{"line":613,"address":[18476204],"length":1,"stats":{"Line":0}},{"line":614,"address":[17206962,17207012,17206866,17206892],"length":1,"stats":{"Line":0}},{"line":619,"address":[14747241,14748735],"length":1,"stats":{"Line":0}},{"line":620,"address":[14880395,14879414,14880308,14879513,14880207,14879106],"length":1,"stats":{"Line":0}},{"line":621,"address":[17206305,17206594,17206495],"length":1,"stats":{"Line":0}},{"line":622,"address":[18261992],"length":1,"stats":{"Line":0}},{"line":623,"address":[14880363,14903152,14880289,14903170],"length":1,"stats":{"Line":0}},{"line":627,"address":[14734772,14734673,14735103,14736663,14735259,14735172,14733303],"length":1,"stats":{"Line":0}},{"line":628,"address":[14328333,14327026,14328284],"length":1,"stats":{"Line":0}},{"line":629,"address":[13006254],"length":1,"stats":{"Line":0}},{"line":630,"address":[14351628,14328782,14351600,14328840],"length":1,"stats":{"Line":0}},{"line":632,"address":[18478561],"length":1,"stats":{"Line":0}},{"line":633,"address":[17209669,17208346],"length":1,"stats":{"Line":0}},{"line":634,"address":[18477864,18477928,18478859],"length":1,"stats":{"Line":0}},{"line":637,"address":[14725128],"length":1,"stats":{"Line":0}},{"line":641,"address":[14760080,14721617,14721475,14722215,14711050],"length":1,"stats":{"Line":0}},{"line":642,"address":[18502334],"length":1,"stats":{"Line":0}},{"line":645,"address":[17210349,17194869,17210161,17195105,17210262,17195204,17211760],"length":1,"stats":{"Line":0}},{"line":647,"address":[14838004,14838122,14838221],"length":1,"stats":{"Line":0}},{"line":648,"address":[14518908],"length":1,"stats":{"Line":0}},{"line":649,"address":[14774064,14751347,14751421,14774082],"length":1,"stats":{"Line":0}},{"line":651,"address":[18480702],"length":1,"stats":{"Line":0}},{"line":652,"address":[14738689,14737380],"length":1,"stats":{"Line":0}},{"line":653,"address":[14853835,14854823,14853899],"length":1,"stats":{"Line":0}},{"line":658,"address":[14734413],"length":1,"stats":{"Line":0}},{"line":663,"address":[14332530,14332453,14316554,14332597,14316641,14305585],"length":1,"stats":{"Line":0}},{"line":664,"address":[14838570,14827336,14838488],"length":1,"stats":{"Line":0}},{"line":665,"address":[14732171,14745742,14762064,14745815,14762280],"length":1,"stats":{"Line":0}},{"line":666,"address":[14350208,14350236,14332507,14332565],"length":1,"stats":{"Line":0}},{"line":668,"address":[18482464],"length":1,"stats":{"Line":0}},{"line":669,"address":[14739179,14740444],"length":1,"stats":{"Line":0}},{"line":670,"address":[14333871,14332901,14332968],"length":1,"stats":{"Line":0}},{"line":676,"address":[14709481],"length":1,"stats":{"Line":0}},{"line":680,"address":[14304001,14307090],"length":1,"stats":{"Line":0}},{"line":681,"address":[14307206],"length":1,"stats":{"Line":0}},{"line":682,"address":[14858725,14858837],"length":1,"stats":{"Line":0}},{"line":683,"address":[18455313],"length":1,"stats":{"Line":0}},{"line":684,"address":[18455342],"length":1,"stats":{"Line":0}},{"line":686,"address":[14713912],"length":1,"stats":{"Line":0}},{"line":687,"address":[14859099,14859035],"length":1,"stats":{"Line":0}},{"line":688,"address":[14632747,14631953,14631886],"length":1,"stats":{"Line":0}},{"line":692,"address":[14304263],"length":1,"stats":{"Line":0}},{"line":697,"address":[14740694,14733156],"length":1,"stats":{"Line":0}},{"line":699,"address":[14731828,14754831,14731927,14731592,14754995,14754908],"length":1,"stats":{"Line":0}},{"line":701,"address":[14311755,14311873,14311972],"length":1,"stats":{"Line":0}},{"line":702,"address":[18262096],"length":1,"stats":{"Line":0}},{"line":703,"address":[18499906,18483059,18499888,18482977],"length":1,"stats":{"Line":0}},{"line":705,"address":[14334827,14334405],"length":1,"stats":{"Line":0}},{"line":706,"address":[14334603,14334719,14334494],"length":1,"stats":{"Line":0}},{"line":707,"address":[18483481,18499698,18499680],"length":1,"stats":{"Line":0}},{"line":708,"address":[14659732,14677834,14677824],"length":1,"stats":{"Line":0}},{"line":709,"address":[17214335],"length":1,"stats":{"Line":0}},{"line":711,"address":[17214474,17214148],"length":1,"stats":{"Line":0}},{"line":714,"address":[18484447],"length":1,"stats":{"Line":0}},{"line":715,"address":[17215567,17214451,17214492],"length":1,"stats":{"Line":0}},{"line":716,"address":[14765022,14765802,14765086],"length":1,"stats":{"Line":0}},{"line":720,"address":[14628441],"length":1,"stats":{"Line":0}},{"line":725,"address":[14733295,14741188],"length":1,"stats":{"Line":0}},{"line":727,"address":[14889005,14864149,14888841,14888918,14863814,14864050],"length":1,"stats":{"Line":0}},{"line":729,"address":[14718190,14717973,14718091],"length":1,"stats":{"Line":0}},{"line":730,"address":[14511306],"length":1,"stats":{"Line":0}},{"line":731,"address":[17216141,17216059,17230866,17230848],"length":1,"stats":{"Line":0}},{"line":733,"address":[17216274],"length":1,"stats":{"Line":0}},{"line":734,"address":[14336563],"length":1,"stats":{"Line":0}},{"line":736,"address":[14766538,14766633],"length":1,"stats":{"Line":0}},{"line":737,"address":[14744954,14743475],"length":1,"stats":{"Line":0}},{"line":738,"address":[14890920],"length":1,"stats":{"Line":0}},{"line":739,"address":[14338390],"length":1,"stats":{"Line":0}},{"line":740,"address":[14745132],"length":1,"stats":{"Line":0}},{"line":741,"address":[17218310,17218196,17218323],"length":1,"stats":{"Line":0}},{"line":743,"address":[17218234],"length":1,"stats":{"Line":0}},{"line":744,"address":[14745209],"length":1,"stats":{"Line":0}},{"line":745,"address":[14891196,14891183,14891104],"length":1,"stats":{"Line":0}},{"line":752,"address":[14766796,14766857],"length":1,"stats":{"Line":0}},{"line":753,"address":[14767002,14766965],"length":1,"stats":{"Line":0}},{"line":754,"address":[14766976],"length":1,"stats":{"Line":0}},{"line":756,"address":[14859868],"length":1,"stats":{"Line":0}},{"line":759,"address":[14662991],"length":1,"stats":{"Line":0}},{"line":760,"address":[14757922,14757986],"length":1,"stats":{"Line":0}},{"line":761,"address":[14758248,14759005,14758181],"length":1,"stats":{"Line":0}},{"line":765,"address":[14733340],"length":1,"stats":{"Line":0}},{"line":770,"address":[14304606,14312658],"length":1,"stats":{"Line":0}},{"line":772,"address":[14718672,14745635,14718436,14745712,14745799,14718771],"length":1,"stats":{"Line":0}},{"line":774,"address":[14312928,14312711,14312829],"length":1,"stats":{"Line":0}},{"line":775,"address":[14723098,14759604,14759811,14732937,14732864],"length":1,"stats":{"Line":0}},{"line":776,"address":[14339012,14351840,14338954,14351868],"length":1,"stats":{"Line":0}},{"line":778,"address":[14760044],"length":1,"stats":{"Line":0}},{"line":779,"address":[14664376],"length":1,"stats":{"Line":0}},{"line":781,"address":[17219059,17218964],"length":1,"stats":{"Line":0}},{"line":782,"address":[17219181,17220707],"length":1,"stats":{"Line":0}},{"line":783,"address":[14340958],"length":1,"stats":{"Line":0}},{"line":784,"address":[14341027],"length":1,"stats":{"Line":0}},{"line":785,"address":[18490085],"length":1,"stats":{"Line":0}},{"line":786,"address":[14893741,14893868,14893855],"length":1,"stats":{"Line":0}},{"line":788,"address":[14762051],"length":1,"stats":{"Line":0}},{"line":789,"address":[18490162],"length":1,"stats":{"Line":0}},{"line":790,"address":[14864182,14864089,14864169],"length":1,"stats":{"Line":0}},{"line":797,"address":[14746182,14746243],"length":1,"stats":{"Line":0}},{"line":798,"address":[14760532,14760495],"length":1,"stats":{"Line":0}},{"line":799,"address":[14862506],"length":1,"stats":{"Line":0}},{"line":801,"address":[14664854],"length":1,"stats":{"Line":0}},{"line":804,"address":[14747240],"length":1,"stats":{"Line":0}},{"line":805,"address":[14760699,14760635],"length":1,"stats":{"Line":0}},{"line":806,"address":[14761718,14760894,14760961],"length":1,"stats":{"Line":0}},{"line":810,"address":[14733479],"length":1,"stats":{"Line":0}},{"line":815,"address":[18452533,18461136],"length":1,"stats":{"Line":0}},{"line":817,"address":[14771632,14742545,14742446,14771709,14742210,14771796],"length":1,"stats":{"Line":0}},{"line":819,"address":[14719079,14718961,14719178],"length":1,"stats":{"Line":0}},{"line":820,"address":[14528174],"length":1,"stats":{"Line":0}},{"line":821,"address":[14782480,14782498,14771764,14771682],"length":1,"stats":{"Line":0}},{"line":823,"address":[14341782],"length":1,"stats":{"Line":0}},{"line":825,"address":[18490883,18490975],"length":1,"stats":{"Line":0}},{"line":826,"address":[14342014,14343513],"length":1,"stats":{"Line":0}},{"line":827,"address":[18492714],"length":1,"stats":{"Line":0}},{"line":829,"address":[14343644,14344177],"length":1,"stats":{"Line":0}},{"line":830,"address":[14669115,14669337,14669040],"length":1,"stats":{"Line":0}},{"line":831,"address":[14764804,14764878],"length":1,"stats":{"Line":0}},{"line":834,"address":[14896490,14896750,14896801],"length":1,"stats":{"Line":0}},{"line":842,"address":[17221999,17221938],"length":1,"stats":{"Line":0}},{"line":843,"address":[14763211,14763353],"length":1,"stats":{"Line":0}},{"line":845,"address":[14749973],"length":1,"stats":{"Line":0}},{"line":846,"address":[18491467,18491528],"length":1,"stats":{"Line":0}},{"line":847,"address":[14667947,14668014,14668779],"length":1,"stats":{"Line":0}},{"line":851,"address":[14710338],"length":1,"stats":{"Line":0}},{"line":856,"address":[14724576,14733534],"length":1,"stats":{"Line":0}},{"line":858,"address":[14897287,14897451,14865532,14865296,14897364,14865631],"length":1,"stats":{"Line":0}},{"line":860,"address":[18461912,18461813,18461695],"length":1,"stats":{"Line":0}},{"line":861,"address":[14733925,14733852,14765591,14723140,14765384],"length":1,"stats":{"Line":0}},{"line":862,"address":[14756978,14751465,14756960,14751547],"length":1,"stats":{"Line":0}},{"line":864,"address":[18493920],"length":1,"stats":{"Line":0}},{"line":866,"address":[17224838,17224746],"length":1,"stats":{"Line":0}},{"line":867,"address":[18495691,18494160],"length":1,"stats":{"Line":0}},{"line":868,"address":[18495777],"length":1,"stats":{"Line":0}},{"line":870,"address":[14754131,14753586],"length":1,"stats":{"Line":0}},{"line":871,"address":[14777216,14776994,14776919],"length":1,"stats":{"Line":0}},{"line":872,"address":[18496037,18495963],"length":1,"stats":{"Line":0}},{"line":875,"address":[14767825,14768085,14768136],"length":1,"stats":{"Line":0}},{"line":883,"address":[14345022,14345083],"length":1,"stats":{"Line":0}},{"line":884,"address":[18494512,18494370],"length":1,"stats":{"Line":0}},{"line":886,"address":[14767180],"length":1,"stats":{"Line":0}},{"line":887,"address":[14898162,14898223],"length":1,"stats":{"Line":0}},{"line":888,"address":[14345599,14346411,14345666],"length":1,"stats":{"Line":0}},{"line":892,"address":[14305164],"length":1,"stats":{"Line":0}},{"line":897,"address":[18453006,18462602],"length":1,"stats":{"Line":0}},{"line":899,"address":[14347467,14347552,14347619,14314580,14314911,14314816],"length":1,"stats":{"Line":0}},{"line":901,"address":[14720427,14720545,14720644],"length":1,"stats":{"Line":0}},{"line":902,"address":[18462920,18496543,18462993,18496750,18451257],"length":1,"stats":{"Line":0}},{"line":903,"address":[14347529,14347587,14350832,14350860],"length":1,"stats":{"Line":0}},{"line":905,"address":[14347724],"length":1,"stats":{"Line":0}},{"line":907,"address":[17229723,17227951,17227854],"length":1,"stats":{"Line":0}},{"line":908,"address":[18497270,18498392],"length":1,"stats":{"Line":0}},{"line":910,"address":[14350496,14349535,14349174,14349242,14350512],"length":1,"stats":{"Line":0}},{"line":911,"address":[14902512,14902356,14902507],"length":1,"stats":{"Line":0}},{"line":913,"address":[14770651,14770817],"length":1,"stats":{"Line":0}},{"line":917,"address":[14769211,14770217],"length":1,"stats":{"Line":0}},{"line":918,"address":[14769561],"length":1,"stats":{"Line":0}},{"line":920,"address":[14901400,14904480,14904501],"length":1,"stats":{"Line":0}},{"line":923,"address":[14348551],"length":1,"stats":{"Line":0}},{"line":924,"address":[14674046],"length":1,"stats":{"Line":0}},{"line":929,"address":[14825753],"length":1,"stats":{"Line":0}},{"line":933,"address":[14732919,14737664],"length":1,"stats":{"Line":0}},{"line":934,"address":[18456740],"length":1,"stats":{"Line":0}},{"line":935,"address":[14860395,14860507],"length":1,"stats":{"Line":0}},{"line":936,"address":[17187783],"length":1,"stats":{"Line":0}},{"line":937,"address":[14309108],"length":1,"stats":{"Line":0}},{"line":939,"address":[18457822],"length":1,"stats":{"Line":0}},{"line":940,"address":[14714897,14714833],"length":1,"stats":{"Line":0}},{"line":941,"address":[14309420,14309487,14310111],"length":1,"stats":{"Line":0}},{"line":945,"address":[14304137],"length":1,"stats":{"Line":0}},{"line":949,"address":[14715896,14709737],"length":1,"stats":{"Line":0}},{"line":950,"address":[14716012],"length":1,"stats":{"Line":0}},{"line":951,"address":[14310459,14310347],"length":1,"stats":{"Line":0}},{"line":952,"address":[17189295],"length":1,"stats":{"Line":0}},{"line":953,"address":[14634748],"length":1,"stats":{"Line":0}},{"line":955,"address":[14833238],"length":1,"stats":{"Line":0}},{"line":956,"address":[14862281,14862217],"length":1,"stats":{"Line":0}},{"line":957,"address":[14635135,14635771,14635068],"length":1,"stats":{"Line":0}},{"line":963,"address":[14836926],"length":1,"stats":{"Line":0}},{"line":964,"address":[14710803],"length":1,"stats":{"Line":0}},{"line":971,"address":[15993712,15994200,15994194],"length":1,"stats":{"Line":4}},{"line":978,"address":[13287556],"length":1,"stats":{"Line":4}},{"line":991,"address":[15752022],"length":1,"stats":{"Line":8}},{"line":995,"address":[18316352],"length":1,"stats":{"Line":3}},{"line":1001,"address":[14298718,14298544,14299047,14299329,14299114,14298528,14298933,14299262,14300984],"length":1,"stats":{"Line":18}},{"line":1003,"address":[14703912,14703924],"length":1,"stats":{"Line":6}},{"line":1004,"address":[14298734,14298598,14298671,14298787,14298997],"length":1,"stats":{"Line":9}},{"line":1005,"address":[18446644,18448738,18446726,18448720],"length":1,"stats":{"Line":3}},{"line":1006,"address":[14852512,14850499],"length":1,"stats":{"Line":3}},{"line":1007,"address":[14706664],"length":1,"stats":{"Line":0}},{"line":1010,"address":[14821054],"length":1,"stats":{"Line":3}},{"line":1012,"address":[14821125],"length":1,"stats":{"Line":3}},{"line":1013,"address":[14728427,14728320],"length":1,"stats":{"Line":6}},{"line":1014,"address":[14300310,14299933],"length":1,"stats":{"Line":6}},{"line":1015,"address":[14729047,14728955,14728817,14728791],"length":1,"stats":{"Line":3}},{"line":1019,"address":[14850933,14851687],"length":1,"stats":{"Line":0}},{"line":1020,"address":[14822563,14822224],"length":1,"stats":{"Line":0}},{"line":1021,"address":[14300701,14300952,14300727,14300866],"length":1,"stats":{"Line":0}},{"line":1026,"address":[14623852],"length":1,"stats":{"Line":3}},{"line":1029,"address":[13285680],"length":1,"stats":{"Line":3}},{"line":1030,"address":[14626112,14626361,14626471,14626449],"length":1,"stats":{"Line":3}},{"line":1031,"address":[14823818],"length":1,"stats":{"Line":0}},{"line":1032,"address":[14853572],"length":1,"stats":{"Line":0}},{"line":1033,"address":[17180772],"length":1,"stats":{"Line":0}},{"line":1034,"address":[14626213],"length":1,"stats":{"Line":0}},{"line":1035,"address":[18450006],"length":1,"stats":{"Line":0}},{"line":1036,"address":[14721944],"length":1,"stats":{"Line":0}},{"line":1037,"address":[14302263],"length":1,"stats":{"Line":0}},{"line":1038,"address":[14721961],"length":1,"stats":{"Line":0}},{"line":1040,"address":[14731117],"length":1,"stats":{"Line":0}},{"line":1044,"address":[13290208,13291018],"length":1,"stats":{"Line":3}},{"line":1049,"address":[15965688,15965770],"length":1,"stats":{"Line":6}},{"line":1050,"address":[15863948,15864010],"length":1,"stats":{"Line":0}},{"line":1051,"address":[15997081,15997046],"length":1,"stats":{"Line":0}},{"line":1053,"address":[13290649,13290713],"length":1,"stats":{"Line":0}},{"line":1056,"address":[13290496,13290525],"length":1,"stats":{"Line":6}},{"line":1059,"address":[15965976],"length":1,"stats":{"Line":3}},{"line":1061,"address":[18517360],"length":1,"stats":{"Line":6}},{"line":1062,"address":[14921021],"length":1,"stats":{"Line":3}},{"line":1063,"address":[14891308],"length":1,"stats":{"Line":3}},{"line":1064,"address":[14891397,14891322,14891360],"length":1,"stats":{"Line":9}},{"line":1065,"address":[14798474],"length":1,"stats":{"Line":3}},{"line":1069,"address":[15997317],"length":1,"stats":{"Line":3}},{"line":1070,"address":[15851406],"length":1,"stats":{"Line":3}},{"line":1075,"address":[15869936],"length":1,"stats":{"Line":0}},{"line":1079,"address":[18515195,18514836,18514989],"length":1,"stats":{"Line":0}},{"line":1080,"address":[14888752],"length":1,"stats":{"Line":0}},{"line":1081,"address":[14772649,14772762,14772713,14772978,14772813],"length":1,"stats":{"Line":0}},{"line":1082,"address":[14691568,14691457,14691586],"length":1,"stats":{"Line":0}},{"line":1085,"address":[13287280],"length":1,"stats":{"Line":0}},{"line":1089,"address":[17246429,17246807,17246590],"length":1,"stats":{"Line":0}},{"line":1090,"address":[14796689],"length":1,"stats":{"Line":0}},{"line":1091,"address":[18268110],"length":1,"stats":{"Line":0}},{"line":1092,"address":[18516048,18516178,18516160],"length":1,"stats":{"Line":0}},{"line":1095,"address":[13287328],"length":1,"stats":{"Line":1}},{"line":1099,"address":[14692863,14693080,14692705],"length":1,"stats":{"Line":3}},{"line":1100,"address":[14890402],"length":1,"stats":{"Line":1}},{"line":1101,"address":[14443886],"length":1,"stats":{"Line":4}},{"line":1102,"address":[14797937,14798048,14798066],"length":1,"stats":{"Line":1}},{"line":1105,"address":[15846064],"length":1,"stats":{"Line":1}},{"line":1110,"address":[18449184,18449337,18449562],"length":1,"stats":{"Line":3}},{"line":1111,"address":[14706956],"length":1,"stats":{"Line":1}},{"line":1112,"address":[12343412],"length":1,"stats":{"Line":4}},{"line":1113,"address":[14301886,14302012,14301984],"length":1,"stats":{"Line":1}},{"line":1116,"address":[15869696],"length":1,"stats":{"Line":1}},{"line":1121,"address":[18510537,18510184,18510340],"length":1,"stats":{"Line":3}},{"line":1122,"address":[14767959],"length":1,"stats":{"Line":1}},{"line":1123,"address":[14442916],"length":1,"stats":{"Line":3}},{"line":1124,"address":[17241391,17241472,17241490],"length":1,"stats":{"Line":1}},{"line":1127,"address":[13286048],"length":1,"stats":{"Line":1}},{"line":1133,"address":[14361117,14361306,14361511],"length":1,"stats":{"Line":3}},{"line":1134,"address":[14361169],"length":1,"stats":{"Line":1}},{"line":1135,"address":[18511436,18511098,18511162,18511262,18511211],"length":1,"stats":{"Line":3}},{"line":1136,"address":[17242386,17242368,17242256],"length":1,"stats":{"Line":1}},{"line":1142,"address":[13286176,13286184],"length":1,"stats":{"Line":0}},{"line":1143,"address":[14915925],"length":1,"stats":{"Line":0}},{"line":1145,"address":[14886003,14886094,14888338,14888320],"length":1,"stats":{"Line":0}},{"line":1151,"address":[14793370],"length":1,"stats":{"Line":0}},{"line":1152,"address":[18512749,18512415,18513122,18513209,18513627,18513013,18512682],"length":1,"stats":{"Line":0}},{"line":1154,"address":[17243237,17243486],"length":1,"stats":{"Line":0}},{"line":1155,"address":[17243571,17243656,17243510,17243877,17242754],"length":1,"stats":{"Line":0}},{"line":1156,"address":[17245378,17243895,17245360,17243977],"length":1,"stats":{"Line":0}},{"line":1157,"address":[14689598,14689669],"length":1,"stats":{"Line":0}},{"line":1158,"address":[17244273],"length":1,"stats":{"Line":0}},{"line":1165,"address":[14916097,14917136,14915607,14917269,14917927],"length":1,"stats":{"Line":0}},{"line":1166,"address":[14917757],"length":1,"stats":{"Line":0}},{"line":1171,"address":[15754568,15754518,15752224],"length":1,"stats":{"Line":4}},{"line":1172,"address":[13288066,13287930],"length":1,"stats":{"Line":8}},{"line":1173,"address":[19576216,19576303],"length":1,"stats":{"Line":0}},{"line":1174,"address":[15872122,15872039],"length":1,"stats":{"Line":0}},{"line":1175,"address":[15752769],"length":1,"stats":{"Line":0}},{"line":1179,"address":[18320737],"length":1,"stats":{"Line":0}},{"line":1180,"address":[15861871],"length":1,"stats":{"Line":0}},{"line":1181,"address":[15872341],"length":1,"stats":{"Line":0}},{"line":1184,"address":[15872389],"length":1,"stats":{"Line":0}},{"line":1185,"address":[13288750],"length":1,"stats":{"Line":0}},{"line":1188,"address":[15849259],"length":1,"stats":{"Line":0}},{"line":1189,"address":[15862273],"length":1,"stats":{"Line":0}},{"line":1192,"address":[15964321],"length":1,"stats":{"Line":0}},{"line":1193,"address":[18321319],"length":1,"stats":{"Line":0}},{"line":1197,"address":[15862455],"length":1,"stats":{"Line":0}},{"line":1198,"address":[15872866],"length":1,"stats":{"Line":0}},{"line":1202,"address":[13289146],"length":1,"stats":{"Line":0}},{"line":1208,"address":[15964820,15964715],"length":1,"stats":{"Line":0}},{"line":1211,"address":[15873092],"length":1,"stats":{"Line":0}},{"line":1212,"address":[15873143],"length":1,"stats":{"Line":0}},{"line":1213,"address":[13289515],"length":1,"stats":{"Line":0}},{"line":1215,"address":[15862828],"length":1,"stats":{"Line":0}},{"line":1216,"address":[15964879],"length":1,"stats":{"Line":0}},{"line":1219,"address":[18321905,18321828,18322214],"length":1,"stats":{"Line":0}},{"line":1220,"address":[15862981,15863251,15863037,15863087],"length":1,"stats":{"Line":0}},{"line":1221,"address":[13289732,13289646,13289699],"length":1,"stats":{"Line":0}},{"line":1227,"address":[15960784],"length":1,"stats":{"Line":0}},{"line":1228,"address":[15869191],"length":1,"stats":{"Line":0}},{"line":1229,"address":[18317724],"length":1,"stats":{"Line":0}},{"line":1232,"address":[15869255,15869212],"length":1,"stats":{"Line":0}},{"line":1233,"address":[19573616,19573692,19573651],"length":1,"stats":{"Line":0}},{"line":1236,"address":[15992560],"length":1,"stats":{"Line":3}},{"line":1237,"address":[19574424],"length":1,"stats":{"Line":3}},{"line":1238,"address":[19574481],"length":1,"stats":{"Line":3}},{"line":1242,"address":[19574556,19574505],"length":1,"stats":{"Line":6}},{"line":1243,"address":[15750881],"length":1,"stats":{"Line":3}},{"line":1244,"address":[19574725],"length":1,"stats":{"Line":3}},{"line":1249,"address":[15751035],"length":1,"stats":{"Line":3}},{"line":1251,"address":[15751044],"length":1,"stats":{"Line":3}},{"line":1255,"address":[13286756],"length":1,"stats":{"Line":3}},{"line":1258,"address":[15847303],"length":1,"stats":{"Line":3}},{"line":1260,"address":[15870592],"length":1,"stats":{"Line":3}},{"line":1263,"address":[18319138,18319342],"length":1,"stats":{"Line":3}},{"line":1264,"address":[15962283],"length":1,"stats":{"Line":3}},{"line":1267,"address":[19575133],"length":1,"stats":{"Line":3}},{"line":1269,"address":[19575142],"length":1,"stats":{"Line":3}},{"line":1272,"address":[13287256,13287071,13287114],"length":1,"stats":{"Line":6}},{"line":1273,"address":[15847598],"length":1,"stats":{"Line":3}},{"line":1279,"address":[15748512,15749596,15749703],"length":1,"stats":{"Line":3}},{"line":1288,"address":[19572439],"length":1,"stats":{"Line":3}},{"line":1289,"address":[18316607],"length":1,"stats":{"Line":3}},{"line":1293,"address":[19572511,19572466],"length":1,"stats":{"Line":3}},{"line":1294,"address":[15844922,15844855,15844881],"length":1,"stats":{"Line":6}},{"line":1295,"address":[19572593,19572948,19572560],"length":1,"stats":{"Line":6}},{"line":1297,"address":[15990851],"length":1,"stats":{"Line":3}},{"line":1298,"address":[15845357,15845279,15845681,15845466],"length":1,"stats":{"Line":12}},{"line":1299,"address":[13285094,13285167],"length":1,"stats":{"Line":6}}],"covered":189,"coverable":569},{"path":["/","home","azureuser","Documents","Chronos","src","lib.rs"],"content":"// Phase 1: Single-node engine modules\npub mod config;\npub mod embedded;\npub mod executor;\npub mod parser;\npub mod raft;\npub mod repl;\npub mod storage;\n\n// Phase 2: Distributed engine modules\npub mod common;\npub mod network;\n\n// Public exports\npub use embedded::ChronosEmbedded;\npub use executor::{Executor, QueryResult};\npub use parser::Parser;\npub use storage::{StorageConfig, StorageEngine};\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","src","main.rs"],"content":"use std::fs::{File, OpenOptions};\nuse std::io::{self, Write};\nuse std::path::Path;\nuse std::sync::Arc;\nuse std::time::{Duration, SystemTime, UNIX_EPOCH};\n\nuse clap::{Parser, Subcommand};\nuse tokio::sync::{mpsc, Mutex};\nuse tokio::time::sleep;\nuse tonic::transport::{Certificate as TlsCertificate, Identity as TlsIdentity, ServerTlsConfig};\n\nuse chronos::network::{SharedSyncStatus, SyncStatusServer, SyncStatusState, SyncWorker};\nuse chronos::storage::snapshot::{create_snapshot, restore_snapshot};\nuse chronos::Executor;\nuse log::{error, info};\nuse tracing_log::LogTracer;\nuse tracing_subscriber::{fmt, prelude::*, EnvFilter};\n\nuse chronos::repl::Repl;\n\nuse chronos::raft::{Raft, RaftConfig};\n\nstruct RotatingFile {\n    path: String,\n    max_size: u64,\n    max_files: u32,\n    file: File,\n    current_size: u64,\n}\n\n#[derive(Subcommand)]\nenum AdminCmd {\n    /// Show node health from the HTTP admin endpoint (host:port of admin HTTP)\n    Status {\n        /// Admin HTTP address, e.g. 127.0.0.1:9000\n        #[arg(short, long)]\n        http: String,\n    },\n    /// Dump Prometheus metrics from the HTTP admin endpoint\n    Metrics {\n        /// Admin HTTP address, e.g. 127.0.0.1:9000\n        #[arg(short, long)]\n        http: String,\n    },\n}\n\nfn http_get(host_port: \u0026str, path: \u0026str) -\u003e Result\u003cString, Box\u003cdyn std::error::Error\u003e\u003e {\n    use std::io::{Read, Write};\n    use std::net::TcpStream;\n    let mut stream = TcpStream::connect(host_port)?;\n    let req = format!(\n        \"GET {} HTTP/1.1\\r\\nHost: {}\\r\\nConnection: close\\r\\n\\r\\n\",\n        path, host_port\n    );\n    stream.write_all(req.as_bytes())?;\n    let mut buf = Vec::new();\n    stream.read_to_end(\u0026mut buf)?;\n    let resp = String::from_utf8_lossy(\u0026buf);\n    if let Some(pos) = resp.find(\"\\r\\n\\r\\n\") {\n        Ok(resp[pos + 4..].to_string())\n    } else {\n        Ok(resp.to_string())\n    }\n}\n\nfn init_logging() {\n    let _ = LogTracer::init();\n\n    let env_filter = EnvFilter::try_from_default_env()\n        .or_else(|_| EnvFilter::try_new(\"info\"))\n        .unwrap();\n\n    let fmt_layer = fmt::layer()\n        .with_target(true)\n        .with_timer(fmt::time::UtcTime::rfc_3339());\n\n    if std::env::var(\"CHRONOS_LOG_FILE\").is_ok() {\n        // When CHRONOS_LOG_FILE is set, we keep using env_logger + RotatingFile\n        // to write plain logs to disk, while tracing collects structured logs\n        // to stderr by default.\n        let mut builder =\n            env_logger::Builder::from_env(env_logger::Env::default().default_filter_or(\"info\"));\n\n        if let Ok(path) = std::env::var(\"CHRONOS_LOG_FILE\") {\n            let max_size_mb = std::env::var(\"CHRONOS_LOG_MAX_SIZE_MB\")\n                .ok()\n                .and_then(|s| s.parse::\u003cu64\u003e().ok())\n                .unwrap_or(10);\n            let max_files = std::env::var(\"CHRONOS_LOG_MAX_FILES\")\n                .ok()\n                .and_then(|s| s.parse::\u003cu32\u003e().ok())\n                .unwrap_or(3);\n\n            if let Ok(rot) = RotatingFile::new(path.clone(), max_size_mb * 1024 * 1024, max_files) {\n                builder.target(env_logger::Target::Pipe(Box::new(rot)));\n            }\n        }\n\n        builder.init();\n    }\n\n    let _ = tracing_subscriber::registry()\n        .with(env_filter)\n        .with(fmt_layer)\n        .try_init();\n}\n\nimpl RotatingFile {\n    fn new(path: String, max_size: u64, max_files: u32) -\u003e io::Result\u003cSelf\u003e {\n        let file = OpenOptions::new().create(true).append(true).open(\u0026path)?;\n        let current_size = file.metadata().map(|m| m.len()).unwrap_or(0);\n        Ok(Self {\n            path,\n            max_size,\n            max_files,\n            file,\n            current_size,\n        })\n    }\n\n    fn rotate(\u0026mut self) -\u003e io::Result\u003c()\u003e {\n        // Close current file by dropping and reopening later\n        // Rotate existing files: path.N-1 -\u003e path.N, ..., path.1 -\u003e path.2, path -\u003e path.1\n        for i in (1..self.max_files).rev() {\n            let src = format!(\"{}.{}\", self.path, i);\n            let dst = format!(\"{}.{}\", self.path, i + 1);\n            let _ = std::fs::rename(\u0026src, \u0026dst);\n        }\n\n        let _ = std::fs::rename(\u0026self.path, format!(\"{}.1\", self.path));\n\n        self.file = OpenOptions::new()\n            .create(true)\n            .write(true)\n            .truncate(true)\n            .open(\u0026self.path)?;\n        self.current_size = 0;\n        Ok(())\n    }\n}\n\nimpl Write for RotatingFile {\n    fn write(\u0026mut self, buf: \u0026[u8]) -\u003e io::Result\u003cusize\u003e {\n        if self.current_size + buf.len() as u64 \u003e self.max_size {\n            self.rotate()?;\n        }\n        let n = self.file.write(buf)?;\n        self.current_size += n as u64;\n        Ok(n)\n    }\n\n    fn flush(\u0026mut self) -\u003e io::Result\u003c()\u003e {\n        self.file.flush()\n    }\n}\n\n#[derive(Parser)]\n#[command(name = \"chronos\")]\n#[command(about = \"A distributed SQL database built from scratch in Rust\")]\nstruct Cli {\n    #[command(subcommand)]\n    command: Command,\n}\n\n#[derive(Subcommand)]\nenum Command {\n    /// Start a single-node database instance\n    SingleNode {\n        /// Directory to store data\n        #[arg(short, long, default_value = \"data\")]\n        data_dir: String,\n    },\n\n    /// Start a node in a distributed cluster\n    Node {\n        /// Unique ID for this node\n        #[arg(short, long)]\n        id: String,\n\n        /// Directory to store data\n        #[arg(short, long, default_value = \"data\")]\n        data_dir: String,\n\n        /// Address to listen on\n        #[arg(short, long, default_value = \"127.0.0.1:8000\")]\n        address: String,\n\n        /// Comma-separated list of peer addresses (id=address)\n        #[arg(short, long)]\n        peers: Option\u003cString\u003e,\n\n        /// Clean the data directory before starting\n        #[arg(long)]\n        clean: bool,\n\n        /// Optional sync target URL (e.g. http://host:port) for edge nodes\n        #[arg(long)]\n        sync_target: Option\u003cString\u003e,\n\n        /// Interval in seconds between sync attempts\n        #[arg(long, default_value_t = 5)]\n        sync_interval_secs: u64,\n\n        /// Maximum number of operations per sync batch\n        #[arg(long, default_value_t = 100)]\n        sync_batch_size: usize,\n\n        /// Interval in seconds between TTL cleanup passes\n        #[arg(long, default_value_t = 3600)]\n        ttl_cleanup_interval_secs: u64,\n\n        /// Enable HTTP ingest endpoint and background queue worker (gateway mode)\n        #[arg(long, default_value_t = false)]\n        enable_ingest: bool,\n    },\n\n    /// Start the Chronos client REPL\n    Client {\n        /// Address of the leader node for distributed mode. If not provided, runs in local mode.\n        #[arg(short, long)]\n        leader: Option\u003cString\u003e,\n\n        /// Directory to store data in local mode\n        #[arg(short, long, default_value = \"data\")]\n        data_dir: String,\n    },\n\n    /// Snapshot management (backup/restore)\n    Snapshot {\n        #[command(subcommand)]\n        cmd: SnapshotCmd,\n    },\n\n    /// Admin tooling\n    Admin {\n        #[command(subcommand)]\n        cmd: AdminCmd,\n    },\n}\n\n#[derive(Subcommand)]\nenum SnapshotCmd {\n    /// Create a snapshot of the node data directory\n    Create {\n        /// Directory to snapshot (e.g., data/node-1)\n        #[arg(short, long, default_value = \"data\")]\n        data_dir: String,\n        /// Output snapshot file path\n        #[arg(short, long)]\n        output: String,\n    },\n    /// Restore a node data directory from a snapshot\n    Restore {\n        /// Directory to restore into (will be created). Refuses if not empty unless --force\n        #[arg(short, long, default_value = \"data\")]\n        data_dir: String,\n        /// Input snapshot file path\n        #[arg(short, long)]\n        input: String,\n        /// Overwrite non-empty directory\n        #[arg(long, default_value_t = false)]\n        force: bool,\n    },\n}\n\nfn load_server_tls_from_env() -\u003e Result\u003cOption\u003cServerTlsConfig\u003e, Box\u003cdyn std::error::Error\u003e\u003e {\n    let cert_path = match std::env::var(\"CHRONOS_TLS_CERT\") {\n        Ok(v) =\u003e v,\n        Err(_) =\u003e return Ok(None),\n    };\n    let key_path = std::env::var(\"CHRONOS_TLS_KEY\")?;\n    let ca_path = std::env::var(\"CHRONOS_TLS_CA_CERT\").ok();\n\n    let cert = std::fs::read(cert_path)?;\n    let key = std::fs::read(key_path)?;\n    let identity = TlsIdentity::from_pem(cert, key);\n\n    let mut config = ServerTlsConfig::new().identity(identity);\n\n    if let Some(ca_path) = ca_path {\n        let ca_bytes = std::fs::read(ca_path)?;\n        let ca = TlsCertificate::from_pem(ca_bytes);\n        config = config.client_ca_root(ca);\n    }\n\n    Ok(Some(config))\n}\n\n#[tokio::main]\nasync fn main() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    init_logging();\n\n    // Parse command line arguments\n    let cli = Cli::parse();\n\n    match cli.command {\n        Command::SingleNode { data_dir } =\u003e {\n            info!(\"Starting Chronos in single-node mode\");\n\n            // Create data directory if it doesn't exist\n            let data_path = Path::new(\u0026data_dir);\n            if !data_path.exists() {\n                std::fs::create_dir_all(data_path)?;\n            }\n\n            // Start REPL\n            let mut repl = Repl::new(\u0026data_dir).await;\n            repl.run().await;\n        }\n        Command::Client { leader, data_dir } =\u003e {\n            match leader {\n                Some(leader_address) =\u003e {\n                    info!(\"Starting Chronos client connecting to leader at {leader_address}\");\n                    let mut repl = Repl::with_distributed_mode(\u0026leader_address);\n                    repl.run().await;\n                }\n                None =\u003e {\n                    info!(\"Starting Chronos client in local mode\");\n\n                    // Create data directory if it doesn't exist\n                    let data_path = Path::new(\u0026data_dir);\n                    if !data_path.exists() {\n                        std::fs::create_dir_all(data_path)?;\n                    }\n\n                    let mut repl = Repl::new(\u0026data_dir).await;\n                    repl.run().await;\n                }\n            }\n        }\n        Command::Snapshot { cmd } =\u003e match cmd {\n            SnapshotCmd::Create { data_dir, output } =\u003e {\n                info!(\"Creating snapshot from '{data_dir}' to '{output}'...\");\n                create_snapshot(\u0026data_dir, \u0026output)?;\n                info!(\"Snapshot created: {output}\");\n            }\n            SnapshotCmd::Restore {\n                data_dir,\n                input,\n                force,\n            } =\u003e {\n                info!(\"Restoring snapshot '{input}' into '{data_dir}' (force={force})...\");\n                restore_snapshot(\u0026data_dir, \u0026input, force)?;\n                info!(\"Snapshot restored into {data_dir}\");\n            }\n        },\n        Command::Admin { cmd } =\u003e match cmd {\n            AdminCmd::Status { http } =\u003e {\n                let body = http_get(\u0026http, \"/health\")?;\n                println!(\"{}\", body);\n            }\n            AdminCmd::Metrics { http } =\u003e {\n                let body = http_get(\u0026http, \"/metrics\")?;\n                println!(\"{}\", body);\n            }\n        },\n        Command::Node {\n            id,\n            data_dir,\n            address,\n            peers,\n            clean,\n            sync_target,\n            sync_interval_secs,\n            sync_batch_size,\n            ttl_cleanup_interval_secs,\n            enable_ingest,\n        } =\u003e {\n            info!(\"Starting Chronos node {id} at {address}\");\n\n            let node_data_dir = format!(\"{data_dir}/{id}\");\n\n            if clean {\n                info!(\n                    \"--clean flag detected, removing data directory: {}\",\n                    \u0026node_data_dir\n                );\n                let node_data_path = Path::new(\u0026node_data_dir);\n                if node_data_path.exists() {\n                    std::fs::remove_dir_all(node_data_path)?;\n                }\n            }\n\n            // Create cluster data directory if it doesn't exist\n            let data_path = Path::new(\u0026data_dir);\n            if !data_path.exists() {\n                std::fs::create_dir_all(data_path)?;\n            }\n\n            // Create data directory for this node\n            std::fs::create_dir_all(\u0026node_data_dir)?;\n\n            // Configure Raft for this node (including peers)\n            let mut config = RaftConfig::new(\u0026id, \u0026node_data_dir);\n\n            // Add peers\n            if let Some(peers_str) = peers {\n                for peer in peers_str.split(',') {\n                    let parts: Vec\u003c\u0026str\u003e = peer.split('=').collect();\n                    if parts.len() == 2 {\n                        let peer_id = parts[0];\n                        let peer_addr = parts[1];\n\n                        if peer_id != id {\n                            config.add_peer(peer_id, peer_addr);\n                            info!(\"Added peer: {peer_id} at {peer_addr}\");\n                        }\n                    }\n                }\n            }\n\n            // Create executor\n            let executor = Arc::new(Mutex::new(Executor::new(\u0026node_data_dir).await));\n\n            // Shared sync status (used by SyncWorker and gRPC)\n            let sync_status: SharedSyncStatus = Arc::new(Mutex::new(SyncStatusState::default()));\n\n            // Start Raft with the configured peers and per-node data dir\n            let raft = Raft::new(config);\n\n            {\n                let weak_node = Arc::downgrade(\u0026raft.node);\n                let mut exec = executor.lock().await;\n                exec.set_raft_node(weak_node);\n            }\n            let (apply_tx, mut apply_rx) = mpsc::unbounded_channel::\u003cVec\u003cu8\u003e\u003e();\n            {\n                let mut node_lock = raft.node.lock().await;\n                node_lock.set_apply_sender(apply_tx);\n            }\n\n            {\n                let executor_for_apply = Arc::clone(\u0026executor);\n                tokio::spawn(async move {\n                    while let Some(cmd) = apply_rx.recv().await {\n                        let mut exec = executor_for_apply.lock().await;\n                        if let Err(e) = exec.apply_command(\u0026cmd).await {\n                            error!(\"Raft apply worker error: {}\", e);\n                        }\n                    }\n                });\n            }\n\n            let _node = Arc::clone(\u0026raft.node);\n            raft.start().await?;\n\n            // Connectivity monitor for this node's SQL endpoint\n            let monitor = chronos::network::ConnectivityMonitor::new(\n                \u0026address,\n                std::time::Duration::from_secs(3),\n            );\n            let connectivity_state = monitor.state();\n            tokio::spawn(monitor.run());\n\n            // Start gRPC server\n            let addr = address.parse()?;\n            let raft_server = chronos::network::RaftServer::new(Arc::clone(\u0026raft.node));\n            let sql_server =\n                chronos::network::SqlServer::new(Arc::clone(\u0026raft.node), Arc::clone(\u0026executor));\n            let health_server =\n                chronos::network::HealthServer::new(Arc::clone(\u0026connectivity_state));\n            let sync_server = chronos::network::SyncServer::new(Arc::clone(\u0026executor));\n            let sync_status_server = SyncStatusServer::new(Arc::clone(\u0026sync_status));\n\n            // If this node is configured as an edge node with a sync target,\n            // start a background SyncWorker that drains the persistent\n            // offline queue via the Executor and pushes operations to the\n            // target.\n            if let Some(target) = sync_target {\n                let worker = SyncWorker::new(\n                    Arc::clone(\u0026executor),\n                    target,\n                    std::time::Duration::from_secs(sync_interval_secs),\n                    sync_batch_size,\n                    Arc::clone(\u0026sync_status),\n                    id.clone(),\n                );\n                tokio::spawn(worker.run());\n            }\n\n            // Start a background TTL cleanup task that periodically removes\n            // expired rows based on table TTL metadata. This runs on every\n            // node independently and is best-effort: errors are logged but\n            // do not terminate the node.\n            {\n                let executor_clone = Arc::clone(\u0026executor);\n                tokio::spawn(async move {\n                    let limit: usize = 1000;\n\n                    loop {\n                        let now_secs = SystemTime::now()\n                            .duration_since(UNIX_EPOCH)\n                            .unwrap()\n                            .as_secs();\n\n                        {\n                            // Restrict the lifetime of the executor lock to just the\n                            // cleanup_expired call so other tasks (like SQL handling)\n                            // are not blocked for the entire sleep interval.\n                            let mut exec = executor_clone.lock().await;\n                            match exec.cleanup_expired(now_secs, limit).await {\n                                Ok(cleaned) =\u003e {\n                                    if cleaned \u003e 0 {\n                                        log::info!(\n                                            \"TTL cleanup removed {} expired rows (now_secs={})\",\n                                            cleaned,\n                                            now_secs\n                                        );\n                                    }\n                                }\n                                Err(e) =\u003e {\n                                    log::error!(\"TTL cleanup error: {}\", e);\n                                }\n                            }\n                        }\n                        sleep(Duration::from_secs(ttl_cleanup_interval_secs)).await;\n                    }\n                });\n            }\n\n            // Optional ingest queue + worker for gateway mode. When enabled,\n            // the HTTP admin server can accept POST /ingest requests and\n            // enqueue them for background insertion into the readings table.\n            let ingest_tx_opt = if enable_ingest {\n                let (tx, rx) = mpsc::unbounded_channel::\u003cchronos::network::IngestRequest\u003e();\n                let executor_for_ingest = Arc::clone(\u0026executor);\n                tokio::spawn(async move {\n                    chronos::network::run_ingest_worker(rx, executor_for_ingest).await;\n                });\n                Some(tx)\n            } else {\n                None\n            };\n\n            let http_addr = {\n                let mut s: std::net::SocketAddr = addr;\n                let port = s.port().saturating_add(1000);\n                s.set_port(port);\n                s\n            };\n\n            {\n                let http_node = Arc::clone(\u0026raft.node);\n                let http_data_dir = node_data_dir.clone();\n                let ingest_tx = ingest_tx_opt.clone();\n                tokio::spawn(async move {\n                    if let Err(e) = chronos::network::http_admin::run_http_admin(\n                        http_addr,\n                        http_node,\n                        http_data_dir,\n                        ingest_tx,\n                    )\n                    .await\n                    {\n                        eprintln!(\"HTTP admin server error: {}\", e);\n                    }\n                });\n            }\n\n            let mut server_builder = tonic::transport::Server::builder();\n\n            if let Some(tls_config) = load_server_tls_from_env()? {\n                server_builder = server_builder.tls_config(tls_config)?;\n            }\n\n            info!(\"gRPC server listening on {addr}\");\n            server_builder\n                .add_service(chronos::network::proto::raft_service_server::RaftServiceServer::new(raft_server))\n                .add_service(chronos::network::proto::sql_service_server::SqlServiceServer::new(sql_server))\n                .add_service(chronos::network::proto::health_service_server::HealthServiceServer::new(health_server))\n                .add_service(chronos::network::proto::sync_service_server::SyncServiceServer::new(sync_server))\n                .add_service(chronos::network::proto::sync_status_service_server::SyncStatusServiceServer::new(sync_status_server))\n                .serve(addr)\n                .await?;\n        }\n    }\n\n    Ok(())\n}\n","traces":[{"line":47,"address":[13928037,13927975,13926512],"length":1,"stats":{"Line":0}},{"line":50,"address":[13926567],"length":1,"stats":{"Line":0}},{"line":51,"address":[13926790,13926703],"length":1,"stats":{"Line":0}},{"line":55,"address":[13928019,13926941,13927032],"length":1,"stats":{"Line":0}},{"line":56,"address":[13927162],"length":1,"stats":{"Line":0}},{"line":57,"address":[13927197,13927274],"length":1,"stats":{"Line":0}},{"line":58,"address":[13927392],"length":1,"stats":{"Line":0}},{"line":59,"address":[13927450,13927533,13927905],"length":1,"stats":{"Line":0}},{"line":60,"address":[13927691,13927627],"length":1,"stats":{"Line":0}},{"line":62,"address":[13927656,13927870],"length":1,"stats":{"Line":0}},{"line":66,"address":[13923184,13921344,13922819],"length":1,"stats":{"Line":0}},{"line":67,"address":[13921396],"length":1,"stats":{"Line":0}},{"line":69,"address":[13921421],"length":1,"stats":{"Line":0}},{"line":70,"address":[13921461],"length":1,"stats":{"Line":0}},{"line":73,"address":[13921504],"length":1,"stats":{"Line":0}},{"line":75,"address":[13921580],"length":1,"stats":{"Line":0}},{"line":77,"address":[13921614],"length":1,"stats":{"Line":0}},{"line":81,"address":[13921782],"length":1,"stats":{"Line":0}},{"line":84,"address":[13921975,13921863,13921938],"length":1,"stats":{"Line":0}},{"line":85,"address":[13922170,13922007],"length":1,"stats":{"Line":0}},{"line":87,"address":[13922117],"length":1,"stats":{"Line":0}},{"line":89,"address":[13922178,13922291],"length":1,"stats":{"Line":0}},{"line":91,"address":[13922244],"length":1,"stats":{"Line":0}},{"line":94,"address":[13922901,13922406,13922298,13922598],"length":1,"stats":{"Line":0}},{"line":95,"address":[13922734,13922654],"length":1,"stats":{"Line":0}},{"line":99,"address":[13922964],"length":1,"stats":{"Line":0}},{"line":102,"address":[13923137,13921760],"length":1,"stats":{"Line":0}},{"line":103,"address":[13923005],"length":1,"stats":{"Line":0}},{"line":104,"address":[13923097],"length":1,"stats":{"Line":0}},{"line":109,"address":[13920146,13920165,13919600],"length":1,"stats":{"Line":0}},{"line":110,"address":[13919651,13919709],"length":1,"stats":{"Line":0}},{"line":111,"address":[13977472,13977473],"length":1,"stats":{"Line":0}},{"line":112,"address":[13920037],"length":1,"stats":{"Line":0}},{"line":113,"address":[13919998],"length":1,"stats":{"Line":0}},{"line":116,"address":[13920033],"length":1,"stats":{"Line":0}},{"line":121,"address":[13921327,13920920,13920192],"length":1,"stats":{"Line":0}},{"line":124,"address":[13920242,13920212],"length":1,"stats":{"Line":0}},{"line":125,"address":[13920289],"length":1,"stats":{"Line":0}},{"line":126,"address":[13920942,13921050,13920464],"length":1,"stats":{"Line":0}},{"line":127,"address":[13921265,13921206],"length":1,"stats":{"Line":0}},{"line":130,"address":[13920495],"length":1,"stats":{"Line":0}},{"line":132,"address":[13920851,13920887,13920731,13920653,13920784],"length":1,"stats":{"Line":0}},{"line":133,"address":[13920666],"length":1,"stats":{"Line":0}},{"line":134,"address":[13920687],"length":1,"stats":{"Line":0}},{"line":135,"address":[13920700],"length":1,"stats":{"Line":0}},{"line":136,"address":[13920768,13920854,13920718],"length":1,"stats":{"Line":0}},{"line":137,"address":[13920890],"length":1,"stats":{"Line":0}},{"line":138,"address":[13920898],"length":1,"stats":{"Line":0}},{"line":143,"address":[13846144],"length":1,"stats":{"Line":0}},{"line":144,"address":[13846181],"length":1,"stats":{"Line":0}},{"line":145,"address":[13846300],"length":1,"stats":{"Line":0}},{"line":147,"address":[13846388,13846247],"length":1,"stats":{"Line":0}},{"line":148,"address":[13846504,13846449],"length":1,"stats":{"Line":0}},{"line":149,"address":[13846488],"length":1,"stats":{"Line":0}},{"line":152,"address":[13846128],"length":1,"stats":{"Line":0}},{"line":153,"address":[13846133],"length":1,"stats":{"Line":0}},{"line":266,"address":[13923216,13925915,13925497],"length":1,"stats":{"Line":0}},{"line":267,"address":[13923232],"length":1,"stats":{"Line":0}},{"line":268,"address":[13923384],"length":1,"stats":{"Line":0}},{"line":269,"address":[13923334],"length":1,"stats":{"Line":0}},{"line":271,"address":[13923551,13925887,13923479],"length":1,"stats":{"Line":0}},{"line":272,"address":[13923797,13923725],"length":1,"stats":{"Line":0}},{"line":274,"address":[13923832,13925739,13923959],"length":1,"stats":{"Line":0}},{"line":275,"address":[13925649,13924240,13924132],"length":1,"stats":{"Line":0}},{"line":276,"address":[13924569,13924413],"length":1,"stats":{"Line":0}},{"line":278,"address":[13924577,13924634],"length":1,"stats":{"Line":0}},{"line":280,"address":[13924733,13925470],"length":1,"stats":{"Line":0}},{"line":281,"address":[13924810,13925024],"length":1,"stats":{"Line":0}},{"line":282,"address":[13925197],"length":1,"stats":{"Line":0}},{"line":283,"address":[13925305],"length":1,"stats":{"Line":0}},{"line":286,"address":[13924840],"length":1,"stats":{"Line":0}},{"line":290,"address":[13926469,13926475,13926000],"length":1,"stats":{"Line":0}},{"line":291,"address":[13978102],"length":1,"stats":{"Line":0}},{"line":294,"address":[13978589],"length":1,"stats":{"Line":0}},{"line":296,"address":[13926073],"length":1,"stats":{"Line":0}},{"line":297,"address":[13978686],"length":1,"stats":{"Line":0}},{"line":298,"address":[13979415,13978714,13979466],"length":1,"stats":{"Line":0}},{"line":301,"address":[13979429,13979715],"length":1,"stats":{"Line":0}},{"line":302,"address":[13979976,13979753],"length":1,"stats":{"Line":0}},{"line":303,"address":[13979864,13979796,13980005],"length":1,"stats":{"Line":0}},{"line":307,"address":[13978329,13979823,13989306,13980125],"length":1,"stats":{"Line":0}},{"line":308,"address":[13989729,13989572,13978350,13989651],"length":1,"stats":{"Line":0}},{"line":310,"address":[13979054],"length":1,"stats":{"Line":0}},{"line":311,"address":[13979138],"length":1,"stats":{"Line":0}},{"line":312,"address":[13983888],"length":1,"stats":{"Line":0}},{"line":313,"address":[13984876,13983916,13984923],"length":1,"stats":{"Line":0}},{"line":314,"address":[13984890,13985238],"length":1,"stats":{"Line":0}},{"line":315,"address":[13989962,13985264,13978371,13985357],"length":1,"stats":{"Line":0}},{"line":318,"address":[13983964,13984118,13984067],"length":1,"stats":{"Line":0}},{"line":321,"address":[13984367,13984081],"length":1,"stats":{"Line":0}},{"line":322,"address":[13984405,13984628],"length":1,"stats":{"Line":0}},{"line":323,"address":[13984448,13984516,13984657],"length":1,"stats":{"Line":0}},{"line":326,"address":[13984710,13984475,13978392,13990228],"length":1,"stats":{"Line":0}},{"line":327,"address":[13978413,13990501,13990594,13990672],"length":1,"stats":{"Line":0}},{"line":331,"address":[13979191],"length":1,"stats":{"Line":0}},{"line":332,"address":[13985556],"length":1,"stats":{"Line":0}},{"line":333,"address":[13985716,13985756,13985620],"length":1,"stats":{"Line":0}},{"line":334,"address":[13986804,13986147,13985730],"length":1,"stats":{"Line":0}},{"line":335,"address":[13986344,13986424],"length":1,"stats":{"Line":0}},{"line":337,"address":[13985462],"length":1,"stats":{"Line":0}},{"line":342,"address":[13986952,13985508,13986912],"length":1,"stats":{"Line":0}},{"line":343,"address":[13988062,13986926,13987410],"length":1,"stats":{"Line":0}},{"line":344,"address":[13987696,13987616],"length":1,"stats":{"Line":0}},{"line":347,"address":[13979274],"length":1,"stats":{"Line":0}},{"line":348,"address":[13988185],"length":1,"stats":{"Line":0}},{"line":349,"address":[13988225,13988308,13988722],"length":1,"stats":{"Line":0}},{"line":350,"address":[13988525,13988596],"length":1,"stats":{"Line":0}},{"line":352,"address":[13988119],"length":1,"stats":{"Line":0}},{"line":353,"address":[13988159,13989234,13988820],"length":1,"stats":{"Line":0}},{"line":354,"address":[13989037,13989108],"length":1,"stats":{"Line":0}},{"line":357,"address":[13978854],"length":1,"stats":{"Line":0}},{"line":369,"address":[13978998,13980389,13980313],"length":1,"stats":{"Line":0}},{"line":371,"address":[13980767,13980327],"length":1,"stats":{"Line":0}},{"line":373,"address":[13980916],"length":1,"stats":{"Line":0}},{"line":374,"address":[13981207],"length":1,"stats":{"Line":0}},{"line":378,"address":[13981443,13981084],"length":1,"stats":{"Line":0}},{"line":379,"address":[13981481,13981669],"length":1,"stats":{"Line":0}},{"line":380,"address":[13981527,13983859],"length":1,"stats":{"Line":0}},{"line":385,"address":[13980930,13981690],"length":1,"stats":{"Line":0}},{"line":386,"address":[13981943,13981728],"length":1,"stats":{"Line":0}},{"line":387,"address":[13981771,13981964,13981831],"length":1,"stats":{"Line":0}},{"line":391,"address":[13981798,13983822,13982017],"length":1,"stats":{"Line":0}},{"line":394,"address":[13982252,13982140],"length":1,"stats":{"Line":0}},{"line":397,"address":[13982355],"length":1,"stats":{"Line":0}},{"line":398,"address":[13982444,13982568],"length":1,"stats":{"Line":0}},{"line":399,"address":[13982869,13982775],"length":1,"stats":{"Line":0}},{"line":400,"address":[13982975,13982896],"length":1,"stats":{"Line":0}},{"line":401,"address":[13983049,13982981],"length":1,"stats":{"Line":0}},{"line":402,"address":[13983072],"length":1,"stats":{"Line":0}},{"line":404,"address":[13983150],"length":1,"stats":{"Line":0}},{"line":405,"address":[13983203],"length":1,"stats":{"Line":0}},{"line":406,"address":[13983253],"length":1,"stats":{"Line":0}},{"line":413,"address":[13983690,13990886,13978434,13982475],"length":1,"stats":{"Line":0}},{"line":416,"address":[13991291,13991349],"length":1,"stats":{"Line":0}},{"line":419,"address":[13991451,13991694],"length":1,"stats":{"Line":0}},{"line":422,"address":[13991802,13991697],"length":1,"stats":{"Line":0}},{"line":423,"address":[13991891,13992012,13991812,13978455],"length":1,"stats":{"Line":0}},{"line":424,"address":[13992320,13992233],"length":1,"stats":{"Line":0}},{"line":426,"address":[13992477,13992379],"length":1,"stats":{"Line":0}},{"line":428,"address":[13978476,13992505,13992587,13992737],"length":1,"stats":{"Line":0}},{"line":429,"address":[13992958,13993045],"length":1,"stats":{"Line":0}},{"line":433,"address":[13993097],"length":1,"stats":{"Line":0}},{"line":434,"address":[14006469,14004580,14004449,14004496,13993143,14004416,14005413],"length":1,"stats":{"Line":0}},{"line":435,"address":[14004494,14004570,14004517,14004611,14005537,14005595],"length":1,"stats":{"Line":0}},{"line":436,"address":[14004532,14005898,14005981,14004635,14005858],"length":1,"stats":{"Line":0}},{"line":437,"address":[14004663,14004907,14006243,14006328,14006173,14004547,14004684],"length":1,"stats":{"Line":0}},{"line":438,"address":[14005105,14005080,14004967],"length":1,"stats":{"Line":0}},{"line":444,"address":[13993254],"length":1,"stats":{"Line":0}},{"line":445,"address":[13993417,13978497,13993324,13993495,13999747],"length":1,"stats":{"Line":0}},{"line":449,"address":[13993833],"length":1,"stats":{"Line":0}},{"line":450,"address":[13993852],"length":1,"stats":{"Line":0}},{"line":452,"address":[13993976,13994091],"length":1,"stats":{"Line":0}},{"line":453,"address":[13994224,13994094],"length":1,"stats":{"Line":0}},{"line":456,"address":[13994297,13999686],"length":1,"stats":{"Line":0}},{"line":457,"address":[13994534,13994610],"length":1,"stats":{"Line":0}},{"line":458,"address":[13994686,13994660,13994775,13999608],"length":1,"stats":{"Line":0}},{"line":460,"address":[13995011,13994922],"length":1,"stats":{"Line":0}},{"line":462,"address":[13995061,13995146],"length":1,"stats":{"Line":0}},{"line":463,"address":[13995265,13995180],"length":1,"stats":{"Line":0}},{"line":469,"address":[13996151,13995315],"length":1,"stats":{"Line":0}},{"line":471,"address":[13995404,13995510],"length":1,"stats":{"Line":0}},{"line":472,"address":[13995526],"length":1,"stats":{"Line":0}},{"line":473,"address":[13995574],"length":1,"stats":{"Line":0}},{"line":474,"address":[13995685],"length":1,"stats":{"Line":0}},{"line":475,"address":[13995787,13995700],"length":1,"stats":{"Line":0}},{"line":476,"address":[13995803],"length":1,"stats":{"Line":0}},{"line":478,"address":[13996078,13996010],"length":1,"stats":{"Line":0}},{"line":486,"address":[13995434,13996372],"length":1,"stats":{"Line":0}},{"line":487,"address":[14001967,14002058,13996380,14004371,14004385,14001895,14001856],"length":1,"stats":{"Line":0}},{"line":488,"address":[14001957],"length":1,"stats":{"Line":0}},{"line":490,"address":[14001965],"length":1,"stats":{"Line":0}},{"line":491,"address":[14002406,14002516,14002578,14002029],"length":1,"stats":{"Line":0}},{"line":492,"address":[14002421],"length":1,"stats":{"Line":0}},{"line":493,"address":[14002452],"length":1,"stats":{"Line":0}},{"line":494,"address":[14002548],"length":1,"stats":{"Line":0}},{"line":500,"address":[14002581,14001983,14002079,14002691],"length":1,"stats":{"Line":0}},{"line":501,"address":[14002113,14003304,14002001,14002895,14003069,14002976],"length":1,"stats":{"Line":0}},{"line":502,"address":[14003409],"length":1,"stats":{"Line":0}},{"line":503,"address":[14003425],"length":1,"stats":{"Line":0}},{"line":504,"address":[14003556,14003462],"length":1,"stats":{"Line":0}},{"line":511,"address":[14003332],"length":1,"stats":{"Line":0}},{"line":512,"address":[14003980,14003952,14003364],"length":1,"stats":{"Line":0}},{"line":516,"address":[14004254,14002019,14002174,14002143],"length":1,"stats":{"Line":0}},{"line":524,"address":[13996864,13996512,13996484],"length":1,"stats":{"Line":0}},{"line":525,"address":[13996514,13996625],"length":1,"stats":{"Line":0}},{"line":526,"address":[13996649,13996720],"length":1,"stats":{"Line":0}},{"line":527,"address":[14007472,14007393,14007514,13996728,14007360,14007621,14007827],"length":1,"stats":{"Line":0}},{"line":528,"address":[14007499,14007652,14007569,14007446],"length":1,"stats":{"Line":0}},{"line":530,"address":[13996841],"length":1,"stats":{"Line":0}},{"line":532,"address":[13996501],"length":1,"stats":{"Line":0}},{"line":536,"address":[13996545],"length":1,"stats":{"Line":0}},{"line":537,"address":[13996583,13996928],"length":1,"stats":{"Line":0}},{"line":538,"address":[13996967],"length":1,"stats":{"Line":0}},{"line":539,"address":[13996993],"length":1,"stats":{"Line":0}},{"line":543,"address":[13997102,13997025],"length":1,"stats":{"Line":0}},{"line":544,"address":[13997205,13997118],"length":1,"stats":{"Line":0}},{"line":545,"address":[13997285,13997213],"length":1,"stats":{"Line":0}},{"line":546,"address":[14006576,14006609,14006794,14006901,13997293,14007347,14006752],"length":1,"stats":{"Line":0}},{"line":547,"address":[14006861,14007105,14007078,14006717,14007179],"length":1,"stats":{"Line":0}},{"line":548,"address":[14006662],"length":1,"stats":{"Line":0}},{"line":549,"address":[14006686],"length":1,"stats":{"Line":0}},{"line":550,"address":[14006690],"length":1,"stats":{"Line":0}},{"line":551,"address":[14006713],"length":1,"stats":{"Line":0}},{"line":553,"address":[14007094,14006932,14006849,14006779,14006885],"length":1,"stats":{"Line":0}},{"line":555,"address":[14007228,14007152],"length":1,"stats":{"Line":0}},{"line":560,"address":[13997494],"length":1,"stats":{"Line":0}},{"line":562,"address":[13997562,13997645,13999494],"length":1,"stats":{"Line":0}},{"line":563,"address":[13998033,13997903,13998213],"length":1,"stats":{"Line":0}},{"line":566,"address":[13998259,13998321,13997972],"length":1,"stats":{"Line":0}},{"line":567,"address":[14000076,14000589,13998273,13998752,14000010,13998886,13999052,13999186,13999948,13999333],"length":1,"stats":{"Line":0}},{"line":568,"address":[13998288,13998650],"length":1,"stats":{"Line":0}},{"line":569,"address":[13998784,13998594,13998711,13998673,13999474],"length":1,"stats":{"Line":0}},{"line":570,"address":[13998845,13999441,13998918,13998815],"length":1,"stats":{"Line":0}},{"line":571,"address":[13998949,13999084,13999416,13999011],"length":1,"stats":{"Line":0}},{"line":572,"address":[13999115,13999218,13999145,13999388],"length":1,"stats":{"Line":0}},{"line":573,"address":[13999241],"length":1,"stats":{"Line":0}},{"line":574,"address":[14000044,13978518,13999318,13999366,13999800,13999980],"length":1,"stats":{"Line":0}},{"line":578,"address":[13926133,13926309],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":218},{"path":["/","home","azureuser","Documents","Chronos","src","network","client.rs"],"content":"use std::env;\nuse std::fs;\nuse std::str::FromStr;\nuse std::time::Duration;\nuse tonic::metadata::MetadataValue;\nuse tonic::transport::{Certificate, Channel, ClientTlsConfig, Endpoint, Identity};\nuse tonic::Request;\n\nuse crate::raft::{LogEntry, RaftMessage};\n\nuse crate::network::proto::raft_service_client::RaftServiceClient;\nuse crate::network::proto::sql_service_client::SqlServiceClient;\nuse crate::network::proto::sync_service_client::SyncServiceClient;\nuse crate::network::proto::{\n    AppendEntriesRequest, RequestVoteRequest, SqlRequest, SyncOperation, SyncRequest, SyncResponse,\n};\n\nuse super::proto::*;\nuse super::NetworkError;\n\nfn tls_env_present() -\u003e bool {\n    env::var(\"CHRONOS_TLS_CERT\").is_ok()\n        \u0026\u0026 env::var(\"CHRONOS_TLS_KEY\").is_ok()\n        \u0026\u0026 env::var(\"CHRONOS_TLS_CA_CERT\").is_ok()\n}\n\nfn configure_tls(endpoint: Endpoint) -\u003e Result\u003cEndpoint, NetworkError\u003e {\n    let cert_path =\n        env::var(\"CHRONOS_TLS_CERT\").map_err(|e| NetworkError::ConnectionError(e.to_string()))?;\n    let key_path =\n        env::var(\"CHRONOS_TLS_KEY\").map_err(|e| NetworkError::ConnectionError(e.to_string()))?;\n    let ca_path = env::var(\"CHRONOS_TLS_CA_CERT\")\n        .map_err(|e| NetworkError::ConnectionError(e.to_string()))?;\n\n    let cert = fs::read(cert_path).map_err(|e| NetworkError::ConnectionError(e.to_string()))?;\n    let key = fs::read(key_path).map_err(|e| NetworkError::ConnectionError(e.to_string()))?;\n    let ca = fs::read(ca_path).map_err(|e| NetworkError::ConnectionError(e.to_string()))?;\n\n    let identity = Identity::from_pem(cert, key);\n    let ca_cert = Certificate::from_pem(ca);\n\n    let domain = env::var(\"CHRONOS_TLS_DOMAIN\").unwrap_or_else(|_| \"localhost\".to_string());\n\n    let tls = ClientTlsConfig::new()\n        .identity(identity)\n        .ca_certificate(ca_cert)\n        .domain_name(domain);\n\n    endpoint\n        .tls_config(tls)\n        .map_err(|e| NetworkError::ConnectionError(e.to_string()))\n}\n\nfn build_endpoint(address: \u0026str) -\u003e Result\u003cEndpoint, NetworkError\u003e {\n    let use_tls = tls_env_present();\n\n    let uri = if address.starts_with(\"http://\") || address.starts_with(\"https://\") {\n        address.to_string()\n    } else if use_tls {\n        format!(\"https://{}\", address)\n    } else {\n        format!(\"http://{}\", address)\n    };\n\n    let endpoint =\n        Endpoint::from_shared(uri).map_err(|e| NetworkError::ConnectionError(e.to_string()))?;\n\n    if use_tls {\n        configure_tls(endpoint)\n    } else {\n        Ok(endpoint)\n    }\n}\n\npub struct RaftClient {\n    address: String,\n    client: Option\u003cRaftServiceClient\u003cChannel\u003e\u003e,\n}\n\nimpl RaftClient {\n    pub fn new(address: \u0026str) -\u003e Self {\n        Self {\n            address: address.to_string(),\n            client: None,\n        }\n    }\n\n    pub async fn connect(\u0026mut self) -\u003e Result\u003c(), NetworkError\u003e {\n        let endpoint = build_endpoint(\u0026self.address)?;\n\n        let channel = endpoint\n            .connect_timeout(Duration::from_secs(5))\n            .timeout(Duration::from_secs(5))\n            .connect()\n            .await?;\n\n        self.client = Some(RaftServiceClient::new(channel));\n\n        Ok(())\n    }\n\n    pub async fn request_vote(\n        \u0026mut self,\n        term: u64,\n        candidate_id: \u0026str,\n        last_log_index: u64,\n        last_log_term: u64,\n    ) -\u003e Result\u003cRaftMessage, NetworkError\u003e {\n        if self.client.is_none() {\n            self.connect().await?;\n        }\n\n        let request = RequestVoteRequest {\n            term,\n            candidate_id: candidate_id.to_string(),\n            last_log_index,\n            last_log_term,\n        };\n\n        let response = self\n            .client\n            .as_mut()\n            .ok_or_else(|| NetworkError::ConnectionError(\"Client not connected\".to_string()))?\n            .request_vote(Request::new(request))\n            .await?\n            .into_inner();\n\n        Ok(RaftMessage::RequestVoteResponse {\n            term: response.term,\n            vote_granted: response.vote_granted,\n        })\n    }\n\n    pub async fn pre_vote(\n        \u0026mut self,\n        term: u64,\n        candidate_id: \u0026str,\n        last_log_index: u64,\n        last_log_term: u64,\n    ) -\u003e Result\u003cRaftMessage, NetworkError\u003e {\n        if self.client.is_none() {\n            self.connect().await?;\n        }\n\n        let request = RequestVoteRequest {\n            term,\n            candidate_id: candidate_id.to_string(),\n            last_log_index,\n            last_log_term,\n        };\n\n        let response = self\n            .client\n            .as_mut()\n            .ok_or_else(|| NetworkError::ConnectionError(\"Client not connected\".to_string()))?\n            .pre_vote(Request::new(request))\n            .await?\n            .into_inner();\n\n        Ok(RaftMessage::PreVoteResponse {\n            term: response.term,\n            vote_granted: response.vote_granted,\n        })\n    }\n\n    pub async fn append_entries(\n        \u0026mut self,\n        term: u64,\n        leader_id: \u0026str,\n        prev_log_index: u64,\n        prev_log_term: u64,\n        entries: Vec\u003cLogEntry\u003e,\n        leader_commit: u64,\n    ) -\u003e Result\u003cRaftMessage, NetworkError\u003e {\n        if self.client.is_none() {\n            self.connect().await?;\n        }\n\n        // Convert entries to proto format\n        let proto_entries = entries\n            .into_iter()\n            .map(|e| super::proto::LogEntry {\n                term: e.term,\n                command: e.command,\n            })\n            .collect();\n\n        let request = AppendEntriesRequest {\n            term,\n            leader_id: leader_id.to_string(),\n            prev_log_index,\n            prev_log_term,\n            entries: proto_entries,\n            leader_commit,\n        };\n\n        let response = self\n            .client\n            .as_mut()\n            .ok_or_else(|| NetworkError::ConnectionError(\"Client not connected\".to_string()))?\n            .append_entries(Request::new(request))\n            .await?\n            .into_inner();\n\n        Ok(RaftMessage::AppendEntriesResponse {\n            term: response.term,\n            success: response.success,\n            match_index: response.match_index,\n        })\n    }\n}\n\npub struct SqlClient {\n    address: String,\n    client: Option\u003cSqlServiceClient\u003cChannel\u003e\u003e,\n    auth_token: Option\u003cString\u003e,\n}\n\nimpl SqlClient {\n    pub fn new(address: \u0026str) -\u003e Self {\n        Self {\n            address: address.to_string(),\n            client: None,\n            auth_token: None,\n        }\n    }\n\n    /// Configure this client to send a bearer token for authentication.\n    /// The token will be attached as an `authorization: Bearer \u003ctoken\u003e`\n    /// header on each gRPC request.\n    pub fn with_auth_token(mut self, token: impl Into\u003cString\u003e) -\u003e Self {\n        self.auth_token = Some(token.into());\n        self\n    }\n\n    pub async fn connect(\u0026mut self) -\u003e Result\u003c(), NetworkError\u003e {\n        let endpoint = build_endpoint(\u0026self.address)?.connect_timeout(Duration::from_secs(5));\n\n        let channel = endpoint.connect().await?;\n\n        self.client = Some(SqlServiceClient::new(channel));\n\n        Ok(())\n    }\n\n    pub async fn execute_sql(\u0026mut self, sql: \u0026str) -\u003e Result\u003cSqlResponse, NetworkError\u003e {\n        if self.client.is_none() {\n            self.connect().await?;\n        }\n\n        let mut request = Request::new(SqlRequest {\n            sql: sql.to_string(),\n        });\n\n        if let Some(token) = \u0026self.auth_token {\n            let header_val = format!(\"Bearer {}\", token);\n            let meta_val = MetadataValue::from_str(\u0026header_val)\n                .map_err(|e| NetworkError::ConnectionError(e.to_string()))?;\n            request.metadata_mut().insert(\"authorization\", meta_val);\n        }\n\n        let response = self\n            .client\n            .as_mut()\n            .ok_or_else(|| NetworkError::ConnectionError(\"Client not connected\".to_string()))?\n            .execute_sql(request)\n            .await?\n            .into_inner();\n\n        Ok(response)\n    }\n}\n\npub struct SyncClient {\n    address: String,\n    client: Option\u003cSyncServiceClient\u003cChannel\u003e\u003e,\n}\n\nimpl SyncClient {\n    pub fn new(address: \u0026str) -\u003e Self {\n        Self {\n            address: address.to_string(),\n            client: None,\n        }\n    }\n\n    pub async fn connect(\u0026mut self) -\u003e Result\u003c(), NetworkError\u003e {\n        let endpoint = build_endpoint(\u0026self.address)?;\n\n        let channel = endpoint\n            .connect_timeout(Duration::from_secs(5))\n            .timeout(Duration::from_secs(5))\n            .connect()\n            .await?;\n\n        self.client = Some(SyncServiceClient::new(channel));\n\n        Ok(())\n    }\n\n    pub async fn sync_operations(\n        \u0026mut self,\n        edge_id: \u0026str,\n        operations: Vec\u003ccrate::storage::offline_queue::PersistentQueuedOperation\u003e,\n    ) -\u003e Result\u003cu64, NetworkError\u003e {\n        if self.client.is_none() {\n            self.connect().await?;\n        }\n\n        let ops: Vec\u003cSyncOperation\u003e = operations\n            .into_iter()\n            .map(|op| {\n                let bytes = bincode::serde::encode_to_vec(\u0026op, bincode::config::standard())\n                    .expect(\"failed to encode PersistentQueuedOperation for sync\");\n                SyncOperation {\n                    id: op.id,\n                    data: bytes,\n                }\n            })\n            .collect();\n\n        let request = SyncRequest {\n            edge_id: edge_id.to_string(),\n            operations: ops,\n        };\n\n        let response: SyncResponse = self\n            .client\n            .as_mut()\n            .ok_or_else(|| NetworkError::ConnectionError(\"Client not connected\".to_string()))?\n            .sync(Request::new(request))\n            .await?\n            .into_inner();\n\n        Ok(response.applied)\n    }\n}\n","traces":[{"line":21,"address":[13691265,13691271,13690864],"length":1,"stats":{"Line":3}},{"line":22,"address":[14085719,14085899],"length":1,"stats":{"Line":6}},{"line":23,"address":[16540840,16540901],"length":1,"stats":{"Line":0}},{"line":24,"address":[13823571,13823636],"length":1,"stats":{"Line":0}},{"line":27,"address":[14070949,14070568,14067744],"length":1,"stats":{"Line":0}},{"line":28,"address":[13060528,13060551],"length":1,"stats":{"Line":0}},{"line":30,"address":[17502004,17502076,17504774],"length":1,"stats":{"Line":0}},{"line":32,"address":[14084631,14082315,14082407,14082216],"length":1,"stats":{"Line":0}},{"line":33,"address":[14581168,14581186],"length":1,"stats":{"Line":0}},{"line":35,"address":[14808016,14808034],"length":1,"stats":{"Line":0}},{"line":36,"address":[18416000,18416018],"length":1,"stats":{"Line":0}},{"line":37,"address":[17503346,17503238],"length":1,"stats":{"Line":0}},{"line":39,"address":[16538478,16538634],"length":1,"stats":{"Line":0}},{"line":40,"address":[14741354,14741455],"length":1,"stats":{"Line":0}},{"line":42,"address":[13821419,13821350],"length":1,"stats":{"Line":0}},{"line":44,"address":[13994101],"length":1,"stats":{"Line":0}},{"line":45,"address":[14083934],"length":1,"stats":{"Line":0}},{"line":46,"address":[17504105],"length":1,"stats":{"Line":0}},{"line":47,"address":[16539092],"length":1,"stats":{"Line":0}},{"line":49,"address":[13441268],"length":1,"stats":{"Line":0}},{"line":50,"address":[13994442],"length":1,"stats":{"Line":0}},{"line":51,"address":[14741947],"length":1,"stats":{"Line":0}},{"line":54,"address":[14071859,14071891,14070992],"length":1,"stats":{"Line":3}},{"line":55,"address":[13822411],"length":1,"stats":{"Line":3}},{"line":57,"address":[13690005],"length":1,"stats":{"Line":3}},{"line":58,"address":[14084919],"length":1,"stats":{"Line":0}},{"line":59,"address":[16539941],"length":1,"stats":{"Line":3}},{"line":60,"address":[16540069],"length":1,"stats":{"Line":0}},{"line":62,"address":[17505035],"length":1,"stats":{"Line":3}},{"line":65,"address":[13822769,13823005],"length":1,"stats":{"Line":6}},{"line":68,"address":[13995709,13995770],"length":1,"stats":{"Line":6}},{"line":69,"address":[13442636,13442740],"length":1,"stats":{"Line":0}},{"line":71,"address":[13442577],"length":1,"stats":{"Line":3}},{"line":81,"address":[13818656],"length":1,"stats":{"Line":0}},{"line":83,"address":[13686257],"length":1,"stats":{"Line":0}},{"line":88,"address":[17126048,17127127,17126293,17126106,17126241,17127042],"length":1,"stats":{"Line":0}},{"line":89,"address":[14660985,14661748,14660850],"length":1,"stats":{"Line":0}},{"line":91,"address":[17126595,17127357,17127447,17126857,17126691,17126818,17127282,17126971],"length":1,"stats":{"Line":0}},{"line":92,"address":[13052149,13052223,13052165,13052564],"length":1,"stats":{"Line":0}},{"line":93,"address":[14661387,14661504,14661653,14661473,14661403],"length":1,"stats":{"Line":0}},{"line":95,"address":[18407593,18407314,18406236,18408027,18406962,18407126,18407383,18406864],"length":1,"stats":{"Line":0}},{"line":97,"address":[14800516,14800673],"length":1,"stats":{"Line":0}},{"line":99,"address":[18407896],"length":1,"stats":{"Line":0}},{"line":102,"address":[16535856],"length":1,"stats":{"Line":0}},{"line":109,"address":[13047108,13047570,13046987],"length":1,"stats":{"Line":0}},{"line":110,"address":[18174817],"length":1,"stats":{"Line":0}},{"line":115,"address":[13047128],"length":1,"stats":{"Line":0}},{"line":120,"address":[13047772,13048625,13048364,13047849,13048035,13048327,13047689,13048084,13048439,13048720],"length":1,"stats":{"Line":0}},{"line":123,"address":[14656753,14657760,14657774,14656672],"length":1,"stats":{"Line":0}},{"line":124,"address":[14665972],"length":1,"stats":{"Line":0}},{"line":125,"address":[18174837],"length":1,"stats":{"Line":0}},{"line":128,"address":[13048645],"length":1,"stats":{"Line":0}},{"line":134,"address":[13686384],"length":1,"stats":{"Line":0}},{"line":141,"address":[14663080,14663574,14662955],"length":1,"stats":{"Line":0}},{"line":142,"address":[14663001,14663267,14663134,14664142],"length":1,"stats":{"Line":0}},{"line":147,"address":[14655420],"length":1,"stats":{"Line":0}},{"line":152,"address":[17129427,17129144,17129053,17129480,17130045,17129731,17130140,17129851,17129225,17129756],"length":1,"stats":{"Line":0}},{"line":155,"address":[14664848,14663841,14664862,14663760],"length":1,"stats":{"Line":0}},{"line":156,"address":[17129284],"length":1,"stats":{"Line":0}},{"line":157,"address":[14523813],"length":1,"stats":{"Line":0}},{"line":160,"address":[14673841],"length":1,"stats":{"Line":0}},{"line":166,"address":[14067152],"length":1,"stats":{"Line":0}},{"line":175,"address":[14569535,14568874,14569000],"length":1,"stats":{"Line":0}},{"line":176,"address":[13050565,13049442,13049156,13049315],"length":1,"stats":{"Line":0}},{"line":180,"address":[13049247],"length":1,"stats":{"Line":0}},{"line":182,"address":[13051542,13049795,13051504],"length":1,"stats":{"Line":0}},{"line":183,"address":[14798712],"length":1,"stats":{"Line":0}},{"line":184,"address":[14652844],"length":1,"stats":{"Line":0}},{"line":190,"address":[14767334],"length":1,"stats":{"Line":0}},{"line":197,"address":[14668992,14668679,14669436,14668346,14669085,14668252,14668439,14668967,14668732],"length":1,"stats":{"Line":0}},{"line":200,"address":[14571390,14570057,14569970,14571376],"length":1,"stats":{"Line":0}},{"line":201,"address":[14767829],"length":1,"stats":{"Line":0}},{"line":202,"address":[13050521,13049174,13050479,13050601,13050871,13050774],"length":1,"stats":{"Line":0}},{"line":205,"address":[14652476],"length":1,"stats":{"Line":0}},{"line":206,"address":[18405461],"length":1,"stats":{"Line":0}},{"line":207,"address":[14652461],"length":1,"stats":{"Line":0}},{"line":208,"address":[14798340],"length":1,"stats":{"Line":0}},{"line":220,"address":[14086192],"length":1,"stats":{"Line":3}},{"line":222,"address":[16541216],"length":1,"stats":{"Line":3}},{"line":231,"address":[14782368,14782624],"length":1,"stats":{"Line":0}},{"line":232,"address":[17139294,17139357],"length":1,"stats":{"Line":0}},{"line":233,"address":[14683276],"length":1,"stats":{"Line":0}},{"line":236,"address":[14683370,14684086,14684204,14683474,14683312],"length":1,"stats":{"Line":12}},{"line":237,"address":[14683514,14683798,14684057,14683446,14684114],"length":1,"stats":{"Line":3}},{"line":239,"address":[14667439,14667078,14666685,14667154],"length":1,"stats":{"Line":9}},{"line":241,"address":[14668109,14667914,14668082],"length":1,"stats":{"Line":6}},{"line":243,"address":[14675871],"length":1,"stats":{"Line":3}},{"line":246,"address":[14663296,14663369,14663726,14663473,14663536,14665046],"length":1,"stats":{"Line":12}},{"line":247,"address":[14780217,14779598,14779723],"length":1,"stats":{"Line":6}},{"line":248,"address":[17136540,17136664,17136797,17138553],"length":1,"stats":{"Line":0}},{"line":251,"address":[14671799],"length":1,"stats":{"Line":3}},{"line":252,"address":[14582054],"length":1,"stats":{"Line":3}},{"line":255,"address":[14681002],"length":1,"stats":{"Line":3}},{"line":256,"address":[13062453,13062546],"length":1,"stats":{"Line":0}},{"line":257,"address":[14664545,14664665,14664579,14664458],"length":1,"stats":{"Line":0}},{"line":258,"address":[17139101,17137592,17137673,17139088],"length":1,"stats":{"Line":0}},{"line":259,"address":[14681627,14681696],"length":1,"stats":{"Line":0}},{"line":262,"address":[18418229,18418136,18418983,18418858,18418741,18417293,18418516,18418763,18418469],"length":1,"stats":{"Line":13}},{"line":265,"address":[18419150,18418199,18418112,18419136],"length":1,"stats":{"Line":3}},{"line":266,"address":[14781422],"length":1,"stats":{"Line":3}},{"line":267,"address":[13012225],"length":1,"stats":{"Line":11}},{"line":270,"address":[14782079],"length":1,"stats":{"Line":2}},{"line":280,"address":[13438480],"length":1,"stats":{"Line":0}},{"line":282,"address":[13819009],"length":1,"stats":{"Line":0}},{"line":287,"address":[14676897,14677783,14676704,14676949,14676762,14677698],"length":1,"stats":{"Line":0}},{"line":288,"address":[14776329,14777092,14776194],"length":1,"stats":{"Line":0}},{"line":290,"address":[14777341,14776802,14776841,14777431,14776675,14776955,14777266,14776579],"length":1,"stats":{"Line":0}},{"line":291,"address":[14660465,14660888,14660539,14660481],"length":1,"stats":{"Line":0}},{"line":292,"address":[13058863,13058980,13058949,13058879,13059121],"length":1,"stats":{"Line":0}},{"line":294,"address":[18413744,18414473,18413842,18413116,18414194,18414907,18414006,18414263],"length":1,"stats":{"Line":0}},{"line":296,"address":[18414532,18414689],"length":1,"stats":{"Line":0}},{"line":298,"address":[14661768],"length":1,"stats":{"Line":0}},{"line":301,"address":[14067520],"length":1,"stats":{"Line":0}},{"line":306,"address":[14674255,14674378,14674883],"length":1,"stats":{"Line":0}},{"line":307,"address":[14355900],"length":1,"stats":{"Line":0}},{"line":310,"address":[14665253],"length":1,"stats":{"Line":0}},{"line":312,"address":[14674924,14676400,14676587],"length":1,"stats":{"Line":0}},{"line":313,"address":[18412615,18412664],"length":1,"stats":{"Line":0}},{"line":314,"address":[14775816],"length":1,"stats":{"Line":0}},{"line":315,"address":[13058017],"length":1,"stats":{"Line":0}},{"line":316,"address":[14578185],"length":1,"stats":{"Line":0}},{"line":323,"address":[17131211],"length":1,"stats":{"Line":0}},{"line":327,"address":[14675341,14675829,14675260,14675807,14676211,14675590,14676097,14675169,14675543,14675924],"length":1,"stats":{"Line":0}},{"line":330,"address":[14578256,14576965,14578270,14576884],"length":1,"stats":{"Line":0}},{"line":331,"address":[13056952],"length":1,"stats":{"Line":0}},{"line":332,"address":[14545024],"length":1,"stats":{"Line":0}},{"line":335,"address":[14577753],"length":1,"stats":{"Line":0}}],"covered":27,"coverable":127},{"path":["/","home","azureuser","Documents","Chronos","src","network","connectivity.rs"],"content":"use std::sync::Arc;\n\nuse tokio::sync::RwLock;\nuse tokio::time::{sleep, Duration};\nuse tonic::transport::Endpoint;\n\nuse crate::network::proto::health_service_client::HealthServiceClient;\nuse crate::network::proto::HealthRequest;\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum ConnectivityState {\n    Connected,\n    Disconnected,\n    Reconnecting,\n}\n\n#[allow(dead_code)]\npub struct ConnectivityMonitor {\n    state: Arc\u003cRwLock\u003cConnectivityState\u003e\u003e,\n    target: String,\n    interval: Duration,\n}\n\nimpl ConnectivityMonitor {\n    pub fn new\u003cT: Into\u003cString\u003e\u003e(target: T, interval: Duration) -\u003e Self {\n        Self {\n            state: Arc::new(RwLock::new(ConnectivityState::Disconnected)),\n            target: target.into(),\n            interval,\n        }\n    }\n\n    pub fn state(\u0026self) -\u003e Arc\u003cRwLock\u003cConnectivityState\u003e\u003e {\n        Arc::clone(\u0026self.state)\n    }\n\n    pub async fn run(self) {\n        let mut reconnecting = false;\n\n        loop {\n            let ok = Self::check_once(\u0026self.target).await;\n\n            let new_state = if ok {\n                reconnecting = false;\n                ConnectivityState::Connected\n            } else if reconnecting {\n                ConnectivityState::Reconnecting\n            } else {\n                reconnecting = true;\n                ConnectivityState::Disconnected\n            };\n\n            {\n                let mut guard = self.state.write().await;\n                *guard = new_state;\n            }\n\n            sleep(self.interval).await;\n        }\n    }\n\n    pub async fn check_once(target: \u0026str) -\u003e bool {\n        let endpoint = match Endpoint::from_shared(format!(\"http://{}\", target)) {\n            Ok(ep) =\u003e ep,\n            Err(_) =\u003e return false,\n        };\n\n        let channel = match endpoint\n            .connect_timeout(Duration::from_secs(5))\n            .timeout(Duration::from_secs(5))\n            .connect()\n            .await\n        {\n            Ok(ch) =\u003e ch,\n            Err(_) =\u003e return false,\n        };\n\n        let mut client = HealthServiceClient::new(channel);\n\n        client.get_connectivity(HealthRequest {}).await.is_ok()\n    }\n}\n","traces":[{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[14841964,14841878],"length":1,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[14011824],"length":1,"stats":{"Line":0}},{"line":34,"address":[15081077],"length":1,"stats":{"Line":0}},{"line":37,"address":[16556561,16556544],"length":1,"stats":{"Line":0}},{"line":38,"address":[16984488],"length":1,"stats":{"Line":0}},{"line":40,"address":[16984492],"length":1,"stats":{"Line":0}},{"line":41,"address":[16984552,16984507,16984594,16984959,16984882],"length":1,"stats":{"Line":0}},{"line":43,"address":[13126127,13126095],"length":1,"stats":{"Line":0}},{"line":44,"address":[13195351],"length":1,"stats":{"Line":0}},{"line":45,"address":[13126123],"length":1,"stats":{"Line":0}},{"line":46,"address":[13126106,13126142],"length":1,"stats":{"Line":0}},{"line":47,"address":[13126149],"length":1,"stats":{"Line":0}},{"line":49,"address":[13195366],"length":1,"stats":{"Line":0}},{"line":50,"address":[13195370],"length":1,"stats":{"Line":0}},{"line":54,"address":[16985306,16984522,16984622,16985198],"length":1,"stats":{"Line":0}},{"line":55,"address":[13195718,13195802],"length":1,"stats":{"Line":0}},{"line":58,"address":[16984537,16984675,16985636,16984650],"length":1,"stats":{"Line":0}},{"line":62,"address":[13193861,13191824,13192992,13191887,13192911,13191999],"length":1,"stats":{"Line":4}},{"line":63,"address":[16981788,16981901],"length":1,"stats":{"Line":2}},{"line":64,"address":[16982101],"length":1,"stats":{"Line":1}},{"line":65,"address":[13192248],"length":1,"stats":{"Line":0}},{"line":68,"address":[13192555,13193143,13192826,13192403,13192682,13192718,13193289],"length":1,"stats":{"Line":7}},{"line":69,"address":[13192917,13192447,13192563,13192505],"length":1,"stats":{"Line":2}},{"line":70,"address":[13123499,13123582,13123515,13123610,13123762],"length":1,"stats":{"Line":3}},{"line":71,"address":[13192730],"length":1,"stats":{"Line":1}},{"line":72,"address":[14433535],"length":1,"stats":{"Line":4}},{"line":74,"address":[16983176],"length":1,"stats":{"Line":1}},{"line":75,"address":[13193320],"length":1,"stats":{"Line":1}},{"line":78,"address":[13124450],"length":1,"stats":{"Line":1}},{"line":80,"address":[13192044,13194036,13193751,13194377,13193686,13194303],"length":1,"stats":{"Line":5}}],"covered":12,"coverable":32},{"path":["/","home","azureuser","Documents","Chronos","src","network","error.rs"],"content":"use thiserror::Error;\nuse tonic::Status;\n\n#[derive(Error, Debug)]\npub enum NetworkError {\n    #[error(\"gRPC error: {0}\")]\n    GrpcError(#[from] Status),\n    \n    #[error(\"Transport error: {0}\")]\n    TransportError(#[from] tonic::transport::Error),\n    \n    #[error(\"Connection error: {0}\")]\n    ConnectionError(String),\n    \n    #[error(\"Timeout error\")]\n    TimeoutError,\n}","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","src","network","http_admin.rs"],"content":"use std::convert::Infallible;\nuse std::net::SocketAddr;\nuse std::sync::Arc;\n\nuse hyper::service::{make_service_fn, service_fn};\nuse hyper::{body, Body, Method, Request, Response};\nuse tokio::sync::{mpsc::UnboundedSender, Mutex};\n\nuse crate::network::{metrics, IngestRequest};\nuse crate::raft::{NodeRole, RaftNode};\n\npub async fn run_http_admin(\n    addr: SocketAddr,\n    node: Arc\u003cMutex\u003cRaftNode\u003e\u003e,\n    data_dir: String,\n    ingest_tx: Option\u003cUnboundedSender\u003cIngestRequest\u003e\u003e,\n) -\u003e Result\u003c(), hyper::Error\u003e {\n    let node_arc = Arc::clone(\u0026node);\n\n    let make_svc = make_service_fn(move |_conn| {\n        let node = Arc::clone(\u0026node_arc);\n        let data_dir = data_dir.clone();\n        let ingest_tx = ingest_tx.clone();\n        async move {\n            Ok::\u003c_, Infallible\u003e(service_fn(move |req| {\n                let node = Arc::clone(\u0026node);\n                let data_dir = data_dir.clone();\n                let ingest_tx = ingest_tx.clone();\n                async move { handle(req, node, data_dir, ingest_tx).await }\n            }))\n        }\n    });\n\n    hyper::Server::bind(\u0026addr).serve(make_svc).await\n}\n\nasync fn handle(\n    req: Request\u003cBody\u003e,\n    node: Arc\u003cMutex\u003cRaftNode\u003e\u003e,\n    data_dir: String,\n    ingest_tx: Option\u003cUnboundedSender\u003cIngestRequest\u003e\u003e,\n) -\u003e Result\u003cResponse\u003cBody\u003e, Infallible\u003e {\n    let method = req.method().clone();\n    let path = req.uri().path().to_string();\n\n    let response = match (method, path.as_str()) {\n        (Method::GET, \"/metrics\") =\u003e {\n            let body = build_metrics(node, data_dir).await;\n            Response::builder()\n                .status(200)\n                .header(\"Content-Type\", \"text/plain; version=0.0.4\")\n                .body(Body::from(body))\n                .unwrap()\n        }\n        (Method::GET, \"/health\") =\u003e {\n            let body = build_health(node).await;\n            Response::builder()\n                .status(200)\n                .header(\"Content-Type\", \"application/json\")\n                .body(Body::from(body))\n                .unwrap()\n        }\n        (Method::POST, \"/ingest\") =\u003e {\n            if let Some(tx) = ingest_tx.clone() {\n                match body::to_bytes(req.into_body()).await {\n                    Ok(bytes) =\u003e match serde_json::from_slice::\u003cIngestRequest\u003e(\u0026bytes) {\n                        Ok(msg) =\u003e {\n                            if let Err(e) = tx.send(msg) {\n                                let body =\n                                    format!(\"{{\\\"error\\\":\\\"ingest queue unavailable: {}\\\"}}\", e);\n                                Response::builder()\n                                    .status(503)\n                                    .header(\"Content-Type\", \"application/json\")\n                                    .body(Body::from(body))\n                                    .unwrap()\n                            } else {\n                                Response::builder()\n                                    .status(202)\n                                    .header(\"Content-Type\", \"application/json\")\n                                    .body(Body::from(\"{\\\"status\\\":\\\"queued\\\"}\"))\n                                    .unwrap()\n                            }\n                        }\n                        Err(e) =\u003e {\n                            let body = format!(\"{{\\\"error\\\":\\\"invalid JSON: {}\\\"}}\", e);\n                            Response::builder()\n                                .status(400)\n                                .header(\"Content-Type\", \"application/json\")\n                                .body(Body::from(body))\n                                .unwrap()\n                        }\n                    },\n                    Err(e) =\u003e {\n                        let body = format!(\"{{\\\"error\\\":\\\"failed to read request body: {}\\\"}}\", e);\n                        Response::builder()\n                            .status(400)\n                            .header(\"Content-Type\", \"application/json\")\n                            .body(Body::from(body))\n                            .unwrap()\n                    }\n                }\n            } else {\n                Response::builder()\n                    .status(503)\n                    .header(\"Content-Type\", \"application/json\")\n                    .body(Body::from(\"{\\\"error\\\":\\\"ingest disabled\\\"}\"))\n                    .unwrap()\n            }\n        }\n        _ =\u003e Response::builder().status(404).body(Body::empty()).unwrap(),\n    };\n\n    Ok(response)\n}\n\nasync fn build_metrics(node: Arc\u003cMutex\u003cRaftNode\u003e\u003e, data_dir: String) -\u003e String {\n    let (reads, writes) = metrics::snapshot_sql();\n\n    let (role_value, term) = {\n        let node_guard = node.lock().await;\n        let role = match node_guard.state().role {\n            NodeRole::Follower =\u003e 0,\n            NodeRole::Candidate =\u003e 1,\n            NodeRole::Leader =\u003e 2,\n        };\n        (role, node_guard.state().current_term)\n    };\n\n    let storage_size = tokio::task::spawn_blocking(move || dir_size(\u0026data_dir))\n        .await\n        .unwrap_or(0);\n\n    format!(\n        concat!(\n            \"# TYPE chronos_sql_requests_total counter\\n\",\n            \"chronos_sql_requests_total{{kind=\\\"read\\\"}} {}\\n\",\n            \"chronos_sql_requests_total{{kind=\\\"write\\\"}} {}\\n\",\n            \"# TYPE chronos_raft_term gauge\\n\",\n            \"chronos_raft_term {}\\n\",\n            \"# TYPE chronos_raft_role gauge\\n\",\n            \"chronos_raft_role {}\\n\",\n            \"# TYPE chronos_storage_size_bytes gauge\\n\",\n            \"chronos_storage_size_bytes {}\\n\",\n        ),\n        reads, writes, term, role_value, storage_size,\n    )\n}\n\nasync fn build_health(node: Arc\u003cMutex\u003cRaftNode\u003e\u003e) -\u003e String {\n    let (role, term) = {\n        let node_guard = node.lock().await;\n        let role_str = match node_guard.state().role {\n            NodeRole::Follower =\u003e \"Follower\",\n            NodeRole::Candidate =\u003e \"Candidate\",\n            NodeRole::Leader =\u003e \"Leader\",\n        };\n        (role_str.to_string(), node_guard.state().current_term)\n    };\n\n    format!(\n        \"{{\\\"status\\\":\\\"ok\\\",\\\"role\\\":\\\"{}\\\",\\\"term\\\":{}}}\",\n        role, term\n    )\n}\n\nfn dir_size(path: \u0026str) -\u003e u64 {\n    use std::fs;\n    use std::path::Path;\n\n    fn walk(path: \u0026Path, acc: \u0026mut u64) {\n        if let Ok(entries) = fs::read_dir(path) {\n            for entry in entries.flatten() {\n                let p = entry.path();\n                if let Ok(meta) = entry.metadata() {\n                    if meta.is_file() {\n                        *acc += meta.len();\n                    } else if meta.is_dir() {\n                        walk(\u0026p, acc);\n                    }\n                }\n            }\n        }\n    }\n\n    let mut total = 0u64;\n    walk(Path::new(path), \u0026mut total);\n    total\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::raft::RaftConfig;\n    use crate::raft::RaftNode;\n    use std::sync::Arc;\n    use tempfile::tempdir;\n    use tokio::sync::Mutex;\n\n    #[tokio::test]\n    async fn health_reports_ok_with_initial_follower_state() {\n        let tmp_dir = tempdir().expect(\"tempdir\");\n        let data_dir = tmp_dir.path().to_string_lossy().to_string();\n\n        let config = RaftConfig::new(\"node1\", \u0026data_dir);\n        let node = Arc::new(Mutex::new(RaftNode::new(config)));\n\n        let body = build_health(Arc::clone(\u0026node)).await;\n\n        assert!(body.contains(\"\\\"status\\\":\\\"ok\\\"\"));\n        assert!(body.contains(\"\\\"role\\\":\\\"Follower\\\"\"));\n        assert!(body.contains(\"\\\"term\\\":0\"));\n    }\n\n    #[tokio::test]\n    async fn metrics_exports_expected_keys() {\n        let tmp_dir = tempdir().expect(\"tempdir\");\n        let data_dir = tmp_dir.path().to_string_lossy().to_string();\n\n        let config = RaftConfig::new(\"node1\", \u0026data_dir);\n        let node = Arc::new(Mutex::new(RaftNode::new(config)));\n\n        // Record some SQL activity to touch the metrics counters.\n        metrics::record_sql(true);\n        metrics::record_sql(false);\n\n        let body = build_metrics(Arc::clone(\u0026node), data_dir).await;\n\n        // Check that the main Prometheus metrics keys are present. We don't assert on\n        // exact numeric values to keep the test robust across runs.\n        assert!(body.contains(\"chronos_sql_requests_total{kind=\\\"read\\\"}\"));\n        assert!(body.contains(\"chronos_sql_requests_total{kind=\\\"write\\\"}\"));\n        assert!(body.contains(\"chronos_raft_term\"));\n        assert!(body.contains(\"chronos_raft_role\"));\n        assert!(body.contains(\"chronos_storage_size_bytes\"));\n    }\n}\n","traces":[{"line":12,"address":[13747184],"length":1,"stats":{"Line":0}},{"line":18,"address":[14776547,14776658],"length":1,"stats":{"Line":0}},{"line":20,"address":[13335749,13334678,13335520,13335755],"length":1,"stats":{"Line":0}},{"line":21,"address":[14747861],"length":1,"stats":{"Line":0}},{"line":22,"address":[14747884],"length":1,"stats":{"Line":0}},{"line":23,"address":[17104843,17104908],"length":1,"stats":{"Line":0}},{"line":24,"address":[14639553,14639781,14639670,14639632,14639760,14639888],"length":1,"stats":{"Line":0}},{"line":25,"address":[14748168,14748284,14748715,14748384],"length":1,"stats":{"Line":0}},{"line":26,"address":[14778149,14778214],"length":1,"stats":{"Line":0}},{"line":27,"address":[14649163],"length":1,"stats":{"Line":0}},{"line":28,"address":[14550871,14550938],"length":1,"stats":{"Line":0}},{"line":29,"address":[14551099,14550943,14551454,14551056,14551302],"length":1,"stats":{"Line":0}},{"line":34,"address":[18384232,18383935,18383726,18383999],"length":1,"stats":{"Line":0}},{"line":37,"address":[14399120],"length":1,"stats":{"Line":0}},{"line":43,"address":[14779512,14779693],"length":1,"stats":{"Line":0}},{"line":44,"address":[17106883,17106965],"length":1,"stats":{"Line":0}},{"line":46,"address":[14552456],"length":1,"stats":{"Line":0}},{"line":47,"address":[18387228,18387368],"length":1,"stats":{"Line":0}},{"line":48,"address":[14642099,14643516,14642398,14641372],"length":1,"stats":{"Line":0}},{"line":49,"address":[14653154,14652916],"length":1,"stats":{"Line":0}},{"line":52,"address":[14653162,14653050,14653289,14653113,14652923],"length":1,"stats":{"Line":0}},{"line":55,"address":[17107414,17107544],"length":1,"stats":{"Line":0}},{"line":56,"address":[18255513],"length":1,"stats":{"Line":0}},{"line":57,"address":[14782661,14782899],"length":1,"stats":{"Line":0}},{"line":60,"address":[14636796,14636923,14637035,14637162,14636986],"length":1,"stats":{"Line":0}},{"line":63,"address":[14553280,14552729],"length":1,"stats":{"Line":0}},{"line":64,"address":[13338577],"length":1,"stats":{"Line":0}},{"line":65,"address":[14635077,14637214,14634943,14633734],"length":1,"stats":{"Line":0}},{"line":66,"address":[14654300,14654411],"length":1,"stats":{"Line":0}},{"line":67,"address":[13341317],"length":1,"stats":{"Line":0}},{"line":68,"address":[17110841],"length":1,"stats":{"Line":0}},{"line":69,"address":[14556432,14556529],"length":1,"stats":{"Line":0}},{"line":71,"address":[14556645,14556883],"length":1,"stats":{"Line":0}},{"line":74,"address":[14638590,14638188,14638378,14638427,14638315],"length":1,"stats":{"Line":0}},{"line":77,"address":[14654819,14655726,14655641],"length":1,"stats":{"Line":0}},{"line":80,"address":[14646468,14646441,14646595,14646513,14646314],"length":1,"stats":{"Line":0}},{"line":84,"address":[17110691],"length":1,"stats":{"Line":0}},{"line":85,"address":[14637667,14638989],"length":1,"stats":{"Line":0}},{"line":86,"address":[14785215,14784977],"length":1,"stats":{"Line":0}},{"line":89,"address":[14557815,14557988,14557703,14557766,14557576],"length":1,"stats":{"Line":0}},{"line":93,"address":[13341058],"length":1,"stats":{"Line":0}},{"line":94,"address":[14637454,14639620],"length":1,"stats":{"Line":0}},{"line":95,"address":[14647654,14647416],"length":1,"stats":{"Line":0}},{"line":98,"address":[14756077,14755887,14756014,14756126,14756874],"length":1,"stats":{"Line":0}},{"line":103,"address":[14652294,14652209,14651832],"length":1,"stats":{"Line":0}},{"line":106,"address":[14652217,14652325,14652141,14652168,14652014],"length":1,"stats":{"Line":0}},{"line":110,"address":[13339237,13337974,13339323],"length":1,"stats":{"Line":0}},{"line":113,"address":[13343744],"length":1,"stats":{"Line":0}},{"line":116,"address":[14645296,14645729,14646352,14647012,14645351,14645465],"length":1,"stats":{"Line":4}},{"line":117,"address":[14744920,14744772],"length":1,"stats":{"Line":2}},{"line":119,"address":[14775276],"length":1,"stats":{"Line":1}},{"line":120,"address":[18259853],"length":1,"stats":{"Line":1}},{"line":121,"address":[14646045,14645972],"length":1,"stats":{"Line":2}},{"line":126,"address":[13333229,13333286],"length":1,"stats":{"Line":2}},{"line":129,"address":[14746521,14745837,14745555,14745925,14745648,14746512],"length":1,"stats":{"Line":6}},{"line":130,"address":[14516736],"length":1,"stats":{"Line":4}},{"line":133,"address":[14637469],"length":1,"stats":{"Line":1}},{"line":149,"address":[14545579,14545847,14546905,14545536,14545662,14546798],"length":1,"stats":{"Line":4}},{"line":150,"address":[14628016],"length":1,"stats":{"Line":1}},{"line":151,"address":[14545878,14545646,14545689,14545749],"length":1,"stats":{"Line":2}},{"line":152,"address":[14773559,14773486],"length":1,"stats":{"Line":2}},{"line":153,"address":[13331759],"length":1,"stats":{"Line":1}},{"line":154,"address":[14644584],"length":1,"stats":{"Line":0}},{"line":155,"address":[14635477],"length":1,"stats":{"Line":0}},{"line":157,"address":[14627824],"length":1,"stats":{"Line":1}},{"line":160,"address":[14635830,14635746],"length":1,"stats":{"Line":2}},{"line":166,"address":[14399264],"length":1,"stats":{"Line":1}},{"line":170,"address":[16216288,16217184,16217335],"length":1,"stats":{"Line":1}},{"line":171,"address":[13671633,13671565],"length":1,"stats":{"Line":2}},{"line":172,"address":[13747818,13747700,13747628],"length":1,"stats":{"Line":3}},{"line":173,"address":[13896313],"length":1,"stats":{"Line":1}},{"line":174,"address":[16216790,16216941,16216858],"length":1,"stats":{"Line":3}},{"line":175,"address":[17146020,17146231,17146079],"length":1,"stats":{"Line":2}},{"line":176,"address":[13896780,13896656,13896743],"length":1,"stats":{"Line":0}},{"line":177,"address":[13771664,13771629],"length":1,"stats":{"Line":2}},{"line":178,"address":[16217073],"length":1,"stats":{"Line":1}},{"line":185,"address":[17145310],"length":1,"stats":{"Line":1}},{"line":186,"address":[13770854],"length":1,"stats":{"Line":1}},{"line":187,"address":[14399306],"length":1,"stats":{"Line":1}}],"covered":28,"coverable":79},{"path":["/","home","azureuser","Documents","Chronos","src","network","ingest.rs"],"content":"use std::collections::HashMap;\nuse std::sync::Arc;\n\nuse tokio::sync::{mpsc::UnboundedReceiver, Mutex};\nuse tokio::time::{sleep, Duration};\n\nuse crate::executor::Executor;\nuse crate::parser::{Ast, Statement, Value};\n\n#[derive(Debug, Clone, serde::Deserialize)]\npub struct IngestRequest {\n    pub device_id: String,\n    pub ts: i64,\n    pub seq: u64,\n    pub metrics: HashMap\u003cString, f64\u003e,\n}\n\npub async fn run_ingest_worker(\n    mut rx: UnboundedReceiver\u003cIngestRequest\u003e,\n    executor: Arc\u003cMutex\u003cExecutor\u003e\u003e,\n) {\n    while let Some(msg) = rx.recv().await {\n        for (metric, value) in msg.metrics.iter() {\n            let mut attempts: u32 = 0;\n            let max_attempts: u32 = 5;\n\n            loop {\n                attempts += 1;\n\n                let ast = build_insert_ast(\u0026msg, metric, *value);\n\n                let result = {\n                    let mut exec = executor.lock().await;\n                    exec.execute(ast).await\n                };\n\n                match result {\n                    Ok(_) =\u003e {\n                        break;\n                    }\n                    Err(e) =\u003e {\n                        log::error!(\n                            \"Ingest worker: failed to insert reading device_id={} ts={} seq={} metric={} on attempt {}: {}\",\n                            msg.device_id,\n                            msg.ts,\n                            msg.seq,\n                            metric,\n                            attempts,\n                            e\n                        );\n                        if attempts \u003e= max_attempts {\n                            log::error!(\n                                \"Ingest worker: giving up on reading device_id={} ts={} seq={} metric={} after {} attempts\",\n                                msg.device_id,\n                                msg.ts,\n                                msg.seq,\n                                metric,\n                                attempts\n                            );\n                            break;\n                        }\n                        sleep(Duration::from_millis(200)).await;\n                    }\n                }\n            }\n        }\n    }\n}\n\nfn build_insert_ast(msg: \u0026IngestRequest, metric: \u0026str, value: f64) -\u003e Ast {\n    let table_name = \"readings\".to_string();\n    let reading_id = format!(\"{}:{}:{}:{}\", msg.device_id, msg.ts, msg.seq, metric);\n\n    let columns = Some(vec![\n        \"reading_id\".to_string(),\n        \"device_id\".to_string(),\n        \"ts\".to_string(),\n        \"seq\".to_string(),\n        \"metric\".to_string(),\n        \"value\".to_string(),\n    ]);\n\n    let values = vec![\n        Value::String(reading_id),\n        Value::String(msg.device_id.clone()),\n        Value::Integer(msg.ts),\n        Value::Integer(msg.seq as i64),\n        Value::String(metric.to_string()),\n        Value::Float(value),\n    ];\n\n    Ast::Statement(Statement::Insert {\n        table_name,\n        columns,\n        values,\n    })\n}\n","traces":[{"line":18,"address":[15641296],"length":1,"stats":{"Line":0}},{"line":22,"address":[14838290,14842002,14842095,14838180,14838350,14838209],"length":1,"stats":{"Line":0}},{"line":23,"address":[14713564,14712721,14712692,14713515],"length":1,"stats":{"Line":0}},{"line":24,"address":[13121573],"length":1,"stats":{"Line":0}},{"line":25,"address":[14614502],"length":1,"stats":{"Line":0}},{"line":27,"address":[17166036,17169088],"length":1,"stats":{"Line":0}},{"line":28,"address":[14693161,14693073],"length":1,"stats":{"Line":0}},{"line":30,"address":[18347420,18347604],"length":1,"stats":{"Line":0}},{"line":33,"address":[14611808,14610979,14610819,14611925],"length":1,"stats":{"Line":0}},{"line":34,"address":[17167031,17165416,17166717,17166804,17165592],"length":1,"stats":{"Line":0}},{"line":37,"address":[14711156],"length":1,"stats":{"Line":0}},{"line":41,"address":[14694380],"length":1,"stats":{"Line":0}},{"line":42,"address":[18348706,18348838,18348801],"length":1,"stats":{"Line":0}},{"line":51,"address":[14702191],"length":1,"stats":{"Line":0}},{"line":52,"address":[14841166,14841201,14841020],"length":1,"stats":{"Line":0}},{"line":62,"address":[13118058,13120693,13118234,13120760,13118268],"length":1,"stats":{"Line":0}},{"line":70,"address":[17995792,17998168,17998073],"length":1,"stats":{"Line":0}},{"line":71,"address":[15442503],"length":1,"stats":{"Line":0}},{"line":72,"address":[12890430,12890549],"length":1,"stats":{"Line":0}},{"line":74,"address":[15442905,15443221,15443365,15443406,15444800,15443293,15442963,15443002,15443077,15443149],"length":1,"stats":{"Line":0}},{"line":75,"address":[15524507],"length":1,"stats":{"Line":0}},{"line":76,"address":[15670454],"length":1,"stats":{"Line":0}},{"line":77,"address":[12891002],"length":1,"stats":{"Line":0}},{"line":78,"address":[15537638],"length":1,"stats":{"Line":0}},{"line":79,"address":[17996606],"length":1,"stats":{"Line":0}},{"line":80,"address":[15524870],"length":1,"stats":{"Line":0}},{"line":83,"address":[15444735,15443884,15444044,15443715,15443781,15444169],"length":1,"stats":{"Line":0}},{"line":84,"address":[15671197],"length":1,"stats":{"Line":0}},{"line":85,"address":[15671266,15671341],"length":1,"stats":{"Line":0}},{"line":86,"address":[12891837],"length":1,"stats":{"Line":0}},{"line":87,"address":[15443995],"length":1,"stats":{"Line":0}},{"line":88,"address":[15671502,15671423],"length":1,"stats":{"Line":0}},{"line":89,"address":[15671550],"length":1,"stats":{"Line":0}},{"line":92,"address":[17997872],"length":1,"stats":{"Line":0}},{"line":93,"address":[15444441],"length":1,"stats":{"Line":0}},{"line":94,"address":[12892344],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":36},{"path":["/","home","azureuser","Documents","Chronos","src","network","metrics.rs"],"content":"use std::sync::atomic::{AtomicU64, Ordering};\n\npub static SQL_READ_TOTAL: AtomicU64 = AtomicU64::new(0);\npub static SQL_WRITE_TOTAL: AtomicU64 = AtomicU64::new(0);\n\npub fn record_sql(is_read: bool) {\n    if is_read {\n        SQL_READ_TOTAL.fetch_add(1, Ordering::Relaxed);\n    } else {\n        SQL_WRITE_TOTAL.fetch_add(1, Ordering::Relaxed);\n    }\n}\n\npub fn snapshot_sql() -\u003e (u64, u64) {\n    (\n        SQL_READ_TOTAL.load(Ordering::Relaxed),\n        SQL_WRITE_TOTAL.load(Ordering::Relaxed),\n    )\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn record_and_snapshot_move_counters_forward() {\n        let (read_before, write_before) = snapshot_sql();\n\n        // Record a read and a write. Other tests may also be updating\n        // these counters concurrently, so we only assert monotonicity\n        // and that the total count increases by at least 2.\n        record_sql(true);\n        record_sql(false);\n\n        let (read_after, write_after) = snapshot_sql();\n\n        assert!(read_after \u003e= read_before);\n        assert!(write_after \u003e= write_before);\n\n        let total_before = read_before + write_before;\n        let total_after = read_after + write_after;\n        assert!(\n            total_after \u003e= total_before + 2,\n            \"expected at least two additional operations recorded\",\n        );\n    }\n}\n","traces":[{"line":6,"address":[14589488],"length":1,"stats":{"Line":1}},{"line":7,"address":[14816909],"length":1,"stats":{"Line":1}},{"line":8,"address":[14787206],"length":1,"stats":{"Line":1}},{"line":10,"address":[18424049],"length":1,"stats":{"Line":1}},{"line":14,"address":[17144128],"length":1,"stats":{"Line":1}},{"line":16,"address":[18424100],"length":1,"stats":{"Line":1}},{"line":17,"address":[13080895],"length":1,"stats":{"Line":1}}],"covered":7,"coverable":7},{"path":["/","home","azureuser","Documents","Chronos","src","network","mod.rs"],"content":"// Temporarily simplified network module for testing\n#[derive(Debug)]\npub enum NetworkError {\n    ConnectionError(String),\n    RpcError(String),\n    TransportError(String),\n}\n\nimpl From\u003ctonic::transport::Error\u003e for NetworkError {\n    fn from(err: tonic::transport::Error) -\u003e Self {\n        NetworkError::TransportError(err.to_string())\n    }\n}\n\nimpl From\u003ctonic::Status\u003e for NetworkError {\n    fn from(status: tonic::Status) -\u003e Self {\n        NetworkError::RpcError(status.to_string())\n    }\n}\n\nimpl std::fmt::Display for NetworkError {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        match self {\n            NetworkError::ConnectionError(e) =\u003e write!(f, \"Connection error: {e}\"),\n            NetworkError::RpcError(e) =\u003e write!(f, \"RPC error: {e}\"),\n            NetworkError::TransportError(e) =\u003e write!(f, \"Transport error: {e}\"),\n        }\n    }\n}\n\nimpl std::error::Error for NetworkError {}\n\npub mod client;\npub mod connectivity;\npub mod http_admin;\npub mod ingest;\npub mod metrics;\npub mod offline_queue;\npub mod server;\npub mod sync_status;\npub mod sync_worker;\n\npub use connectivity::*;\npub use ingest::{run_ingest_worker, IngestRequest};\npub use offline_queue::*;\npub use server::{HealthServer, SyncServer, SyncStatusServer};\npub use sync_status::{SharedSyncStatus, SyncStatusState};\npub use sync_worker::SyncWorker;\n\npub mod proto {\n    tonic::include_proto!(\"raft\");\n}\n\npub use client::{RaftClient, SqlClient, SyncClient};\npub use server::{RaftServer, SqlServer};\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use tonic::Status;\n\n    #[test]\n    fn display_includes_error_kind() {\n        let conn = NetworkError::ConnectionError(\"boom\".to_string());\n        assert!(format!(\"{conn}\").contains(\"Connection error\"));\n\n        let rpc = NetworkError::RpcError(\"bad\".to_string());\n        assert!(format!(\"{rpc}\").contains(\"RPC error\"));\n\n        let transport = NetworkError::TransportError(\"down\".to_string());\n        assert!(format!(\"{transport}\").contains(\"Transport error\"));\n    }\n\n    #[test]\n    fn from_tonic_status_maps_to_rpc_error() {\n        let status = Status::invalid_argument(\"oops\");\n        let err: NetworkError = status.into();\n        match err {\n            NetworkError::RpcError(msg) =\u003e {\n                assert!(msg.contains(\"oops\"));\n            }\n            other =\u003e panic!(\"expected RpcError, got {other:?}\"),\n        }\n    }\n}\n","traces":[{"line":10,"address":[15882639,15882512],"length":1,"stats":{"Line":0}},{"line":11,"address":[15978717,15978659],"length":1,"stats":{"Line":0}},{"line":16,"address":[15884656,15884783],"length":1,"stats":{"Line":1}},{"line":17,"address":[15993715,15993773],"length":1,"stats":{"Line":2}},{"line":22,"address":[18451680],"length":1,"stats":{"Line":1}},{"line":23,"address":[18451712],"length":1,"stats":{"Line":1}},{"line":24,"address":[16125815],"length":1,"stats":{"Line":1}},{"line":25,"address":[16125913],"length":1,"stats":{"Line":1}},{"line":26,"address":[12723936],"length":1,"stats":{"Line":1}}],"covered":7,"coverable":9},{"path":["/","home","azureuser","Documents","Chronos","src","network","offline_queue.rs"],"content":"use std::collections::VecDeque;\n\nuse crate::common::timestamp::HybridTimestamp;\nuse crate::storage::wal::Operation;\n\n#[derive(Debug, Clone)]\npub struct QueuedOperation {\n    pub timestamp: HybridTimestamp,\n    pub operation: Operation,\n}\n\n#[derive(Debug, Clone, Copy)]\npub enum OverflowStrategy {\n    RejectNew,\n    DropOldest,\n}\n\n#[derive(Debug)]\npub enum OfflineQueueError {\n    QueueFull,\n}\n\npub type Result\u003cT\u003e = std::result::Result\u003cT, OfflineQueueError\u003e;\n\npub struct OfflineQueue {\n    memory_queue: VecDeque\u003cQueuedOperation\u003e,\n    max_size: usize,\n    strategy: OverflowStrategy,\n}\n\nimpl OfflineQueue {\n    pub fn new(max_size: usize, strategy: OverflowStrategy) -\u003e Self {\n        Self {\n            memory_queue: VecDeque::new(),\n            max_size,\n            strategy,\n        }\n    }\n\n    pub fn len(\u0026self) -\u003e usize {\n        self.memory_queue.len()\n    }\n\n    pub fn is_empty(\u0026self) -\u003e bool {\n        self.memory_queue.is_empty()\n    }\n\n    pub fn enqueue(\u0026mut self, operation: Operation, timestamp: HybridTimestamp) -\u003e Result\u003c()\u003e {\n        if self.memory_queue.len() \u003e= self.max_size {\n            match self.strategy {\n                OverflowStrategy::RejectNew =\u003e {\n                    return Err(OfflineQueueError::QueueFull);\n                }\n                OverflowStrategy::DropOldest =\u003e {\n                    self.memory_queue.pop_front();\n                }\n            }\n        }\n\n        self.memory_queue.push_back(QueuedOperation {\n            timestamp,\n            operation,\n        });\n        Ok(())\n    }\n\n    pub fn drain(\u0026mut self, limit: usize) -\u003e Vec\u003cQueuedOperation\u003e {\n        let mut drained = Vec::new();\n        for _ in 0..limit {\n            if let Some(op) = self.memory_queue.pop_front() {\n                drained.push(op);\n            } else {\n                break;\n            }\n        }\n        drained\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use uhlc::HLC;\n\n    #[test]\n    fn enqueue_and_drain_respects_max_size_drop_oldest() {\n        let mut queue = OfflineQueue::new(2, OverflowStrategy::DropOldest);\n        let ts = HybridTimestamp {\n            ts: HLC::default().new_timestamp(),\n            node_id: 1,\n        };\n\n        queue\n            .enqueue(\n                Operation::Delete {\n                    table: \"t\".into(),\n                    key: b\"k1\".to_vec(),\n                },\n                ts,\n            )\n            .unwrap();\n        queue\n            .enqueue(\n                Operation::Delete {\n                    table: \"t\".into(),\n                    key: b\"k2\".to_vec(),\n                },\n                ts,\n            )\n            .unwrap();\n        queue\n            .enqueue(\n                Operation::Delete {\n                    table: \"t\".into(),\n                    key: b\"k3\".to_vec(),\n                },\n                ts,\n            )\n            .unwrap();\n\n        assert_eq!(queue.len(), 2);\n        let drained = queue.drain(10);\n        assert_eq!(drained.len(), 2);\n    }\n\n    #[test]\n    fn enqueue_rejects_when_full_and_strategy_reject_new() {\n        let mut queue = OfflineQueue::new(1, OverflowStrategy::RejectNew);\n        let ts = HybridTimestamp {\n            ts: HLC::default().new_timestamp(),\n            node_id: 1,\n        };\n\n        queue\n            .enqueue(\n                Operation::Delete {\n                    table: \"t\".into(),\n                    key: b\"k1\".to_vec(),\n                },\n                ts,\n            )\n            .unwrap();\n        let res = queue.enqueue(\n            Operation::Delete {\n                table: \"t\".into(),\n                key: b\"k2\".to_vec(),\n            },\n            ts,\n        );\n        assert!(matches!(res, Err(OfflineQueueError::QueueFull)));\n    }\n}\n","traces":[{"line":32,"address":[14693936],"length":1,"stats":{"Line":1}},{"line":34,"address":[13842708],"length":1,"stats":{"Line":1}},{"line":40,"address":[14693920],"length":1,"stats":{"Line":1}},{"line":41,"address":[13998981],"length":1,"stats":{"Line":1}},{"line":44,"address":[13775648],"length":1,"stats":{"Line":0}},{"line":45,"address":[13482869],"length":1,"stats":{"Line":0}},{"line":48,"address":[13999552,14000013,13999984],"length":1,"stats":{"Line":1}},{"line":49,"address":[13968622,13968705],"length":1,"stats":{"Line":2}},{"line":50,"address":[14694811],"length":1,"stats":{"Line":1}},{"line":52,"address":[13482765],"length":1,"stats":{"Line":1}},{"line":55,"address":[17612310,17612264],"length":1,"stats":{"Line":2}},{"line":60,"address":[13999757],"length":1,"stats":{"Line":1}},{"line":62,"address":[13968730],"length":1,"stats":{"Line":1}},{"line":64,"address":[13775593],"length":1,"stats":{"Line":1}},{"line":67,"address":[14694064,14694460,14694466],"length":1,"stats":{"Line":1}},{"line":68,"address":[16319547],"length":1,"stats":{"Line":1}},{"line":69,"address":[16319642,16319566],"length":1,"stats":{"Line":2}},{"line":70,"address":[13842985,13843045],"length":1,"stats":{"Line":2}},{"line":71,"address":[17611848],"length":1,"stats":{"Line":1}},{"line":76,"address":[14694263],"length":1,"stats":{"Line":1}}],"covered":18,"coverable":20},{"path":["/","home","azureuser","Documents","Chronos","src","network","server.rs"],"content":"use log::{debug, error, info};\nuse std::collections::HashMap;\nuse std::sync::Arc;\nuse tokio::sync::{Mutex, RwLock};\nuse tonic::{Request, Response, Status};\n\nuse crate::common::timestamp::HybridTimestamp;\nuse crate::executor::Executor;\nuse crate::network::proto::health_service_server::HealthService;\nuse crate::network::proto::raft_service_server::RaftService;\nuse crate::network::proto::sql_service_server::SqlService;\nuse crate::network::proto::sync_service_server::SyncService;\nuse crate::network::proto::sync_status_service_server::SyncStatusService;\nuse crate::parser::Parser;\nuse crate::raft::{RaftMessage, RaftNode};\nuse crate::storage::wal::Operation as WalOperation;\nuse crate::storage::StorageError;\nuse uhlc::HLC;\n\nuse super::proto::*;\nuse crate::network::metrics;\nuse crate::network::sync_status::SharedSyncStatus;\nuse crate::network::ConnectivityState;\n\ntype LwwStateMap = HashMap\u003c(String, Vec\u003cu8\u003e), HybridTimestamp\u003e;\n\n#[derive(Debug, Clone, Copy)]\nenum Role {\n    Admin,\n    ReadOnly,\n}\n\n#[derive(Debug, Clone)]\nstruct AuthContext {\n    user: String,\n    role: Option\u003cRole\u003e,\n}\n\nfn load_auth_tokens_from_env() -\u003e (Option\u003cString\u003e, Option\u003cString\u003e) {\n    let admin = std::env::var(\"CHRONOS_AUTH_TOKEN_ADMIN\").ok();\n    let readonly = std::env::var(\"CHRONOS_AUTH_TOKEN_READONLY\").ok();\n    (admin, readonly)\n}\n\n#[allow(clippy::result_large_err)]\nfn authenticate_request(\n    metadata: \u0026tonic::metadata::MetadataMap,\n    is_read_query: bool,\n) -\u003e Result\u003cAuthContext, Status\u003e {\n    let (admin_token, readonly_token) = load_auth_tokens_from_env();\n    let require_auth = admin_token.is_some() || readonly_token.is_some();\n\n    let user = metadata\n        .get(\"x-chronos-user\")\n        .and_then(|v| v.to_str().ok())\n        .unwrap_or(\"anonymous\")\n        .to_string();\n\n    if !require_auth {\n        return Ok(AuthContext { user, role: None });\n    }\n\n    let raw = metadata\n        .get(\"authorization\")\n        .ok_or_else(|| Status::unauthenticated(\"missing authorization header\"))?;\n    let raw_str = raw\n        .to_str()\n        .map_err(|_| Status::unauthenticated(\"invalid authorization header\"))?;\n\n    const PREFIX: \u0026str = \"Bearer \";\n    if !raw_str.starts_with(PREFIX) {\n        return Err(Status::unauthenticated(\"invalid authorization scheme\"));\n    }\n    let token = \u0026raw_str[PREFIX.len()..];\n\n    let role = if let Some(ref admin) = admin_token {\n        if token == admin {\n            Role::Admin\n        } else if let Some(ref ro) = readonly_token {\n            if token == ro {\n                Role::ReadOnly\n            } else {\n                return Err(Status::unauthenticated(\"invalid token\"));\n            }\n        } else {\n            return Err(Status::unauthenticated(\"invalid token\"));\n        }\n    } else if let Some(ref ro) = readonly_token {\n        if token == ro {\n            Role::ReadOnly\n        } else {\n            return Err(Status::unauthenticated(\"invalid token\"));\n        }\n    } else {\n        // Should not happen if require_auth is false above, but keep a safe default.\n        return Ok(AuthContext { user, role: None });\n    };\n\n    if let Role::ReadOnly = role {\n        if !is_read_query {\n            return Err(Status::permission_denied(\n                \"write operations are not allowed for read-only role\",\n            ));\n        }\n    }\n\n    Ok(AuthContext {\n        user,\n        role: Some(role),\n    })\n}\n\n#[derive(Default, Debug)]\nstruct SyncStats {\n    /// Total number of operations successfully applied via SyncServer.\n    total_applied: u64,\n    /// Total number of operations skipped due to LWW (stale timestamps).\n    total_skipped_lww: u64,\n}\n\npub struct RaftServer {\n    node: Arc\u003cMutex\u003cRaftNode\u003e\u003e,\n}\n\nimpl RaftServer {\n    pub fn new(node: Arc\u003cMutex\u003cRaftNode\u003e\u003e) -\u003e Self {\n        Self { node }\n    }\n}\n\npub struct SyncStatusServer {\n    state: SharedSyncStatus,\n}\n\nimpl SyncStatusServer {\n    pub fn new(state: SharedSyncStatus) -\u003e Self {\n        Self { state }\n    }\n}\n\n#[tonic::async_trait]\nimpl SyncStatusService for SyncStatusServer {\n    async fn get_sync_status(\n        \u0026self,\n        _request: Request\u003cSyncStatusRequest\u003e,\n    ) -\u003e Result\u003cResponse\u003cSyncStatusResponse\u003e, Status\u003e {\n        let status = self.state.lock().await;\n        Ok(Response::new(SyncStatusResponse {\n            last_sync_ts_ms: status.last_sync_ts_ms,\n            last_sync_applied: status.last_sync_applied,\n            pending_ops: status.pending_ops,\n            last_error: status.last_error.clone().unwrap_or_default(),\n        }))\n    }\n}\n\n#[tonic::async_trait]\nimpl RaftService for RaftServer {\n    async fn request_vote(\n        \u0026self,\n        request: Request\u003cRequestVoteRequest\u003e,\n    ) -\u003e Result\u003cResponse\u003cRequestVoteResponse\u003e, Status\u003e {\n        let req = request.into_inner();\n        debug!(\"Received RequestVote: {:?}\", req);\n\n        let mut node = self.node.lock().await;\n\n        // Convert to internal message format\n        let message = RaftMessage::RequestVote {\n            term: req.term,\n            candidate_id: req.candidate_id,\n            last_log_index: req.last_log_index,\n            last_log_term: req.last_log_term,\n        };\n\n        // Process the message\n        let mut response = RequestVoteResponse {\n            term: node.state().current_term,\n            vote_granted: false,\n        };\n\n        match node.handle_message(message) {\n            Ok(reply) =\u003e {\n                if let Some(RaftMessage::RequestVoteResponse { term, vote_granted }) = reply {\n                    response.term = term;\n                    response.vote_granted = vote_granted;\n                }\n            }\n            Err(e) =\u003e {\n                error!(\"Error handling RequestVote: {e}\");\n                return Err(Status::internal(format!(\"Internal error: {e}\")));\n            }\n        }\n\n        Ok(Response::new(response))\n    }\n\n    async fn pre_vote(\n        \u0026self,\n        request: Request\u003cRequestVoteRequest\u003e,\n    ) -\u003e Result\u003cResponse\u003cRequestVoteResponse\u003e, Status\u003e {\n        let req = request.into_inner();\n        debug!(\"Received PreVote: {:?}\", req);\n\n        let mut node = self.node.lock().await;\n\n        // Convert to internal message format\n        let message = RaftMessage::PreVote {\n            term: req.term,\n            candidate_id: req.candidate_id,\n            last_log_index: req.last_log_index,\n            last_log_term: req.last_log_term,\n        };\n\n        // Process the message\n        let mut response = RequestVoteResponse {\n            term: node.state().current_term,\n            vote_granted: false,\n        };\n\n        match node.handle_message(message) {\n            Ok(reply) =\u003e {\n                if let Some(RaftMessage::PreVoteResponse { term, vote_granted }) = reply {\n                    response.term = term;\n                    response.vote_granted = vote_granted;\n                }\n            }\n            Err(e) =\u003e {\n                error!(\"Error handling PreVote: {e}\");\n                return Err(Status::internal(format!(\"Internal error: {e}\")));\n            }\n        }\n\n        Ok(Response::new(response))\n    }\n\n    async fn append_entries(\n        \u0026self,\n        request: Request\u003cAppendEntriesRequest\u003e,\n    ) -\u003e Result\u003cResponse\u003cAppendEntriesResponse\u003e, Status\u003e {\n        let req = request.into_inner();\n        debug!(\n            \"Received AppendEntries: term={}, leader={}, entries={}\",\n            req.term,\n            req.leader_id,\n            req.entries.len()\n        );\n\n        let mut node = self.node.lock().await;\n\n        // Convert entries to internal format\n        let entries = req\n            .entries\n            .into_iter()\n            .map(|e| crate::raft::LogEntry {\n                term: e.term,\n                command: e.command,\n            })\n            .collect();\n\n        // Convert to internal message format\n        let message = RaftMessage::AppendEntries {\n            term: req.term,\n            leader_id: req.leader_id,\n            prev_log_index: req.prev_log_index,\n            prev_log_term: req.prev_log_term,\n            entries,\n            leader_commit: req.leader_commit,\n        };\n\n        // Process the message\n        let mut response = AppendEntriesResponse {\n            term: node.state().current_term,\n            success: false,\n            match_index: 0,\n        };\n\n        match node.handle_message(message) {\n            Ok(reply) =\u003e {\n                if let Some(RaftMessage::AppendEntriesResponse {\n                    term,\n                    success,\n                    match_index,\n                }) = reply\n                {\n                    response.term = term;\n                    response.success = success;\n                    response.match_index = match_index;\n                }\n            }\n            Err(e) =\u003e {\n                error!(\"Error handling AppendEntries: {e}\");\n                return Err(Status::internal(format!(\"Internal error: {e}\")));\n            }\n        }\n\n        Ok(Response::new(response))\n    }\n}\n\npub struct HealthServer {\n    state: Arc\u003cRwLock\u003cConnectivityState\u003e\u003e,\n}\n\nimpl HealthServer {\n    pub fn new(state: Arc\u003cRwLock\u003cConnectivityState\u003e\u003e) -\u003e Self {\n        Self { state }\n    }\n}\n\n#[tonic::async_trait]\nimpl HealthService for HealthServer {\n    async fn get_connectivity(\n        \u0026self,\n        _request: Request\u003cHealthRequest\u003e,\n    ) -\u003e Result\u003cResponse\u003cHealthResponse\u003e, Status\u003e {\n        let state = *self.state.read().await;\n        let state_str = match state {\n            ConnectivityState::Connected =\u003e \"Connected\",\n            ConnectivityState::Disconnected =\u003e \"Disconnected\",\n            ConnectivityState::Reconnecting =\u003e \"Reconnecting\",\n        };\n        Ok(Response::new(HealthResponse {\n            state: state_str.to_string(),\n        }))\n    }\n}\n\npub struct SyncServer {\n    executor: Arc\u003cMutex\u003cExecutor\u003e\u003e,\n    lww_state: Arc\u003cMutex\u003cLwwStateMap\u003e\u003e,\n    stats: Arc\u003cMutex\u003cSyncStats\u003e\u003e,\n}\n\nimpl SyncServer {\n    pub fn new(executor: Arc\u003cMutex\u003cExecutor\u003e\u003e) -\u003e Self {\n        Self {\n            executor,\n            lww_state: Arc::new(Mutex::new(HashMap::new())),\n            stats: Arc::new(Mutex::new(SyncStats::default())),\n        }\n    }\n\n    /// Load the last applied sync ID for a given edge_id from the underlying\n    /// storage engine. This is implemented via a dedicated sled tree in\n    /// SledEngine; here we just delegate through the Executor.\n    async fn get_last_applied_id(\n        \u0026self,\n        executor: \u0026Executor,\n        edge_id: \u0026str,\n    ) -\u003e Result\u003cu64, StorageError\u003e {\n        // For now, we store the cursor in the same LWW timestamp tree using a\n        // reserved key prefix, keeping the complexity minimal. This can be\n        // refactored into a dedicated metadata tree if needed.\n        // We use an empty key and interpret the HybridTimestamp node_id\n        // field as the last applied ID.\n        if let Some(ts) = executor\n            .get_lww_timestamp(edge_id, \u0026[])\n            .await\n            .map_err(|e| StorageError::SledError(e.to_string()))?\n        {\n            Ok(ts.node_id)\n        } else {\n            Ok(0)\n        }\n    }\n\n    async fn set_last_applied_id(\n        \u0026self,\n        executor: \u0026mut Executor,\n        edge_id: \u0026str,\n        id: u64,\n    ) -\u003e Result\u003c(), StorageError\u003e {\n        let ts = HybridTimestamp {\n            ts: HLC::default().new_timestamp(),\n            node_id: id,\n        };\n        executor\n            .set_lww_timestamp(edge_id, \u0026[], ts)\n            .await\n            .map_err(|e| StorageError::SledError(e.to_string()))\n    }\n}\n\n#[tonic::async_trait]\nimpl SyncService for SyncServer {\n    async fn sync(\u0026self, request: Request\u003cSyncRequest\u003e) -\u003e Result\u003cResponse\u003cSyncResponse\u003e, Status\u003e {\n        let req = request.into_inner();\n        let mut applied: u64 = 0;\n        let mut skipped_lww: u64 = 0;\n\n        let mut executor = self.executor.lock().await;\n        let mut lww = self.lww_state.lock().await;\n\n        // Determine the last applied ID for this edge (delta sync cursor).\n        let edge_id = req.edge_id.clone();\n        let mut max_seen_id: u64 = 0;\n        let last_applied_id = match self.get_last_applied_id(\u0026executor, \u0026edge_id).await {\n            Ok(id) =\u003e id,\n            Err(e) =\u003e {\n                error!(\"Failed to get last_applied_id for edge {}: {}\", edge_id, e);\n                0\n            }\n        };\n\n        for op in req.operations {\n            // Skip operations whose IDs are already at or below the cursor\n            // for this edge. This avoids re-processing old batches after\n            // restarts.\n            if op.id \u003c= last_applied_id {\n                continue;\n            }\n\n            if op.id \u003e max_seen_id {\n                max_seen_id = op.id;\n            }\n            let data = op.data;\n            let decoded: Result\u003c\n                (\n                    crate::storage::offline_queue::PersistentQueuedOperation,\n                    usize,\n                ),\n                _,\n            \u003e = bincode::serde::decode_from_slice(\u0026data, bincode::config::standard());\n\n            match decoded {\n                Ok((entry, _len)) =\u003e {\n                    // Derive LWW key from the underlying operation\n                    let (table, key_bytes) = match \u0026entry.operation {\n                        WalOperation::Insert { table, key, .. } =\u003e (table.clone(), key.clone()),\n                        WalOperation::Update { table, key, .. } =\u003e (table.clone(), key.clone()),\n                        WalOperation::Delete { table, key } =\u003e (table.clone(), key.clone()),\n                    };\n                    let map_key = (table.clone(), key_bytes.clone());\n\n                    // Last-Write-Wins: consult in-memory cache first, then\n                    // persisted LWW metadata if needed. Skip if we have a\n                    // newer or equal timestamp.\n                    let ts = entry.timestamp;\n\n                    let prev_ts = match lww.get(\u0026map_key) {\n                        Some(prev) =\u003e Some(*prev),\n                        None =\u003e match executor.get_lww_timestamp(\u0026table, \u0026key_bytes).await {\n                            Ok(opt_ts) =\u003e {\n                                if let Some(persisted) = opt_ts {\n                                    lww.insert(map_key.clone(), persisted);\n                                    Some(persisted)\n                                } else {\n                                    None\n                                }\n                            }\n                            Err(e) =\u003e {\n                                error!(\n                                    \"LWW get_lww_timestamp error for table={} id={}: {}\",\n                                    table, entry.id, e\n                                );\n                                None\n                            }\n                        },\n                    };\n\n                    let should_apply = match prev_ts {\n                        Some(prev_ts) if prev_ts \u003e= ts =\u003e {\n                            info!(\n                                \"Skipping stale synced operation id={} due to LWW (prev_ts \u003e= new_ts)\",\n                                entry.id\n                            );\n                            skipped_lww += 1;\n                            false\n                        }\n                        _ =\u003e {\n                            lww.insert(map_key.clone(), ts);\n                            true\n                        }\n                    };\n\n                    if !should_apply {\n                        continue;\n                    }\n\n                    if let Err(e) = executor\n                        .apply_storage_operation(entry.operation.clone())\n                        .await\n                    {\n                        error!(\"Failed to apply synced operation id={}: {}\", entry.id, e);\n                        continue;\n                    }\n                    // Best-effort persist of the new LWW timestamp; if it\n                    // fails we still keep the in-memory view and applied\n                    // data, and will recompute on next sync.\n                    if let Err(e) = executor.set_lww_timestamp(\u0026table, \u0026key_bytes, ts).await {\n                        error!(\n                            \"Failed to persist LWW timestamp for table={} id={}: {}\",\n                            table, entry.id, e\n                        );\n                    }\n                    applied += 1;\n                }\n                Err(e) =\u003e {\n                    error!(\"Failed to decode SyncOperation id={}: {}\", op.id, e);\n                }\n            }\n        }\n\n        {\n            let mut stats = self.stats.lock().await;\n            stats.total_applied = stats.total_applied.saturating_add(applied);\n            stats.total_skipped_lww = stats.total_skipped_lww.saturating_add(skipped_lww);\n            info!(\n                \"SyncServer applied {} operations from edge (skipped_lww={}, total_applied={}, total_skipped_lww={})\",\n                applied,\n                skipped_lww,\n                stats.total_applied,\n                stats.total_skipped_lww,\n            );\n        }\n\n        // Update the per-edge cursor if we observed any new IDs.\n        if max_seen_id \u003e last_applied_id {\n            if let Err(e) = self\n                .set_last_applied_id(\u0026mut executor, \u0026edge_id, max_seen_id)\n                .await\n            {\n                error!(\n                    \"Failed to persist last_applied_id for edge {} to {}: {}\",\n                    edge_id, max_seen_id, e\n                );\n            }\n        }\n\n        Ok(Response::new(SyncResponse { applied }))\n    }\n}\n\npub struct SqlServer {\n    node: Arc\u003cMutex\u003cRaftNode\u003e\u003e,\n    executor: Arc\u003cMutex\u003cExecutor\u003e\u003e,\n}\n\nimpl SqlServer {\n    pub fn new(node: Arc\u003cMutex\u003cRaftNode\u003e\u003e, executor: Arc\u003cMutex\u003cExecutor\u003e\u003e) -\u003e Self {\n        Self { node, executor }\n    }\n}\n\n#[tonic::async_trait]\nimpl SqlService for SqlServer {\n    async fn execute_sql(\n        \u0026self,\n        request: Request\u003cSqlRequest\u003e,\n    ) -\u003e Result\u003cResponse\u003cSqlResponse\u003e, Status\u003e {\n        info!(\"SqlServer::execute_sql: ENTER\");\n\n        let sql = request.get_ref().sql.clone();\n        info!(\"SqlServer::execute_sql: Received SQL: {}\", sql);\n        let is_read_query = sql.trim_start().to_uppercase().starts_with(\"SELECT\");\n\n        let auth = authenticate_request(request.metadata(), is_read_query)?;\n        let role_label = match auth.role {\n            Some(Role::Admin) =\u003e \"Admin\",\n            Some(Role::ReadOnly) =\u003e \"ReadOnly\",\n            None =\u003e \"None\",\n        };\n        info!(\n            \"audit_sql user={} role={} sql={}\",\n            auth.user, role_label, sql\n        );\n\n        // Parse the SQL\n        let ast = match Parser::parse(\u0026sql) {\n            Ok(ast) =\u003e {\n                info!(\"SqlServer::execute_sql: parse OK\");\n                ast\n            }\n            Err(e) =\u003e {\n                error!(\"SQL parse error: {e}\");\n                return Ok(Response::new(SqlResponse {\n                    success: false,\n                    error: format!(\"Parse error: {e}\"),\n                    columns: vec![],\n                    rows: vec![],\n                }));\n            }\n        };\n\n        // Check if this node is the leader\n        let is_leader = {\n            let node = self.node.lock().await;\n            let is_leader = node.is_leader();\n            debug!(\"SqlServer::execute_sql: is_leader={}\", is_leader);\n            is_leader\n        };\n\n        if !is_leader {\n            info!(\"SqlServer::execute_sql: Not the leader, returning error\");\n            return Ok(Response::new(SqlResponse {\n                success: false,\n                error: \"Not the leader\".to_string(),\n                columns: vec![],\n                rows: vec![],\n            }));\n        }\n\n        // Use tokio Mutex for async-safe locking\n        let mut executor = self.executor.lock().await;\n        info!(\"SqlServer::execute_sql: calling Executor::execute\");\n        let result = executor.execute(ast).await.map_err(|e| {\n            error!(\"SqlServer::execute_sql: Executor::execute error: {e}\");\n            Status::internal(format!(\"Execution error: {e}\"))\n        })?;\n        info!(\"SqlServer::execute_sql: Executor::execute done\");\n\n        // Convert the result to the response format\n        let mut response = SqlResponse {\n            success: true,\n            error: \"\".to_string(),\n            columns: result.columns,\n            rows: vec![],\n        };\n\n        // Convert rows\n        for row in result.rows {\n            let mut proto_row = Row { values: vec![] };\n\n            for value in row {\n                let proto_value = match value {\n                    crate::parser::Value::String(s) =\u003e Value {\n                        value: Some(super::proto::value::Value::StringValue(s)),\n                    },\n                    crate::parser::Value::Integer(i) =\u003e Value {\n                        value: Some(super::proto::value::Value::IntValue(i)),\n                    },\n                    crate::parser::Value::Float(f) =\u003e Value {\n                        value: Some(super::proto::value::Value::FloatValue(f)),\n                    },\n                    crate::parser::Value::Boolean(b) =\u003e Value {\n                        value: Some(super::proto::value::Value::BoolValue(b)),\n                    },\n                    crate::parser::Value::Null =\u003e Value {\n                        value: Some(super::proto::value::Value::NullValue(true)),\n                    },\n                };\n\n                proto_row.values.push(proto_value);\n            }\n\n            response.rows.push(proto_row);\n        }\n\n        if response.success {\n            metrics::record_sql(is_read_query);\n        }\n        info!(\n            \"SqlServer::execute_sql: returning SqlResponse (success={})\",\n            response.success\n        );\n        Ok(Response::new(response))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::network::SyncStatusState;\n    use std::sync::Arc;\n    use tokio::sync::{Mutex as TokioMutex, RwLock};\n    use tonic::metadata::{AsciiMetadataValue, MetadataMap};\n    use tonic::{Code, Request};\n\n    fn make_metadata(user: \u0026str, auth_header: Option\u003c\u0026str\u003e) -\u003e MetadataMap {\n        let mut meta = MetadataMap::new();\n        meta.insert(\n            \"x-chronos-user\",\n            AsciiMetadataValue::try_from(user).expect(\"user meta\"),\n        );\n        if let Some(h) = auth_header {\n            meta.insert(\n                \"authorization\",\n                AsciiMetadataValue::try_from(h).expect(\"auth meta\"),\n            );\n        }\n        meta\n    }\n\n    #[test]\n    fn authenticate_request_allows_anonymous_when_no_tokens_set() {\n        std::env::remove_var(\"CHRONOS_AUTH_TOKEN_ADMIN\");\n        std::env::remove_var(\"CHRONOS_AUTH_TOKEN_READONLY\");\n\n        let meta = make_metadata(\"alice\", None);\n        let ctx = authenticate_request(\u0026meta, false).expect(\"auth should succeed\");\n        assert_eq!(ctx.user, \"alice\");\n        assert!(ctx.role.is_none());\n    }\n\n    #[test]\n    fn authenticate_request_admin_token_allows_write() {\n        std::env::set_var(\"CHRONOS_AUTH_TOKEN_ADMIN\", \"secret-admin\");\n        std::env::remove_var(\"CHRONOS_AUTH_TOKEN_READONLY\");\n\n        let meta = make_metadata(\"bob\", Some(\"Bearer secret-admin\"));\n        let ctx = authenticate_request(\u0026meta, false).expect(\"auth should succeed\");\n        assert_eq!(ctx.user, \"bob\");\n        matches!(ctx.role, Some(Role::Admin));\n    }\n\n    #[test]\n    fn authenticate_request_readonly_rejects_write_queries() {\n        std::env::remove_var(\"CHRONOS_AUTH_TOKEN_ADMIN\");\n        std::env::set_var(\"CHRONOS_AUTH_TOKEN_READONLY\", \"ro-token\");\n\n        let meta = make_metadata(\"carol\", Some(\"Bearer ro-token\"));\n        let err = authenticate_request(\u0026meta, false).unwrap_err();\n        assert_eq!(err.code(), Code::PermissionDenied);\n    }\n\n    #[tokio::test]\n    async fn health_server_reports_connectivity_state() {\n        let state = Arc::new(RwLock::new(ConnectivityState::Reconnecting));\n        let server = HealthServer::new(Arc::clone(\u0026state));\n\n        let req = Request::new(HealthRequest {});\n        let resp = server.get_connectivity(req).await.expect(\"health OK\");\n        let inner = resp.into_inner();\n        assert_eq!(inner.state, \"Reconnecting\");\n    }\n\n    #[tokio::test]\n    async fn sync_status_server_returns_current_status() {\n        let status = SyncStatusState {\n            pending_ops: 5,\n            last_sync_applied: 10,\n            last_sync_ts_ms: 1234,\n            last_error: Some(\"boom\".to_string()),\n        };\n        let shared: SharedSyncStatus = Arc::new(TokioMutex::new(status));\n        let server = SyncStatusServer::new(Arc::clone(\u0026shared));\n\n        let req = Request::new(SyncStatusRequest {});\n        let resp = server.get_sync_status(req).await.expect(\"sync_status OK\");\n        let inner = resp.into_inner();\n\n        assert_eq!(inner.pending_ops, 5);\n        assert_eq!(inner.last_sync_applied, 10);\n        assert_eq!(inner.last_sync_ts_ms, 1234);\n        assert_eq!(inner.last_error, \"boom\".to_string());\n    }\n}\n","traces":[{"line":39,"address":[16179131,16178848,16179125],"length":1,"stats":{"Line":1}},{"line":40,"address":[19791600],"length":1,"stats":{"Line":1}},{"line":41,"address":[12730392,12730464],"length":1,"stats":{"Line":2}},{"line":42,"address":[16064104],"length":1,"stats":{"Line":1}},{"line":46,"address":[15967788,15967794,15965392],"length":1,"stats":{"Line":1}},{"line":50,"address":[16074489],"length":1,"stats":{"Line":1}},{"line":51,"address":[16176651,16176574],"length":1,"stats":{"Line":2}},{"line":55,"address":[16061844],"length":1,"stats":{"Line":3}},{"line":59,"address":[16061951],"length":1,"stats":{"Line":1}},{"line":60,"address":[18533781],"length":1,"stats":{"Line":1}},{"line":63,"address":[16085545,16085648,16087129],"length":1,"stats":{"Line":1}},{"line":65,"address":[16075158,16075265],"length":1,"stats":{"Line":1}},{"line":66,"address":[16075470,16076756,16075367],"length":1,"stats":{"Line":1}},{"line":68,"address":[16208308,16208415],"length":1,"stats":{"Line":1}},{"line":71,"address":[16062621],"length":1,"stats":{"Line":1}},{"line":72,"address":[12729062,12729121],"length":1,"stats":{"Line":0}},{"line":74,"address":[19790407,19790337],"length":1,"stats":{"Line":2}},{"line":76,"address":[18535312,18534621],"length":1,"stats":{"Line":2}},{"line":77,"address":[16177912,16177859,16178044,16177778],"length":1,"stats":{"Line":3}},{"line":78,"address":[16208864],"length":1,"stats":{"Line":1}},{"line":79,"address":[16075925,16075865],"length":1,"stats":{"Line":0}},{"line":80,"address":[15966893,15966959],"length":1,"stats":{"Line":0}},{"line":81,"address":[15966996],"length":1,"stats":{"Line":0}},{"line":83,"address":[16086422,16086373],"length":1,"stats":{"Line":0}},{"line":86,"address":[16063202,16063052],"length":1,"stats":{"Line":0}},{"line":88,"address":[19790545,19790881],"length":1,"stats":{"Line":2}},{"line":89,"address":[19790889,19791107],"length":1,"stats":{"Line":2}},{"line":90,"address":[19791144],"length":1,"stats":{"Line":1}},{"line":92,"address":[16209337,16209389],"length":1,"stats":{"Line":0}},{"line":96,"address":[16063283],"length":1,"stats":{"Line":0}},{"line":99,"address":[16086445],"length":1,"stats":{"Line":1}},{"line":100,"address":[16086827],"length":1,"stats":{"Line":1}},{"line":101,"address":[16076620],"length":1,"stats":{"Line":1}},{"line":107,"address":[15967483],"length":1,"stats":{"Line":1}},{"line":108,"address":[16076476],"length":1,"stats":{"Line":1}},{"line":109,"address":[18535412],"length":1,"stats":{"Line":1}},{"line":126,"address":[16206896],"length":1,"stats":{"Line":0}},{"line":136,"address":[12727952],"length":1,"stats":{"Line":1}},{"line":147,"address":[14271634,14271919,14271439,14271804],"length":1,"stats":{"Line":2}},{"line":148,"address":[15980516],"length":1,"stats":{"Line":1}},{"line":149,"address":[13568376,13568449],"length":1,"stats":{"Line":2}},{"line":150,"address":[13666499,13666426],"length":1,"stats":{"Line":2}},{"line":151,"address":[14272269,14272326],"length":1,"stats":{"Line":2}},{"line":152,"address":[13511582,13511655],"length":1,"stats":{"Line":2}},{"line":163,"address":[14247842,14247739],"length":1,"stats":{"Line":0}},{"line":164,"address":[13543401,13543277,13543371],"length":1,"stats":{"Line":0}},{"line":166,"address":[17210767,17210109,17210911,17210470],"length":1,"stats":{"Line":0}},{"line":170,"address":[13404699],"length":1,"stats":{"Line":0}},{"line":171,"address":[17211138],"length":1,"stats":{"Line":0}},{"line":172,"address":[13487047],"length":1,"stats":{"Line":0}},{"line":173,"address":[15955854],"length":1,"stats":{"Line":0}},{"line":178,"address":[13642151,13642221],"length":1,"stats":{"Line":0}},{"line":182,"address":[13642262],"length":1,"stats":{"Line":0}},{"line":183,"address":[15956312],"length":1,"stats":{"Line":0}},{"line":184,"address":[14249102,14249258,14249206],"length":1,"stats":{"Line":0}},{"line":185,"address":[17211809],"length":1,"stats":{"Line":0}},{"line":186,"address":[17211817],"length":1,"stats":{"Line":0}},{"line":189,"address":[13479531],"length":1,"stats":{"Line":0}},{"line":190,"address":[13479563,13480144,13480180],"length":1,"stats":{"Line":0}},{"line":191,"address":[15956854,15957148],"length":1,"stats":{"Line":0}},{"line":195,"address":[13544740],"length":1,"stats":{"Line":0}},{"line":202,"address":[13484934,13484827],"length":1,"stats":{"Line":0}},{"line":203,"address":[13492845,13492939,13492969],"length":1,"stats":{"Line":0}},{"line":205,"address":[13492950,13493247,13492589,13493391],"length":1,"stats":{"Line":0}},{"line":209,"address":[13411307],"length":1,"stats":{"Line":0}},{"line":210,"address":[15962418],"length":1,"stats":{"Line":0}},{"line":211,"address":[13612839],"length":1,"stats":{"Line":0}},{"line":212,"address":[17217790],"length":1,"stats":{"Line":0}},{"line":217,"address":[17217879,17217949],"length":1,"stats":{"Line":0}},{"line":221,"address":[14255234],"length":1,"stats":{"Line":0}},{"line":222,"address":[17218248],"length":1,"stats":{"Line":0}},{"line":223,"address":[13551294,13551346,13551186],"length":1,"stats":{"Line":0}},{"line":224,"address":[14255641],"length":1,"stats":{"Line":0}},{"line":225,"address":[13613481],"length":1,"stats":{"Line":0}},{"line":228,"address":[13411739],"length":1,"stats":{"Line":0}},{"line":229,"address":[13649664,13649700,13649083],"length":1,"stats":{"Line":0}},{"line":230,"address":[17219084,17218790],"length":1,"stats":{"Line":0}},{"line":234,"address":[15963108],"length":1,"stats":{"Line":0}},{"line":241,"address":[14250651,14250761],"length":1,"stats":{"Line":0}},{"line":242,"address":[13481491,13481455,13481355,13481639],"length":1,"stats":{"Line":0}},{"line":249,"address":[14250500,14250889,14251509,14251385],"length":1,"stats":{"Line":0}},{"line":252,"address":[13407929],"length":1,"stats":{"Line":0}},{"line":255,"address":[13645349,13647296,13647334],"length":1,"stats":{"Line":0}},{"line":256,"address":[13484392],"length":1,"stats":{"Line":0}},{"line":257,"address":[15961100],"length":1,"stats":{"Line":0}},{"line":263,"address":[15959203],"length":1,"stats":{"Line":0}},{"line":264,"address":[13645418],"length":1,"stats":{"Line":0}},{"line":265,"address":[13482543],"length":1,"stats":{"Line":0}},{"line":266,"address":[13482550],"length":1,"stats":{"Line":0}},{"line":268,"address":[15959261],"length":1,"stats":{"Line":0}},{"line":273,"address":[13547612,13547682],"length":1,"stats":{"Line":0}},{"line":278,"address":[13609879],"length":1,"stats":{"Line":0}},{"line":279,"address":[13547993],"length":1,"stats":{"Line":0}},{"line":280,"address":[13646171,13646016,13646070],"length":1,"stats":{"Line":0}},{"line":281,"address":[13610271],"length":1,"stats":{"Line":0}},{"line":282,"address":[15959903],"length":1,"stats":{"Line":0}},{"line":283,"address":[15959921],"length":1,"stats":{"Line":0}},{"line":286,"address":[14252585],"length":1,"stats":{"Line":0}},{"line":287,"address":[14252593],"length":1,"stats":{"Line":0}},{"line":288,"address":[15959955],"length":1,"stats":{"Line":0}},{"line":291,"address":[13408572],"length":1,"stats":{"Line":0}},{"line":292,"address":[13548584,13548620,13547948],"length":1,"stats":{"Line":0}},{"line":293,"address":[13611030,13610734],"length":1,"stats":{"Line":0}},{"line":297,"address":[13548205],"length":1,"stats":{"Line":0}},{"line":306,"address":[16176400],"length":1,"stats":{"Line":2}},{"line":317,"address":[13664317,13664118,13664481,13664616],"length":1,"stats":{"Line":4}},{"line":318,"address":[17234087],"length":1,"stats":{"Line":2}},{"line":319,"address":[15978788],"length":1,"stats":{"Line":1}},{"line":320,"address":[13510017],"length":1,"stats":{"Line":0}},{"line":321,"address":[13502142],"length":1,"stats":{"Line":1}},{"line":323,"address":[13567148],"length":1,"stats":{"Line":2}},{"line":324,"address":[15978873],"length":1,"stats":{"Line":2}},{"line":336,"address":[15965024,15965336,15965342],"length":1,"stats":{"Line":1}},{"line":339,"address":[16084462,16084522],"length":1,"stats":{"Line":2}},{"line":340,"address":[15965244,15965176],"length":1,"stats":{"Line":2}},{"line":347,"address":[16084320],"length":1,"stats":{"Line":1}},{"line":357,"address":[14273679,14273928,14273510,14273299,14273599,14273851],"length":1,"stats":{"Line":4}},{"line":358,"address":[15981244],"length":1,"stats":{"Line":1}},{"line":359,"address":[13667866,13667622,13667563,13667673,13667509],"length":1,"stats":{"Line":3}},{"line":360,"address":[14273959,14273582,14273640,14273936],"length":1,"stats":{"Line":1}},{"line":362,"address":[14273817],"length":1,"stats":{"Line":1}},{"line":364,"address":[17237297],"length":1,"stats":{"Line":1}},{"line":368,"address":[19788736],"length":1,"stats":{"Line":1}},{"line":375,"address":[15982399,15982505],"length":1,"stats":{"Line":2}},{"line":378,"address":[13571151,13570823,13570925],"length":1,"stats":{"Line":3}},{"line":379,"address":[13431505],"length":1,"stats":{"Line":1}},{"line":380,"address":[14358903],"length":1,"stats":{"Line":3}},{"line":381,"address":[13571280,13571198,13571298],"length":1,"stats":{"Line":1}},{"line":387,"address":[12726591],"length":1,"stats":{"Line":4}},{"line":388,"address":[13615322,13615131],"length":1,"stats":{"Line":2}},{"line":389,"address":[15964945],"length":1,"stats":{"Line":1}},{"line":390,"address":[13413852],"length":1,"stats":{"Line":1}},{"line":392,"address":[13496252,13496399,13496167,13495602],"length":1,"stats":{"Line":2}},{"line":393,"address":[13414539,13413319,13414323,13414412],"length":1,"stats":{"Line":2}},{"line":396,"address":[17221199],"length":1,"stats":{"Line":1}},{"line":397,"address":[13497165],"length":1,"stats":{"Line":1}},{"line":398,"address":[14569670],"length":1,"stats":{"Line":2}},{"line":399,"address":[13489927],"length":1,"stats":{"Line":1}},{"line":400,"address":[13415423],"length":1,"stats":{"Line":0}},{"line":401,"address":[13652783,13652988,13653035],"length":1,"stats":{"Line":0}},{"line":402,"address":[13555034],"length":1,"stats":{"Line":0}},{"line":406,"address":[13655038,13653401,13654974,13653469,13652870],"length":1,"stats":{"Line":5}},{"line":410,"address":[17224265],"length":1,"stats":{"Line":1}},{"line":414,"address":[15969304,15969158],"length":1,"stats":{"Line":2}},{"line":415,"address":[15969290],"length":1,"stats":{"Line":1}},{"line":417,"address":[13418106],"length":1,"stats":{"Line":1}},{"line":418,"address":[13655463,13655546],"length":1,"stats":{"Line":2}},{"line":426,"address":[14261715],"length":1,"stats":{"Line":1}},{"line":427,"address":[13655728],"length":1,"stats":{"Line":1}},{"line":429,"address":[17224993,17225434],"length":1,"stats":{"Line":2}},{"line":430,"address":[13656140,13655924],"length":1,"stats":{"Line":2}},{"line":431,"address":[13620172,13620597],"length":1,"stats":{"Line":0}},{"line":432,"address":[13418756,13419288],"length":1,"stats":{"Line":2}},{"line":434,"address":[13656384,13656779],"length":1,"stats":{"Line":2}},{"line":439,"address":[13501916],"length":1,"stats":{"Line":1}},{"line":441,"address":[15970744],"length":1,"stats":{"Line":1}},{"line":442,"address":[13657079],"length":1,"stats":{"Line":1}},{"line":443,"address":[13552705,13559258,13555540,13559528],"length":1,"stats":{"Line":2}},{"line":444,"address":[15971622],"length":1,"stats":{"Line":1}},{"line":445,"address":[13657856,13657955],"length":1,"stats":{"Line":2}},{"line":446,"address":[14263986,14264040],"length":1,"stats":{"Line":0}},{"line":447,"address":[13658077],"length":1,"stats":{"Line":0}},{"line":449,"address":[13420632],"length":1,"stats":{"Line":1}},{"line":452,"address":[13494838],"length":1,"stats":{"Line":0}},{"line":453,"address":[13658229,13658273,13657782],"length":1,"stats":{"Line":0}},{"line":457,"address":[13560275],"length":1,"stats":{"Line":0}},{"line":462,"address":[13560188],"length":1,"stats":{"Line":1}},{"line":463,"address":[14264759,14264838],"length":1,"stats":{"Line":2}},{"line":464,"address":[14264882,14264984],"length":1,"stats":{"Line":2}},{"line":468,"address":[13561296,13560936,13561279],"length":1,"stats":{"Line":2}},{"line":469,"address":[17228374],"length":1,"stats":{"Line":1}},{"line":472,"address":[13622934,13623488],"length":1,"stats":{"Line":2}},{"line":473,"address":[17228539],"length":1,"stats":{"Line":1}},{"line":477,"address":[13496373],"length":1,"stats":{"Line":1}},{"line":481,"address":[14265848,14265612,14265802,14265498],"length":1,"stats":{"Line":4}},{"line":482,"address":[13659503],"length":1,"stats":{"Line":1}},{"line":483,"address":[13422308,13422513,13413382,13422321,13416233,13422248],"length":1,"stats":{"Line":5}},{"line":485,"address":[13505028,13505056,13504895],"length":1,"stats":{"Line":0}},{"line":491,"address":[13416270,13423260,13413403,13416304,13422644,13416565],"length":1,"stats":{"Line":4}},{"line":492,"address":[13555969,13556109,13556134],"length":1,"stats":{"Line":0}},{"line":497,"address":[13654569,13654544,13653990],"length":1,"stats":{"Line":2}},{"line":499,"address":[13655642],"length":1,"stats":{"Line":0}},{"line":500,"address":[13619848,13625079,13625107],"length":1,"stats":{"Line":0}},{"line":506,"address":[14599502],"length":1,"stats":{"Line":1}},{"line":507,"address":[13661651,13661564],"length":1,"stats":{"Line":2}},{"line":508,"address":[14267679],"length":1,"stats":{"Line":1}},{"line":509,"address":[13662048],"length":1,"stats":{"Line":2}},{"line":519,"address":[13626641],"length":1,"stats":{"Line":1}},{"line":520,"address":[13662678,13662908,13662974,13662526],"length":1,"stats":{"Line":4}},{"line":521,"address":[14268463],"length":1,"stats":{"Line":1}},{"line":522,"address":[16926696],"length":1,"stats":{"Line":3}},{"line":524,"address":[14269050,14268964,14269074],"length":1,"stats":{"Line":0}},{"line":531,"address":[13499577,13500685],"length":1,"stats":{"Line":2}},{"line":541,"address":[16077152],"length":1,"stats":{"Line":0}},{"line":552,"address":[13629859,13629902,13629730],"length":1,"stats":{"Line":0}},{"line":554,"address":[17198993,17199271],"length":1,"stats":{"Line":0}},{"line":555,"address":[13392967,13392864,13393014],"length":1,"stats":{"Line":0}},{"line":556,"address":[14237197,14237537],"length":1,"stats":{"Line":0}},{"line":558,"address":[13393569,13396444],"length":1,"stats":{"Line":0}},{"line":559,"address":[13476199],"length":1,"stats":{"Line":0}},{"line":560,"address":[13476375],"length":1,"stats":{"Line":0}},{"line":561,"address":[15945140],"length":1,"stats":{"Line":0}},{"line":562,"address":[13476262],"length":1,"stats":{"Line":0}},{"line":564,"address":[13533327,13533500,13533547],"length":1,"stats":{"Line":0}},{"line":570,"address":[13631482,13632001],"length":1,"stats":{"Line":0}},{"line":571,"address":[17201257],"length":1,"stats":{"Line":0}},{"line":572,"address":[14239241,14239149,14239411],"length":1,"stats":{"Line":0}},{"line":573,"address":[13632379],"length":1,"stats":{"Line":0}},{"line":575,"address":[14238941],"length":1,"stats":{"Line":0}},{"line":576,"address":[13596265,13597176,13597212],"length":1,"stats":{"Line":0}},{"line":577,"address":[13597719],"length":1,"stats":{"Line":0}},{"line":579,"address":[13597496,13597182],"length":1,"stats":{"Line":0}},{"line":580,"address":[13396108],"length":1,"stats":{"Line":0}},{"line":581,"address":[13470571],"length":1,"stats":{"Line":0}},{"line":588,"address":[18206655],"length":1,"stats":{"Line":0}},{"line":589,"address":[13479034,13479113],"length":1,"stats":{"Line":0}},{"line":590,"address":[13396923,13396843],"length":1,"stats":{"Line":0}},{"line":594,"address":[13471607],"length":1,"stats":{"Line":0}},{"line":595,"address":[13598838,13598798,13598705],"length":1,"stats":{"Line":0}},{"line":596,"address":[14241818],"length":1,"stats":{"Line":0}},{"line":598,"address":[13536660],"length":1,"stats":{"Line":0}},{"line":599,"address":[14241699],"length":1,"stats":{"Line":0}},{"line":600,"address":[13536990],"length":1,"stats":{"Line":0}},{"line":605,"address":[13599385,13599506,13593699,13598758],"length":1,"stats":{"Line":0}},{"line":606,"address":[13635550,13635647,13635687],"length":1,"stats":{"Line":0}},{"line":607,"address":[14463568],"length":1,"stats":{"Line":0}},{"line":608,"address":[14246931,14246854,14246960],"length":1,"stats":{"Line":0}},{"line":609,"address":[13477677,13477410],"length":1,"stats":{"Line":0}},{"line":611,"address":[13399481,13399394,13399518],"length":1,"stats":{"Line":0}},{"line":616,"address":[13399487],"length":1,"stats":{"Line":0}},{"line":617,"address":[13399768],"length":1,"stats":{"Line":0}},{"line":618,"address":[13601296],"length":1,"stats":{"Line":0}},{"line":622,"address":[13401686,13399983,13400091,13400226],"length":1,"stats":{"Line":0}},{"line":623,"address":[13482607,13483474],"length":1,"stats":{"Line":0}},{"line":625,"address":[13540797,13540554,13540662],"length":1,"stats":{"Line":0}},{"line":626,"address":[13401522],"length":1,"stats":{"Line":0}},{"line":628,"address":[13484043],"length":1,"stats":{"Line":0}},{"line":631,"address":[13639216],"length":1,"stats":{"Line":0}},{"line":634,"address":[13484353],"length":1,"stats":{"Line":0}},{"line":637,"address":[15953300],"length":1,"stats":{"Line":0}},{"line":640,"address":[13639633],"length":1,"stats":{"Line":0}},{"line":644,"address":[13541787],"length":1,"stats":{"Line":0}},{"line":647,"address":[14245576],"length":1,"stats":{"Line":0}},{"line":650,"address":[13474744],"length":1,"stats":{"Line":0}},{"line":651,"address":[15951508],"length":1,"stats":{"Line":0}},{"line":653,"address":[13637864,13637740,13637666],"length":1,"stats":{"Line":0}},{"line":657,"address":[14244446,14244857],"length":1,"stats":{"Line":0}}],"covered":109,"coverable":247},{"path":["/","home","azureuser","Documents","Chronos","src","network","sync_status.rs"],"content":"use std::sync::Arc;\nuse tokio::sync::Mutex;\n\n/// In-memory state for sync status metrics on a single node.\n#[derive(Debug, Clone, Default)]\npub struct SyncStatusState {\n    /// Approximate number of pending operations in the offline queue\n    /// at the time of the last sync attempt.\n    pub pending_ops: u64,\n    /// Number of operations successfully applied in the last sync batch.\n    pub last_sync_applied: u64,\n    /// Timestamp of the last sync attempt, in milliseconds since UNIX_EPOCH.\n    pub last_sync_ts_ms: u64,\n    /// Last sync error message, if any (empty/None if last attempt succeeded).\n    pub last_error: Option\u003cString\u003e,\n}\n\npub type SharedSyncStatus = Arc\u003cMutex\u003cSyncStatusState\u003e\u003e;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","src","network","sync_worker.rs"],"content":"use std::sync::Arc;\nuse std::time::{Duration, SystemTime, UNIX_EPOCH};\n\nuse anyhow::Result;\nuse tokio::sync::Mutex as TokioMutex;\nuse tokio::time::sleep;\n\nuse crate::executor::Executor;\nuse crate::network::SharedSyncStatus;\nuse crate::network::SyncClient;\nuse crate::storage::offline_queue::PersistentQueuedOperation;\n\npub struct SyncWorker {\n    executor: Arc\u003cTokioMutex\u003cExecutor\u003e\u003e,\n    target: String,\n    interval: Duration,\n    batch_size: usize,\n    status: SharedSyncStatus,\n    edge_id: String,\n}\n\nimpl SyncWorker {\n    pub fn new(\n        executor: Arc\u003cTokioMutex\u003cExecutor\u003e\u003e,\n        target: String,\n        interval: Duration,\n        batch_size: usize,\n        status: SharedSyncStatus,\n        edge_id: String,\n    ) -\u003e Self {\n        Self {\n            executor,\n            target,\n            interval,\n            batch_size,\n            status,\n            edge_id,\n        }\n    }\n\n    pub async fn run(mut self) {\n        loop {\n            if let Err(e) = self.sync_once().await {\n                log::error!(\"SyncWorker error: {e}\");\n            }\n            sleep(self.interval).await;\n        }\n    }\n\n    async fn sync_once(\u0026mut self) -\u003e Result\u003c()\u003e {\n        // Drain a batch of operations from the persistent offline queue.\n        let drained: Vec\u003cPersistentQueuedOperation\u003e = {\n            let exec = self.executor.lock().await;\n            exec.drain_offline_queue(self.batch_size)\n                .await\n                .map_err(|e| anyhow::anyhow!(e.to_string()))?\n        };\n        if drained.is_empty() {\n            return Ok(());\n        }\n\n        let now_ms = SystemTime::now()\n            .duration_since(UNIX_EPOCH)\n            .unwrap()\n            .as_millis() as u64;\n\n        let mut client = SyncClient::new(\u0026self.target);\n\n        match client.sync_operations(\u0026self.edge_id, drained.clone()).await {\n            Ok(applied) =\u003e {\n                {\n                    let mut status = self.status.lock().await;\n                    status.last_sync_ts_ms = now_ms;\n                    status.last_sync_applied = applied;\n                    status.pending_ops = drained.len() as u64;\n                    status.last_error = None;\n                }\n\n                log::info!(\n                    \"SyncWorker synced {} operations to {} (applied={})\",\n                    drained.len(),\n                    self.target,\n                    applied\n                );\n                Ok(())\n            }\n            Err(e) =\u003e {\n                // On failure, re-enqueue operations so they are not lost.\n                log::warn!(\"SyncWorker failed to sync batch: {e}. Re-enqueuing operations\");\n                let exec = self.executor.lock().await;\n                exec.requeue_offline_ops(drained.clone())\n                    .await\n                    .map_err(|e| anyhow::anyhow!(e.to_string()))?;\n\n                {\n                    let mut status = self.status.lock().await;\n                    status.last_sync_ts_ms = now_ms;\n                    status.last_sync_applied = 0;\n                    status.pending_ops = drained.len() as u64;\n                    status.last_error = Some(e.to_string());\n                }\n\n                Err(anyhow::anyhow!(e.to_string()))\n            }\n        }\n    }\n}\n","traces":[{"line":23,"address":[14009616],"length":1,"stats":{"Line":0}},{"line":41,"address":[14218936,14219009,14217792,14217864,14217744,14217933],"length":1,"stats":{"Line":0}},{"line":42,"address":[14074998],"length":1,"stats":{"Line":0}},{"line":43,"address":[14728005,14728035,14728345,14728075,14728389],"length":1,"stats":{"Line":0}},{"line":44,"address":[14089452,14089589,14089614],"length":1,"stats":{"Line":0}},{"line":46,"address":[14088926,14089499,14089886,14088954,14088836],"length":1,"stats":{"Line":0}},{"line":50,"address":[17823984,17824976,17824341,17824038,17824164,17824504],"length":1,"stats":{"Line":0}},{"line":53,"address":[14219250,14219594,14219447,14219190],"length":1,"stats":{"Line":0}},{"line":54,"address":[14189251,14189456,14189376,14190437,14188951,14188864,14189013],"length":1,"stats":{"Line":0}},{"line":55,"address":[14077074,14077182,14077379,14076407,14077142],"length":1,"stats":{"Line":0}},{"line":56,"address":[14091344,14097503,14091253,14097488],"length":1,"stats":{"Line":0}},{"line":58,"address":[14001700,14001777],"length":1,"stats":{"Line":0}},{"line":59,"address":[13833385],"length":1,"stats":{"Line":0}},{"line":62,"address":[14189890,14189734,14189836,14189655],"length":1,"stats":{"Line":0}},{"line":63,"address":[13833445],"length":1,"stats":{"Line":0}},{"line":64,"address":[14189780],"length":1,"stats":{"Line":0}},{"line":65,"address":[16546755],"length":1,"stats":{"Line":0}},{"line":67,"address":[16546790],"length":1,"stats":{"Line":0}},{"line":69,"address":[14091872,14090236,14092676,14092006,14092375],"length":1,"stats":{"Line":0}},{"line":70,"address":[17826795],"length":1,"stats":{"Line":0}},{"line":72,"address":[18178621],"length":1,"stats":{"Line":0}},{"line":73,"address":[17827793,17827900],"length":1,"stats":{"Line":0}},{"line":74,"address":[14080096],"length":1,"stats":{"Line":0}},{"line":75,"address":[14732910],"length":1,"stats":{"Line":0}},{"line":76,"address":[17828866,17828097,17828044,17828165],"length":1,"stats":{"Line":0}},{"line":79,"address":[16549290,16549498,16549365],"length":1,"stats":{"Line":0}},{"line":85,"address":[14192452],"length":1,"stats":{"Line":0}},{"line":87,"address":[14078903],"length":1,"stats":{"Line":0}},{"line":89,"address":[14093066,14093110,14092739],"length":1,"stats":{"Line":0}},{"line":90,"address":[13834872,13836698,13832070,13835201],"length":1,"stats":{"Line":0}},{"line":91,"address":[14193235,14193414,14193795,14193317,14193984,14193640,14193719],"length":1,"stats":{"Line":0}},{"line":92,"address":[14427855],"length":1,"stats":{"Line":0}},{"line":93,"address":[14224650,14226271,14224739,14226256],"length":1,"stats":{"Line":0}},{"line":96,"address":[18178696],"length":1,"stats":{"Line":0}},{"line":97,"address":[14225326,14225413],"length":1,"stats":{"Line":0}},{"line":98,"address":[14194457],"length":1,"stats":{"Line":0}},{"line":99,"address":[16551398],"length":1,"stats":{"Line":0}},{"line":100,"address":[13838290,13838389,13838952,13838451,13838264],"length":1,"stats":{"Line":0}},{"line":103,"address":[14735662,14735569,14735876],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":39},{"path":["/","home","azureuser","Documents","Chronos","src","parser","ast.rs"],"content":"use super::{ParserError, Rule};\nuse pest::iterators::Pairs;\n\n#[derive(\n    Debug, Clone, PartialEq, serde::Serialize, serde::Deserialize, bincode::Encode, bincode::Decode,\n)]\npub enum DataType {\n    Int,\n    Text,\n    Float,\n    Boolean,\n    String,\n}\n\n#[derive(\n    Debug, Clone, PartialEq, serde::Serialize, serde::Deserialize, bincode::Encode, bincode::Decode,\n)]\npub struct ColumnDefinition {\n    pub name: String,\n    pub data_type: DataType,\n    pub primary_key: bool,\n}\n\n#[derive(\n    Debug, Clone, PartialEq, serde::Serialize, serde::Deserialize, bincode::Encode, bincode::Decode,\n)]\npub struct TtlSpec {\n    pub seconds: u64,\n}\n\nfn parse_ttl_value(raw: \u0026str) -\u003e Result\u003cTtlSpec, ParserError\u003e {\n    // raw format: digits + optional unit (s|m|h|d)\n    if raw.is_empty() {\n        return Err(ParserError::InvalidSyntax(\"TTL value missing\".to_string()));\n    }\n    let (num_part, unit_part) =\n        raw.split_at(raw.chars().take_while(|c| c.is_ascii_digit()).count());\n    if num_part.is_empty() {\n        return Err(ParserError::InvalidSyntax(\n            \"TTL numeric part missing\".to_string(),\n        ));\n    }\n    let n: u64 = num_part\n        .parse()\n        .map_err(|_| ParserError::InvalidSyntax(\"TTL parse error\".to_string()))?;\n    let seconds = match unit_part {\n        \"s\" | \"\" =\u003e n,\n        \"m\" =\u003e n * 60,\n        \"h\" =\u003e n * 60 * 60,\n        \"d\" =\u003e n * 60 * 60 * 24,\n        _ =\u003e return Err(ParserError::InvalidSyntax(\"TTL unit invalid\".to_string())),\n    };\n    Ok(TtlSpec { seconds })\n}\n\n#[derive(\n    Debug, Clone, PartialEq, serde::Serialize, serde::Deserialize, bincode::Encode, bincode::Decode,\n)]\npub enum Value {\n    String(String),\n    Integer(i64),\n    Float(f64),\n    Boolean(bool),\n    Null,\n}\n\nimpl std::fmt::Display for Value {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        match self {\n            Value::String(s) =\u003e write!(f, \"{s}\"),\n            Value::Integer(i) =\u003e write!(f, \"{i}\"),\n            Value::Float(fl) =\u003e write!(f, \"{fl}\"),\n            Value::Boolean(b) =\u003e write!(f, \"{b}\"),\n            Value::Null =\u003e write!(f, \"NULL\"),\n        }\n    }\n}\n\nimpl PartialOrd for Value {\n    fn partial_cmp(\u0026self, other: \u0026Self) -\u003e Option\u003cstd::cmp::Ordering\u003e {\n        match (self, other) {\n            (Value::Integer(a), Value::Integer(b)) =\u003e a.partial_cmp(b),\n            (Value::Float(a), Value::Float(b)) =\u003e a.partial_cmp(b),\n            (Value::Integer(a), Value::Float(b)) =\u003e (*a as f64).partial_cmp(b),\n            (Value::Float(a), Value::Integer(b)) =\u003e a.partial_cmp(\u0026(*b as f64)),\n            (Value::String(a), Value::String(b)) =\u003e a.partial_cmp(b),\n            _ =\u003e None, // Incomparable types\n        }\n    }\n}\n\n#[derive(\n    Debug, Clone, PartialEq, serde::Serialize, serde::Deserialize, bincode::Encode, bincode::Decode,\n)]\npub enum Operator {\n    Equals,\n    NotEquals,\n    LessThan,\n    GreaterThan,\n    LessThanOrEqual,\n    GreaterThanOrEqual,\n}\n\n#[derive(\n    Debug, Clone, PartialEq, serde::Serialize, serde::Deserialize, bincode::Encode, bincode::Decode,\n)]\npub struct Condition {\n    pub column_name: String,\n    pub operator: Operator,\n    pub value: Value,\n}\n\n#[derive(\n    Debug, Clone, PartialEq, serde::Serialize, serde::Deserialize, bincode::Encode, bincode::Decode,\n)]\npub struct Assignment {\n    pub column_name: String,\n    pub value: Value,\n}\n\n#[derive(\n    Debug, Clone, PartialEq, serde::Serialize, serde::Deserialize, bincode::Encode, bincode::Decode,\n)]\npub enum Statement {\n    CreateTable {\n        table_name: String,\n        columns: Vec\u003cColumnDefinition\u003e,\n        ttl: Option\u003cTtlSpec\u003e,\n    },\n    Insert {\n        table_name: String,\n        columns: Option\u003cVec\u003cString\u003e\u003e,\n        values: Vec\u003cValue\u003e,\n    },\n    Select {\n        table_name: String,\n        columns: Vec\u003cString\u003e,\n        conditions: Option\u003cVec\u003cCondition\u003e\u003e,\n    },\n    SelectAgg1h {\n        table_name: String,\n        column_name: String,\n    },\n    SelectAgg24h {\n        table_name: String,\n        column_name: String,\n    },\n    SelectAgg7d {\n        table_name: String,\n        column_name: String,\n    },\n    SelectCount {\n        table_name: String,\n        column: Option\u003cString\u003e,\n        conditions: Option\u003cVec\u003cCondition\u003e\u003e, // COUNT(* or column) with optional WHERE\n    },\n    SelectSum {\n        table_name: String,\n        column_name: String,\n        conditions: Option\u003cVec\u003cCondition\u003e\u003e, // SUM(column) with optional WHERE\n    },\n    SelectAvg {\n        table_name: String,\n        column_name: String,\n        conditions: Option\u003cVec\u003cCondition\u003e\u003e, // AVG(column) with optional WHERE\n    },\n    SelectMin {\n        table_name: String,\n        column_name: String,\n        conditions: Option\u003cVec\u003cCondition\u003e\u003e, // MIN(column) with optional WHERE\n    },\n    SelectMax {\n        table_name: String,\n        column_name: String,\n        conditions: Option\u003cVec\u003cCondition\u003e\u003e, // MAX(column) with optional WHERE\n    },\n    SelectJoin {\n        left_table: String,\n        right_table: String,\n        join_column: String,\n        columns: Vec\u003cString\u003e,\n        conditions: Option\u003cVec\u003cCondition\u003e\u003e, // SELECT ... FROM left JOIN right USING (col) [WHERE ...]\n    },\n    SelectGroupCount {\n        table_name: String,\n        group_column: String,\n        conditions: Option\u003cVec\u003cCondition\u003e\u003e, // SELECT col, COUNT(*) ... GROUP BY col with optional WHERE\n    },\n    Begin,\n    Commit,\n    Rollback,\n    Update {\n        table_name: String,\n        assignments: Vec\u003cAssignment\u003e,\n        conditions: Option\u003cVec\u003cCondition\u003e\u003e,\n    },\n    Delete {\n        table_name: String,\n        conditions: Option\u003cVec\u003cCondition\u003e\u003e,\n    },\n    CreateIndex {\n        index_name: String,\n        table_name: String,\n        column_name: String,\n    },\n}\n\n#[derive(\n    Debug, Clone, PartialEq, serde::Serialize, serde::Deserialize, bincode::Encode, bincode::Decode,\n)]\npub enum Ast {\n    Statement(Statement),\n}\n\npub fn parse_ast(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::sql =\u003e {\n                // Recursively process the inner pairs\n                return parse_ast(pair.into_inner());\n            }\n            Rule::sql_stmt =\u003e {\n                // Process the SQL statement\n                return parse_statement(pair.into_inner());\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Err(ParserError::InvalidSyntax(\"Invalid SQL syntax\".to_string()))\n}\n\nfn parse_statement(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::create_table_stmt =\u003e {\n                return parse_create_table(pair.into_inner());\n            }\n            Rule::create_index_stmt =\u003e {\n                return parse_create_index(pair.into_inner());\n            }\n            Rule::insert_stmt =\u003e {\n                return parse_insert(pair.into_inner());\n            }\n            Rule::select_agg_1h_stmt =\u003e {\n                return parse_select_agg_1h(pair.into_inner());\n            }\n            Rule::select_agg_24h_stmt =\u003e {\n                return parse_select_agg_24h(pair.into_inner());\n            }\n            Rule::select_agg_7d_stmt =\u003e {\n                return parse_select_agg_7d(pair.into_inner());\n            }\n            Rule::select_count_stmt =\u003e {\n                return parse_select_count(pair.into_inner());\n            }\n            Rule::select_sum_stmt =\u003e {\n                return parse_select_sum(pair.into_inner());\n            }\n            Rule::select_avg_stmt =\u003e {\n                return parse_select_avg(pair.into_inner());\n            }\n            Rule::select_min_stmt =\u003e {\n                return parse_select_min(pair.into_inner());\n            }\n            Rule::select_max_stmt =\u003e {\n                return parse_select_max(pair.into_inner());\n            }\n            Rule::select_group_count_stmt =\u003e {\n                return parse_select_group_count(pair.into_inner());\n            }\n            Rule::select_join_stmt =\u003e {\n                return parse_select_join(pair.into_inner());\n            }\n            Rule::select_stmt =\u003e {\n                return parse_select(pair.into_inner());\n            }\n            Rule::begin_stmt =\u003e {\n                return Ok(Ast::Statement(Statement::Begin));\n            }\n            Rule::commit_stmt =\u003e {\n                return Ok(Ast::Statement(Statement::Commit));\n            }\n            Rule::rollback_stmt =\u003e {\n                return Ok(Ast::Statement(Statement::Rollback));\n            }\n            Rule::update_stmt =\u003e {\n                return parse_update(pair.into_inner());\n            }\n            Rule::delete_stmt =\u003e {\n                return parse_delete(pair.into_inner());\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Err(ParserError::InvalidSyntax(\"Invalid statement\".to_string()))\n}\n\nfn parse_create_table(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    let mut table_name = String::new();\n    let mut columns = Vec::new();\n    let mut ttl: Option\u003cTtlSpec\u003e = None;\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::table_name =\u003e {\n                table_name = pair.as_str().to_string();\n            }\n            Rule::column_list =\u003e {\n                for column_pair in pair.into_inner() {\n                    if column_pair.as_rule() == Rule::column_definition {\n                        let column = parse_column_definition(column_pair.into_inner())?;\n                        columns.push(column);\n                    }\n                }\n            }\n            Rule::ttl_clause =\u003e {\n                for inner in pair.into_inner() {\n                    if inner.as_rule() == Rule::ttl_value {\n                        ttl = Some(parse_ttl_value(inner.as_str())?);\n                    }\n                }\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(Ast::Statement(Statement::CreateTable {\n        table_name,\n        columns,\n        ttl,\n    }))\n}\n\nfn parse_column_definition(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cColumnDefinition, ParserError\u003e {\n    let mut name = String::new();\n    let mut data_type = DataType::Text; // Default\n    let mut primary_key = false;\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::column_name =\u003e {\n                name = pair.as_str().to_string();\n            }\n            Rule::data_type =\u003e {\n                data_type = match pair.as_str().to_uppercase().as_str() {\n                    \"INT\" =\u003e DataType::Int,\n                    \"TEXT\" =\u003e DataType::Text,\n                    \"FLOAT\" =\u003e DataType::Float,\n                    \"BOOLEAN\" =\u003e DataType::Boolean,\n                    \"STRING\" =\u003e DataType::String,\n                    _ =\u003e return Err(ParserError::InvalidDataType(pair.as_str().to_string())),\n                };\n            }\n            Rule::PRIMARY =\u003e {\n                // Next token should be KEY\n                primary_key = true;\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(ColumnDefinition {\n        name,\n        data_type,\n        primary_key,\n    })\n}\n\nfn parse_insert(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    let mut table_name = String::new();\n    let mut columns: Option\u003cVec\u003cString\u003e\u003e = None;\n    let mut values = Vec::new();\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::table_name =\u003e {\n                table_name = pair.as_str().to_string();\n            }\n            Rule::column_name =\u003e {\n                let column_name = pair.as_str().to_string();\n                if let Some(ref mut cols) = columns {\n                    cols.push(column_name);\n                } else {\n                    columns = Some(vec![column_name]);\n                }\n            }\n            Rule::value_list =\u003e {\n                for value_pair in pair.into_inner() {\n                    if value_pair.as_rule() == Rule::value {\n                        let value = parse_value(value_pair.into_inner())?;\n                        values.push(value);\n                    }\n                }\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(Ast::Statement(Statement::Insert {\n        table_name,\n        columns,\n        values,\n    }))\n}\n\nfn parse_value(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cValue, ParserError\u003e {\n    for pair in pairs {\n        if pair.as_rule() == Rule::literal {\n            return parse_literal(pair.into_inner());\n        }\n    }\n\n    Err(ParserError::InvalidValue(\"Invalid value\".to_string()))\n}\n\nfn parse_literal(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cValue, ParserError\u003e {\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::string_literal =\u003e {\n                // Remove the surrounding quotes\n                let s = pair.as_str();\n                let s = \u0026s[1..s.len() - 1];\n                return Ok(Value::String(s.to_string()));\n            }\n            Rule::integer_literal =\u003e {\n                let i = pair.as_str().parse::\u003ci64\u003e().map_err(|_| {\n                    ParserError::InvalidValue(format!(\"Invalid integer: {}\", pair.as_str()))\n                })?;\n                return Ok(Value::Integer(i));\n            }\n            Rule::float_literal =\u003e {\n                let f = pair.as_str().parse::\u003cf64\u003e().map_err(|_| {\n                    ParserError::InvalidValue(format!(\"Invalid float: {}\", pair.as_str()))\n                })?;\n                return Ok(Value::Float(f));\n            }\n            Rule::boolean_literal =\u003e {\n                let b = pair.as_str().to_uppercase() == \"TRUE\";\n                return Ok(Value::Boolean(b));\n            }\n            Rule::null_literal =\u003e {\n                return Ok(Value::Null);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Err(ParserError::InvalidValue(\"Invalid literal\".to_string()))\n}\n\nfn parse_select(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    let mut table_name = String::new();\n    let mut columns = Vec::new();\n    let mut conditions = None;\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::column_selector =\u003e {\n                if pair.as_str() == \"*\" {\n                    columns.push(\"*\".to_string());\n                } else {\n                    for column_pair in pair.into_inner() {\n                        if column_pair.as_rule() == Rule::column_name {\n                            columns.push(column_pair.as_str().to_string());\n                        }\n                    }\n                }\n            }\n            Rule::table_name =\u003e {\n                table_name = pair.as_str().to_string();\n            }\n            Rule::where_clause =\u003e {\n                conditions = Some(parse_where_clause(pair.into_inner())?);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(Ast::Statement(Statement::Select {\n        table_name,\n        columns,\n        conditions,\n    }))\n}\n\nfn parse_select_agg_1h(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    let mut table_name = String::new();\n    let mut column_name = String::new();\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::column_name =\u003e {\n                column_name = pair.as_str().to_string();\n            }\n            Rule::table_name =\u003e {\n                table_name = pair.as_str().to_string();\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(Ast::Statement(Statement::SelectAgg1h {\n        table_name,\n        column_name,\n    }))\n}\n\nfn parse_select_agg_24h(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    let mut table_name = String::new();\n    let mut column_name = String::new();\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::column_name =\u003e {\n                column_name = pair.as_str().to_string();\n            }\n            Rule::table_name =\u003e {\n                table_name = pair.as_str().to_string();\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(Ast::Statement(Statement::SelectAgg24h {\n        table_name,\n        column_name,\n    }))\n}\n\nfn parse_select_agg_7d(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    let mut table_name = String::new();\n    let mut column_name = String::new();\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::column_name =\u003e {\n                column_name = pair.as_str().to_string();\n            }\n            Rule::table_name =\u003e {\n                table_name = pair.as_str().to_string();\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(Ast::Statement(Statement::SelectAgg7d {\n        table_name,\n        column_name,\n    }))\n}\n\nfn parse_select_count(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    let mut table_name = String::new();\n    let mut column: Option\u003cString\u003e = None;\n    let mut conditions = None;\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::table_name =\u003e {\n                table_name = pair.as_str().to_string();\n            }\n            Rule::column_name =\u003e {\n                // COUNT(column_name)\n                column = Some(pair.as_str().to_string());\n            }\n            Rule::where_clause =\u003e {\n                conditions = Some(parse_where_clause(pair.into_inner())?);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(Ast::Statement(Statement::SelectCount {\n        table_name,\n        column,\n        conditions,\n    }))\n}\n\nfn parse_select_group_count(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    let mut table_name = String::new();\n    let mut group_column = String::new();\n    let mut group_by_column: Option\u003cString\u003e = None;\n    let mut conditions = None;\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::column_name =\u003e {\n                if group_column.is_empty() {\n                    group_column = pair.as_str().to_string();\n                }\n            }\n            Rule::table_name =\u003e {\n                table_name = pair.as_str().to_string();\n            }\n            Rule::where_clause =\u003e {\n                conditions = Some(parse_where_clause(pair.into_inner())?);\n            }\n            Rule::group_by_clause =\u003e {\n                for inner in pair.into_inner() {\n                    if inner.as_rule() == Rule::column_name {\n                        group_by_column = Some(inner.as_str().to_string());\n                    }\n                }\n            }\n            _ =\u003e {}\n        }\n    }\n\n    if let Some(gb_col) = group_by_column {\n        if gb_col != group_column {\n            return Err(ParserError::InvalidSyntax(\n                \"GROUP BY column must match selected group column\".to_string(),\n            ));\n        }\n    }\n\n    Ok(Ast::Statement(Statement::SelectGroupCount {\n        table_name,\n        group_column,\n        conditions,\n    }))\n}\n\nfn parse_select_sum(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    let mut table_name = String::new();\n    let mut column_name = String::new();\n    let mut conditions = None;\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::column_name =\u003e {\n                column_name = pair.as_str().to_string();\n            }\n            Rule::table_name =\u003e {\n                table_name = pair.as_str().to_string();\n            }\n            Rule::where_clause =\u003e {\n                conditions = Some(parse_where_clause(pair.into_inner())?);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(Ast::Statement(Statement::SelectSum {\n        table_name,\n        column_name,\n        conditions,\n    }))\n}\n\nfn parse_select_avg(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    let mut table_name = String::new();\n    let mut column_name = String::new();\n    let mut conditions = None;\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::column_name =\u003e {\n                column_name = pair.as_str().to_string();\n            }\n            Rule::table_name =\u003e {\n                table_name = pair.as_str().to_string();\n            }\n            Rule::where_clause =\u003e {\n                conditions = Some(parse_where_clause(pair.into_inner())?);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(Ast::Statement(Statement::SelectAvg {\n        table_name,\n        column_name,\n        conditions,\n    }))\n}\n\nfn parse_select_min(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    let mut table_name = String::new();\n    let mut column_name = String::new();\n    let mut conditions = None;\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::column_name =\u003e {\n                column_name = pair.as_str().to_string();\n            }\n            Rule::table_name =\u003e {\n                table_name = pair.as_str().to_string();\n            }\n            Rule::where_clause =\u003e {\n                conditions = Some(parse_where_clause(pair.into_inner())?);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(Ast::Statement(Statement::SelectMin {\n        table_name,\n        column_name,\n        conditions,\n    }))\n}\n\nfn parse_select_max(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    let mut table_name = String::new();\n    let mut column_name = String::new();\n    let mut conditions = None;\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::column_name =\u003e {\n                column_name = pair.as_str().to_string();\n            }\n            Rule::table_name =\u003e {\n                table_name = pair.as_str().to_string();\n            }\n            Rule::where_clause =\u003e {\n                conditions = Some(parse_where_clause(pair.into_inner())?);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(Ast::Statement(Statement::SelectMax {\n        table_name,\n        column_name,\n        conditions,\n    }))\n}\n\nfn parse_select_join(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    let mut left_table = String::new();\n    let mut right_table = String::new();\n    let mut join_column = String::new();\n    let mut columns = Vec::new();\n    let mut conditions = None;\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::column_selector =\u003e {\n                if pair.as_str() == \"*\" {\n                    columns.push(\"*\".to_string());\n                } else {\n                    for column_pair in pair.into_inner() {\n                        if column_pair.as_rule() == Rule::column_name {\n                            columns.push(column_pair.as_str().to_string());\n                        }\n                    }\n                }\n            }\n            Rule::table_name =\u003e {\n                if left_table.is_empty() {\n                    left_table = pair.as_str().to_string();\n                } else {\n                    right_table = pair.as_str().to_string();\n                }\n            }\n            Rule::column_name =\u003e {\n                // JOIN ... USING(column_name)\n                if join_column.is_empty() {\n                    join_column = pair.as_str().to_string();\n                }\n            }\n            Rule::where_clause =\u003e {\n                conditions = Some(parse_where_clause(pair.into_inner())?);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(Ast::Statement(Statement::SelectJoin {\n        left_table,\n        right_table,\n        join_column,\n        columns,\n        conditions,\n    }))\n}\n\nfn parse_create_index(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    let mut index_name = String::new();\n    let mut table_name = String::new();\n    let mut column_name = String::new();\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::identifier =\u003e {\n                index_name = pair.as_str().to_string();\n            }\n            Rule::table_name =\u003e {\n                table_name = pair.as_str().to_string();\n            }\n            Rule::column_name =\u003e {\n                column_name = pair.as_str().to_string();\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(Ast::Statement(Statement::CreateIndex {\n        index_name,\n        table_name,\n        column_name,\n    }))\n}\n\nfn parse_where_clause(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cVec\u003cCondition\u003e, ParserError\u003e {\n    let mut conditions = Vec::new();\n\n    for pair in pairs {\n        if pair.as_rule() == Rule::condition {\n            let condition = parse_condition(pair.into_inner())?;\n            conditions.push(condition);\n        }\n    }\n\n    Ok(conditions)\n}\n\nfn parse_condition(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cCondition, ParserError\u003e {\n    let mut column_name = String::new();\n    let mut operator_str = String::new();\n    let mut value = Value::Null;\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::column_name =\u003e {\n                column_name = pair.as_str().to_string();\n            }\n            Rule::comparison_operator =\u003e {\n                operator_str = pair.as_str().to_string();\n            }\n            Rule::value =\u003e {\n                value = parse_value(pair.into_inner())?;\n            }\n            _ =\u003e {}\n        }\n    }\n\n    let operator = match operator_str.as_str() {\n        \"=\" =\u003e Operator::Equals,\n        \"!=\" =\u003e Operator::NotEquals,\n        \"\u003c\" =\u003e Operator::LessThan,\n        \"\u003e\" =\u003e Operator::GreaterThan,\n        \"\u003c=\" =\u003e Operator::LessThanOrEqual,\n        \"\u003e=\" =\u003e Operator::GreaterThanOrEqual,\n        _ =\u003e return Err(ParserError::InvalidOperator(operator_str)),\n    };\n\n    Ok(Condition {\n        column_name,\n        operator,\n        value,\n    })\n}\n\nfn parse_update(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    let mut table_name = String::new();\n    let mut assignments = Vec::new();\n    let mut conditions = None;\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::table_name =\u003e {\n                table_name = pair.as_str().to_string();\n            }\n            Rule::assignment_list =\u003e {\n                assignments = parse_assignment_list(pair.into_inner())?;\n            }\n            Rule::where_clause =\u003e {\n                conditions = Some(parse_where_clause(pair.into_inner())?);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(Ast::Statement(Statement::Update {\n        table_name,\n        assignments,\n        conditions,\n    }))\n}\n\nfn parse_delete(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAst, ParserError\u003e {\n    let mut table_name = String::new();\n    let mut conditions = None;\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::table_name =\u003e {\n                table_name = pair.as_str().to_string();\n            }\n            Rule::where_clause =\u003e {\n                conditions = Some(parse_where_clause(pair.into_inner())?);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(Ast::Statement(Statement::Delete {\n        table_name,\n        conditions,\n    }))\n}\n\nfn parse_assignment_list(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cVec\u003cAssignment\u003e, ParserError\u003e {\n    let mut assignments = Vec::new();\n\n    for pair in pairs {\n        if let Rule::assignment = pair.as_rule() {\n            assignments.push(parse_assignment(pair.into_inner())?);\n        }\n    }\n\n    Ok(assignments)\n}\n\nfn parse_assignment(pairs: Pairs\u003cRule\u003e) -\u003e Result\u003cAssignment, ParserError\u003e {\n    let mut column_name = String::new();\n    let mut value = Value::Null;\n\n    for pair in pairs {\n        match pair.as_rule() {\n            Rule::column_name =\u003e {\n                column_name = pair.as_str().to_string();\n            }\n            Rule::value =\u003e {\n                value = parse_value(pair.into_inner())?;\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(Assignment { column_name, value })\n}\n","traces":[{"line":31,"address":[13962096],"length":1,"stats":{"Line":1}},{"line":33,"address":[13737771],"length":1,"stats":{"Line":1}},{"line":34,"address":[14964532],"length":1,"stats":{"Line":0}},{"line":36,"address":[16282562],"length":1,"stats":{"Line":3}},{"line":38,"address":[14964514],"length":1,"stats":{"Line":1}},{"line":39,"address":[13738231],"length":1,"stats":{"Line":0}},{"line":40,"address":[14964772],"length":1,"stats":{"Line":0}},{"line":43,"address":[13931836,13931565],"length":1,"stats":{"Line":1}},{"line":45,"address":[13962732,13962503],"length":1,"stats":{"Line":1}},{"line":47,"address":[13931893],"length":1,"stats":{"Line":1}},{"line":48,"address":[13814516,13814575,13815051],"length":1,"stats":{"Line":0}},{"line":49,"address":[13739019,13738676,13738579],"length":1,"stats":{"Line":0}},{"line":50,"address":[14013600,14013638,14013396],"length":1,"stats":{"Line":0}},{"line":51,"address":[13932127],"length":1,"stats":{"Line":0}},{"line":53,"address":[13932414],"length":1,"stats":{"Line":1}},{"line":68,"address":[16247824],"length":1,"stats":{"Line":0}},{"line":69,"address":[14930417],"length":1,"stats":{"Line":0}},{"line":70,"address":[13703148],"length":1,"stats":{"Line":0}},{"line":71,"address":[14930571],"length":1,"stats":{"Line":0}},{"line":72,"address":[13978124],"length":1,"stats":{"Line":0}},{"line":73,"address":[14930829],"length":1,"stats":{"Line":0}},{"line":74,"address":[16248390],"length":1,"stats":{"Line":0}},{"line":80,"address":[13983360],"length":1,"stats":{"Line":0}},{"line":81,"address":[13776779,13776699],"length":1,"stats":{"Line":0}},{"line":82,"address":[13708956],"length":1,"stats":{"Line":0}},{"line":83,"address":[13785093],"length":1,"stats":{"Line":0}},{"line":84,"address":[13708995],"length":1,"stats":{"Line":0}},{"line":85,"address":[13902481],"length":1,"stats":{"Line":0}},{"line":86,"address":[17545651],"length":1,"stats":{"Line":0}},{"line":87,"address":[17545436],"length":1,"stats":{"Line":0}},{"line":215,"address":[13963712,13964489],"length":1,"stats":{"Line":4}},{"line":216,"address":[13846377,13846273,13847006],"length":1,"stats":{"Line":8}},{"line":217,"address":[16315264,16315511],"length":1,"stats":{"Line":8}},{"line":220,"address":[16315643,16315777],"length":1,"stats":{"Line":8}},{"line":224,"address":[14996118,14996289],"length":1,"stats":{"Line":8}},{"line":230,"address":[14045285],"length":1,"stats":{"Line":0}},{"line":233,"address":[16282446,16279856],"length":1,"stats":{"Line":4}},{"line":234,"address":[13928529,13928633,13931075],"length":1,"stats":{"Line":7}},{"line":235,"address":[14961967,14962201],"length":1,"stats":{"Line":6}},{"line":237,"address":[14010356,14011961],"length":1,"stats":{"Line":6}},{"line":240,"address":[14962340,14963840],"length":1,"stats":{"Line":2}},{"line":243,"address":[14010528,14012024],"length":1,"stats":{"Line":6}},{"line":246,"address":[13735862,13737294],"length":1,"stats":{"Line":2}},{"line":249,"address":[13737316,13735948],"length":1,"stats":{"Line":2}},{"line":252,"address":[14010786,14012090],"length":1,"stats":{"Line":2}},{"line":255,"address":[17572856,17574099],"length":1,"stats":{"Line":2}},{"line":258,"address":[17574124,17572942],"length":1,"stats":{"Line":2}},{"line":261,"address":[13737413,13736292],"length":1,"stats":{"Line":0}},{"line":264,"address":[17573114,17574174],"length":1,"stats":{"Line":0}},{"line":267,"address":[13805527,13804528],"length":1,"stats":{"Line":0}},{"line":270,"address":[13813456,13812518],"length":1,"stats":{"Line":2}},{"line":273,"address":[13737513,13736636],"length":1,"stats":{"Line":2}},{"line":276,"address":[14963324,14964128],"length":1,"stats":{"Line":6}},{"line":279,"address":[13930232],"length":1,"stats":{"Line":0}},{"line":282,"address":[16281648],"length":1,"stats":{"Line":0}},{"line":285,"address":[16281720],"length":1,"stats":{"Line":0}},{"line":288,"address":[13961947,13961408],"length":1,"stats":{"Line":2}},{"line":291,"address":[14964178,14963704],"length":1,"stats":{"Line":2}},{"line":297,"address":[14010085],"length":1,"stats":{"Line":0}},{"line":300,"address":[13753776,13756687,13755709],"length":1,"stats":{"Line":3}},{"line":301,"address":[13753798],"length":1,"stats":{"Line":3}},{"line":302,"address":[13829859],"length":1,"stats":{"Line":3}},{"line":303,"address":[14028702],"length":1,"stats":{"Line":3}},{"line":305,"address":[13822149,13824705,13822026,13822243],"length":1,"stats":{"Line":12}},{"line":306,"address":[17591381,17591002],"length":1,"stats":{"Line":6}},{"line":307,"address":[13755062],"length":1,"stats":{"Line":3}},{"line":308,"address":[16299476,16299690],"length":1,"stats":{"Line":6}},{"line":311,"address":[13832460,13831683,13830794,13831807],"length":1,"stats":{"Line":13}},{"line":312,"address":[13831894,13832447,13831984],"length":1,"stats":{"Line":9}},{"line":313,"address":[14981982],"length":1,"stats":{"Line":3}},{"line":314,"address":[14982255],"length":1,"stats":{"Line":3}},{"line":319,"address":[16299959,16299835,16299508],"length":1,"stats":{"Line":3}},{"line":320,"address":[13823334,13823700,13823427],"length":1,"stats":{"Line":4}},{"line":321,"address":[13979812],"length":1,"stats":{"Line":1}},{"line":329,"address":[13947832],"length":1,"stats":{"Line":3}},{"line":330,"address":[13947735],"length":1,"stats":{"Line":3}},{"line":331,"address":[16299118],"length":1,"stats":{"Line":3}},{"line":332,"address":[13978776],"length":1,"stats":{"Line":3}},{"line":336,"address":[13960019,13958352],"length":1,"stats":{"Line":3}},{"line":337,"address":[13840921],"length":1,"stats":{"Line":3}},{"line":338,"address":[14039782],"length":1,"stats":{"Line":3}},{"line":339,"address":[13989422],"length":1,"stats":{"Line":3}},{"line":341,"address":[13958690,13958596,13958470],"length":1,"stats":{"Line":9}},{"line":342,"address":[14991121,14990845],"length":1,"stats":{"Line":6}},{"line":343,"address":[13959369],"length":1,"stats":{"Line":3}},{"line":344,"address":[14040536,14040465],"length":1,"stats":{"Line":6}},{"line":347,"address":[13990126,13990344,13990442,13990943],"length":1,"stats":{"Line":13}},{"line":348,"address":[14040892,14040826],"length":1,"stats":{"Line":6}},{"line":349,"address":[14040869,14040948,14040909],"length":1,"stats":{"Line":7}},{"line":350,"address":[16310941,16310981,16311020],"length":1,"stats":{"Line":9}},{"line":351,"address":[13834333,13834372,13834293],"length":1,"stats":{"Line":0}},{"line":352,"address":[13990709,13990669,13990743],"length":1,"stats":{"Line":0}},{"line":353,"address":[14041083,14041133],"length":1,"stats":{"Line":0}},{"line":356,"address":[16310479],"length":1,"stats":{"Line":1}},{"line":358,"address":[14991179],"length":1,"stats":{"Line":1}},{"line":364,"address":[13989841],"length":1,"stats":{"Line":3}},{"line":365,"address":[14040147],"length":1,"stats":{"Line":3}},{"line":366,"address":[16310211],"length":1,"stats":{"Line":3}},{"line":367,"address":[13958874],"length":1,"stats":{"Line":3}},{"line":371,"address":[13919205,13916208,13918126],"length":1,"stats":{"Line":3}},{"line":372,"address":[13947190],"length":1,"stats":{"Line":3}},{"line":373,"address":[16267685],"length":1,"stats":{"Line":3}},{"line":374,"address":[13722922],"length":1,"stats":{"Line":3}},{"line":376,"address":[14950335,14950131,14952771,14950249],"length":1,"stats":{"Line":12}},{"line":377,"address":[16268508,16268062],"length":1,"stats":{"Line":6}},{"line":378,"address":[13800064],"length":1,"stats":{"Line":3}},{"line":379,"address":[13998551,13998708],"length":1,"stats":{"Line":6}},{"line":382,"address":[17560564,17560847],"length":1,"stats":{"Line":6}},{"line":383,"address":[13792202],"length":1,"stats":{"Line":3}},{"line":384,"address":[13998937,13999066],"length":1,"stats":{"Line":6}},{"line":386,"address":[13948718,13948645],"length":1,"stats":{"Line":6}},{"line":390,"address":[13948244,13949216,13949092,13949886],"length":1,"stats":{"Line":12}},{"line":391,"address":[13918433,13918343,13918913],"length":1,"stats":{"Line":9}},{"line":392,"address":[17561807],"length":1,"stats":{"Line":3}},{"line":393,"address":[14952438],"length":1,"stats":{"Line":3}},{"line":401,"address":[13791535],"length":1,"stats":{"Line":4}},{"line":402,"address":[13998091],"length":1,"stats":{"Line":3}},{"line":403,"address":[13947762],"length":1,"stats":{"Line":3}},{"line":404,"address":[13916847],"length":1,"stats":{"Line":3}},{"line":408,"address":[13797113,13796448],"length":1,"stats":{"Line":3}},{"line":409,"address":[13720497,13720601,13721074],"length":1,"stats":{"Line":6}},{"line":410,"address":[13796656,13796889],"length":1,"stats":{"Line":6}},{"line":411,"address":[17557719,17557828],"length":1,"stats":{"Line":6}},{"line":415,"address":[13914149],"length":1,"stats":{"Line":0}},{"line":418,"address":[14959158,14959182,14957392],"length":1,"stats":{"Line":3}},{"line":419,"address":[14957415,14957517],"length":1,"stats":{"Line":6}},{"line":420,"address":[13731024,13730773],"length":1,"stats":{"Line":6}},{"line":423,"address":[16276065,16275853],"length":1,"stats":{"Line":2}},{"line":424,"address":[13807297],"length":1,"stats":{"Line":1}},{"line":425,"address":[16276226],"length":1,"stats":{"Line":1}},{"line":428,"address":[13710352],"length":1,"stats":{"Line":6}},{"line":429,"address":[13858813],"length":1,"stats":{"Line":0}},{"line":431,"address":[13956191],"length":1,"stats":{"Line":3}},{"line":434,"address":[13702208],"length":1,"stats":{"Line":6}},{"line":435,"address":[13827615],"length":1,"stats":{"Line":0}},{"line":437,"address":[13925521],"length":1,"stats":{"Line":3}},{"line":440,"address":[13808155,13807149],"length":1,"stats":{"Line":0}},{"line":441,"address":[13800384],"length":1,"stats":{"Line":0}},{"line":444,"address":[14958015],"length":1,"stats":{"Line":0}},{"line":450,"address":[17567552],"length":1,"stats":{"Line":0}},{"line":453,"address":[13803715,13801792,13804288],"length":1,"stats":{"Line":3}},{"line":454,"address":[13793910],"length":1,"stats":{"Line":3}},{"line":455,"address":[13950307],"length":1,"stats":{"Line":3}},{"line":456,"address":[14953016],"length":1,"stats":{"Line":3}},{"line":458,"address":[14953024,14955206,14953142,14953228],"length":1,"stats":{"Line":12}},{"line":459,"address":[16271075,16271521],"length":1,"stats":{"Line":6}},{"line":461,"address":[17563577,17563860],"length":1,"stats":{"Line":6}},{"line":462,"address":[14954247,14954705],"length":1,"stats":{"Line":2}},{"line":464,"address":[14954168,14954297,14954393],"length":1,"stats":{"Line":9}},{"line":465,"address":[17564236,17564329],"length":1,"stats":{"Line":6}},{"line":466,"address":[13803626],"length":1,"stats":{"Line":3}},{"line":471,"address":[14954097],"length":1,"stats":{"Line":3}},{"line":472,"address":[13802780,13802937],"length":1,"stats":{"Line":6}},{"line":474,"address":[16272907],"length":1,"stats":{"Line":0}},{"line":475,"address":[13952189,13951257],"length":1,"stats":{"Line":0}},{"line":481,"address":[14953484],"length":1,"stats":{"Line":3}},{"line":482,"address":[13802320],"length":1,"stats":{"Line":3}},{"line":483,"address":[14001143],"length":1,"stats":{"Line":3}},{"line":484,"address":[13726436],"length":1,"stats":{"Line":3}},{"line":488,"address":[13760112,13761313],"length":1,"stats":{"Line":1}},{"line":489,"address":[13984518],"length":1,"stats":{"Line":1}},{"line":490,"address":[13984592],"length":1,"stats":{"Line":1}},{"line":492,"address":[13953682,13953802,13953893],"length":1,"stats":{"Line":3}},{"line":493,"address":[13984932,13985279],"length":1,"stats":{"Line":2}},{"line":494,"address":[16306076],"length":1,"stats":{"Line":1}},{"line":495,"address":[13760973,13761168],"length":1,"stats":{"Line":2}},{"line":497,"address":[13837122],"length":1,"stats":{"Line":1}},{"line":498,"address":[13985398,13985328],"length":1,"stats":{"Line":2}},{"line":504,"address":[17597407],"length":1,"stats":{"Line":1}},{"line":505,"address":[13984977],"length":1,"stats":{"Line":1}},{"line":506,"address":[14035384],"length":1,"stats":{"Line":1}},{"line":510,"address":[13957233,13956032],"length":1,"stats":{"Line":1}},{"line":511,"address":[17599366],"length":1,"stats":{"Line":1}},{"line":512,"address":[14037456],"length":1,"stats":{"Line":1}},{"line":514,"address":[14988569,14988486,14988370],"length":1,"stats":{"Line":3}},{"line":515,"address":[13956468,13956815],"length":1,"stats":{"Line":2}},{"line":516,"address":[14038556],"length":1,"stats":{"Line":1}},{"line":517,"address":[17600400,17600205],"length":1,"stats":{"Line":2}},{"line":519,"address":[17600386],"length":1,"stats":{"Line":1}},{"line":520,"address":[13987894,13987824],"length":1,"stats":{"Line":2}},{"line":526,"address":[14988763],"length":1,"stats":{"Line":1}},{"line":527,"address":[13839057],"length":1,"stats":{"Line":1}},{"line":528,"address":[13763128],"length":1,"stats":{"Line":1}},{"line":532,"address":[13985744,13986945],"length":1,"stats":{"Line":1}},{"line":533,"address":[13829446],"length":1,"stats":{"Line":1}},{"line":534,"address":[13761456],"length":1,"stats":{"Line":1}},{"line":536,"address":[13761506,13761717,13761626],"length":1,"stats":{"Line":3}},{"line":537,"address":[13829860,13830207],"length":1,"stats":{"Line":2}},{"line":538,"address":[16307324],"length":1,"stats":{"Line":1}},{"line":539,"address":[13830480,13830285],"length":1,"stats":{"Line":2}},{"line":541,"address":[13986786],"length":1,"stats":{"Line":1}},{"line":542,"address":[13955686,13955616],"length":1,"stats":{"Line":2}},{"line":548,"address":[17598655],"length":1,"stats":{"Line":1}},{"line":549,"address":[13829905],"length":1,"stats":{"Line":1}},{"line":550,"address":[13837848],"length":1,"stats":{"Line":1}},{"line":554,"address":[16303479,16301488],"length":1,"stats":{"Line":1}},{"line":555,"address":[13832710],"length":1,"stats":{"Line":1}},{"line":556,"address":[14031586],"length":1,"stats":{"Line":1}},{"line":557,"address":[14031591],"length":1,"stats":{"Line":1}},{"line":559,"address":[13952089,13950397,13950271,13950491],"length":1,"stats":{"Line":4}},{"line":560,"address":[13757594,13757154],"length":1,"stats":{"Line":2}},{"line":561,"address":[16302718],"length":1,"stats":{"Line":1}},{"line":562,"address":[16302421,16302578],"length":1,"stats":{"Line":2}},{"line":564,"address":[13834105],"length":1,"stats":{"Line":1}},{"line":566,"address":[16302733,16302450],"length":1,"stats":{"Line":2}},{"line":568,"address":[14984300],"length":1,"stats":{"Line":1}},{"line":569,"address":[14032466,14032910],"length":1,"stats":{"Line":2}},{"line":575,"address":[16302093],"length":1,"stats":{"Line":1}},{"line":576,"address":[13833167],"length":1,"stats":{"Line":1}},{"line":577,"address":[17593974],"length":1,"stats":{"Line":1}},{"line":578,"address":[16302045],"length":1,"stats":{"Line":1}},{"line":582,"address":[14992096,14995426,14993383],"length":1,"stats":{"Line":1}},{"line":583,"address":[14992118],"length":1,"stats":{"Line":1}},{"line":584,"address":[17603499],"length":1,"stats":{"Line":1}},{"line":585,"address":[13766829],"length":1,"stats":{"Line":1}},{"line":586,"address":[13960287],"length":1,"stats":{"Line":1}},{"line":588,"address":[13960421,13960295,13963375,13960515],"length":1,"stats":{"Line":4}},{"line":589,"address":[16311946,16312791],"length":1,"stats":{"Line":2}},{"line":591,"address":[13836546,13836771,13836185],"length":1,"stats":{"Line":3}},{"line":592,"address":[13836555],"length":1,"stats":{"Line":1}},{"line":595,"address":[17605209],"length":1,"stats":{"Line":1}},{"line":596,"address":[13836145,13836381],"length":1,"stats":{"Line":2}},{"line":598,"address":[13962486],"length":1,"stats":{"Line":1}},{"line":599,"address":[13768728,13768135],"length":1,"stats":{"Line":2}},{"line":602,"address":[13837519,13836285,13837395],"length":1,"stats":{"Line":3}},{"line":603,"address":[13963362,13963051,13962958],"length":1,"stats":{"Line":3}},{"line":604,"address":[16314460],"length":1,"stats":{"Line":1}},{"line":612,"address":[13767223],"length":1,"stats":{"Line":1}},{"line":613,"address":[13835837,13835364],"length":1,"stats":{"Line":2}},{"line":614,"address":[14042589],"length":1,"stats":{"Line":0}},{"line":615,"address":[17604537],"length":1,"stats":{"Line":0}},{"line":620,"address":[13960909],"length":1,"stats":{"Line":1}},{"line":621,"address":[14992762],"length":1,"stats":{"Line":1}},{"line":622,"address":[16312149],"length":1,"stats":{"Line":1}},{"line":623,"address":[17604173],"length":1,"stats":{"Line":1}},{"line":627,"address":[14021456,14023422],"length":1,"stats":{"Line":1}},{"line":628,"address":[13814790],"length":1,"stats":{"Line":1}},{"line":629,"address":[17583544],"length":1,"stats":{"Line":1}},{"line":630,"address":[13971252],"length":1,"stats":{"Line":1}},{"line":632,"address":[13822970,13824592,13823064,13822844],"length":1,"stats":{"Line":4}},{"line":633,"address":[13940607,13941047],"length":1,"stats":{"Line":2}},{"line":634,"address":[13824102],"length":1,"stats":{"Line":1}},{"line":635,"address":[13816058,13815775],"length":1,"stats":{"Line":2}},{"line":637,"address":[14022731],"length":1,"stats":{"Line":1}},{"line":638,"address":[13747839,13747682],"length":1,"stats":{"Line":2}},{"line":640,"address":[13816553],"length":1,"stats":{"Line":1}},{"line":641,"address":[13824123,13823711],"length":1,"stats":{"Line":2}},{"line":647,"address":[13940778],"length":1,"stats":{"Line":1}},{"line":648,"address":[17583964],"length":1,"stats":{"Line":1}},{"line":649,"address":[16292035],"length":1,"stats":{"Line":1}},{"line":650,"address":[14022058],"length":1,"stats":{"Line":1}},{"line":654,"address":[13934080,13936046],"length":1,"stats":{"Line":0}},{"line":655,"address":[17577414],"length":1,"stats":{"Line":0}},{"line":656,"address":[14967256],"length":1,"stats":{"Line":0}},{"line":657,"address":[13816788],"length":1,"stats":{"Line":0}},{"line":659,"address":[14969016,14967528,14967324,14967442],"length":1,"stats":{"Line":0}},{"line":660,"address":[17577871,17578311],"length":1,"stats":{"Line":0}},{"line":661,"address":[13810150],"length":1,"stats":{"Line":0}},{"line":662,"address":[13817914,13817631],"length":1,"stats":{"Line":0}},{"line":664,"address":[13935355],"length":1,"stats":{"Line":0}},{"line":665,"address":[16286559,16286402],"length":1,"stats":{"Line":0}},{"line":667,"address":[14968889],"length":1,"stats":{"Line":0}},{"line":668,"address":[13966079,13966491],"length":1,"stats":{"Line":0}},{"line":674,"address":[13809370],"length":1,"stats":{"Line":0}},{"line":675,"address":[14967652],"length":1,"stats":{"Line":0}},{"line":676,"address":[14015971],"length":1,"stats":{"Line":0}},{"line":677,"address":[13741258],"length":1,"stats":{"Line":0}},{"line":681,"address":[13820656,13822622],"length":1,"stats":{"Line":0}},{"line":682,"address":[14019462],"length":1,"stats":{"Line":0}},{"line":683,"address":[13969176],"length":1,"stats":{"Line":0}},{"line":684,"address":[13969236],"length":1,"stats":{"Line":0}},{"line":686,"address":[14019612,14021360,14019832,14019738],"length":1,"stats":{"Line":0}},{"line":687,"address":[13745607,13745167],"length":1,"stats":{"Line":0}},{"line":688,"address":[16290886],"length":1,"stats":{"Line":0}},{"line":689,"address":[16290746,16290463],"length":1,"stats":{"Line":0}},{"line":691,"address":[13939387],"length":1,"stats":{"Line":0}},{"line":692,"address":[13813730,13813887],"length":1,"stats":{"Line":0}},{"line":694,"address":[13970857],"length":1,"stats":{"Line":0}},{"line":695,"address":[13745727,13746139],"length":1,"stats":{"Line":0}},{"line":701,"address":[13969722],"length":1,"stats":{"Line":0}},{"line":702,"address":[16289980],"length":1,"stats":{"Line":0}},{"line":703,"address":[13813315],"length":1,"stats":{"Line":0}},{"line":704,"address":[13969674],"length":1,"stats":{"Line":0}},{"line":708,"address":[14969088,14970990],"length":1,"stats":{"Line":0}},{"line":709,"address":[13936118],"length":1,"stats":{"Line":0}},{"line":710,"address":[13810840],"length":1,"stats":{"Line":0}},{"line":711,"address":[13936260],"length":1,"stats":{"Line":0}},{"line":713,"address":[14970952,14969464,14969378,14969260],"length":1,"stats":{"Line":0}},{"line":714,"address":[13743151,13743591],"length":1,"stats":{"Line":0}},{"line":715,"address":[13812166],"length":1,"stats":{"Line":0}},{"line":716,"address":[13937103,13937386],"length":1,"stats":{"Line":0}},{"line":718,"address":[13743947],"length":1,"stats":{"Line":0}},{"line":719,"address":[13968034,13968191],"length":1,"stats":{"Line":0}},{"line":721,"address":[16289225],"length":1,"stats":{"Line":0}},{"line":722,"address":[13819679,13820091],"length":1,"stats":{"Line":0}},{"line":728,"address":[14018074],"length":1,"stats":{"Line":0}},{"line":729,"address":[13811260],"length":1,"stats":{"Line":0}},{"line":730,"address":[13819203],"length":1,"stats":{"Line":0}},{"line":731,"address":[13811338],"length":1,"stats":{"Line":0}},{"line":735,"address":[16293488,16296235,16296861],"length":1,"stats":{"Line":1}},{"line":736,"address":[13824716],"length":1,"stats":{"Line":1}},{"line":737,"address":[16293604],"length":1,"stats":{"Line":1}},{"line":738,"address":[13824860],"length":1,"stats":{"Line":1}},{"line":739,"address":[13817004],"length":1,"stats":{"Line":1}},{"line":740,"address":[13749015],"length":1,"stats":{"Line":1}},{"line":742,"address":[16293791,16293917,16296815,16294011],"length":1,"stats":{"Line":4}},{"line":743,"address":[14024720,14024082],"length":1,"stats":{"Line":2}},{"line":745,"address":[13818134,13818903],"length":1,"stats":{"Line":2}},{"line":746,"address":[13826946,13827441],"length":1,"stats":{"Line":2}},{"line":748,"address":[14025888,14025764,14025647],"length":1,"stats":{"Line":0}},{"line":749,"address":[13944639,13944732],"length":1,"stats":{"Line":0}},{"line":750,"address":[13975757],"length":1,"stats":{"Line":0}},{"line":756,"address":[14976742,14976566,14976336,14976186],"length":1,"stats":{"Line":4}},{"line":757,"address":[13818509,13818291],"length":1,"stats":{"Line":2}},{"line":759,"address":[13750198,13750269],"length":1,"stats":{"Line":2}},{"line":764,"address":[16295383,16295592,16294824],"length":1,"stats":{"Line":3}},{"line":765,"address":[13818688],"length":1,"stats":{"Line":1}},{"line":768,"address":[13751865],"length":1,"stats":{"Line":0}},{"line":769,"address":[14026280,14024854],"length":1,"stats":{"Line":0}},{"line":775,"address":[13749615],"length":1,"stats":{"Line":1}},{"line":776,"address":[13825343],"length":1,"stats":{"Line":1}},{"line":777,"address":[14975575],"length":1,"stats":{"Line":1}},{"line":778,"address":[13817535],"length":1,"stats":{"Line":1}},{"line":779,"address":[13749519],"length":1,"stats":{"Line":1}},{"line":780,"address":[13942991],"length":1,"stats":{"Line":1}},{"line":784,"address":[13945552,13947152],"length":1,"stats":{"Line":1}},{"line":785,"address":[14026902],"length":1,"stats":{"Line":1}},{"line":786,"address":[13820288],"length":1,"stats":{"Line":1}},{"line":787,"address":[13945701],"length":1,"stats":{"Line":1}},{"line":789,"address":[13976711,13976837,13976931],"length":1,"stats":{"Line":3}},{"line":790,"address":[13977010,13977459],"length":1,"stats":{"Line":2}},{"line":791,"address":[13821444],"length":1,"stats":{"Line":1}},{"line":792,"address":[17589873,17589976],"length":1,"stats":{"Line":2}},{"line":794,"address":[13829515],"length":1,"stats":{"Line":1}},{"line":795,"address":[17589902,17590131],"length":1,"stats":{"Line":2}},{"line":797,"address":[16298491],"length":1,"stats":{"Line":1}},{"line":798,"address":[17590298,17589934],"length":1,"stats":{"Line":2}},{"line":804,"address":[13977187],"length":1,"stats":{"Line":1}},{"line":805,"address":[14978715],"length":1,"stats":{"Line":1}},{"line":806,"address":[13752710],"length":1,"stats":{"Line":1}},{"line":807,"address":[13820819],"length":1,"stats":{"Line":1}},{"line":811,"address":[13836041,13835959,13834720],"length":1,"stats":{"Line":1}},{"line":812,"address":[17595510],"length":1,"stats":{"Line":1}},{"line":814,"address":[13758868,13759073,13758982,13759945],"length":1,"stats":{"Line":4}},{"line":815,"address":[14034102,14034684,14033912],"length":1,"stats":{"Line":3}},{"line":816,"address":[14985173],"length":1,"stats":{"Line":1}},{"line":817,"address":[13953208],"length":1,"stats":{"Line":1}},{"line":821,"address":[14033962],"length":1,"stats":{"Line":1}},{"line":824,"address":[13810964,13811014,13808416],"length":1,"stats":{"Line":1}},{"line":825,"address":[13925894],"length":1,"stats":{"Line":1}},{"line":826,"address":[13808534],"length":1,"stats":{"Line":1}},{"line":827,"address":[13732632],"length":1,"stats":{"Line":1}},{"line":829,"address":[13957262,13957168,13959334,13957042],"length":1,"stats":{"Line":4}},{"line":830,"address":[13801029,13801953],"length":1,"stats":{"Line":2}},{"line":831,"address":[13734282],"length":1,"stats":{"Line":1}},{"line":832,"address":[16278716,16278873],"length":1,"stats":{"Line":2}},{"line":834,"address":[14009226],"length":1,"stats":{"Line":1}},{"line":835,"address":[16278745,16279065],"length":1,"stats":{"Line":2}},{"line":837,"address":[13802861],"length":1,"stats":{"Line":1}},{"line":838,"address":[16278777,16279263],"length":1,"stats":{"Line":2}},{"line":844,"address":[14007770],"length":1,"stats":{"Line":1}},{"line":845,"address":[16277895,16277829],"length":1,"stats":{"Line":2}},{"line":846,"address":[17569840,17569919,17569880],"length":1,"stats":{"Line":2}},{"line":847,"address":[13801224,13801264,13801303],"length":1,"stats":{"Line":2}},{"line":848,"address":[13809224,13809263,13809184],"length":1,"stats":{"Line":3}},{"line":849,"address":[13926696,13926775,13926736],"length":1,"stats":{"Line":0}},{"line":850,"address":[17570064,17570104,17570298],"length":1,"stats":{"Line":0}},{"line":851,"address":[14960111],"length":1,"stats":{"Line":0}},{"line":854,"address":[14960402],"length":1,"stats":{"Line":1}},{"line":855,"address":[13927023],"length":1,"stats":{"Line":1}},{"line":856,"address":[13801703],"length":1,"stats":{"Line":1}},{"line":857,"address":[13927070],"length":1,"stats":{"Line":1}},{"line":861,"address":[17565088,17567246],"length":1,"stats":{"Line":1}},{"line":862,"address":[16273142],"length":1,"stats":{"Line":1}},{"line":863,"address":[13796515],"length":1,"stats":{"Line":1}},{"line":864,"address":[13952904],"length":1,"stats":{"Line":1}},{"line":866,"address":[16273293,16273416,16273510,16275232],"length":1,"stats":{"Line":4}},{"line":867,"address":[13953647,13953213],"length":1,"stats":{"Line":2}},{"line":868,"address":[16274448],"length":1,"stats":{"Line":1}},{"line":869,"address":[13797390,13797604],"length":1,"stats":{"Line":2}},{"line":871,"address":[17567090],"length":1,"stats":{"Line":1}},{"line":872,"address":[13730359,13729444,13730073],"length":1,"stats":{"Line":2}},{"line":874,"address":[13954404],"length":1,"stats":{"Line":1}},{"line":875,"address":[16274126,16274469,16274793],"length":1,"stats":{"Line":2}},{"line":881,"address":[13797058],"length":1,"stats":{"Line":1}},{"line":882,"address":[14955774],"length":1,"stats":{"Line":1}},{"line":883,"address":[13922337],"length":1,"stats":{"Line":1}},{"line":884,"address":[13922376],"length":1,"stats":{"Line":1}},{"line":888,"address":[16267502,16265936],"length":1,"stats":{"Line":1}},{"line":889,"address":[13995942],"length":1,"stats":{"Line":1}},{"line":890,"address":[13914706],"length":1,"stats":{"Line":1}},{"line":892,"address":[14949852,14948503,14948615,14948698],"length":1,"stats":{"Line":4}},{"line":893,"address":[13789649,13789993],"length":1,"stats":{"Line":2}},{"line":894,"address":[13996990],"length":1,"stats":{"Line":1}},{"line":895,"address":[14949175,14949282],"length":1,"stats":{"Line":2}},{"line":897,"address":[13997324],"length":1,"stats":{"Line":1}},{"line":898,"address":[16266771,16267027],"length":1,"stats":{"Line":2}},{"line":904,"address":[14948900],"length":1,"stats":{"Line":1}},{"line":905,"address":[17558366],"length":1,"stats":{"Line":1}},{"line":906,"address":[13797637],"length":1,"stats":{"Line":1}},{"line":910,"address":[13764891,13763856],"length":1,"stats":{"Line":1}},{"line":911,"address":[17600614],"length":1,"stats":{"Line":1}},{"line":913,"address":[13839932,13840813,13840137,13840046],"length":1,"stats":{"Line":4}},{"line":914,"address":[13764446,13764256],"length":1,"stats":{"Line":2}},{"line":915,"address":[17601191,17601309],"length":1,"stats":{"Line":2}},{"line":919,"address":[13840274],"length":1,"stats":{"Line":1}},{"line":922,"address":[14965680,14967110],"length":1,"stats":{"Line":1}},{"line":923,"address":[13815110],"length":1,"stats":{"Line":1}},{"line":924,"address":[13739234],"length":1,"stats":{"Line":1}},{"line":926,"address":[13815327,13815207,13815418,13816532],"length":1,"stats":{"Line":4}},{"line":927,"address":[13815805,13815505],"length":1,"stats":{"Line":2}},{"line":928,"address":[13964530],"length":1,"stats":{"Line":1}},{"line":929,"address":[13964390,13964267],"length":1,"stats":{"Line":2}},{"line":931,"address":[16285216],"length":1,"stats":{"Line":1}},{"line":932,"address":[14014663,14014919],"length":1,"stats":{"Line":2}},{"line":938,"address":[14966123],"length":1,"stats":{"Line":1}}],"covered":316,"coverable":416},{"path":["/","home","azureuser","Documents","Chronos","src","parser","error.rs"],"content":"use thiserror::Error;\n\n#[derive(Error, Debug)]\npub enum ParserError {\n    #[error(\"Pest parser error: {0}\")]\n    PestError(String),\n\n    #[error(\"Invalid syntax: {0}\")]\n    InvalidSyntax(String),\n\n    #[error(\"Invalid data type: {0}\")]\n    InvalidDataType(String),\n\n    #[error(\"Invalid value: {0}\")]\n    InvalidValue(String),\n\n    #[error(\"Invalid operator: {0}\")]\n    InvalidOperator(String),\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","src","parser","mod.rs"],"content":"pub mod ast;\npub mod error;\n\nuse pest::Parser as PestParser;\nuse pest_derive::Parser;\n\npub use self::ast::{\n    Assignment, Ast, ColumnDefinition, Condition, DataType, Operator, Statement, TtlSpec, Value,\n};\npub use self::error::ParserError;\n\n#[derive(Parser)]\n#[grammar = \"parser/chronos.pest\"]\nstruct SqlParser;\n\npub struct Parser;\n\nimpl Parser {\n    pub fn parse(input: \u0026str) -\u003e Result\u003cAst, ParserError\u003e {\n        let pairs = SqlParser::parse(Rule::sql, input)\n            .map_err(|e| ParserError::PestError(e.to_string()))?;\n\n        ast::parse_ast(pairs)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_create_table() {\n        let sql = \"CREATE TABLE users (id INT PRIMARY KEY, name TEXT, age INT);\";\n        let ast = Parser::parse(sql).unwrap();\n\n        match ast {\n            Ast::Statement(Statement::CreateTable {\n                table_name,\n                columns,\n                ..\n            }) =\u003e {\n                assert_eq!(table_name, \"users\");\n                assert_eq!(columns.len(), 3);\n                assert_eq!(columns[0].name, \"id\");\n                assert_eq!(columns[0].data_type, DataType::Int);\n                assert!(columns[0].primary_key);\n                assert_eq!(columns[1].name, \"name\");\n                assert_eq!(columns[1].data_type, DataType::Text);\n                assert!(!columns[1].primary_key);\n                assert_eq!(columns[2].name, \"age\");\n                assert_eq!(columns[2].data_type, DataType::Int);\n                assert!(!columns[2].primary_key);\n            }\n            _ =\u003e panic!(\"Expected CreateTable statement\"),\n        }\n    }\n\n    #[test]\n    fn test_insert() {\n        let sql = \"INSERT INTO users VALUES ('John', 30);\";\n        let ast = Parser::parse(sql).unwrap();\n\n        match ast {\n            Ast::Statement(Statement::Insert {\n                table_name, values, ..\n            }) =\u003e {\n                assert_eq!(table_name, \"users\");\n                assert_eq!(values.len(), 2);\n            }\n            _ =\u003e panic!(\"Expected Insert statement\"),\n        }\n    }\n\n    #[test]\n    fn test_select() {\n        let sql = \"SELECT * FROM users;\";\n        let ast = Parser::parse(sql).unwrap();\n\n        match ast {\n            Ast::Statement(Statement::Select {\n                table_name,\n                columns,\n                ..\n            }) =\u003e {\n                assert_eq!(table_name, \"users\");\n                assert_eq!(columns, vec![\"*\"]);\n            }\n            _ =\u003e panic!(\"Expected Select statement\"),\n        }\n    }\n\n    #[test]\n    fn test_update() {\n        let sql = \"UPDATE users SET age = 31 WHERE name = 'John';\";\n        let ast = Parser::parse(sql).unwrap();\n\n        match ast {\n            Ast::Statement(Statement::Update {\n                table_name,\n                assignments,\n                conditions,\n            }) =\u003e {\n                assert_eq!(table_name, \"users\");\n                assert_eq!(assignments.len(), 1);\n                assert_eq!(assignments[0].column_name, \"age\");\n                assert_eq!(assignments[0].value, Value::Integer(31));\n\n                let conds = conditions.unwrap();\n                assert_eq!(conds.len(), 1);\n                assert_eq!(conds[0].column_name, \"name\");\n                assert_eq!(conds[0].operator, Operator::Equals);\n                assert_eq!(conds[0].value, Value::String(\"John\".to_string()));\n            }\n            _ =\u003e panic!(\"Expected Update statement\"),\n        }\n    }\n\n    #[test]\n    fn test_delete() {\n        let sql = \"DELETE FROM users WHERE age \u003e 30;\";\n        let ast = Parser::parse(sql).unwrap();\n\n        match ast {\n            Ast::Statement(Statement::Delete {\n                table_name,\n                conditions,\n            }) =\u003e {\n                assert_eq!(table_name, \"users\");\n\n                let conds = conditions.unwrap();\n                assert_eq!(conds.len(), 1);\n                assert_eq!(conds[0].column_name, \"age\");\n                assert_eq!(conds[0].operator, Operator::GreaterThan);\n                assert_eq!(conds[0].value, Value::Integer(30));\n            }\n            _ =\u003e panic!(\"Expected Delete statement\"),\n        }\n    }\n\n    #[test]\n    fn test_create_index() {\n        let sql = \"CREATE INDEX idx_users_on_name ON users(name);\";\n        let ast = Parser::parse(sql).unwrap();\n\n        match ast {\n            Ast::Statement(Statement::CreateIndex {\n                index_name,\n                table_name,\n                column_name,\n            }) =\u003e {\n                assert_eq!(index_name, \"idx_users_on_name\");\n                assert_eq!(table_name, \"users\");\n                assert_eq!(column_name, \"name\");\n            }\n            _ =\u003e panic!(\"Expected CreateIndex statement\"),\n        }\n    }\n\n    #[test]\n    fn test_select_avg_1h() {\n        let sql = \"SELECT AVG_1H(temp) FROM sensors;\";\n        let ast = Parser::parse(sql).unwrap();\n\n        match ast {\n            Ast::Statement(Statement::SelectAgg1h {\n                table_name,\n                column_name,\n            }) =\u003e {\n                assert_eq!(table_name, \"sensors\");\n                assert_eq!(column_name, \"temp\");\n            }\n            _ =\u003e panic!(\"Expected SelectAgg1h statement\"),\n        }\n    }\n\n    #[test]\n    fn test_select_avg_24h() {\n        let sql = \"SELECT AVG_24H(temp) FROM sensors;\";\n        let ast = Parser::parse(sql).unwrap();\n\n        match ast {\n            Ast::Statement(Statement::SelectAgg24h {\n                table_name,\n                column_name,\n            }) =\u003e {\n                assert_eq!(table_name, \"sensors\");\n                assert_eq!(column_name, \"temp\");\n            }\n            _ =\u003e panic!(\"Expected SelectAgg24h statement\"),\n        }\n    }\n\n    #[test]\n    fn test_select_avg_7d() {\n        let sql = \"SELECT AVG_7D(temp) FROM sensors;\";\n        let ast = Parser::parse(sql).unwrap();\n\n        match ast {\n            Ast::Statement(Statement::SelectAgg7d {\n                table_name,\n                column_name,\n            }) =\u003e {\n                assert_eq!(table_name, \"sensors\");\n                assert_eq!(column_name, \"temp\");\n            }\n            _ =\u003e panic!(\"Expected SelectAgg7d statement\"),\n        }\n    }\n\n    #[test]\n    fn test_select_count_star() {\n        let sql = \"SELECT COUNT(*) FROM sensors;\";\n        let ast = Parser::parse(sql).unwrap();\n\n        match ast {\n            Ast::Statement(Statement::SelectCount {\n                table_name,\n                column,\n                conditions,\n            }) =\u003e {\n                assert_eq!(table_name, \"sensors\");\n                assert!(column.is_none());\n                assert!(conditions.is_none());\n            }\n            _ =\u003e panic!(\"Expected SelectCount statement\"),\n        }\n    }\n\n    #[test]\n    fn test_select_sum_with_where() {\n        let sql = \"SELECT SUM(temp) FROM sensors WHERE temp \u003e 0;\";\n        let ast = Parser::parse(sql).unwrap();\n\n        match ast {\n            Ast::Statement(Statement::SelectSum {\n                table_name,\n                column_name,\n                conditions,\n            }) =\u003e {\n                assert_eq!(table_name, \"sensors\");\n                assert_eq!(column_name, \"temp\");\n\n                let conds = conditions.expect(\"expected conditions\");\n                assert_eq!(conds.len(), 1);\n                assert_eq!(conds[0].column_name, \"temp\");\n            }\n            _ =\u003e panic!(\"Expected SelectSum statement\"),\n        }\n    }\n\n    #[test]\n    fn test_select_join_using() {\n        let sql = \"SELECT * FROM sensors JOIN devices USING (device_id);\";\n        let ast = Parser::parse(sql).unwrap();\n\n        match ast {\n            Ast::Statement(Statement::SelectJoin {\n                left_table,\n                right_table,\n                join_column,\n                columns,\n                ..\n            }) =\u003e {\n                assert_eq!(left_table, \"sensors\");\n                assert_eq!(right_table, \"devices\");\n                assert_eq!(join_column, \"device_id\");\n                assert_eq!(columns, vec![\"*\".to_string()]);\n            }\n            _ =\u003e panic!(\"Expected SelectJoin statement\"),\n        }\n    }\n\n    #[test]\n    fn test_select_group_count_simple() {\n        let sql = \"SELECT device, COUNT(*) FROM sensors GROUP BY device;\";\n        let ast = Parser::parse(sql).unwrap();\n\n        match ast {\n            Ast::Statement(Statement::SelectGroupCount {\n                table_name,\n                group_column,\n                conditions,\n            }) =\u003e {\n                assert_eq!(table_name, \"sensors\");\n                assert_eq!(group_column, \"device\");\n                assert!(conditions.is_none());\n            }\n            _ =\u003e panic!(\"Expected SelectGroupCount statement\"),\n        }\n    }\n\n    #[test]\n    fn test_select_group_count_with_where() {\n        let sql = \"SELECT device, COUNT(*) FROM sensors WHERE temperature \u003e 0 GROUP BY device;\";\n        let ast = Parser::parse(sql).unwrap();\n\n        match ast {\n            Ast::Statement(Statement::SelectGroupCount {\n                table_name,\n                group_column,\n                conditions,\n            }) =\u003e {\n                assert_eq!(table_name, \"sensors\");\n                assert_eq!(group_column, \"device\");\n\n                let conds = conditions.expect(\"expected conditions\");\n                assert_eq!(conds.len(), 1);\n                assert_eq!(conds[0].column_name, \"temperature\");\n            }\n            _ =\u003e panic!(\"Expected SelectGroupCount statement\"),\n        }\n    }\n\n    #[test]\n    fn test_select_count_column_with_where() {\n        let sql = \"SELECT COUNT(temp) FROM sensors WHERE temp \u003e 0;\";\n        let ast = Parser::parse(sql).unwrap();\n\n        match ast {\n            Ast::Statement(Statement::SelectCount {\n                table_name,\n                column,\n                conditions,\n            }) =\u003e {\n                assert_eq!(table_name, \"sensors\");\n                assert_eq!(column, Some(\"temp\".to_string()));\n\n                let conds = conditions.expect(\"expected conditions\");\n                assert_eq!(conds.len(), 1);\n                assert_eq!(conds[0].column_name, \"temp\");\n            }\n            _ =\u003e panic!(\"Expected SelectCount statement\"),\n        }\n    }\n}\n","traces":[{"line":19,"address":[14214285,14213808,14214314],"length":1,"stats":{"Line":4}},{"line":20,"address":[14114708,14114518,14114567,14114670],"length":1,"stats":{"Line":12}},{"line":21,"address":[12383504,12383527],"length":1,"stats":{"Line":4}},{"line":23,"address":[14214151],"length":1,"stats":{"Line":4}}],"covered":4,"coverable":4},{"path":["/","home","azureuser","Documents","Chronos","src","raft","config.rs"],"content":"use std::collections::HashMap;\n\n#[derive(Debug, Clone)]\npub struct RaftConfig {\n    pub node_id: String,\n    pub data_dir: String,\n    pub peers: HashMap\u003cString, String\u003e, // node_id -\u003e address\n    pub election_timeout_min: u64,      // in milliseconds\n    pub election_timeout_max: u64,      // in milliseconds\n    pub heartbeat_interval: u64,        // in milliseconds\n}\n\nimpl RaftConfig {\n    pub fn new(node_id: \u0026str, data_dir: \u0026str) -\u003e Self {\n        Self {\n            node_id: node_id.to_string(),\n            data_dir: data_dir.to_string(),\n            peers: HashMap::new(),\n            // Defaults tuned for small edge nodes (low CPU/RAM) to reduce\n            // spurious elections under scheduler and network jitter.\n            election_timeout_min: 800,\n            election_timeout_max: 1600,\n            heartbeat_interval: 100,\n        }\n    }\n\n    pub fn add_peer(\u0026mut self, peer_id: \u0026str, address: \u0026str) {\n        self.peers.insert(peer_id.to_string(), address.to_string());\n    }\n}\n","traces":[{"line":14,"address":[16747593,16747599,16747280],"length":1,"stats":{"Line":1}},{"line":16,"address":[16747338],"length":1,"stats":{"Line":1}},{"line":17,"address":[16747377],"length":1,"stats":{"Line":1}},{"line":18,"address":[16747422],"length":1,"stats":{"Line":1}},{"line":27,"address":[14282458,14282487,14282256],"length":1,"stats":{"Line":0}},{"line":28,"address":[14197495,14197331,14197392],"length":1,"stats":{"Line":0}}],"covered":4,"coverable":6},{"path":["/","home","azureuser","Documents","Chronos","src","raft","error.rs"],"content":"use thiserror::Error;\n\n#[derive(Error, Debug)]\npub enum RaftError {\n    #[error(\"Not a leader\")]\n    NotLeader,\n\n    #[error(\"Node is not running\")]\n    NotRunning,\n\n    #[error(\"Invalid term: {0}\")]\n    InvalidTerm(u64),\n\n    #[error(\"Invalid log index: {0}\")]\n    InvalidLogIndex(u64),\n\n    #[error(\"Network error: {0}\")]\n    NetworkError(String),\n\n    #[error(\"IO error: {0}\")]\n    IoError(#[from] std::io::Error),\n\n    #[error(\"Serialization error: {0}\")]\n    SerializationError(String),\n\n    #[error(\"Timeout\")]\n    Timeout,\n\n    #[error(\"Consensus failed\")]\n    ConsensusFailed,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","src","raft","log.rs"],"content":"use serde::{Deserialize, Serialize};\nuse std::fs::File;\nuse std::io::{Read, Write};\nuse std::path::PathBuf;\n\nuse super::RaftError;\n\n#[derive(Debug, Clone, Serialize, Deserialize, bincode::Encode, bincode::Decode)]\npub struct LogEntry {\n    pub term: u64,\n    pub command: Vec\u003cu8\u003e,\n}\n\npub struct Log {\n    entries: Vec\u003cLogEntry\u003e,\n    log_file: PathBuf,\n}\n\nimpl Log {\n    pub fn new(data_dir: \u0026str) -\u003e Self {\n        let log_dir = PathBuf::from(data_dir).join(\"raft\");\n        if !log_dir.exists() {\n            std::fs::create_dir_all(\u0026log_dir).expect(\"Failed to create raft log directory\");\n        }\n\n        let log_file = log_dir.join(\"log.bin\");\n\n        let mut log = Self {\n            entries: Vec::new(),\n            log_file,\n        };\n\n        // Load existing log entries\n        if log.log_file.exists() {\n            match log.load_from_disk() {\n                Ok(_) =\u003e {}\n                Err(e) =\u003e {\n                    eprintln!(\"Error loading log from disk: {e}\");\n                    // In a production system, we might want to handle this more gracefully\n                }\n            }\n        }\n\n        // Add a dummy entry at index 0\n        if log.entries.is_empty() {\n            log.entries.push(LogEntry {\n                term: 0,\n                command: Vec::new(),\n            });\n        }\n\n        log\n    }\n\n    pub fn last_index(\u0026self) -\u003e u64 {\n        self.entries.len() as u64 - 1\n    }\n\n    pub fn term_at(\u0026self, index: u64) -\u003e Option\u003cu64\u003e {\n        if index == 0 {\n            return Some(0);\n        }\n\n        self.entries.get(index as usize).map(|e| e.term)\n    }\n\n    pub fn append(\u0026mut self, entry: LogEntry) -\u003e Result\u003cu64, RaftError\u003e {\n        self.entries.push(entry.clone());\n        let index = self.entries.len() as u64 - 1;\n\n        // Append to disk\n        self.append_to_disk(\u0026entry)?;\n\n        Ok(index)\n    }\n\n    pub fn get_entry(\u0026self, index: u64) -\u003e Result\u003cOption\u003cLogEntry\u003e, RaftError\u003e {\n        Ok(self.entries.get(index as usize).cloned())\n    }\n\n    pub fn get_entries(\u0026self, start: u64, end: Option\u003cu64\u003e) -\u003e Result\u003cVec\u003cLogEntry\u003e, RaftError\u003e {\n        let end = end.unwrap_or(self.entries.len() as u64);\n\n        if start \u003e= end || start \u003e= self.entries.len() as u64 {\n            return Ok(Vec::new());\n        }\n\n        let end = end.min(self.entries.len() as u64);\n\n        Ok(self.entries[start as usize..end as usize].to_vec())\n    }\n\n    pub fn truncate(\u0026mut self, index: u64) -\u003e Result\u003c(), RaftError\u003e {\n        if index \u003c 1 {\n            return Err(RaftError::InvalidLogIndex(index));\n        }\n\n        if index \u003e= self.entries.len() as u64 {\n            return Ok(());\n        }\n\n        self.entries.truncate(index as usize + 1);\n\n        // Rewrite the log file\n        self.save_to_disk()?;\n\n        Ok(())\n    }\n\n    fn load_from_disk(\u0026mut self) -\u003e Result\u003c(), RaftError\u003e {\n        let mut file = File::open(\u0026self.log_file)?;\n        let mut buffer = Vec::new();\n        file.read_to_end(\u0026mut buffer)?;\n\n        if buffer.is_empty() {\n            return Ok(());\n        }\n\n        let (entries, _): (Vec\u003cLogEntry\u003e, usize) =\n            bincode::decode_from_slice(\u0026buffer, bincode::config::standard())\n                .map_err(|e| RaftError::SerializationError(e.to_string()))?;\n\n        self.entries = entries;\n\n        Ok(())\n    }\n\n    fn save_to_disk(\u0026self) -\u003e Result\u003c(), RaftError\u003e {\n        let encoded = bincode::encode_to_vec(\u0026self.entries, bincode::config::standard())\n            .map_err(|e| RaftError::SerializationError(e.to_string()))?;\n\n        let mut file = File::create(\u0026self.log_file)?;\n        file.write_all(\u0026encoded)?;\n\n        Ok(())\n    }\n\n    fn append_to_disk(\u0026self, _entry: \u0026LogEntry) -\u003e Result\u003c(), RaftError\u003e {\n        // In a real implementation, we would use a more efficient append-only log format\n        // For simplicity, we'll just rewrite the entire log file\n        self.save_to_disk()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use tempfile::tempdir;\n\n    #[test]\n    fn new_initializes_dummy_entry() {\n        let tmp = tempdir().expect(\"tempdir\");\n        let data_dir = tmp.path().to_string_lossy().to_string();\n\n        let log = Log::new(\u0026data_dir);\n\n        // Index 0 should always exist as a dummy entry with term 0.\n        assert_eq!(log.last_index(), 0);\n        assert_eq!(log.term_at(0), Some(0));\n    }\n\n    #[test]\n    fn append_and_persist_entries_across_restarts() {\n        let tmp = tempdir().expect(\"tempdir\");\n        let data_dir = tmp.path().to_string_lossy().to_string();\n\n        {\n            // First instance: append a couple of entries and ensure indices are correct.\n            let mut log = Log::new(\u0026data_dir);\n            let idx1 = log\n                .append(LogEntry {\n                    term: 1,\n                    command: b\"cmd1\".to_vec(),\n                })\n                .expect(\"append 1\");\n            let idx2 = log\n                .append(LogEntry {\n                    term: 2,\n                    command: b\"cmd2\".to_vec(),\n                })\n                .expect(\"append 2\");\n\n            assert_eq!(idx1, 1);\n            assert_eq!(idx2, 2);\n            assert_eq!(log.last_index(), 2);\n        }\n\n        // New instance reading from the same data_dir should see the persisted entries.\n        let log = Log::new(\u0026data_dir);\n        assert_eq!(log.last_index(), 2);\n        assert_eq!(log.term_at(1), Some(1));\n        assert_eq!(log.term_at(2), Some(2));\n\n        // get_entries should return the correct slice.\n        let entries = log.get_entries(1, None).expect(\"get_entries\");\n        assert_eq!(entries.len(), 2);\n        assert_eq!(entries[0].term, 1);\n        assert_eq!(entries[1].term, 2);\n    }\n\n    #[test]\n    fn truncate_discards_entries_and_rewrites_log() {\n        let tmp = tempdir().expect(\"tempdir\");\n        let data_dir = tmp.path().to_string_lossy().to_string();\n\n        let mut log = Log::new(\u0026data_dir);\n        for term in 1..=3u64 {\n            log.append(LogEntry {\n                term,\n                command: vec![],\n            })\n            .expect(\"append\");\n        }\n\n        assert_eq!(log.last_index(), 3);\n\n        // Truncate down to index 1 should keep dummy + first real entry.\n        log.truncate(1).expect(\"truncate\");\n        assert_eq!(log.last_index(), 1);\n        assert_eq!(log.term_at(1), Some(1));\n\n        // Truncating with index 0 is invalid.\n        let err = log.truncate(0).unwrap_err();\n        match err {\n            RaftError::InvalidLogIndex(i) =\u003e assert_eq!(i, 0),\n            other =\u003e panic!(\"unexpected error: {other:?}\"),\n        }\n    }\n}\n","traces":[{"line":20,"address":[13560560,13561701,13561673],"length":1,"stats":{"Line":2}},{"line":21,"address":[17139361],"length":1,"stats":{"Line":2}},{"line":22,"address":[13498073],"length":1,"stats":{"Line":2}},{"line":23,"address":[13448937,13448985],"length":1,"stats":{"Line":4}},{"line":26,"address":[13560867,13560931],"length":1,"stats":{"Line":4}},{"line":29,"address":[13449067],"length":1,"stats":{"Line":2}},{"line":34,"address":[13561214,13561143],"length":1,"stats":{"Line":4}},{"line":35,"address":[13683485],"length":1,"stats":{"Line":1}},{"line":37,"address":[14063088],"length":1,"stats":{"Line":0}},{"line":38,"address":[13683623,13683552],"length":1,"stats":{"Line":0}},{"line":45,"address":[13350195,13350470],"length":1,"stats":{"Line":4}},{"line":46,"address":[13498842],"length":1,"stats":{"Line":2}},{"line":48,"address":[13498823],"length":1,"stats":{"Line":2}},{"line":52,"address":[15767441],"length":1,"stats":{"Line":2}},{"line":55,"address":[13495648],"length":1,"stats":{"Line":2}},{"line":56,"address":[17137113,17137147],"length":1,"stats":{"Line":2}},{"line":59,"address":[13442320],"length":1,"stats":{"Line":2}},{"line":60,"address":[13684360],"length":1,"stats":{"Line":2}},{"line":61,"address":[15768078],"length":1,"stats":{"Line":2}},{"line":64,"address":[14057909,14057904],"length":1,"stats":{"Line":6}},{"line":67,"address":[13350688,13351069],"length":1,"stats":{"Line":2}},{"line":68,"address":[13561776,13561829],"length":1,"stats":{"Line":4}},{"line":69,"address":[13442049,13442121],"length":1,"stats":{"Line":2}},{"line":72,"address":[13350882,13350909],"length":1,"stats":{"Line":4}},{"line":74,"address":[13442258],"length":1,"stats":{"Line":2}},{"line":77,"address":[13450720],"length":1,"stats":{"Line":1}},{"line":78,"address":[13442858],"length":1,"stats":{"Line":1}},{"line":81,"address":[15764320],"length":1,"stats":{"Line":1}},{"line":82,"address":[13495778],"length":1,"stats":{"Line":1}},{"line":84,"address":[15764429],"length":1,"stats":{"Line":1}},{"line":85,"address":[17137305],"length":1,"stats":{"Line":0}},{"line":88,"address":[13438785],"length":1,"stats":{"Line":1}},{"line":90,"address":[13680841],"length":1,"stats":{"Line":1}},{"line":93,"address":[13442432],"length":1,"stats":{"Line":2}},{"line":94,"address":[13562283],"length":1,"stats":{"Line":2}},{"line":95,"address":[17141093],"length":1,"stats":{"Line":2}},{"line":98,"address":[15768214],"length":1,"stats":{"Line":2}},{"line":99,"address":[15768328],"length":1,"stats":{"Line":1}},{"line":102,"address":[14064270,14064160,14064206],"length":1,"stats":{"Line":4}},{"line":105,"address":[17141280,17141209],"length":1,"stats":{"Line":2}},{"line":107,"address":[14064368],"length":1,"stats":{"Line":2}},{"line":110,"address":[14062281,14062323,14061296],"length":1,"stats":{"Line":1}},{"line":111,"address":[13439742],"length":1,"stats":{"Line":1}},{"line":112,"address":[14061428],"length":1,"stats":{"Line":1}},{"line":113,"address":[13497006,13497798,13497091],"length":1,"stats":{"Line":2}},{"line":115,"address":[13497206],"length":1,"stats":{"Line":1}},{"line":116,"address":[13448079],"length":1,"stats":{"Line":0}},{"line":119,"address":[15766078,15766431,15765934,15765869,15766000],"length":1,"stats":{"Line":1}},{"line":121,"address":[13678210,13678192],"length":1,"stats":{"Line":1}},{"line":123,"address":[13349224,13349362,13349280],"length":1,"stats":{"Line":2}},{"line":125,"address":[13349385],"length":1,"stats":{"Line":1}},{"line":128,"address":[15764640,15765365,15765373],"length":1,"stats":{"Line":2}},{"line":129,"address":[13681106,13680958,13681005],"length":1,"stats":{"Line":4}},{"line":130,"address":[15764766,15764695],"length":1,"stats":{"Line":2}},{"line":132,"address":[14060757,14060821,14061227],"length":1,"stats":{"Line":4}},{"line":133,"address":[13439422,13439342],"length":1,"stats":{"Line":4}},{"line":135,"address":[15765283],"length":1,"stats":{"Line":2}},{"line":138,"address":[13447568],"length":1,"stats":{"Line":2}},{"line":141,"address":[13496789],"length":1,"stats":{"Line":2}}],"covered":55,"coverable":59},{"path":["/","home","azureuser","Documents","Chronos","src","raft","mod.rs"],"content":"mod config;\nmod error;\nmod log;\nmod node;\nmod state;\n\npub use self::config::RaftConfig;\npub use self::error::RaftError;\npub use self::log::{Log, LogEntry};\npub use self::node::RaftNode;\npub use self::state::{NodeRole, NodeState};\n\nuse std::sync::Arc;\nuse std::time::Duration;\nuse tokio::sync::{mpsc, Mutex};\nuse tokio::time::sleep;\n// Use external log crate, not our own log module\nuse ::log::{debug, error, info};\n\n// Message types for Raft communication\n#[derive(Debug, Clone)]\npub enum RaftMessage {\n    // Leader election messages\n    RequestVote {\n        term: u64,\n        candidate_id: String,\n        last_log_index: u64,\n        last_log_term: u64,\n    },\n    PreVote {\n        term: u64,\n        candidate_id: String,\n        last_log_index: u64,\n        last_log_term: u64,\n    },\n    RequestVoteResponse {\n        term: u64,\n        vote_granted: bool,\n    },\n    PreVoteResponse {\n        term: u64,\n        vote_granted: bool,\n    },\n    RequestVoteResponseFromPeer {\n        peer_id: String,\n        term: u64,\n        vote_granted: bool,\n    },\n    PreVoteResponseFromPeer {\n        peer_id: String,\n        term: u64,\n        vote_granted: bool,\n    },\n\n    // Log replication messages\n    AppendEntries {\n        term: u64,\n        leader_id: String,\n        prev_log_index: u64,\n        prev_log_term: u64,\n        entries: Vec\u003cLogEntry\u003e,\n        leader_commit: u64,\n    },\n    AppendEntriesResponse {\n        term: u64,\n        success: bool,\n        match_index: u64,\n    },\n    AppendEntriesResponseFromPeer {\n        peer_id: String,\n        term: u64,\n        success: bool,\n        match_index: u64,\n    },\n}\n\n// Main Raft service\npub struct Raft {\n    pub node: Arc\u003cMutex\u003cRaftNode\u003e\u003e,\n}\n\nimpl Raft {\n    pub fn new(config: RaftConfig) -\u003e Self {\n        let node = RaftNode::new(config);\n        Self {\n            node: Arc::new(Mutex::new(node)),\n        }\n    }\n\n    pub async fn start(\u0026self) -\u003e Result\u003c(), RaftError\u003e {\n        let node = Arc::clone(\u0026self.node);\n\n        // Create channels for message passing\n        let (tx, mut rx) = mpsc::channel(100);\n\n        // Store the sender in the node\n        {\n            let mut node_lock = node.lock().await;\n            node_lock.set_message_sender(tx.clone());\n        }\n\n        // Spawn a task to handle incoming messages\n        let node_clone = Arc::clone(\u0026node);\n        tokio::spawn(async move {\n            while let Some(message) = rx.recv().await {\n                let mut node = node_clone.lock().await;\n                match node.handle_message(message) {\n                    Ok(_) =\u003e {}\n                    Err(e) =\u003e error!(\"Error handling message: {e}\"),\n                }\n            }\n        });\n\n        // Spawn a task for election timeout\n        let node_clone = Arc::clone(\u0026node);\n        tokio::spawn(async move {\n            loop {\n                let timeout = {\n                    let node = node_clone.lock().await;\n                    if node.is_leader() {\n                        // Leaders don't have election timeouts\n                        Duration::from_millis(node.config().heartbeat_interval)\n                    } else {\n                        // Random election timeout\n                        node.get_election_timeout()\n                    }\n                };\n\n                sleep(timeout).await;\n\n                let mut node = node_clone.lock().await;\n                if node.is_leader() {\n                    // Send heartbeats\n                    match node.send_heartbeats() {\n                        Ok(_) =\u003e debug!(\"Sent heartbeats\"),\n                        Err(e) =\u003e error!(\"Error sending heartbeats: {e}\"),\n                    }\n                } else {\n                    // Check if election timeout has elapsed\n                    if node.election_timeout_elapsed() {\n                        info!(\"Election timeout elapsed, starting pre-vote\");\n                        match node.start_pre_vote() {\n                            Ok(_) =\u003e debug!(\"Started election\"),\n                            Err(e) =\u003e error!(\"Error starting election: {e}\"),\n                        }\n                    }\n                }\n            }\n        });\n\n        Ok(())\n    }\n\n    pub fn submit_command(\u0026self, _command: Vec\u003cu8\u003e) -\u003e Result\u003c(), RaftError\u003e {\n        // This is a sync wrapper - actual submission happens through async lock in caller\n        // Caller should lock the node and call RaftNode::submit_command directly\n        unimplemented!(\"Use direct RaftNode::submit_command via lock instead\")\n    }\n}\n","traces":[{"line":83,"address":[15911328],"length":1,"stats":{"Line":0}},{"line":84,"address":[18479274],"length":1,"stats":{"Line":0}},{"line":86,"address":[19735123],"length":1,"stats":{"Line":0}},{"line":90,"address":[12157813,12158791,12157632,12157675,12158109,12157768],"length":1,"stats":{"Line":0}},{"line":91,"address":[14422684,14422797],"length":1,"stats":{"Line":0}},{"line":94,"address":[14203968,14204054],"length":1,"stats":{"Line":0}},{"line":98,"address":[14284775,14284709,14284535,14284904],"length":1,"stats":{"Line":0}},{"line":99,"address":[18028234,18028307],"length":1,"stats":{"Line":0}},{"line":103,"address":[14423428],"length":1,"stats":{"Line":0}},{"line":104,"address":[12158881,12160815,12158937,12159010,12160748,12158470,12158848],"length":1,"stats":{"Line":0}},{"line":105,"address":[12924809],"length":1,"stats":{"Line":0}},{"line":106,"address":[14394269,14395961,14394394,14396006,14394369],"length":1,"stats":{"Line":0}},{"line":107,"address":[14205517,14205592],"length":1,"stats":{"Line":0}},{"line":109,"address":[14278695,14278791],"length":1,"stats":{"Line":0}},{"line":115,"address":[14277693],"length":1,"stats":{"Line":0}},{"line":116,"address":[18028538,18030992,18031179,18031031,18031087,18034643,18032890],"length":1,"stats":{"Line":0}},{"line":117,"address":[14207309],"length":1,"stats":{"Line":0}},{"line":119,"address":[14297200,14297103,14297157,14299675,14299764],"length":1,"stats":{"Line":0}},{"line":120,"address":[14283148,14283221],"length":1,"stats":{"Line":0}},{"line":122,"address":[14429239,14429142],"length":1,"stats":{"Line":0}},{"line":125,"address":[16756286,16756339],"length":1,"stats":{"Line":0}},{"line":129,"address":[14438032],"length":1,"stats":{"Line":0}},{"line":131,"address":[14438052],"length":1,"stats":{"Line":0}},{"line":132,"address":[12161433,12161493],"length":1,"stats":{"Line":0}},{"line":134,"address":[14297683,14298904],"length":1,"stats":{"Line":0}},{"line":135,"address":[12162855],"length":1,"stats":{"Line":0}},{"line":136,"address":[16755546,16755175],"length":1,"stats":{"Line":0}},{"line":140,"address":[14207880,14207945],"length":1,"stats":{"Line":0}},{"line":141,"address":[14426830,14426918],"length":1,"stats":{"Line":0}},{"line":142,"address":[12161688,12161955],"length":1,"stats":{"Line":0}},{"line":143,"address":[16754454],"length":1,"stats":{"Line":0}},{"line":144,"address":[12162375,12161990],"length":1,"stats":{"Line":0}},{"line":151,"address":[14204844],"length":1,"stats":{"Line":0}},{"line":154,"address":[13374144,13374243],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":34},{"path":["/","home","azureuser","Documents","Chronos","src","raft","node.rs"],"content":"use rand::Rng;\nuse std::collections::HashMap;\nuse std::time::{Duration, Instant};\nuse tokio::sync::{mpsc, oneshot};\n// Use external log crate, not our own log module\nuse ::log::{debug, error, info};\n\nuse super::{Log, LogEntry, NodeRole, NodeState, RaftConfig, RaftError, RaftMessage};\n\npub struct RaftNode {\n    // Node identity\n    id: String,\n\n    // Raft state\n    state: NodeState,\n    log: Log,\n\n    // Configuration\n    config: RaftConfig,\n\n    // Communication\n    peers: HashMap\u003cString, String\u003e, // node_id -\u003e address\n    message_sender: Option\u003cmpsc::Sender\u003cRaftMessage\u003e\u003e,\n\n    // Election state\n    last_election_time: Instant,\n    votes_received: HashMap\u003cString, bool\u003e,\n\n    // Leader state\n    next_index: HashMap\u003cString, u64\u003e,\n    match_index: HashMap\u003cString, u64\u003e,\n    // Leader lease for low-latency reads\n    lease_expiry: Option\u003cInstant\u003e,\n    lease_duration: Duration,\n    // Optional channel to forward committed commands to an external state\n    // machine (e.g., the SQL Executor) for application.\n    apply_sender: Option\u003cmpsc::UnboundedSender\u003cVec\u003cu8\u003e\u003e\u003e,\n    // For the current leader: map of log index -\u003e oneshot sender used to\n    // notify when a given entry has been committed and applied locally.\n    pending_commands: HashMap\u003cu64, oneshot::Sender\u003c()\u003e\u003e,\n}\n\nimpl RaftNode {\n    pub fn new(config: RaftConfig) -\u003e Self {\n        let peers = config.peers.clone();\n        let heartbeat_interval = config.heartbeat_interval;\n\n        Self {\n            id: config.node_id.clone(),\n            state: NodeState {\n                current_term: 0,\n                voted_for: None,\n                role: NodeRole::Follower,\n                leader_id: None,\n                commit_index: 0,\n                last_applied: 0,\n            },\n            log: Log::new(\u0026config.data_dir),\n            config,\n            peers,\n            message_sender: None,\n            last_election_time: Instant::now(),\n            votes_received: HashMap::new(),\n            next_index: HashMap::new(),\n            match_index: HashMap::new(),\n            lease_expiry: None,\n            lease_duration: Duration::from_millis(heartbeat_interval * 3),\n            apply_sender: None,\n            pending_commands: HashMap::new(),\n        }\n    }\n\n    pub fn set_apply_sender(\u0026mut self, sender: mpsc::UnboundedSender\u003cVec\u003cu8\u003e\u003e) {\n        self.apply_sender = Some(sender);\n    }\n\n    pub fn config(\u0026self) -\u003e \u0026RaftConfig {\n        \u0026self.config\n    }\n\n    pub fn state(\u0026self) -\u003e \u0026NodeState {\n        \u0026self.state\n    }\n\n    pub fn set_message_sender(\u0026mut self, sender: mpsc::Sender\u003cRaftMessage\u003e) {\n        self.message_sender = Some(sender);\n    }\n\n    pub fn is_leader(\u0026self) -\u003e bool {\n        matches!(self.state.role, NodeRole::Leader)\n    }\n\n    pub fn get_election_timeout(\u0026self) -\u003e Duration {\n        let mut rng = rand::rng();\n        let timeout_ms =\n            rng.random_range(self.config.election_timeout_min..=self.config.election_timeout_max);\n        Duration::from_millis(timeout_ms)\n    }\n\n    pub fn election_timeout_elapsed(\u0026self) -\u003e bool {\n        let elapsed = self.last_election_time.elapsed().as_millis() as u64;\n        elapsed \u003e self.config.election_timeout_max\n    }\n\n    fn abort_pending_commands(\u0026mut self) {\n        // Dropping the senders will cause any awaiters on the corresponding\n        // oneshot::Receiver to observe an error instead of hanging forever.\n        self.pending_commands.clear();\n    }\n\n    pub fn start_election(\u0026mut self) -\u003e Result\u003c(), RaftError\u003e {\n        // Increment current term\n        self.state.current_term += 1;\n\n        // Vote for self\n        self.state.voted_for = Some(self.id.clone());\n        self.state.role = NodeRole::Candidate;\n\n        // Reset election timer\n        self.last_election_time = Instant::now();\n\n        // Reset votes received\n        self.votes_received.clear();\n        self.votes_received.insert(self.id.clone(), true);\n\n        // Send RequestVote RPCs to all peers\n        let last_log_index = self.log.last_index();\n        let last_log_term = self.log.term_at(last_log_index).unwrap_or(0);\n\n        let request = RaftMessage::RequestVote {\n            term: self.state.current_term,\n            candidate_id: self.id.clone(),\n            last_log_index,\n            last_log_term,\n        };\n\n        self.broadcast_message(request)?;\n\n        // Check if we have already won the election (e.g. single node cluster)\n        let majority_count = self.peers.len().div_ceil(2) + 1;\n        if self.votes_received.len() \u003e= majority_count {\n            info!(\n                \"Election won (single node), becoming leader for term {}\",\n                self.state.current_term\n            );\n            self.become_leader()?;\n        }\n\n        Ok(())\n    }\n\n    pub fn start_pre_vote(\u0026mut self) -\u003e Result\u003c(), RaftError\u003e {\n        // Pre-vote does not change current_term or voted_for.\n        self.state.role = NodeRole::Candidate;\n        self.last_election_time = Instant::now();\n        self.votes_received.clear();\n        // Count self as a pre-vote yes.\n        self.votes_received.insert(self.id.clone(), true);\n\n        let last_log_index = self.log.last_index();\n        let last_log_term = self.log.term_at(last_log_index).unwrap_or(0);\n\n        let request = RaftMessage::PreVote {\n            term: self.state.current_term,\n            candidate_id: self.id.clone(),\n            last_log_index,\n            last_log_term,\n        };\n\n        self.broadcast_message(request)?;\n\n        // Single-node optimization\n        let majority_count = self.peers.len().div_ceil(2) + 1;\n        if self.votes_received.len() \u003e= majority_count {\n            // Proceed to real election\n            self.start_election()?;\n        }\n\n        Ok(())\n    }\n\n    pub fn send_heartbeats(\u0026mut self) -\u003e Result\u003c(), RaftError\u003e {\n        if !self.is_leader() {\n            return Err(RaftError::NotLeader);\n        }\n\n        for peer_id in self.peers.keys() {\n            let next_idx = self.next_index.get(peer_id).cloned().unwrap_or(1);\n            let prev_log_index = next_idx - 1;\n            let prev_log_term = self.log.term_at(prev_log_index).unwrap_or(0);\n\n            // Get entries to send (empty for heartbeat)\n            let entries = Vec::new();\n\n            let message = RaftMessage::AppendEntries {\n                term: self.state.current_term,\n                leader_id: self.id.clone(),\n                prev_log_index,\n                prev_log_term,\n                entries,\n                leader_commit: self.state.commit_index,\n            };\n\n            self.send_message_to_peer(peer_id, message.clone())?;\n        }\n        // Extend leader lease after sending heartbeats\n        self.lease_expiry = Some(Instant::now() + self.lease_duration);\n\n        Ok(())\n    }\n\n    pub fn submit_command(\u0026mut self, command: Vec\u003cu8\u003e) -\u003e Result\u003coneshot::Receiver\u003c()\u003e, RaftError\u003e {\n        if !self.is_leader() {\n            return Err(RaftError::NotLeader);\n        }\n\n        // Append to local log\n        let entry = LogEntry {\n            term: self.state.current_term,\n            command,\n        };\n\n        let log_index = self.log.append(entry)?;\n        let (tx, rx) = oneshot::channel();\n        self.pending_commands.insert(log_index, tx);\n        // Update commit index immediately after appending so that single-node\n        // clusters (with no peers) can commit entries based on the leader's\n        // own log, while multi-node clusters still wait for follower\n        // match_index updates.\n        self.update_commit_index()?;\n\n        // Replicate to followers\n        self.replicate_log()?;\n\n        Ok(rx)\n    }\n\n    pub fn replicate_log(\u0026mut self) -\u003e Result\u003c(), RaftError\u003e {\n        if !self.is_leader() {\n            return Err(RaftError::NotLeader);\n        }\n\n        for peer_id in self.peers.keys() {\n            let next_idx = self.next_index.get(peer_id).cloned().unwrap_or(1);\n            let prev_log_index = next_idx - 1;\n            let prev_log_term = self.log.term_at(prev_log_index).unwrap_or(0);\n\n            // Get entries to send\n            let entries = self.log.get_entries(next_idx, None)?;\n\n            let message = RaftMessage::AppendEntries {\n                term: self.state.current_term,\n                leader_id: self.id.clone(),\n                prev_log_index,\n                prev_log_term,\n                entries,\n                leader_commit: self.state.commit_index,\n            };\n\n            self.send_message_to_peer(peer_id, message.clone())?;\n        }\n\n        Ok(())\n    }\n\n    pub fn handle_message(\n        \u0026mut self,\n        message: RaftMessage,\n    ) -\u003e Result\u003cOption\u003cRaftMessage\u003e, RaftError\u003e {\n        match message {\n            RaftMessage::RequestVote {\n                term,\n                candidate_id,\n                last_log_index,\n                last_log_term,\n            } =\u003e self.handle_request_vote(term, candidate_id, last_log_index, last_log_term),\n            RaftMessage::PreVote {\n                term,\n                candidate_id: _,\n                last_log_index,\n                last_log_term,\n            } =\u003e {\n                // Pre-vote check: do NOT change term or voted_for.\n                let mut vote_granted = false;\n                let our_last_log_index = self.log.last_index();\n                let our_last_log_term = self.log.term_at(our_last_log_index).unwrap_or(0);\n                if term \u003e= self.state.current_term\n                    \u0026\u0026 (last_log_term \u003e our_last_log_term\n                        || (last_log_term == our_last_log_term\n                            \u0026\u0026 last_log_index \u003e= our_last_log_index))\n                {\n                    vote_granted = true;\n                }\n                let response = RaftMessage::PreVoteResponse {\n                    term: self.state.current_term,\n                    vote_granted,\n                };\n                Ok(Some(response))\n            }\n            RaftMessage::RequestVoteResponseFromPeer {\n                peer_id,\n                term,\n                vote_granted,\n            } =\u003e self\n                .handle_request_vote_response(peer_id, term, vote_granted)\n                .map(|_| None),\n            RaftMessage::PreVoteResponseFromPeer {\n                peer_id,\n                term,\n                vote_granted,\n            } =\u003e {\n                // Ignore responses with higher term (become follower)\n                if term \u003e self.state.current_term {\n                    self.state.current_term = term;\n                    self.state.voted_for = None;\n                    self.state.role = NodeRole::Follower;\n                    self.abort_pending_commands();\n                    return Ok(None);\n                }\n                if self.state.role == NodeRole::Candidate\n                    \u0026\u0026 term == self.state.current_term\n                    \u0026\u0026 vote_granted\n                {\n                    self.votes_received.insert(peer_id, true);\n                    let votes_needed = self.peers.len().div_ceil(2) + 1; // +1 self\n                    if self.votes_received.values().filter(|\u0026\u0026v| v).count() \u003e= votes_needed {\n                        // Start the real election now\n                        self.start_election()?;\n                    }\n                }\n                Ok(None)\n            }\n            RaftMessage::AppendEntries {\n                term,\n                leader_id,\n                prev_log_index,\n                prev_log_term,\n                entries,\n                leader_commit,\n            } =\u003e self.handle_append_entries(\n                term,\n                leader_id,\n                prev_log_index,\n                prev_log_term,\n                entries,\n                leader_commit,\n            ),\n            RaftMessage::AppendEntriesResponseFromPeer {\n                peer_id,\n                term,\n                success,\n                match_index,\n            } =\u003e self\n                .handle_append_entries_response(peer_id, term, success, match_index)\n                .map(|_| None),\n            // Plain response variants should not normally be sent into the RaftNode\n            // event loop; they are wrapped into *_FromPeer by send_message_to_peer.\n            // Handle them as no-ops for robustness.\n            RaftMessage::RequestVoteResponse { .. }\n            | RaftMessage::PreVoteResponse { .. }\n            | RaftMessage::AppendEntriesResponse { .. } =\u003e Ok(None),\n        }\n    }\n\n    fn handle_request_vote(\n        \u0026mut self,\n        term: u64,\n        candidate_id: String,\n        last_log_index: u64,\n        last_log_term: u64,\n    ) -\u003e Result\u003cOption\u003cRaftMessage\u003e, RaftError\u003e {\n        let mut vote_granted = false;\n\n        // If the term is greater than our current term, update it\n        if term \u003e self.state.current_term {\n            self.state.current_term = term;\n            self.state.voted_for = None;\n            self.state.role = NodeRole::Follower;\n            self.abort_pending_commands();\n        }\n\n        // Decide whether to grant vote\n        if term \u003e= self.state.current_term\n            \u0026\u0026 (self.state.voted_for.is_none()\n                || self.state.voted_for.as_ref() == Some(\u0026candidate_id))\n        {\n            // Check if candidate's log is at least as up-to-date as ours\n            let our_last_log_index = self.log.last_index();\n            let our_last_log_term = self.log.term_at(our_last_log_index).unwrap_or(0);\n\n            if last_log_term \u003e our_last_log_term\n                || (last_log_term == our_last_log_term \u0026\u0026 last_log_index \u003e= our_last_log_index)\n            {\n                vote_granted = true;\n                self.state.voted_for = Some(candidate_id.clone());\n                self.last_election_time = Instant::now(); // Reset election timeout\n            }\n        }\n\n        // Create response\n        let response = RaftMessage::RequestVoteResponse {\n            term: self.state.current_term,\n            vote_granted,\n        };\n\n        Ok(Some(response))\n    }\n\n    fn handle_request_vote_response(\n        \u0026mut self,\n        peer_id: String,\n        term: u64,\n        vote_granted: bool,\n    ) -\u003e Result\u003c(), RaftError\u003e {\n        // If the term is greater than our current term, update it and become follower\n        if term \u003e self.state.current_term {\n            self.state.current_term = term;\n            self.state.voted_for = None;\n            self.state.role = NodeRole::Follower;\n            self.abort_pending_commands();\n            return Ok(());\n        }\n\n        // Only process if we're still a candidate and in the same term\n        if self.state.role == NodeRole::Candidate \u0026\u0026 term == self.state.current_term \u0026\u0026 vote_granted\n        {\n            // Count the vote for this specific peer\n            self.votes_received.insert(peer_id, true);\n\n            // Check if we have majority (peers + self)\n            let votes_needed = self.peers.len().div_ceil(2) + 1; // +1 for self\n            if self.votes_received.values().filter(|\u0026\u0026v| v).count() \u003e= votes_needed {\n                // We won the election!\n                self.become_leader()?;\n            }\n        }\n\n        Ok(())\n    }\n\n    fn handle_append_entries(\n        \u0026mut self,\n        term: u64,\n        leader_id: String,\n        prev_log_index: u64,\n        prev_log_term: u64,\n        entries: Vec\u003cLogEntry\u003e,\n        leader_commit: u64,\n    ) -\u003e Result\u003cOption\u003cRaftMessage\u003e, RaftError\u003e {\n        let mut success = false;\n\n        // If the term is greater than our current term, update it\n        if term \u003e self.state.current_term {\n            self.state.current_term = term;\n            self.state.voted_for = None;\n            self.state.role = NodeRole::Follower;\n        }\n\n        // Reply false if term \u003c currentTerm\n        if term \u003c self.state.current_term {\n            let response = RaftMessage::AppendEntriesResponse {\n                term: self.state.current_term,\n                success: false,\n                match_index: 0,\n            };\n\n            return Ok(Some(response));\n        }\n\n        // Reset election timeout since we heard from the leader\n        self.last_election_time = Instant::now();\n\n        // Update leader ID\n        self.state.leader_id = Some(leader_id.clone());\n\n        // Ensure we're a follower\n        if self.state.role != NodeRole::Follower {\n            self.state.role = NodeRole::Follower;\n            self.abort_pending_commands();\n        }\n\n        // Check if log contains an entry at prevLogIndex with prevLogTerm\n        let log_ok = if prev_log_index == 0 {\n            // Special case for empty log\n            true\n        } else if prev_log_index \u003e self.log.last_index() {\n            // Our log is too short\n            false\n        } else {\n            // Check if terms match\n            self.log.term_at(prev_log_index) == Some(prev_log_term)\n        };\n\n        if log_ok {\n            // If we have existing entries that conflict with new ones, delete them\n            if !entries.is_empty() {\n                let new_entries = entries.clone();\n                let start_idx = prev_log_index + 1;\n\n                // Find the first conflicting entry\n                let mut conflict_idx = None;\n                for (i, entry) in new_entries.iter().enumerate() {\n                    let log_idx = start_idx + i as u64;\n                    if let Some(existing_term) = self.log.term_at(log_idx) {\n                        if existing_term != entry.term {\n                            conflict_idx = Some(i);\n                            break;\n                        }\n                    } else {\n                        // We've reached the end of our log\n                        break;\n                    }\n                }\n\n                // Delete conflicting entries and append new ones\n                if let Some(idx) = conflict_idx {\n                    self.log.truncate(start_idx + idx as u64 - 1)?;\n                    for entry in new_entries[idx..].iter() {\n                        self.log.append(entry.clone())?;\n                    }\n                } else {\n                    // No conflicts, just append any entries we don't have\n                    let last_new_idx = start_idx + new_entries.len() as u64 - 1;\n                    if last_new_idx \u003e self.log.last_index() {\n                        let append_start_idx = self.log.last_index() + 1 - start_idx;\n                        for entry in new_entries[append_start_idx as usize..].iter() {\n                            self.log.append(entry.clone())?;\n                        }\n                    }\n                }\n            }\n\n            // Update commit index\n            if leader_commit \u003e self.state.commit_index {\n                self.state.commit_index = leader_commit.min(self.log.last_index());\n                // Apply committed entries (in a real implementation)\n                self.apply_committed_entries()?;\n            }\n\n            success = true;\n        }\n\n        // Create response\n        let response = RaftMessage::AppendEntriesResponse {\n            term: self.state.current_term,\n            success,\n            match_index: if success {\n                prev_log_index + entries.len() as u64\n            } else {\n                0\n            },\n        };\n\n        Ok(Some(response))\n    }\n\n    fn handle_append_entries_response(\n        \u0026mut self,\n        peer_id: String,\n        term: u64,\n        success: bool,\n        match_index: u64,\n    ) -\u003e Result\u003c(), RaftError\u003e {\n        // If the term is greater than our current term, update it and become follower\n        if term \u003e self.state.current_term {\n            self.state.current_term = term;\n            self.state.voted_for = None;\n            self.state.role = NodeRole::Follower;\n            self.abort_pending_commands();\n            return Ok(());\n        }\n\n        // Only process if we're still the leader and in the same term\n        if self.state.role == NodeRole::Leader \u0026\u0026 term == self.state.current_term {\n            if success {\n                // Update nextIndex and matchIndex for the follower\n                self.match_index.insert(peer_id.clone(), match_index);\n                self.next_index.insert(peer_id, match_index + 1);\n\n                // Check if we can commit any entries\n                self.update_commit_index()?;\n            } else {\n                // If AppendEntries failed because of log inconsistency, decrement nextIndex and retry\n                let next_idx = self.next_index.get(\u0026peer_id).cloned().unwrap_or(1);\n                if next_idx \u003e 1 {\n                    self.next_index.insert(peer_id, next_idx - 1);\n                    // Retry log replication (in a real implementation)\n                    // self.replicate_log_to_peer(\u0026peer_id)?;\n                }\n            }\n        }\n\n        Ok(())\n    }\n\n    fn become_leader(\u0026mut self) -\u003e Result\u003c(), RaftError\u003e {\n        if self.state.role != NodeRole::Candidate {\n            return Ok(());\n        }\n\n        info!(\n            \"Node {} becoming leader for term {}\",\n            self.id, self.state.current_term\n        );\n\n        self.state.role = NodeRole::Leader;\n        self.state.leader_id = Some(self.id.clone());\n        // Initialize leader lease\n        self.lease_expiry = Some(Instant::now() + self.lease_duration);\n\n        // Initialize leader state\n        let last_log_idx = self.log.last_index();\n        for peer_id in self.peers.keys() {\n            self.next_index.insert(peer_id.clone(), last_log_idx + 1);\n            self.match_index.insert(peer_id.clone(), 0);\n        }\n\n        // Send initial empty AppendEntries RPCs (heartbeats)\n        self.send_heartbeats()?;\n\n        Ok(())\n    }\n\n    pub fn can_serve_read_locally(\u0026self) -\u003e bool {\n        if !self.is_leader() {\n            return false;\n        }\n        match self.lease_expiry {\n            Some(exp) =\u003e Instant::now() \u003c exp,\n            None =\u003e false,\n        }\n    }\n\n    fn update_commit_index(\u0026mut self) -\u003e Result\u003c(), RaftError\u003e {\n        if self.state.role != NodeRole::Leader {\n            return Ok(());\n        }\n\n        // Find the highest log index that is replicated on a majority of servers\n        let mut match_indices: Vec\u003cu64\u003e = self.match_index.values().cloned().collect();\n        match_indices.push(self.log.last_index()); // Include the leader's log\n\n        match_indices.sort_unstable();\n        let majority_idx = match_indices[match_indices.len() / 2];\n\n        // Only commit if the entry is from the current term\n        if majority_idx \u003e self.state.commit_index {\n            if let Some(term) = self.log.term_at(majority_idx) {\n                if term == self.state.current_term {\n                    self.state.commit_index = majority_idx;\n                    // Apply committed entries (in a real implementation)\n                    self.apply_committed_entries()?;\n                }\n            }\n        }\n\n        Ok(())\n    }\n\n    fn apply_committed_entries(\u0026mut self) -\u003e Result\u003c(), RaftError\u003e {\n        while self.state.last_applied \u003c self.state.commit_index {\n            self.state.last_applied += 1;\n\n            // Get the entry\n            if let Some(entry) = self.log.get_entry(self.state.last_applied)? {\n                // Apply the command to the state machine\n                debug!(\n                    \"Applying log entry {} (term {})\",\n                    self.state.last_applied, entry.term\n                );\n                if let Some(tx) = \u0026self.apply_sender {\n                    if let Err(e) = tx.send(entry.command.clone()) {\n                        error!(\n                            \"Failed to forward committed command at index {}: {}\",\n                            self.state.last_applied, e\n                        );\n                    }\n                }\n\n                if self.is_leader() {\n                    if let Some(tx) = self.pending_commands.remove(\u0026self.state.last_applied) {\n                        let _ = tx.send(());\n                    }\n                }\n            }\n        }\n\n        Ok(())\n    }\n\n    fn broadcast_message(\u0026self, message: RaftMessage) -\u003e Result\u003c(), RaftError\u003e {\n        for peer_id in self.peers.keys() {\n            self.send_message_to_peer(peer_id, message.clone())?;\n        }\n\n        Ok(())\n    }\n\n    fn send_message_to_peer(\u0026self, peer_id: \u0026str, message: RaftMessage) -\u003e Result\u003c(), RaftError\u003e {\n        debug!(\"Sending message to peer {peer_id}: {message:?}\");\n\n        // Get the peer address\n        let peer_addr = self\n            .peers\n            .get(peer_id)\n            .ok_or_else(|| RaftError::NetworkError(format!(\"Unknown peer: {peer_id}\")))?;\n\n        // In a real implementation, we would use the network client to send the message\n        // For now, we'll just create a task to send it\n        let peer_addr = peer_addr.clone();\n        let message_clone = message.clone();\n        let peer_id_clone = peer_id.to_string(); // Clone the peer_id for the async block\n        let tx_opt = self.message_sender.clone();\n\n        tokio::spawn(async move {\n            use crate::network::RaftClient;\n\n            let mut client = RaftClient::new(\u0026peer_addr);\n\n            match message_clone {\n                RaftMessage::RequestVote {\n                    term,\n                    candidate_id,\n                    last_log_index,\n                    last_log_term,\n                } =\u003e {\n                    let resp = client\n                        .request_vote(term, \u0026candidate_id, last_log_index, last_log_term)\n                        .await;\n                    match (tx_opt, resp) {\n                        (Some(tx), Ok(RaftMessage::RequestVoteResponse { term, vote_granted })) =\u003e {\n                            let msg = RaftMessage::RequestVoteResponseFromPeer {\n                                peer_id: peer_id_clone.clone(),\n                                term,\n                                vote_granted,\n                            };\n                            if let Err(e) = tx.send(msg).await {\n                                error!(\"Failed to forward RequestVoteResponse from {peer_id_clone}: {e}\");\n                            }\n                        }\n                        (_, Err(e)) =\u003e {\n                            debug!(\"Failed to send RequestVote to {peer_id_clone}: {e}\");\n                        }\n                        _ =\u003e {}\n                    }\n                }\n                RaftMessage::PreVote {\n                    term,\n                    candidate_id,\n                    last_log_index,\n                    last_log_term,\n                } =\u003e {\n                    let resp = client\n                        .pre_vote(term, \u0026candidate_id, last_log_index, last_log_term)\n                        .await;\n                    match (tx_opt, resp) {\n                        (Some(tx), Ok(RaftMessage::PreVoteResponse { term, vote_granted })) =\u003e {\n                            let msg = RaftMessage::PreVoteResponseFromPeer {\n                                peer_id: peer_id_clone.clone(),\n                                term,\n                                vote_granted,\n                            };\n                            if let Err(e) = tx.send(msg).await {\n                                error!(\n                                    \"Failed to forward PreVoteResponse from {peer_id_clone}: {e}\"\n                                );\n                            }\n                        }\n                        (_, Err(e)) =\u003e {\n                            debug!(\"Failed to send PreVote to {peer_id_clone}: {e}\");\n                        }\n                        _ =\u003e {}\n                    }\n                }\n                RaftMessage::AppendEntries {\n                    term,\n                    leader_id,\n                    prev_log_index,\n                    prev_log_term,\n                    entries,\n                    leader_commit,\n                } =\u003e {\n                    let resp = client\n                        .append_entries(\n                            term,\n                            \u0026leader_id,\n                            prev_log_index,\n                            prev_log_term,\n                            entries,\n                            leader_commit,\n                        )\n                        .await;\n                    match (tx_opt, resp) {\n                        (\n                            Some(tx),\n                            Ok(RaftMessage::AppendEntriesResponse {\n                                term,\n                                success,\n                                match_index,\n                            }),\n                        ) =\u003e {\n                            let msg = RaftMessage::AppendEntriesResponseFromPeer {\n                                peer_id: peer_id_clone.clone(),\n                                term,\n                                success,\n                                match_index,\n                            };\n                            if let Err(e) = tx.send(msg).await {\n                                error!(\"Failed to forward AppendEntriesResponse from {peer_id_clone}: {e}\");\n                            }\n                        }\n                        (_, Err(e)) =\u003e {\n                            debug!(\"Failed to send AppendEntries to {peer_id_clone}: {e}\");\n                        }\n                        _ =\u003e {}\n                    }\n                }\n                _ =\u003e {\n                    error!(\"Cannot send response message to peer: {message_clone:?}\");\n                }\n            }\n        });\n\n        Ok(())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::time::{Duration, Instant};\n    use tempfile::tempdir;\n\n    #[test]\n    fn start_election_single_node_becomes_leader_and_sets_lease() {\n        let tmp = tempdir().expect(\"tempdir\");\n        let cfg = RaftConfig::new(\"n1\", tmp.path().to_str().unwrap());\n        let mut node = RaftNode::new(cfg);\n\n        assert_eq!(node.state.current_term, 0);\n        assert!(matches!(node.state.role, NodeRole::Follower));\n\n        node.start_election().expect(\"start_election\");\n\n        assert!(node.is_leader());\n        assert_eq!(node.state.current_term, 1);\n        assert_eq!(node.state.voted_for.as_deref(), Some(\"n1\"));\n        assert_eq!(node.state.leader_id.as_deref(), Some(\"n1\"));\n        assert!(node.lease_expiry.is_some());\n        assert!(node.can_serve_read_locally());\n    }\n\n    #[test]\n    fn can_serve_read_locally_false_when_not_leader_or_no_lease() {\n        let tmp = tempdir().expect(\"tempdir\");\n        let cfg = RaftConfig::new(\"n1\", tmp.path().to_str().unwrap());\n        let node = RaftNode::new(cfg);\n\n        assert!(!node.is_leader());\n        assert!(!node.can_serve_read_locally());\n    }\n\n    #[test]\n    fn can_serve_read_locally_false_when_lease_expired() {\n        let tmp = tempdir().expect(\"tempdir\");\n        let cfg = RaftConfig::new(\"n1\", tmp.path().to_str().unwrap());\n        let mut node = RaftNode::new(cfg);\n\n        node.state.role = NodeRole::Leader;\n        node.lease_expiry = Some(Instant::now() - Duration::from_millis(1));\n        assert!(!node.can_serve_read_locally());\n    }\n\n    #[tokio::test]\n    async fn abort_pending_commands_cancels_waiters() {\n        let tmp = tempdir().expect(\"tempdir\");\n        let cfg = RaftConfig::new(\"n1\", tmp.path().to_str().unwrap());\n        let mut node = RaftNode::new(cfg);\n\n        let (tx, rx) = oneshot::channel::\u003c()\u003e();\n        node.pending_commands.insert(1, tx);\n\n        node.abort_pending_commands();\n\n        assert!(rx.await.is_err());\n    }\n}\n","traces":[{"line":44,"address":[19230160,19231559,19231666],"length":1,"stats":{"Line":1}},{"line":45,"address":[15488032,15487942],"length":1,"stats":{"Line":2}},{"line":46,"address":[19230280],"length":1,"stats":{"Line":1}},{"line":49,"address":[12752597],"length":1,"stats":{"Line":1}},{"line":50,"address":[15501064],"length":1,"stats":{"Line":1}},{"line":58,"address":[15634207,15634132],"length":1,"stats":{"Line":2}},{"line":62,"address":[19230764],"length":1,"stats":{"Line":1}},{"line":63,"address":[15511886],"length":1,"stats":{"Line":1}},{"line":64,"address":[17960433],"length":1,"stats":{"Line":1}},{"line":65,"address":[15603597],"length":1,"stats":{"Line":1}},{"line":67,"address":[19230990],"length":1,"stats":{"Line":1}},{"line":69,"address":[15501791],"length":1,"stats":{"Line":1}},{"line":73,"address":[15621104,15621163],"length":1,"stats":{"Line":0}},{"line":74,"address":[17947092,17947135,17947064],"length":1,"stats":{"Line":0}},{"line":77,"address":[15604384],"length":1,"stats":{"Line":0}},{"line":78,"address":[15635352],"length":1,"stats":{"Line":0}},{"line":81,"address":[19231696],"length":1,"stats":{"Line":1}},{"line":82,"address":[15407928],"length":1,"stats":{"Line":1}},{"line":85,"address":[15475931,15475872],"length":1,"stats":{"Line":0}},{"line":86,"address":[15475924,15475967,15475896],"length":1,"stats":{"Line":0}},{"line":89,"address":[15604400],"length":1,"stats":{"Line":1}},{"line":90,"address":[19231733],"length":1,"stats":{"Line":1}},{"line":93,"address":[12742782,12742608,12742788],"length":1,"stats":{"Line":0}},{"line":94,"address":[15490702],"length":1,"stats":{"Line":0}},{"line":95,"address":[15623743,15623681],"length":1,"stats":{"Line":0}},{"line":97,"address":[15592826],"length":1,"stats":{"Line":0}},{"line":100,"address":[15631440],"length":1,"stats":{"Line":0}},{"line":101,"address":[15498493],"length":1,"stats":{"Line":0}},{"line":102,"address":[19227865],"length":1,"stats":{"Line":0}},{"line":105,"address":[19225888],"length":1,"stats":{"Line":1}},{"line":108,"address":[15506933],"length":1,"stats":{"Line":1}},{"line":111,"address":[15616840,15616640],"length":1,"stats":{"Line":1}},{"line":113,"address":[19213154,19213038],"length":1,"stats":{"Line":1}},{"line":116,"address":[12735862,12736016,12735940],"length":1,"stats":{"Line":2}},{"line":117,"address":[15483956],"length":1,"stats":{"Line":1}},{"line":120,"address":[15585963],"length":1,"stats":{"Line":1}},{"line":123,"address":[15471075],"length":1,"stats":{"Line":1}},{"line":124,"address":[15586005],"length":1,"stats":{"Line":1}},{"line":127,"address":[12736163],"length":1,"stats":{"Line":1}},{"line":128,"address":[15494468],"length":1,"stats":{"Line":1}},{"line":131,"address":[19213472],"length":1,"stats":{"Line":1}},{"line":132,"address":[15389708],"length":1,"stats":{"Line":1}},{"line":137,"address":[12736379],"length":1,"stats":{"Line":1}},{"line":140,"address":[12736639,12736548],"length":1,"stats":{"Line":1}},{"line":141,"address":[15471615],"length":1,"stats":{"Line":1}},{"line":142,"address":[15586692,15586581],"length":1,"stats":{"Line":2}},{"line":146,"address":[15390175,15390491],"length":1,"stats":{"Line":1}},{"line":149,"address":[19213897],"length":1,"stats":{"Line":1}},{"line":152,"address":[15472128],"length":1,"stats":{"Line":0}},{"line":154,"address":[15472158],"length":1,"stats":{"Line":0}},{"line":155,"address":[15390629],"length":1,"stats":{"Line":0}},{"line":156,"address":[15472189],"length":1,"stats":{"Line":0}},{"line":158,"address":[15472207],"length":1,"stats":{"Line":0}},{"line":160,"address":[15618137],"length":1,"stats":{"Line":0}},{"line":161,"address":[12737301],"length":1,"stats":{"Line":0}},{"line":164,"address":[15472340],"length":1,"stats":{"Line":0}},{"line":165,"address":[15390816],"length":1,"stats":{"Line":0}},{"line":170,"address":[15495748],"length":1,"stats":{"Line":0}},{"line":173,"address":[15587548,15587641],"length":1,"stats":{"Line":0}},{"line":174,"address":[15587617],"length":1,"stats":{"Line":0}},{"line":176,"address":[12737764],"length":1,"stats":{"Line":0}},{"line":179,"address":[15587659],"length":1,"stats":{"Line":0}},{"line":182,"address":[15475193,15474096,15475187],"length":1,"stats":{"Line":1}},{"line":183,"address":[15487046],"length":1,"stats":{"Line":1}},{"line":184,"address":[15620029],"length":1,"stats":{"Line":0}},{"line":187,"address":[15589198,15590062,15589120],"length":1,"stats":{"Line":2}},{"line":188,"address":[15474365],"length":1,"stats":{"Line":0}},{"line":189,"address":[15393107,15392983,15392876],"length":1,"stats":{"Line":0}},{"line":190,"address":[15487439],"length":1,"stats":{"Line":0}},{"line":193,"address":[15497855],"length":1,"stats":{"Line":0}},{"line":196,"address":[17946413],"length":1,"stats":{"Line":0}},{"line":197,"address":[15393081],"length":1,"stats":{"Line":0}},{"line":201,"address":[15589674],"length":1,"stats":{"Line":0}},{"line":204,"address":[15620737,15620833],"length":1,"stats":{"Line":0}},{"line":207,"address":[19216676],"length":1,"stats":{"Line":1}},{"line":209,"address":[15392961],"length":1,"stats":{"Line":1}},{"line":212,"address":[15496224,15497286,15497335],"length":1,"stats":{"Line":0}},{"line":213,"address":[15496267,15496351],"length":1,"stats":{"Line":0}},{"line":214,"address":[15391546],"length":1,"stats":{"Line":0}},{"line":219,"address":[19215378],"length":1,"stats":{"Line":0}},{"line":223,"address":[12738201,12738982,12738260],"length":1,"stats":{"Line":0}},{"line":224,"address":[15473402],"length":1,"stats":{"Line":0}},{"line":225,"address":[19215810,19215714],"length":1,"stats":{"Line":0}},{"line":230,"address":[15486530,15486866],"length":1,"stats":{"Line":0}},{"line":233,"address":[15619805,15619623],"length":1,"stats":{"Line":0}},{"line":235,"address":[15497173],"length":1,"stats":{"Line":0}},{"line":238,"address":[19209120,19210383,19210389],"length":1,"stats":{"Line":0}},{"line":239,"address":[12732006],"length":1,"stats":{"Line":0}},{"line":240,"address":[15581853],"length":1,"stats":{"Line":0}},{"line":243,"address":[12732161,12733169,12732079],"length":1,"stats":{"Line":0}},{"line":244,"address":[15490435],"length":1,"stats":{"Line":0}},{"line":245,"address":[15613261,15613130,15613079],"length":1,"stats":{"Line":0}},{"line":246,"address":[15613138],"length":1,"stats":{"Line":0}},{"line":249,"address":[15582227,15582319],"length":1,"stats":{"Line":0}},{"line":252,"address":[15480486],"length":1,"stats":{"Line":0}},{"line":253,"address":[19209826],"length":1,"stats":{"Line":0}},{"line":257,"address":[15386182],"length":1,"stats":{"Line":0}},{"line":260,"address":[17939629,17939725],"length":1,"stats":{"Line":0}},{"line":263,"address":[19209476],"length":1,"stats":{"Line":0}},{"line":266,"address":[15389218,15386656,15389140],"length":1,"stats":{"Line":0}},{"line":270,"address":[15481151],"length":1,"stats":{"Line":0}},{"line":271,"address":[15583296],"length":1,"stats":{"Line":0}},{"line":277,"address":[19210687],"length":1,"stats":{"Line":0}},{"line":284,"address":[15583399],"length":1,"stats":{"Line":0}},{"line":285,"address":[15492547,15491775],"length":1,"stats":{"Line":0}},{"line":286,"address":[15615147],"length":1,"stats":{"Line":0}},{"line":287,"address":[12734576,12734404],"length":1,"stats":{"Line":0}},{"line":288,"address":[15615364],"length":1,"stats":{"Line":0}},{"line":289,"address":[15615382],"length":1,"stats":{"Line":0}},{"line":290,"address":[15615421],"length":1,"stats":{"Line":0}},{"line":292,"address":[15469520],"length":1,"stats":{"Line":0}},{"line":295,"address":[17941181],"length":1,"stats":{"Line":0}},{"line":298,"address":[15469422],"length":1,"stats":{"Line":0}},{"line":300,"address":[15583534],"length":1,"stats":{"Line":0}},{"line":305,"address":[15387117],"length":1,"stats":{"Line":0}},{"line":306,"address":[15803475,15803472],"length":1,"stats":{"Line":0}},{"line":307,"address":[15583591],"length":1,"stats":{"Line":0}},{"line":313,"address":[15492037],"length":1,"stats":{"Line":0}},{"line":314,"address":[15388101],"length":1,"stats":{"Line":0}},{"line":315,"address":[15615536,15616215],"length":1,"stats":{"Line":0}},{"line":316,"address":[19212693],"length":1,"stats":{"Line":0}},{"line":317,"address":[15483372],"length":1,"stats":{"Line":0}},{"line":318,"address":[15493755],"length":1,"stats":{"Line":0}},{"line":320,"address":[19211839,19211971],"length":1,"stats":{"Line":0}},{"line":321,"address":[15615685],"length":1,"stats":{"Line":0}},{"line":322,"address":[15584738],"length":1,"stats":{"Line":0}},{"line":324,"address":[15469840],"length":1,"stats":{"Line":0}},{"line":325,"address":[17941727,17941848],"length":1,"stats":{"Line":0}},{"line":326,"address":[15834474,15834464],"length":1,"stats":{"Line":0}},{"line":328,"address":[15616186,15616010],"length":1,"stats":{"Line":0}},{"line":331,"address":[15388209],"length":1,"stats":{"Line":0}},{"line":333,"address":[12735693,12733946],"length":1,"stats":{"Line":0}},{"line":348,"address":[15614818],"length":1,"stats":{"Line":0}},{"line":354,"address":[15469025],"length":1,"stats":{"Line":0}},{"line":355,"address":[15585607],"length":1,"stats":{"Line":0}},{"line":359,"address":[12733581],"length":1,"stats":{"Line":0}},{"line":365,"address":[19218224,19219249],"length":1,"stats":{"Line":0}},{"line":372,"address":[17947866],"length":1,"stats":{"Line":0}},{"line":375,"address":[15476066],"length":1,"stats":{"Line":0}},{"line":376,"address":[17947921],"length":1,"stats":{"Line":0}},{"line":377,"address":[15476140],"length":1,"stats":{"Line":0}},{"line":378,"address":[15489180],"length":1,"stats":{"Line":0}},{"line":379,"address":[15622147,15622195],"length":1,"stats":{"Line":0}},{"line":383,"address":[12740965],"length":1,"stats":{"Line":0}},{"line":384,"address":[15394924],"length":1,"stats":{"Line":0}},{"line":385,"address":[15489467,15489409],"length":1,"stats":{"Line":0}},{"line":388,"address":[15622397,15622497],"length":1,"stats":{"Line":0}},{"line":389,"address":[15499913],"length":1,"stats":{"Line":0}},{"line":391,"address":[15499986,15500284],"length":1,"stats":{"Line":0}},{"line":392,"address":[12741648,12741589],"length":1,"stats":{"Line":0}},{"line":394,"address":[15591648],"length":1,"stats":{"Line":0}},{"line":395,"address":[17948603,17948552],"length":1,"stats":{"Line":0}},{"line":396,"address":[15622829],"length":1,"stats":{"Line":0}},{"line":402,"address":[17948141],"length":1,"stats":{"Line":0}},{"line":406,"address":[15591294],"length":1,"stats":{"Line":0}},{"line":409,"address":[12751118,12750224,12751089],"length":1,"stats":{"Line":0}},{"line":416,"address":[15600624],"length":1,"stats":{"Line":0}},{"line":417,"address":[15404241],"length":1,"stats":{"Line":0}},{"line":418,"address":[15509084,15509682],"length":1,"stats":{"Line":0}},{"line":419,"address":[17958302],"length":1,"stats":{"Line":0}},{"line":420,"address":[15404965],"length":1,"stats":{"Line":0}},{"line":421,"address":[19228753],"length":1,"stats":{"Line":0}},{"line":425,"address":[19227982,19228108,19228155],"length":1,"stats":{"Line":0}},{"line":428,"address":[15404408],"length":1,"stats":{"Line":0}},{"line":431,"address":[15486123,15486005],"length":1,"stats":{"Line":0}},{"line":432,"address":[12750723,12750665],"length":1,"stats":{"Line":0}},{"line":434,"address":[17958032,17958187],"length":1,"stats":{"Line":0}},{"line":438,"address":[15509159],"length":1,"stats":{"Line":0}},{"line":441,"address":[12748249,12744112,12747598],"length":1,"stats":{"Line":0}},{"line":450,"address":[15397919],"length":1,"stats":{"Line":0}},{"line":453,"address":[12744492,12744247],"length":1,"stats":{"Line":0}},{"line":454,"address":[19221762],"length":1,"stats":{"Line":0}},{"line":455,"address":[15479549],"length":1,"stats":{"Line":0}},{"line":456,"address":[12744485],"length":1,"stats":{"Line":0}},{"line":460,"address":[15625360],"length":1,"stats":{"Line":0}},{"line":462,"address":[15479750],"length":1,"stats":{"Line":0}},{"line":467,"address":[15625675],"length":1,"stats":{"Line":0}},{"line":471,"address":[15503215,15502993],"length":1,"stats":{"Line":0}},{"line":474,"address":[15503228],"length":1,"stats":{"Line":0}},{"line":477,"address":[15480150],"length":1,"stats":{"Line":0}},{"line":478,"address":[19222459],"length":1,"stats":{"Line":0}},{"line":479,"address":[12745002],"length":1,"stats":{"Line":0}},{"line":483,"address":[15503523,15503483],"length":1,"stats":{"Line":0}},{"line":485,"address":[12745011],"length":1,"stats":{"Line":0}},{"line":486,"address":[17952179,17952061,17952119],"length":1,"stats":{"Line":0}},{"line":488,"address":[15595275],"length":1,"stats":{"Line":0}},{"line":491,"address":[15480397,15480332],"length":1,"stats":{"Line":0}},{"line":494,"address":[15401436,15398740],"length":1,"stats":{"Line":0}},{"line":496,"address":[15503832],"length":1,"stats":{"Line":0}},{"line":497,"address":[17952399],"length":1,"stats":{"Line":0}},{"line":498,"address":[15595654,15595571],"length":1,"stats":{"Line":0}},{"line":501,"address":[15595607],"length":1,"stats":{"Line":0}},{"line":502,"address":[15493619,15493734],"length":1,"stats":{"Line":0}},{"line":503,"address":[15494085,15494025,15494124],"length":1,"stats":{"Line":0}},{"line":504,"address":[15627053,15627121],"length":1,"stats":{"Line":0}},{"line":505,"address":[15481307],"length":1,"stats":{"Line":0}},{"line":506,"address":[15504605],"length":1,"stats":{"Line":0}},{"line":516,"address":[15596278,15596046],"length":1,"stats":{"Line":0}},{"line":517,"address":[15399854,15399925,15400665],"length":1,"stats":{"Line":0}},{"line":518,"address":[15400157,15400636],"length":1,"stats":{"Line":0}},{"line":519,"address":[15400472,15400415,15400641],"length":1,"stats":{"Line":0}},{"line":523,"address":[19224574,19224459,19223663],"length":1,"stats":{"Line":0}},{"line":524,"address":[19224554,19224608],"length":1,"stats":{"Line":0}},{"line":525,"address":[17954336,17954193],"length":1,"stats":{"Line":0}},{"line":526,"address":[15495471,15495404,15495838],"length":1,"stats":{"Line":0}},{"line":527,"address":[12747575,12747389],"length":1,"stats":{"Line":0}},{"line":534,"address":[15595545],"length":1,"stats":{"Line":0}},{"line":535,"address":[15506265],"length":1,"stats":{"Line":0}},{"line":537,"address":[15597974,15598520],"length":1,"stats":{"Line":0}},{"line":540,"address":[15401428],"length":1,"stats":{"Line":0}},{"line":545,"address":[12745264],"length":1,"stats":{"Line":0}},{"line":547,"address":[15506489,15506791,15503805],"length":1,"stats":{"Line":0}},{"line":554,"address":[19225561],"length":1,"stats":{"Line":0}},{"line":557,"address":[15405749,15406354,15405040],"length":1,"stats":{"Line":0}},{"line":565,"address":[19228896],"length":1,"stats":{"Line":0}},{"line":566,"address":[19228977],"length":1,"stats":{"Line":0}},{"line":567,"address":[15405228,15406200],"length":1,"stats":{"Line":0}},{"line":568,"address":[15633715],"length":1,"stats":{"Line":0}},{"line":569,"address":[12752386],"length":1,"stats":{"Line":0}},{"line":570,"address":[15633734],"length":1,"stats":{"Line":0}},{"line":574,"address":[19228942,19229118,19229071],"length":1,"stats":{"Line":0}},{"line":575,"address":[15632763],"length":1,"stats":{"Line":0}},{"line":577,"address":[19229180,19229541],"length":1,"stats":{"Line":0}},{"line":578,"address":[17959143,17959517],"length":1,"stats":{"Line":0}},{"line":581,"address":[15406155,15405997],"length":1,"stats":{"Line":0}},{"line":584,"address":[19229147,19229225],"length":1,"stats":{"Line":0}},{"line":585,"address":[15405514,15405722],"length":1,"stats":{"Line":0}},{"line":586,"address":[15500175,15499987],"length":1,"stats":{"Line":0}},{"line":593,"address":[15486842],"length":1,"stats":{"Line":0}},{"line":596,"address":[15385296,15384000,15385328],"length":1,"stats":{"Line":1}},{"line":597,"address":[15384038],"length":1,"stats":{"Line":1}},{"line":598,"address":[17937456],"length":1,"stats":{"Line":0}},{"line":601,"address":[15489034,15488890],"length":1,"stats":{"Line":2}},{"line":606,"address":[15611537],"length":1,"stats":{"Line":1}},{"line":607,"address":[15466057,15465672],"length":1,"stats":{"Line":1}},{"line":609,"address":[19208419],"length":1,"stats":{"Line":1}},{"line":612,"address":[15466232],"length":1,"stats":{"Line":1}},{"line":613,"address":[17938068,17938137],"length":1,"stats":{"Line":2}},{"line":614,"address":[15479757,15479587,15479320,15479632],"length":1,"stats":{"Line":0}},{"line":615,"address":[15612646],"length":1,"stats":{"Line":0}},{"line":619,"address":[15612356],"length":1,"stats":{"Line":1}},{"line":621,"address":[15612517],"length":1,"stats":{"Line":1}},{"line":624,"address":[15629552],"length":1,"stats":{"Line":1}},{"line":625,"address":[15598605],"length":1,"stats":{"Line":1}},{"line":626,"address":[15629575],"length":1,"stats":{"Line":1}},{"line":628,"address":[15483714],"length":1,"stats":{"Line":1}},{"line":629,"address":[15483760],"length":1,"stats":{"Line":1}},{"line":630,"address":[15598733],"length":1,"stats":{"Line":0}},{"line":634,"address":[15501031,15501037,15500320],"length":1,"stats":{"Line":0}},{"line":635,"address":[15622950],"length":1,"stats":{"Line":0}},{"line":636,"address":[15500496],"length":1,"stats":{"Line":0}},{"line":640,"address":[19219351],"length":1,"stats":{"Line":0}},{"line":641,"address":[15592186,15592103],"length":1,"stats":{"Line":0}},{"line":643,"address":[15623169],"length":1,"stats":{"Line":0}},{"line":644,"address":[19219584],"length":1,"stats":{"Line":0}},{"line":647,"address":[12742268],"length":1,"stats":{"Line":0}},{"line":648,"address":[15490388],"length":1,"stats":{"Line":0}},{"line":649,"address":[19219800],"length":1,"stats":{"Line":0}},{"line":650,"address":[17949391],"length":1,"stats":{"Line":0}},{"line":652,"address":[15592510],"length":1,"stats":{"Line":0}},{"line":657,"address":[15500723],"length":1,"stats":{"Line":0}},{"line":660,"address":[15483840,15485397,15485545],"length":1,"stats":{"Line":0}},{"line":661,"address":[15629747],"length":1,"stats":{"Line":0}},{"line":662,"address":[15598944,15598871,15598822],"length":1,"stats":{"Line":0}},{"line":665,"address":[17955858,17955774],"length":1,"stats":{"Line":0}},{"line":667,"address":[12749049,12748898,12748984],"length":1,"stats":{"Line":0}},{"line":671,"address":[15630648,15630250],"length":1,"stats":{"Line":0}},{"line":672,"address":[15599696,15599758],"length":1,"stats":{"Line":0}},{"line":673,"address":[15497854,15497944,15497972],"length":1,"stats":{"Line":0}},{"line":680,"address":[15508103,15508687],"length":1,"stats":{"Line":0}},{"line":681,"address":[19227677],"length":1,"stats":{"Line":0}},{"line":682,"address":[17957337],"length":1,"stats":{"Line":0}},{"line":688,"address":[15598808],"length":1,"stats":{"Line":0}},{"line":691,"address":[15621712,15621216],"length":1,"stats":{"Line":1}},{"line":692,"address":[15393907,15393843],"length":1,"stats":{"Line":2}},{"line":693,"address":[15621443,15621529],"length":1,"stats":{"Line":0}},{"line":696,"address":[15498878],"length":1,"stats":{"Line":1}},{"line":699,"address":[15502588,15501264,15502525],"length":1,"stats":{"Line":0}},{"line":700,"address":[12742946,12742993,12742845],"length":1,"stats":{"Line":0}},{"line":703,"address":[12743342,12742957,12743414],"length":1,"stats":{"Line":0}},{"line":705,"address":[19220402],"length":1,"stats":{"Line":0}},{"line":706,"address":[15491410,15491494],"length":1,"stats":{"Line":0}},{"line":710,"address":[15491571],"length":1,"stats":{"Line":0}},{"line":711,"address":[17950514,17950562],"length":1,"stats":{"Line":0}},{"line":712,"address":[15397226,15397298],"length":1,"stats":{"Line":0}},{"line":713,"address":[15478908,15478842],"length":1,"stats":{"Line":0}},{"line":715,"address":[15491828],"length":1,"stats":{"Line":0}},{"line":718,"address":[15593032,15592692],"length":1,"stats":{"Line":0}},{"line":720,"address":[15712466],"length":1,"stats":{"Line":0}},{"line":722,"address":[18161137],"length":1,"stats":{"Line":0}},{"line":723,"address":[15689349],"length":1,"stats":{"Line":0}},{"line":724,"address":[19417036],"length":1,"stats":{"Line":0}},{"line":725,"address":[15804320],"length":1,"stats":{"Line":0}},{"line":727,"address":[15714414,15712708,15713259],"length":1,"stats":{"Line":0}},{"line":728,"address":[15702831,15702354],"length":1,"stats":{"Line":0}},{"line":729,"address":[14351410],"length":1,"stats":{"Line":0}},{"line":730,"address":[18163048],"length":1,"stats":{"Line":0}},{"line":731,"address":[15806414],"length":1,"stats":{"Line":0}},{"line":732,"address":[15837542],"length":1,"stats":{"Line":0}},{"line":733,"address":[15691566],"length":1,"stats":{"Line":0}},{"line":737,"address":[14206885,14206474,14205717,14203043],"length":1,"stats":{"Line":0}},{"line":738,"address":[15596897,15596768,15596869],"length":1,"stats":{"Line":0}},{"line":741,"address":[19419524],"length":1,"stats":{"Line":0}},{"line":742,"address":[15595907,15595879,15595778],"length":1,"stats":{"Line":0}},{"line":744,"address":[15806863],"length":1,"stats":{"Line":0}},{"line":748,"address":[15593348],"length":1,"stats":{"Line":0}},{"line":749,"address":[14203540],"length":1,"stats":{"Line":0}},{"line":750,"address":[19417183],"length":1,"stats":{"Line":0}},{"line":751,"address":[15593427],"length":1,"stats":{"Line":0}},{"line":753,"address":[14204224,14207892,14203619],"length":1,"stats":{"Line":0}},{"line":754,"address":[15594012,15593461],"length":1,"stats":{"Line":0}},{"line":755,"address":[14424422],"length":1,"stats":{"Line":0}},{"line":756,"address":[18165909],"length":1,"stats":{"Line":0}},{"line":757,"address":[15717643],"length":1,"stats":{"Line":0}},{"line":758,"address":[19422179],"length":1,"stats":{"Line":0}},{"line":759,"address":[15707339],"length":1,"stats":{"Line":0}},{"line":763,"address":[14540592],"length":1,"stats":{"Line":0}},{"line":764,"address":[15841623,15841752,15841724],"length":1,"stats":{"Line":0}},{"line":769,"address":[15694737],"length":1,"stats":{"Line":0}},{"line":770,"address":[15598639,15598768,15598740],"length":1,"stats":{"Line":0}},{"line":772,"address":[15707724],"length":1,"stats":{"Line":0}},{"line":776,"address":[15593495],"length":1,"stats":{"Line":0}},{"line":777,"address":[19417291],"length":1,"stats":{"Line":0}},{"line":778,"address":[15835554],"length":1,"stats":{"Line":0}},{"line":779,"address":[18161510],"length":1,"stats":{"Line":0}},{"line":780,"address":[19417370],"length":1,"stats":{"Line":0}},{"line":781,"address":[18161568],"length":1,"stats":{"Line":0}},{"line":783,"address":[15703401,15702692,15709762],"length":1,"stats":{"Line":0}},{"line":784,"address":[15836285],"length":1,"stats":{"Line":0}},{"line":786,"address":[15835666],"length":1,"stats":{"Line":0}},{"line":789,"address":[15836246],"length":1,"stats":{"Line":0}},{"line":792,"address":[15696930,15690522,15696687,15689058,15690454],"length":1,"stats":{"Line":0}},{"line":793,"address":[18168764],"length":1,"stats":{"Line":0}},{"line":795,"address":[15601090],"length":1,"stats":{"Line":0}},{"line":797,"address":[14211041],"length":1,"stats":{"Line":0}},{"line":798,"address":[15697262],"length":1,"stats":{"Line":0}},{"line":799,"address":[15812194],"length":1,"stats":{"Line":0}},{"line":802,"address":[15710329],"length":1,"stats":{"Line":0}},{"line":803,"address":[15812217],"length":1,"stats":{"Line":0}},{"line":808,"address":[19426306,19425889,19425141,19416727],"length":1,"stats":{"Line":0}},{"line":809,"address":[15698711,15698739,15698616],"length":1,"stats":{"Line":0}},{"line":812,"address":[15720909],"length":1,"stats":{"Line":0}},{"line":813,"address":[15601654,15601531,15601626],"length":1,"stats":{"Line":0}},{"line":815,"address":[19425349],"length":1,"stats":{"Line":0}},{"line":818,"address":[18162423],"length":1,"stats":{"Line":0}},{"line":819,"address":[15702185,15703521,15703532],"length":1,"stats":{"Line":0}},{"line":824,"address":[12743961],"length":1,"stats":{"Line":0}}],"covered":58,"coverable":347},{"path":["/","home","azureuser","Documents","Chronos","src","raft","state.rs"],"content":"use serde::{Deserialize, Serialize};\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]\npub enum NodeRole {\n    Follower,\n    Candidate,\n    Leader,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct NodeState {\n    pub current_term: u64,\n    pub voted_for: Option\u003cString\u003e,\n    pub role: NodeRole,\n    pub leader_id: Option\u003cString\u003e,\n    pub commit_index: u64,\n    pub last_applied: u64,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","src","repl","mod.rs"],"content":"use rustyline::error::ReadlineError;\nuse rustyline::DefaultEditor;\nuse std::collections::VecDeque;\n\nuse crate::executor::Executor;\nuse crate::network::NetworkError;\nuse crate::parser::{Parser, Value};\n\npub struct Repl {\n    executor: Option\u003cExecutor\u003e,\n    rl: DefaultEditor,\n    distributed_mode: bool,\n    sql_client: Option\u003ccrate::network::SqlClient\u003e,\n    pending_sql: VecDeque\u003cString\u003e,\n}\n\nimpl Repl {\n    pub async fn new(data_dir: \u0026str) -\u003e Self {\n        Self {\n            executor: Some(Executor::new(data_dir).await),\n            rl: DefaultEditor::new().expect(\"Failed to create line editor\"),\n            distributed_mode: false,\n            sql_client: None,\n            pending_sql: VecDeque::new(),\n        }\n    }\n\n    pub fn with_distributed_mode(leader_address: \u0026str) -\u003e Self {\n        let mut client = crate::network::SqlClient::new(leader_address);\n        if let Ok(token) = std::env::var(\"CHRONOS_AUTH_TOKEN\") {\n            client = client.with_auth_token(token);\n        }\n\n        Self {\n            executor: None,\n            rl: DefaultEditor::new().expect(\"Failed to create line editor\"),\n            distributed_mode: true,\n            sql_client: Some(client),\n            pending_sql: VecDeque::new(),\n        }\n    }\n\n    fn enqueue_sql(\u0026mut self, sql: String) {\n        const MAX_QUEUE: usize = 10_000;\n        if self.pending_sql.len() \u003e= MAX_QUEUE {\n            self.pending_sql.pop_front();\n        }\n        self.pending_sql.push_back(sql);\n    }\n\n    async fn flush_pending_for(\n        client: \u0026mut crate::network::SqlClient,\n        pending_sql: \u0026mut VecDeque\u003cString\u003e,\n    ) -\u003e Result\u003c(), crate::network::NetworkError\u003e {\n        while let Some(sql) = pending_sql.pop_front() {\n            match client.execute_sql(\u0026sql).await {\n                Ok(_response) =\u003e {\n                    // Do not print results for flushed commands\n                }\n                Err(e) =\u003e {\n                    match \u0026e {\n                        // True network issues: re-queue and stop flushing\n                        NetworkError::ConnectionError(_) | NetworkError::TransportError(_) =\u003e {\n                            pending_sql.push_front(sql);\n                            return Err(e);\n                        }\n                        // Application-level errors from the leader: drop this bad\n                        // command so it doesn't poison the queue.\n                        NetworkError::RpcError(_) =\u003e {\n                            eprintln!(\"Remote execution error for queued command: {e}\");\n                        }\n                    }\n                }\n            }\n        }\n        Ok(())\n    }\n\n    pub async fn run(\u0026mut self) {\n        println!(\"Welcome to Chronos SQL Database\");\n        if self.distributed_mode {\n            println!(\"Running in distributed mode\");\n        } else {\n            println!(\"Running in single-node mode\");\n        }\n        println!(\"Enter SQL statements or 'exit' to quit\");\n\n        loop {\n            let readline = self.rl.readline(\"chronos\u003e \");\n            match readline {\n                Ok(line) =\u003e {\n                    if line.trim().is_empty() {\n                        continue;\n                    }\n\n                    let _ = self.rl.add_history_entry(line.as_str());\n\n                    if line.trim().eq_ignore_ascii_case(\"exit\") {\n                        println!(\"Goodbye!\");\n                        break;\n                    }\n\n                    if self.distributed_mode {\n                        // In distributed mode, send the SQL to the leader\n                        if let Some(client) = \u0026mut self.sql_client {\n                            // Flush any queued commands first\n                            if let Err(e) =\n                                Self::flush_pending_for(client, \u0026mut self.pending_sql).await\n                            {\n                                match e {\n                                    NetworkError::ConnectionError(_)\n                                    | NetworkError::TransportError(_) =\u003e {\n                                        eprintln!(\"Network error while flushing queued commands: {e}. Command queued locally\");\n                                        self.enqueue_sql(line);\n                                        continue;\n                                    }\n                                    NetworkError::RpcError(_) =\u003e {\n                                        // Already reported per-command in flush_pending_for; do not\n                                        // treat as a network outage.\n                                    }\n                                }\n                            }\n\n                            match client.execute_sql(\u0026line).await {\n                                Ok(response) =\u003e {\n                                    if !response.success {\n                                        eprintln!(\"Error: {}\", response.error);\n                                        continue;\n                                    }\n\n                                    // Print column headers\n                                    let header_width = 20;\n                                    for col in \u0026response.columns {\n                                        print!(\"{col:header_width$}\");\n                                    }\n                                    println!();\n\n                                    // Print separator\n                                    for _ in 0..response.columns.len() {\n                                        print!(\"{}\", \"-\".repeat(header_width));\n                                    }\n                                    println!();\n\n                                    // Print rows\n                                    for row in response.rows {\n                                        for value in row.values {\n                                            let display = match value.value {\n                                                Some(crate::network::proto::value::Value::StringValue(s)) =\u003e s,\n                                                Some(crate::network::proto::value::Value::IntValue(i)) =\u003e i.to_string(),\n                                                Some(crate::network::proto::value::Value::FloatValue(f)) =\u003e f.to_string(),\n                                                Some(crate::network::proto::value::Value::BoolValue(b)) =\u003e b.to_string(),\n                                                Some(crate::network::proto::value::Value::NullValue(_)) =\u003e \"NULL\".to_string(),\n                                                None =\u003e \"NULL\".to_string(),\n                                            };\n                                            print!(\"{display:header_width$}\");\n                                        }\n                                        println!();\n                                    }\n                                }\n                                Err(e) =\u003e {\n                                    match e {\n                                        NetworkError::ConnectionError(_)\n                                        | NetworkError::TransportError(_) =\u003e {\n                                            eprintln!(\"Network error: {e}. Command queued locally\");\n                                            self.enqueue_sql(line);\n                                        }\n                                        NetworkError::RpcError(_) =\u003e {\n                                            // Application-level error from leader (e.g. table already exists).\n                                            // Report it but do not queue the command.\n                                            eprintln!(\"Error from leader: {e}\");\n                                        }\n                                    }\n                                }\n                            }\n                        } else {\n                            eprintln!(\"SQL client not initialized\");\n                        }\n                    } else {\n                        // In single-node mode, execute locally\n                        let executor = self\n                            .executor\n                            .as_mut()\n                            .expect(\"Executor not initialized in single-node mode\");\n                        match Parser::parse(\u0026line) {\n                            Ok(ast) =\u003e {\n                                match executor.execute(ast).await {\n                                    Ok(result) =\u003e {\n                                        // Print column headers\n                                        let header_width = 20;\n                                        for col in \u0026result.columns {\n                                            print!(\"{col:header_width$}\");\n                                        }\n                                        println!();\n\n                                        // Print separator\n                                        for _ in 0..result.columns.len() {\n                                            print!(\"{}\", \"-\".repeat(header_width));\n                                        }\n                                        println!();\n\n                                        // Print rows\n                                        for row in result.rows {\n                                            for value in row {\n                                                let display = match value {\n                                                    Value::String(s) =\u003e s,\n                                                    Value::Integer(i) =\u003e i.to_string(),\n                                                    Value::Float(f) =\u003e f.to_string(),\n                                                    Value::Boolean(b) =\u003e b.to_string(),\n                                                    Value::Null =\u003e \"NULL\".to_string(),\n                                                };\n                                                print!(\"{display:header_width$}\");\n                                            }\n                                            println!();\n                                        }\n                                    }\n                                    Err(e) =\u003e {\n                                        eprintln!(\"Error: {e}\");\n                                    }\n                                }\n                            }\n                            Err(e) =\u003e {\n                                eprintln!(\"Parse error: {e}\");\n                            }\n                        }\n                    }\n                }\n                Err(ReadlineError::Interrupted) =\u003e {\n                    println!(\"CTRL-C\");\n                    break;\n                }\n                Err(ReadlineError::Eof) =\u003e {\n                    println!(\"CTRL-D\");\n                    break;\n                }\n                Err(err) =\u003e {\n                    eprintln!(\"Error: {err}\");\n                    break;\n                }\n            }\n        }\n    }\n}\n","traces":[{"line":18,"address":[16535680,16535693],"length":1,"stats":{"Line":0}},{"line":20,"address":[13082953,13082764,13082798,13082868],"length":1,"stats":{"Line":0}},{"line":21,"address":[13083320,13083364],"length":1,"stats":{"Line":0}},{"line":24,"address":[17491143],"length":1,"stats":{"Line":0}},{"line":28,"address":[14183813,14184301,14183440],"length":1,"stats":{"Line":0}},{"line":29,"address":[17819377],"length":1,"stats":{"Line":0}},{"line":30,"address":[14183612,14183575,14183786,14183503],"length":1,"stats":{"Line":0}},{"line":31,"address":[16534988,16535099],"length":1,"stats":{"Line":0}},{"line":36,"address":[14080271,14080208],"length":1,"stats":{"Line":0}},{"line":38,"address":[17819869],"length":1,"stats":{"Line":0}},{"line":39,"address":[17819944],"length":1,"stats":{"Line":0}},{"line":43,"address":[16534496,16534727,16534701],"length":1,"stats":{"Line":0}},{"line":45,"address":[13989816,13989746],"length":1,"stats":{"Line":0}},{"line":46,"address":[12442081],"length":1,"stats":{"Line":0}},{"line":48,"address":[13817193],"length":1,"stats":{"Line":0}},{"line":51,"address":[13989968],"length":1,"stats":{"Line":0}},{"line":55,"address":[17489836,17488897,17488859],"length":1,"stats":{"Line":0}},{"line":56,"address":[14514071],"length":1,"stats":{"Line":0}},{"line":57,"address":[17489378],"length":1,"stats":{"Line":0}},{"line":60,"address":[13081687],"length":1,"stats":{"Line":0}},{"line":61,"address":[13081719],"length":1,"stats":{"Line":0}},{"line":64,"address":[13081885],"length":1,"stats":{"Line":0}},{"line":65,"address":[17490110],"length":1,"stats":{"Line":0}},{"line":70,"address":[13081961,13082008],"length":1,"stats":{"Line":0}},{"line":76,"address":[13082292],"length":1,"stats":{"Line":0}},{"line":79,"address":[12443112,12443104],"length":1,"stats":{"Line":0}},{"line":80,"address":[17491617,17491778],"length":1,"stats":{"Line":0}},{"line":81,"address":[17491805],"length":1,"stats":{"Line":0}},{"line":82,"address":[17491843,17491916],"length":1,"stats":{"Line":0}},{"line":84,"address":[17491817,17491869],"length":1,"stats":{"Line":0}},{"line":86,"address":[13084194,13084241],"length":1,"stats":{"Line":0}},{"line":88,"address":[17494862],"length":1,"stats":{"Line":0}},{"line":89,"address":[13084270,13087188],"length":1,"stats":{"Line":0}},{"line":90,"address":[17494980],"length":1,"stats":{"Line":0}},{"line":91,"address":[13087287],"length":1,"stats":{"Line":0}},{"line":92,"address":[17495102],"length":1,"stats":{"Line":0}},{"line":96,"address":[13087427,13087520],"length":1,"stats":{"Line":0}},{"line":98,"address":[13087550],"length":1,"stats":{"Line":0}},{"line":99,"address":[17500278,17495489],"length":1,"stats":{"Line":0}},{"line":103,"address":[17495475],"length":1,"stats":{"Line":0}},{"line":105,"address":[13088388,13087763],"length":1,"stats":{"Line":0}},{"line":107,"address":[17496352,17491676,17492033,17496220,17496282],"length":1,"stats":{"Line":0}},{"line":110,"address":[13088759],"length":1,"stats":{"Line":0}},{"line":113,"address":[17496683,17496773],"length":1,"stats":{"Line":0}},{"line":114,"address":[17496850],"length":1,"stats":{"Line":0}},{"line":124,"address":[17492067,17497026,17496937,17496650,17491697],"length":1,"stats":{"Line":0}},{"line":125,"address":[13089505],"length":1,"stats":{"Line":0}},{"line":126,"address":[17497427],"length":1,"stats":{"Line":0}},{"line":127,"address":[13089549,13089660],"length":1,"stats":{"Line":0}},{"line":132,"address":[17497464],"length":1,"stats":{"Line":0}},{"line":133,"address":[17497698,17497476],"length":1,"stats":{"Line":0}},{"line":134,"address":[13091789,13089910],"length":1,"stats":{"Line":0}},{"line":136,"address":[17497852],"length":1,"stats":{"Line":0}},{"line":139,"address":[17497897],"length":1,"stats":{"Line":0}},{"line":140,"address":[17499567,17498014],"length":1,"stats":{"Line":0}},{"line":142,"address":[13090156],"length":1,"stats":{"Line":0}},{"line":145,"address":[13090391,13090201],"length":1,"stats":{"Line":0}},{"line":146,"address":[17498676,17498541,17498368,17499562],"length":1,"stats":{"Line":0}},{"line":147,"address":[13090941,13090837],"length":1,"stats":{"Line":0}},{"line":148,"address":[13091112],"length":1,"stats":{"Line":0}},{"line":149,"address":[13091213,13091361],"length":1,"stats":{"Line":0}},{"line":150,"address":[17499184,17499306],"length":1,"stats":{"Line":0}},{"line":151,"address":[17499311,17499229],"length":1,"stats":{"Line":0}},{"line":152,"address":[13091376,13091330],"length":1,"stats":{"Line":0}},{"line":153,"address":[13091056,13090998],"length":1,"stats":{"Line":0}},{"line":155,"address":[17498994,17499365],"length":1,"stats":{"Line":0}},{"line":157,"address":[13090891],"length":1,"stats":{"Line":0}},{"line":160,"address":[17497315],"length":1,"stats":{"Line":0}},{"line":161,"address":[13089459],"length":1,"stats":{"Line":0}},{"line":164,"address":[13092162,13092000],"length":1,"stats":{"Line":0}},{"line":165,"address":[13092239],"length":1,"stats":{"Line":0}},{"line":170,"address":[13092073,13092026],"length":1,"stats":{"Line":0}},{"line":176,"address":[17496253,17500254],"length":1,"stats":{"Line":0}},{"line":180,"address":[17495681,17495526],"length":1,"stats":{"Line":0}},{"line":184,"address":[13087885],"length":1,"stats":{"Line":0}},{"line":185,"address":[17495862],"length":1,"stats":{"Line":0}},{"line":186,"address":[17495973,17492101,17492406,17492135,17491718],"length":1,"stats":{"Line":0}},{"line":187,"address":[17492505],"length":1,"stats":{"Line":0}},{"line":189,"address":[17492561],"length":1,"stats":{"Line":0}},{"line":190,"address":[13084853,13084936],"length":1,"stats":{"Line":0}},{"line":191,"address":[13085050,13086755],"length":1,"stats":{"Line":0}},{"line":193,"address":[13085096],"length":1,"stats":{"Line":0}},{"line":196,"address":[17492873],"length":1,"stats":{"Line":0}},{"line":197,"address":[13086593,13085282],"length":1,"stats":{"Line":0}},{"line":199,"address":[17493052],"length":1,"stats":{"Line":0}},{"line":202,"address":[13085365,13085555],"length":1,"stats":{"Line":0}},{"line":203,"address":[13085874,13085640,13085747],"length":1,"stats":{"Line":0}},{"line":204,"address":[13085943],"length":1,"stats":{"Line":0}},{"line":205,"address":[17493835],"length":1,"stats":{"Line":0}},{"line":206,"address":[17494150,17493936],"length":1,"stats":{"Line":0}},{"line":207,"address":[13086214,13086376],"length":1,"stats":{"Line":0}},{"line":208,"address":[17494027,17494154],"length":1,"stats":{"Line":0}},{"line":209,"address":[13086292,13086380],"length":1,"stats":{"Line":0}},{"line":211,"address":[17494107,17494202],"length":1,"stats":{"Line":0}},{"line":213,"address":[13086021],"length":1,"stats":{"Line":0}},{"line":216,"address":[13084719],"length":1,"stats":{"Line":0}},{"line":217,"address":[13086971,13084767],"length":1,"stats":{"Line":0}},{"line":221,"address":[13087984],"length":1,"stats":{"Line":0}},{"line":222,"address":[17495816,17496109],"length":1,"stats":{"Line":0}},{"line":228,"address":[13092658,13092538],"length":1,"stats":{"Line":0}},{"line":229,"address":[13092677],"length":1,"stats":{"Line":0}},{"line":232,"address":[13092512,13092634],"length":1,"stats":{"Line":0}},{"line":233,"address":[13092653],"length":1,"stats":{"Line":0}},{"line":235,"address":[13092470],"length":1,"stats":{"Line":0}},{"line":236,"address":[13092726,13092502],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":105},{"path":["/","home","azureuser","Documents","Chronos","src","storage","compression","chimp.rs"],"content":"use std::io::{self};\n\npub struct BitWriter {\n    buf: Vec\u003cu8\u003e,\n    cur: u8,\n    nbits: u8,\n}\n\nimpl BitWriter {\n    pub fn new() -\u003e Self {\n        Self {\n            buf: Vec::new(),\n            cur: 0,\n            nbits: 0,\n        }\n    }\n    pub fn write_bit(\u0026mut self, bit: bool) {\n        self.cur \u003c\u003c= 1;\n        if bit {\n            self.cur |= 1;\n        }\n        self.nbits += 1;\n        if self.nbits == 8 {\n            self.buf.push(self.cur);\n            self.cur = 0;\n            self.nbits = 0;\n        }\n    }\n    pub fn write_u64_bits(\u0026mut self, x: u64) {\n        for i in (0..64).rev() {\n            let b = ((x \u003e\u003e i) \u0026 1) != 0;\n            self.write_bit(b);\n        }\n    }\n    pub fn finish(mut self) -\u003e Vec\u003cu8\u003e {\n        if self.nbits != 0 {\n            self.cur \u003c\u003c= 8 - self.nbits;\n            self.buf.push(self.cur);\n        }\n        self.buf\n    }\n}\n\nimpl Default for BitWriter {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\npub struct BitReader\u003c'a\u003e {\n    buf: \u0026'a [u8],\n    idx: usize,\n    cur: u8,\n    nbits: u8,\n}\n\nimpl\u003c'a\u003e BitReader\u003c'a\u003e {\n    pub fn new(buf: \u0026'a [u8]) -\u003e Self {\n        let mut r = Self {\n            buf,\n            idx: 0,\n            cur: 0,\n            nbits: 0,\n        };\n        r.refresh();\n        r\n    }\n    fn refresh(\u0026mut self) {\n        if self.nbits == 0 \u0026\u0026 self.idx \u003c self.buf.len() {\n            self.cur = self.buf[self.idx];\n            self.idx += 1;\n            self.nbits = 8;\n        }\n    }\n    pub fn read_bit(\u0026mut self) -\u003e io::Result\u003cbool\u003e {\n        if self.nbits == 0 {\n            return Err(io::Error::new(io::ErrorKind::UnexpectedEof, \"no more bits\"));\n        }\n        let b = (self.cur \u0026 0x80) != 0;\n        self.cur \u003c\u003c= 1;\n        self.nbits -= 1;\n        if self.nbits == 0 {\n            self.refresh();\n        }\n        Ok(b)\n    }\n    pub fn read_u64_bits(\u0026mut self) -\u003e io::Result\u003cu64\u003e {\n        let mut x = 0u64;\n        for _ in 0..64 {\n            x \u003c\u003c= 1;\n            x |= if self.read_bit()? { 1 } else { 0 };\n        }\n        Ok(x)\n    }\n}\n\n/// Naive XOR-based float compressor (experimental):\n/// First value stored fully (64 bits). For next values: write 0 bit if same,\n/// else write 1 bit and the full 64-bit value. This is a simplified baseline\n/// for future Chimp-style optimizations.\npub fn encode_series(vals: \u0026[f64]) -\u003e Vec\u003cu8\u003e {\n    let mut w = BitWriter::new();\n    // Write count header (u64) to avoid EOF/padding ambiguity\n    w.write_u64_bits(vals.len() as u64);\n    let mut prev_bits: u64 = 0;\n    for (i, v) in vals.iter().enumerate() {\n        let bits = v.to_bits();\n        if i == 0 {\n            w.write_bit(true);\n            w.write_u64_bits(bits);\n        } else {\n            let xor = bits ^ prev_bits;\n            if xor == 0 {\n                w.write_bit(false);\n            } else {\n                w.write_bit(true);\n                w.write_u64_bits(bits);\n            }\n        }\n        prev_bits = bits;\n    }\n    w.finish()\n}\n\npub fn decode_series(buf: \u0026[u8]) -\u003e io::Result\u003cVec\u003cf64\u003e\u003e {\n    let mut r = BitReader::new(buf);\n    let count = r.read_u64_bits()? as usize;\n    let mut out = Vec::with_capacity(count);\n    let mut prev_bits: u64 = 0;\n    for i in 0..count {\n        let bit = r.read_bit()?;\n        let bits = if i == 0 {\n            if !bit {\n                return Err(io::Error::new(\n                    io::ErrorKind::InvalidData,\n                    \"first value must be full\",\n                ));\n            }\n            let b = r.read_u64_bits()?;\n            prev_bits = b;\n            b\n        } else if !bit {\n            prev_bits\n        } else {\n            let b = r.read_u64_bits()?;\n            prev_bits = b;\n            b\n        };\n        out.push(f64::from_bits(bits));\n    }\n    Ok(out)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    #[test]\n    fn roundtrip_simple_series() {\n        let vals = vec![\n            1.0,\n            1.0,\n            2.5,\n            2.5,\n            std::f64::consts::PI,\n            std::f64::consts::PI,\n            -42.0,\n        ];\n        let enc = encode_series(\u0026vals);\n        let dec = decode_series(\u0026enc).expect(\"decode\");\n        assert_eq!(vals.len(), dec.len());\n        for (a, b) in vals.iter().zip(dec.iter()) {\n            assert!((a - b).abs() \u003c 1e-12);\n        }\n    }\n}\n","traces":[{"line":10,"address":[18702400],"length":1,"stats":{"Line":2}},{"line":12,"address":[16247421],"length":1,"stats":{"Line":2}},{"line":17,"address":[16345824],"length":1,"stats":{"Line":2}},{"line":18,"address":[16247754],"length":1,"stats":{"Line":2}},{"line":19,"address":[16134818,16134858],"length":1,"stats":{"Line":4}},{"line":20,"address":[16376849],"length":1,"stats":{"Line":2}},{"line":22,"address":[16231008,16230955,16230997],"length":1,"stats":{"Line":4}},{"line":23,"address":[14999640],"length":1,"stats":{"Line":2}},{"line":24,"address":[19958674],"length":1,"stats":{"Line":2}},{"line":25,"address":[14999691],"length":1,"stats":{"Line":2}},{"line":26,"address":[16134927],"length":1,"stats":{"Line":2}},{"line":29,"address":[16376272],"length":1,"stats":{"Line":2}},{"line":30,"address":[16230424,16230455],"length":1,"stats":{"Line":4}},{"line":31,"address":[16345481,16345410,16345436],"length":1,"stats":{"Line":4}},{"line":32,"address":[16345464],"length":1,"stats":{"Line":2}},{"line":35,"address":[16134759,16134544],"length":1,"stats":{"Line":2}},{"line":36,"address":[14088867],"length":1,"stats":{"Line":2}},{"line":37,"address":[14999500,14999384,14999468],"length":1,"stats":{"Line":4}},{"line":38,"address":[16230843,16230882],"length":1,"stats":{"Line":4}},{"line":40,"address":[14999352],"length":1,"stats":{"Line":2}},{"line":45,"address":[16247888],"length":1,"stats":{"Line":0}},{"line":46,"address":[16345992],"length":1,"stats":{"Line":0}},{"line":58,"address":[16229888],"length":1,"stats":{"Line":2}},{"line":65,"address":[19957589],"length":1,"stats":{"Line":2}},{"line":66,"address":[16344873],"length":1,"stats":{"Line":2}},{"line":68,"address":[16230016],"length":1,"stats":{"Line":2}},{"line":69,"address":[14088341,14088206],"length":1,"stats":{"Line":4}},{"line":70,"address":[16230061,16230135],"length":1,"stats":{"Line":2}},{"line":71,"address":[16345015,16345069,16345079],"length":1,"stats":{"Line":4}},{"line":72,"address":[16230161],"length":1,"stats":{"Line":2}},{"line":75,"address":[16345104],"length":1,"stats":{"Line":2}},{"line":76,"address":[16247032],"length":1,"stats":{"Line":2}},{"line":77,"address":[16345134],"length":1,"stats":{"Line":0}},{"line":79,"address":[16345179],"length":1,"stats":{"Line":2}},{"line":80,"address":[16230290],"length":1,"stats":{"Line":2}},{"line":81,"address":[16376218,16376170,16376207],"length":1,"stats":{"Line":4}},{"line":82,"address":[16345250],"length":1,"stats":{"Line":2}},{"line":83,"address":[18702172],"length":1,"stats":{"Line":2}},{"line":85,"address":[16230378],"length":1,"stats":{"Line":2}},{"line":87,"address":[19957280],"length":1,"stats":{"Line":2}},{"line":88,"address":[16375517],"length":1,"stats":{"Line":2}},{"line":89,"address":[16229880,16229654],"length":1,"stats":{"Line":4}},{"line":90,"address":[14998356],"length":1,"stats":{"Line":2}},{"line":91,"address":[19957361,19957441],"length":1,"stats":{"Line":2}},{"line":93,"address":[16246575],"length":1,"stats":{"Line":2}},{"line":101,"address":[19957244,19957273,19956560],"length":1,"stats":{"Line":2}},{"line":102,"address":[16245771],"length":1,"stats":{"Line":2}},{"line":104,"address":[16229000],"length":1,"stats":{"Line":2}},{"line":105,"address":[16374934],"length":1,"stats":{"Line":2}},{"line":106,"address":[19956722,19957175],"length":1,"stats":{"Line":4}},{"line":107,"address":[16229427,16229322],"length":1,"stats":{"Line":4}},{"line":108,"address":[16375307],"length":1,"stats":{"Line":2}},{"line":109,"address":[14998127],"length":1,"stats":{"Line":2}},{"line":110,"address":[16344408],"length":1,"stats":{"Line":2}},{"line":112,"address":[14087643],"length":1,"stats":{"Line":1}},{"line":113,"address":[16133355],"length":1,"stats":{"Line":1}},{"line":114,"address":[14998207,14998231],"length":1,"stats":{"Line":2}},{"line":116,"address":[19957198],"length":1,"stats":{"Line":1}},{"line":117,"address":[14998243],"length":1,"stats":{"Line":1}},{"line":120,"address":[14998187],"length":1,"stats":{"Line":2}},{"line":122,"address":[16133215],"length":1,"stats":{"Line":2}},{"line":125,"address":[18700696,18699472,18700702],"length":1,"stats":{"Line":2}},{"line":126,"address":[16131575],"length":1,"stats":{"Line":2}},{"line":127,"address":[14996452],"length":1,"stats":{"Line":2}},{"line":128,"address":[16227844],"length":1,"stats":{"Line":2}},{"line":129,"address":[16373745],"length":1,"stats":{"Line":2}},{"line":130,"address":[14086061,14086146],"length":1,"stats":{"Line":4}},{"line":131,"address":[16228076,16228210,16228883],"length":1,"stats":{"Line":4}},{"line":132,"address":[14086504],"length":1,"stats":{"Line":2}},{"line":133,"address":[14086514],"length":1,"stats":{"Line":2}},{"line":134,"address":[16343348,16343273],"length":1,"stats":{"Line":0}},{"line":139,"address":[16343306,16343553,16343394],"length":1,"stats":{"Line":4}},{"line":140,"address":[16374473],"length":1,"stats":{"Line":2}},{"line":141,"address":[16132481],"length":1,"stats":{"Line":2}},{"line":142,"address":[19956310,19956484,19955996],"length":1,"stats":{"Line":3}},{"line":143,"address":[16343558],"length":1,"stats":{"Line":1}},{"line":145,"address":[16132536,16132750],"length":1,"stats":{"Line":1}},{"line":146,"address":[16374692],"length":1,"stats":{"Line":1}},{"line":147,"address":[18700636],"length":1,"stats":{"Line":1}},{"line":149,"address":[19956265,19956495],"length":1,"stats":{"Line":4}},{"line":151,"address":[14996832],"length":1,"stats":{"Line":2}}],"covered":77,"coverable":81},{"path":["/","home","azureuser","Documents","Chronos","src","storage","compression","mod.rs"],"content":"pub mod chimp;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","src","storage","error.rs"],"content":"use thiserror::Error;\n\n#[derive(Error, Debug)]\npub enum StorageError {\n    #[error(\"Table '{0}' not found\")]\n    TableNotFound(String),\n\n    #[error(\"Table '{0}' already exists\")]\n    TableAlreadyExists(String),\n\n    #[error(\"Column '{0}' not found in table '{1}'\")]\n    ColumnNotFound(String, String),\n\n    #[error(\"Schema mismatch: {0}\")]\n    SchemaMismatch(String),\n\n    #[error(\"Serialization error: {0}\")]\n    SerializationError(String),\n\n    #[error(\"IO error: {0}\")]\n    IoError(#[from] std::io::Error),\n\n    #[error(\"Sled error: {0}\")]\n    SledError(String),\n\n    #[error(\"Invalid filter operation\")]\n    InvalidFilter,\n\n    #[error(\"Transaction error: {0}\")]\n    TransactionError(String),\n\n    #[error(\"Unsupported storage version: {0}\")]\n    UnsupportedStorageVersion(u32),\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","src","storage","mod.rs"],"content":"pub mod compression;\npub mod error;\npub mod offline_queue;\npub mod sled_engine;\npub mod snapshot;\npub mod wal;\n\npub use error::StorageError;\npub use sled_engine::SledEngine;\n\nuse crate::common::timestamp::HybridTimestamp;\nuse crate::parser::Value;\nuse crate::storage::offline_queue::PersistentQueuedOperation;\nuse crate::storage::wal::Operation;\nuse anyhow::Result;\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\n\n/// Storage engine abstraction for pluggable backends\n#[async_trait::async_trait]\npub trait StorageEngine: Send + Sync {\n    /// Initialize storage (create dirs, open connections, etc)\n    async fn init(\u0026mut self) -\u003e Result\u003c()\u003e;\n\n    /// Create a new table with schema\n    async fn create_table(\u0026mut self, table_name: \u0026str, schema: TableSchema) -\u003e Result\u003c()\u003e;\n\n    /// Insert rows into table\n    async fn insert(\u0026mut self, table_name: \u0026str, rows: Vec\u003cRow\u003e) -\u003e Result\u003c()\u003e;\n\n    /// Query rows with optional filter\n    async fn query(\u0026self, table_name: \u0026str, filter: Option\u003cFilter\u003e) -\u003e Result\u003cVec\u003cRow\u003e\u003e;\n\n    /// Delete rows matching filter\n    async fn delete(\u0026mut self, table_name: \u0026str, filter: Filter) -\u003e Result\u003cusize\u003e;\n\n    /// Cleanup expired rows based on TTL metadata (if supported). Returns number of deleted rows.\n    async fn cleanup_expired(\u0026mut self, _now_secs: u64, _limit: usize) -\u003e Result\u003cu64\u003e {\n        Ok(0)\n    }\n\n    /// Create index on column\n    async fn create_index(\u0026mut self, table_name: \u0026str, column: \u0026str) -\u003e Result\u003c()\u003e;\n\n    /// Get table metadata\n    async fn get_schema(\u0026self, table_name: \u0026str) -\u003e Result\u003cOption\u003cTableSchema\u003e\u003e;\n\n    /// List all tables\n    async fn list_tables(\u0026self) -\u003e Result\u003cVec\u003cString\u003e\u003e;\n\n    /// Checkpoint/flush to disk\n    async fn checkpoint(\u0026mut self) -\u003e Result\u003c()\u003e;\n\n    /// Close storage gracefully\n    async fn close(\u0026mut self) -\u003e Result\u003c()\u003e;\n\n    /// Apply a low-level storage operation (used by sync replication).\n    /// Default implementation returns an error for engines that do not\n    /// support this.\n    async fn apply_operation(\u0026mut self, _op: Operation) -\u003e Result\u003c()\u003e {\n        Err(anyhow::anyhow!(\n            \"apply_operation not supported for this storage engine\"\n        ))\n    }\n\n    /// Drain at most `limit` operations from the offline queue. Default\n    /// implementation returns an empty vector for engines that do not\n    /// support offline queueing.\n    async fn drain_offline_queue(\u0026self, _limit: usize) -\u003e Result\u003cVec\u003cPersistentQueuedOperation\u003e\u003e {\n        Ok(Vec::new())\n    }\n\n    /// Requeue operations back into the offline queue. Default implementation\n    /// is a no-op for engines without offline queue support.\n    async fn requeue_offline_ops(\u0026self, _ops: Vec\u003cPersistentQueuedOperation\u003e) -\u003e Result\u003c()\u003e {\n        Ok(())\n    }\n\n    /// Get the last-seen HybridTimestamp for a given logical key (table, key)\n    /// used by the edge-\u003ecloud sync LWW conflict resolution. Default\n    /// implementation returns None for engines that do not support it.\n    async fn get_lww_ts(\u0026self, _table: \u0026str, _key: \u0026[u8]) -\u003e Result\u003cOption\u003cHybridTimestamp\u003e\u003e {\n        Ok(None)\n    }\n\n    /// Persist the last-seen HybridTimestamp for a given logical key\n    /// (table, key) used by the edge-\u003ecloud sync LWW conflict resolution.\n    /// Default implementation is a no-op for engines that do not support it.\n    async fn set_lww_ts(\u0026mut self, _table: \u0026str, _key: \u0026[u8], _ts: HybridTimestamp) -\u003e Result\u003c()\u003e {\n        Ok(())\n    }\n}\n\n/// Table schema definition\n#[derive(Debug, Clone, Serialize, Deserialize, bincode::Encode, bincode::Decode)]\npub struct TableSchema {\n    pub name: String,\n    pub columns: Vec\u003cColumn\u003e,\n    pub ttl_seconds: Option\u003cu64\u003e,\n}\n\n/// Column definition\n#[derive(Debug, Clone, Serialize, Deserialize, bincode::Encode, bincode::Decode)]\npub struct Column {\n    pub name: String,\n    pub data_type: DataType,\n}\n\n/// Supported data types\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, bincode::Encode, bincode::Decode)]\npub enum DataType {\n    Int,\n    Float,\n    String,\n    Boolean,\n    Timestamp,\n}\n\n/// Row representation\n#[derive(Debug, Clone, Serialize, Deserialize, bincode::Encode, bincode::Decode)]\npub struct Row {\n    pub values: HashMap\u003cString, Value\u003e,\n}\n\nimpl Row {\n    pub fn new() -\u003e Self {\n        Self {\n            values: HashMap::new(),\n        }\n    }\n\n    pub fn insert(\u0026mut self, column: String, value: Value) {\n        self.values.insert(column, value);\n    }\n\n    pub fn get(\u0026self, column: \u0026str) -\u003e Option\u003c\u0026Value\u003e {\n        self.values.get(column)\n    }\n}\n\nimpl Default for Row {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n/// Query filter for WHERE clauses\n#[derive(Debug, Clone)]\npub struct Filter {\n    pub column: String,\n    pub op: FilterOp,\n    pub value: Value,\n}\n\n/// Filter operations\n#[derive(Debug, Clone)]\npub enum FilterOp {\n    Eq,\n    Ne,\n    NotEq,\n    Lt,\n    Le,\n    Gt,\n    Ge,\n    Lte,\n    Gte,\n    Between(Value),\n    Like,\n}\n\nimpl Filter {\n    pub fn matches(\u0026self, row: \u0026Row) -\u003e bool {\n        let row_value = match row.get(\u0026self.column) {\n            Some(v) =\u003e v,\n            None =\u003e return false,\n        };\n\n        match \u0026self.op {\n            FilterOp::Eq =\u003e row_value == \u0026self.value,\n            FilterOp::Ne | FilterOp::NotEq =\u003e row_value != \u0026self.value,\n            FilterOp::Lt =\u003e self.compare_lt(row_value, \u0026self.value),\n            FilterOp::Le | FilterOp::Lte =\u003e !self.compare_gt(row_value, \u0026self.value),\n            FilterOp::Gt =\u003e self.compare_gt(row_value, \u0026self.value),\n            FilterOp::Ge | FilterOp::Gte =\u003e !self.compare_lt(row_value, \u0026self.value),\n            FilterOp::Like =\u003e self.matches_like(row_value, \u0026self.value),\n            FilterOp::Between(high) =\u003e {\n                !self.compare_lt(row_value, \u0026self.value) \u0026\u0026 !self.compare_gt(row_value, high)\n            }\n        }\n    }\n\n    fn compare_lt(\u0026self, a: \u0026Value, b: \u0026Value) -\u003e bool {\n        match (a, b) {\n            (Value::Integer(av), Value::Integer(bv)) =\u003e av \u003c bv,\n            (Value::Float(av), Value::Float(bv)) =\u003e av \u003c bv,\n            (Value::String(av), Value::String(bv)) =\u003e av \u003c bv,\n            _ =\u003e false,\n        }\n    }\n\n    fn compare_gt(\u0026self, a: \u0026Value, b: \u0026Value) -\u003e bool {\n        match (a, b) {\n            (Value::Integer(av), Value::Integer(bv)) =\u003e av \u003e bv,\n            (Value::Float(av), Value::Float(bv)) =\u003e av \u003e bv,\n            (Value::String(av), Value::String(bv)) =\u003e av \u003e bv,\n            _ =\u003e false,\n        }\n    }\n\n    fn matches_like(\u0026self, row_value: \u0026Value, pattern: \u0026Value) -\u003e bool {\n        match (row_value, pattern) {\n            (Value::String(s), Value::String(p)) =\u003e {\n                // Simple LIKE implementation (% = wildcard)\n                let pattern = p.replace('%', \".*\");\n                regex::Regex::new(\u0026pattern)\n                    .map(|re| re.is_match(s))\n                    .unwrap_or(false)\n            }\n            _ =\u003e false,\n        }\n    }\n}\n\n/// Storage configuration\n#[derive(Debug, Clone)]\npub enum StorageConfig {\n    Sled { data_dir: String },\n}\n\n/// Factory for creating storage engines\npub fn create_storage_engine(config: StorageConfig) -\u003e Result\u003cBox\u003cdyn StorageEngine\u003e\u003e {\n    match config {\n        StorageConfig::Sled { data_dir } =\u003e Ok(Box::new(sled_engine::SledEngine::new(\u0026data_dir)?)),\n    }\n}\n","traces":[{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[14910128],"length":1,"stats":{"Line":6}},{"line":128,"address":[16262686],"length":1,"stats":{"Line":6}},{"line":132,"address":[16020736],"length":1,"stats":{"Line":6}},{"line":133,"address":[14910210],"length":1,"stats":{"Line":6}},{"line":136,"address":[18588576],"length":1,"stats":{"Line":5}},{"line":137,"address":[16262658],"length":1,"stats":{"Line":5}},{"line":142,"address":[16261088],"length":1,"stats":{"Line":0}},{"line":143,"address":[16019096],"length":1,"stats":{"Line":0}},{"line":172,"address":[16131168],"length":1,"stats":{"Line":1}},{"line":173,"address":[16118280],"length":1,"stats":{"Line":1}},{"line":174,"address":[19845985],"length":1,"stats":{"Line":2}},{"line":175,"address":[16264303],"length":1,"stats":{"Line":0}},{"line":178,"address":[16131264],"length":1,"stats":{"Line":1}},{"line":179,"address":[16141734],"length":1,"stats":{"Line":1}},{"line":180,"address":[14911818],"length":1,"stats":{"Line":0}},{"line":181,"address":[16131442],"length":1,"stats":{"Line":0}},{"line":182,"address":[16022432],"length":1,"stats":{"Line":0}},{"line":183,"address":[19846243],"length":1,"stats":{"Line":0}},{"line":184,"address":[16022500],"length":1,"stats":{"Line":0}},{"line":185,"address":[16264572],"length":1,"stats":{"Line":0}},{"line":186,"address":[16264539],"length":1,"stats":{"Line":0}},{"line":187,"address":[16233649,16233584],"length":1,"stats":{"Line":0}},{"line":192,"address":[16232288],"length":1,"stats":{"Line":0}},{"line":193,"address":[16263280,16263356],"length":1,"stats":{"Line":0}},{"line":194,"address":[16232630],"length":1,"stats":{"Line":0}},{"line":195,"address":[14911101],"length":1,"stats":{"Line":0}},{"line":196,"address":[16130569],"length":1,"stats":{"Line":0}},{"line":197,"address":[16130381],"length":1,"stats":{"Line":0}},{"line":201,"address":[16020784],"length":1,"stats":{"Line":0}},{"line":202,"address":[16140224,16140300],"length":1,"stats":{"Line":0}},{"line":203,"address":[16117254],"length":1,"stats":{"Line":0}},{"line":204,"address":[16232223],"length":1,"stats":{"Line":0}},{"line":205,"address":[16232105],"length":1,"stats":{"Line":0}},{"line":206,"address":[16140285],"length":1,"stats":{"Line":0}},{"line":210,"address":[16264107,16264113,16263712],"length":1,"stats":{"Line":0}},{"line":211,"address":[14911209],"length":1,"stats":{"Line":0}},{"line":212,"address":[16118002],"length":1,"stats":{"Line":0}},{"line":214,"address":[16130930],"length":1,"stats":{"Line":0}},{"line":215,"address":[16118136,16118204,16118068],"length":1,"stats":{"Line":0}},{"line":216,"address":[15380766,15380752],"length":1,"stats":{"Line":0}},{"line":219,"address":[16130894],"length":1,"stats":{"Line":0}},{"line":231,"address":[16129344,16129653],"length":1,"stats":{"Line":3}},{"line":233,"address":[14909793,14910056],"length":1,"stats":{"Line":3}}],"covered":13,"coverable":56},{"path":["/","home","azureuser","Documents","Chronos","src","storage","offline_queue.rs"],"content":"use std::convert::TryInto;\n\nuse serde::{Deserialize, Serialize};\n\nuse crate::common::timestamp::HybridTimestamp;\nuse crate::storage::error::StorageError;\nuse crate::storage::wal::Operation;\n\n/// Persistent representation of an operation queued for later sync.\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct PersistentQueuedOperation {\n    pub id: u64,\n    pub timestamp: HybridTimestamp,\n    pub operation: Operation,\n}\n\n/// Persistent offline queue backed by a dedicated Sled tree.\n///\n/// This is intended to store operations that still need to be synced to a\n/// remote cluster or cloud endpoint. It uses a monotonically increasing\n/// sequence ID encoded in big-endian as the key so that iteration order\n/// corresponds to insertion order (FIFO).\npub struct PersistentOfflineQueue {\n    tree: sled::Tree,\n    next_id: u64,\n}\n\nimpl PersistentOfflineQueue {\n    const TREE_NAME: \u0026'static str = \"__offline_queue__\";\n    const META_NEXT_ID_KEY: \u0026'static [u8] = b\"__next_id__\";\n\n    /// Open or create the offline queue for the given database.\n    pub fn new(db: \u0026sled::Db) -\u003e Result\u003cSelf, StorageError\u003e {\n        let tree = db\n            .open_tree(Self::TREE_NAME)\n            .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n        // Prefer a persisted next_id metadata entry if present, otherwise\n        // fall back to scanning existing numeric keys for backward\n        // compatibility.\n        let mut next_id: u64 = 0;\n\n        if let Ok(Some(bytes)) = tree.get(Self::META_NEXT_ID_KEY) {\n            if bytes.len() == 8 {\n                if let Ok(arr) = bytes.as_ref().try_into() as Result\u003c[u8; 8], _\u003e {\n                    next_id = u64::from_be_bytes(arr);\n                }\n            }\n        } else {\n            // Legacy initialization path: determine next_id by looking at the\n            // last numeric key in the tree, if any.\n            let mut last_id: u64 = 0;\n            for item in tree.iter() {\n                let (key, _value) = item.map_err(|e| StorageError::SledError(e.to_string()))?;\n                if key.len() == 8 {\n                    if let Ok(id_bytes) = key.as_ref().try_into() as Result\u003c[u8; 8], _\u003e {\n                        let id = u64::from_be_bytes(id_bytes);\n                        if id \u003e last_id {\n                            last_id = id;\n                        }\n                    }\n                }\n            }\n            next_id = last_id;\n        }\n\n        Ok(Self { tree, next_id })\n    }\n\n    /// Current length of the queue (number of enqueued items).\n    pub fn len(\u0026self) -\u003e Result\u003cusize, StorageError\u003e {\n        let mut count: usize = 0;\n        for item in self.tree.iter() {\n            let (key, _value) = item.map_err(|e| StorageError::SledError(e.to_string()))?;\n            if key.len() == 8 {\n                count += 1;\n            }\n        }\n        Ok(count)\n    }\n\n    /// Returns true if the queue is empty.\n    pub fn is_empty(\u0026self) -\u003e Result\u003cbool, StorageError\u003e {\n        for item in self.tree.iter() {\n            let (key, _value) = item.map_err(|e| StorageError::SledError(e.to_string()))?;\n            if key.len() == 8 {\n                return Ok(false);\n            }\n        }\n        Ok(true)\n    }\n\n    /// Enqueue a new operation with its timestamp. Returns the assigned ID.\n    pub fn enqueue(\n        \u0026mut self,\n        timestamp: HybridTimestamp,\n        operation: Operation,\n    ) -\u003e Result\u003cu64, StorageError\u003e {\n        self.next_id = self.next_id.wrapping_add(1);\n        let id = self.next_id;\n\n        let entry = PersistentQueuedOperation {\n            id,\n            timestamp,\n            operation,\n        };\n\n        let bytes = bincode::serde::encode_to_vec(\u0026entry, bincode::config::standard())\n            .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n        self.tree\n            .insert(id.to_be_bytes(), bytes)\n            .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n        // Persist the updated next_id metadata so IDs never reset even if the\n        // queue is temporarily empty.\n        self.tree\n            .insert(Self::META_NEXT_ID_KEY, \u0026id.to_be_bytes())\n            .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n        Ok(id)\n    }\n\n    /// Drain up to `limit` operations from the head of the queue in FIFO order.\n    /// Removed items are deleted from the underlying Sled tree.\n    pub fn drain(\u0026mut self, limit: usize) -\u003e Result\u003cVec\u003cPersistentQueuedOperation\u003e, StorageError\u003e {\n        let mut drained = Vec::new();\n\n        for item in self.tree.iter() {\n            if drained.len() \u003e= limit {\n                break;\n            }\n\n            let (key, value) = item.map_err(|e| StorageError::SledError(e.to_string()))?;\n\n            // Skip metadata entries such as the next_id marker; only keys\n            // that are exactly 8 bytes long are real queued operations.\n            if key.len() != 8 {\n                continue;\n            }\n\n            let (entry, _): (PersistentQueuedOperation, usize) =\n                bincode::serde::decode_from_slice(\u0026value, bincode::config::standard())\n                    .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n            self.tree\n                .remove(key)\n                .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n            drained.push(entry);\n        }\n\n        Ok(drained)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use tempfile::TempDir;\n\n    #[test]\n    fn enqueue_and_drain_persistent_queue() {\n        let temp_dir = TempDir::new().unwrap();\n        let db = sled::open(temp_dir.path()).unwrap();\n\n        let mut queue = PersistentOfflineQueue::new(\u0026db).unwrap();\n\n        let ts = HybridTimestamp {\n            ts: uhlc::HLC::default().new_timestamp(),\n            node_id: 1,\n        };\n\n        queue\n            .enqueue(\n                ts,\n                Operation::Delete {\n                    table: \"t\".into(),\n                    key: b\"k1\".to_vec(),\n                },\n            )\n            .unwrap();\n\n        queue\n            .enqueue(\n                ts,\n                Operation::Delete {\n                    table: \"t\".into(),\n                    key: b\"k2\".to_vec(),\n                },\n            )\n            .unwrap();\n\n        assert_eq!(queue.len().unwrap(), 2);\n\n        let drained = queue.drain(1).unwrap();\n        assert_eq!(drained.len(), 1);\n        assert_eq!(queue.len().unwrap(), 1);\n\n        let drained_all = queue.drain(10).unwrap();\n        assert_eq!(drained_all.len(), 1);\n        assert!(queue.is_empty().unwrap());\n    }\n}\n","traces":[{"line":33,"address":[13853084,13851216,13851953],"length":1,"stats":{"Line":6}},{"line":34,"address":[14095337,14095418],"length":1,"stats":{"Line":6}},{"line":35,"address":[14014649],"length":1,"stats":{"Line":6}},{"line":36,"address":[13851342,13851267],"length":1,"stats":{"Line":6}},{"line":41,"address":[14095462],"length":1,"stats":{"Line":6}},{"line":43,"address":[14233796,14233666,14233743],"length":1,"stats":{"Line":18}},{"line":44,"address":[14204151,14204212],"length":1,"stats":{"Line":2}},{"line":45,"address":[14229402,14229451,14229571],"length":1,"stats":{"Line":3}},{"line":46,"address":[16561226],"length":1,"stats":{"Line":1}},{"line":52,"address":[14104701],"length":1,"stats":{"Line":6}},{"line":53,"address":[16561367,16560937,16561491],"length":1,"stats":{"Line":18}},{"line":54,"address":[13483906,13483888],"length":1,"stats":{"Line":0}},{"line":55,"address":[14105895,14105834],"length":1,"stats":{"Line":0}},{"line":56,"address":[14205286,14205237],"length":1,"stats":{"Line":0}},{"line":57,"address":[14096877],"length":1,"stats":{"Line":0}},{"line":58,"address":[17840078,17840105],"length":1,"stats":{"Line":0}},{"line":59,"address":[14096961],"length":1,"stats":{"Line":0}},{"line":64,"address":[14234476],"length":1,"stats":{"Line":6}},{"line":67,"address":[16561691],"length":1,"stats":{"Line":6}},{"line":71,"address":[14228000,14228859,14228884],"length":1,"stats":{"Line":1}},{"line":72,"address":[14103513],"length":1,"stats":{"Line":1}},{"line":73,"address":[14202977,14202850],"length":1,"stats":{"Line":2}},{"line":74,"address":[13847394,13847376],"length":1,"stats":{"Line":2}},{"line":75,"address":[17838215,17838157,17838272],"length":1,"stats":{"Line":3}},{"line":76,"address":[16560498,16560445,16560491],"length":1,"stats":{"Line":2}},{"line":79,"address":[14228309],"length":1,"stats":{"Line":1}},{"line":83,"address":[16567649,16567657,16566768],"length":1,"stats":{"Line":1}},{"line":84,"address":[14234921,14235047],"length":1,"stats":{"Line":2}},{"line":85,"address":[16036272,16036290],"length":1,"stats":{"Line":2}},{"line":86,"address":[14102119,14102063],"length":1,"stats":{"Line":2}},{"line":87,"address":[14021490],"length":1,"stats":{"Line":0}},{"line":90,"address":[17844849],"length":1,"stats":{"Line":1}},{"line":94,"address":[17844500,17842880,17844508],"length":1,"stats":{"Line":5}},{"line":99,"address":[14208354,14208248],"length":1,"stats":{"Line":9}},{"line":100,"address":[14099894],"length":1,"stats":{"Line":4}},{"line":108,"address":[13856252,13856135,13857322,13856084,13856032],"length":1,"stats":{"Line":12}},{"line":109,"address":[13679234,13679216],"length":1,"stats":{"Line":4}},{"line":111,"address":[14019971,14020700,14020088,14019893],"length":1,"stats":{"Line":8}},{"line":112,"address":[14208870,14209021,14208933],"length":1,"stats":{"Line":12}},{"line":113,"address":[13679074,13679056],"length":1,"stats":{"Line":8}},{"line":117,"address":[14110242,14110125,14110450],"length":1,"stats":{"Line":4}},{"line":118,"address":[17844013],"length":1,"stats":{"Line":5}},{"line":119,"address":[16566591,16566418,16566322],"length":1,"stats":{"Line":8}},{"line":121,"address":[14020620],"length":1,"stats":{"Line":4}},{"line":126,"address":[14233272,14230768,14232981],"length":1,"stats":{"Line":1}},{"line":127,"address":[14205659],"length":1,"stats":{"Line":1}},{"line":129,"address":[14205762,14207827,14205702,14205880],"length":1,"stats":{"Line":4}},{"line":130,"address":[16562985,16562891],"length":1,"stats":{"Line":2}},{"line":134,"address":[14016990,14017127,14018932],"length":1,"stats":{"Line":2}},{"line":138,"address":[13854108,13854047],"length":1,"stats":{"Line":2}},{"line":142,"address":[17841700],"length":1,"stats":{"Line":1}},{"line":144,"address":[13484546,13484528],"length":1,"stats":{"Line":1}},{"line":146,"address":[17842104,17841987],"length":1,"stats":{"Line":1}},{"line":147,"address":[13854652],"length":1,"stats":{"Line":1}},{"line":148,"address":[14108056,14107960,14108229],"length":1,"stats":{"Line":2}},{"line":150,"address":[13855064],"length":1,"stats":{"Line":1}},{"line":153,"address":[17842752],"length":1,"stats":{"Line":1}}],"covered":50,"coverable":57},{"path":["/","home","azureuser","Documents","Chronos","src","storage","sled_engine.rs"],"content":"use super::{\n    error::StorageError,\n    offline_queue::PersistentOfflineQueue,\n    wal::{Operation, WalEntry},\n    Filter, FilterOp, Row, StorageEngine, TableSchema,\n};\nuse crate::common::timestamp::HybridTimestamp;\nuse crate::storage::compression::chimp;\nuse anyhow::Result;\nuse lru::LruCache;\nuse lz4_flex::block::{compress_prepend_size, decompress_size_prepended};\nuse std::collections::HashMap;\nuse std::num::NonZeroUsize;\nuse std::path::PathBuf;\nuse tokio::sync::Mutex as TokioMutex;\n\nconst SCHEMA_TREE: \u0026str = \"__schemas__\";\nconst INDEX_META_TREE: \u0026str = \"__indexes__\";\n#[allow(dead_code)]\nconst TTL_TREE: \u0026str = \"__ttl__\";\nconst LWW_TS_TREE: \u0026str = \"__lww_ts__\";\nconst SERIES_META_TREE: \u0026str = \"__series_meta__\";\n\npub struct SledEngine {\n    db: sled::Db,\n    wal_sequence: u64,\n    offline_queue: TokioMutex\u003cPersistentOfflineQueue\u003e,\n    cache: TokioMutex\u003cLruCache\u003c(String, Vec\u003cu8\u003e), Row\u003e\u003e,\n}\n\nimpl SledEngine {\n    pub fn new(data_dir: \u0026str) -\u003e Result\u003cSelf\u003e {\n        let path = PathBuf::from(data_dir);\n        std::fs::create_dir_all(\u0026path)?;\n        // Ensure on-disk storage version marker exists and is supported\n        let ver_path = path.join(\"STORAGE_VERSION\");\n        let expected_version: u32 = 1;\n        if ver_path.exists() {\n            let contents = std::fs::read_to_string(\u0026ver_path).unwrap_or_default();\n            let parsed = contents.trim().parse::\u003cu32\u003e().unwrap_or(0);\n            if parsed != expected_version {\n                return Err(StorageError::UnsupportedStorageVersion(parsed).into());\n            }\n        } else {\n            let _ = std::fs::write(\u0026ver_path, b\"1\\n\");\n        }\n\n        let db = sled::open(\u0026path).map_err(|e| StorageError::SledError(e.to_string()))?;\n\n        log::info!(\"Sled storage engine initialized at {:?}\", path);\n\n        let offline_queue = PersistentOfflineQueue::new(\u0026db)?;\n        let cache_capacity = NonZeroUsize::new(10_000).expect(\"non-zero cache size\");\n        let cache = TokioMutex::new(LruCache::new(cache_capacity));\n\n        Ok(Self {\n            db,\n            wal_sequence: 0,\n            offline_queue: TokioMutex::new(offline_queue),\n            cache,\n        })\n    }\n\n    fn table_tree(\u0026self, table_name: \u0026str) -\u003e Result\u003csled::Tree\u003e {\n        self.db\n            .open_tree(format!(\"table:{}\", table_name))\n            .map_err(|e| StorageError::SledError(e.to_string()).into())\n    }\n\n    fn schema_tree(\u0026self) -\u003e Result\u003csled::Tree\u003e {\n        self.db\n            .open_tree(SCHEMA_TREE)\n            .map_err(|e| StorageError::SledError(e.to_string()).into())\n    }\n\n    fn wal_tree(\u0026self) -\u003e Result\u003csled::Tree\u003e {\n        self.db\n            .open_tree(\"__wal__\")\n            .map_err(|e| StorageError::SledError(e.to_string()).into())\n    }\n\n    fn index_tree(\u0026self, table_name: \u0026str, column: \u0026str) -\u003e Result\u003csled::Tree\u003e {\n        self.db\n            .open_tree(format!(\"index:{}:{}\", table_name, column))\n            .map_err(|e| StorageError::SledError(e.to_string()).into())\n    }\n\n    fn index_meta_tree(\u0026self) -\u003e Result\u003csled::Tree\u003e {\n        self.db\n            .open_tree(INDEX_META_TREE)\n            .map_err(|e| StorageError::SledError(e.to_string()).into())\n    }\n\n    #[allow(dead_code)]\n    fn ttl_tree(\u0026self) -\u003e Result\u003csled::Tree\u003e {\n        self.db\n            .open_tree(TTL_TREE)\n            .map_err(|e| StorageError::SledError(e.to_string()).into())\n    }\n\n    fn lww_ts_tree(\u0026self) -\u003e Result\u003csled::Tree\u003e {\n        self.db\n            .open_tree(LWW_TS_TREE)\n            .map_err(|e| StorageError::SledError(e.to_string()).into())\n    }\n    fn series_meta_tree(\u0026self) -\u003e Result\u003csled::Tree\u003e {\n        self.db\n            .open_tree(SERIES_META_TREE)\n            .map_err(|e| StorageError::SledError(e.to_string()).into())\n    }\n    fn series_tree(\u0026self, table_name: \u0026str, column: \u0026str) -\u003e Result\u003csled::Tree\u003e {\n        self.db\n            .open_tree(format!(\"series:chimp:{}:{}\", table_name, column))\n            .map_err(|e| StorageError::SledError(e.to_string()).into())\n    }\n    fn chimp_enabled() -\u003e bool {\n        std::env::var(\"CHRONOS_CHIMP_ENABLE\")\n            .map(|v| v == \"1\" || v.eq_ignore_ascii_case(\"true\"))\n            .unwrap_or(false)\n    }\n\n    fn generate_row_key(\u0026self) -\u003e String {\n        format!(\n            \"{:020}:{:08x}\",\n            std::time::SystemTime::now()\n                .duration_since(std::time::UNIX_EPOCH)\n                .unwrap()\n                .as_nanos(),\n            rand::random::\u003cu32\u003e()\n        )\n    }\n}\n\nfn compress_row(bytes: \u0026[u8]) -\u003e Result\u003cVec\u003cu8\u003e, StorageError\u003e {\n    // Prefix with 0x01 to indicate compressed payload; legacy uncompressed\n    // rows will not have this prefix and will be decoded as-is.\n    let mut out = Vec::with_capacity(1 + bytes.len());\n    out.push(1);\n    let mut compressed = compress_prepend_size(bytes);\n    out.append(\u0026mut compressed);\n    Ok(out)\n}\n\nfn decompress_row(bytes: \u0026[u8]) -\u003e Result\u003cVec\u003cu8\u003e, StorageError\u003e {\n    match bytes.first() {\n        Some(1) =\u003e {\n            // New compressed format\n            decompress_size_prepended(\u0026bytes[1..])\n                .map_err(|e| StorageError::SledError(e.to_string()))\n        }\n        _ =\u003e Ok(bytes.to_vec()), // Legacy uncompressed row\n    }\n}\n\n#[async_trait::async_trait]\nimpl StorageEngine for SledEngine {\n    async fn init(\u0026mut self) -\u003e Result\u003c()\u003e {\n        self.recover_from_wal().await?;\n        Ok(())\n    }\n\n    async fn create_table(\u0026mut self, table_name: \u0026str, schema: TableSchema) -\u003e Result\u003c()\u003e {\n        let schema_tree = self.schema_tree()?;\n\n        if schema_tree.contains_key(table_name.as_bytes())? {\n            return Err(StorageError::TableAlreadyExists(table_name.to_string()).into());\n        }\n\n        let schema_bytes = bincode::encode_to_vec(\u0026schema, bincode::config::standard())?;\n        schema_tree.insert(table_name.as_bytes(), schema_bytes)?;\n\n        self.table_tree(table_name)?;\n\n        log::info!(\n            \"Created table '{}' with {} columns\",\n            table_name,\n            schema.columns.len()\n        );\n\n        Ok(())\n    }\n\n    async fn insert(\u0026mut self, table_name: \u0026str, rows: Vec\u003cRow\u003e) -\u003e Result\u003c()\u003e {\n        let tree = self.table_tree(table_name)?;\n        let wal_tree = self.wal_tree()?;\n\n        let schema = self\n            .get_schema(table_name)\n            .await?\n            .ok_or_else(|| StorageError::TableNotFound(table_name.to_string()))?;\n\n        let ttl_seconds = schema.ttl_seconds;\n        let ttl_tree = if ttl_seconds.is_some() {\n            Some(self.ttl_tree()?)\n        } else {\n            None\n        };\n\n        let row_count = rows.len();\n        // Optional: accumulate FLOAT column values per column for Chimp series\n        let do_chimp = Self::chimp_enabled();\n        let float_cols: Vec\u003cString\u003e = if do_chimp {\n            schema\n                .columns\n                .iter()\n                .filter_map(|c| match c.data_type {\n                    crate::storage::DataType::Float =\u003e Some(c.name.clone()),\n                    _ =\u003e None,\n                })\n                .collect()\n        } else {\n            Vec::new()\n        };\n        let mut chimp_acc: HashMap\u003cString, Vec\u003cf64\u003e\u003e = HashMap::new();\n        for row in rows {\n            for col in \u0026schema.columns {\n                if !row.values.contains_key(\u0026col.name) {\n                    return Err(StorageError::ColumnNotFound(\n                        col.name.clone(),\n                        table_name.to_string(),\n                    )\n                    .into());\n                }\n            }\n\n            let key = self.generate_row_key();\n            let raw_value = bincode::encode_to_vec(\u0026row, bincode::config::standard())?;\n            let value = compress_row(\u0026raw_value)?;\n\n            self.wal_sequence = self.wal_sequence.wrapping_add(1);\n            let op = Operation::Insert {\n                table: table_name.to_string(),\n                key: key.as_bytes().to_vec(),\n                value: value.clone(),\n            };\n            let ts = crate::common::timestamp::HybridTimestamp {\n                ts: uhlc::HLC::default().new_timestamp(),\n                node_id: 0,\n            };\n\n            // Enqueue into persistent offline queue for Phase 2 sync.\n            {\n                let mut queue = self.offline_queue.lock().await;\n                let _ = queue.enqueue(ts, op.clone())?;\n            }\n\n            let entry = WalEntry::new(self.wal_sequence, ts, op, 0);\n            let wal_bytes = bincode::serde::encode_to_vec(\u0026entry, bincode::config::standard())?;\n            wal_tree\n                .insert(self.wal_sequence.to_be_bytes(), wal_bytes)\n                .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n            tree.insert(key.as_bytes(), value)?;\n\n            if let (Some(ttl), Some(ttl_tree)) = (ttl_seconds, ttl_tree.as_ref()) {\n                let expiration_ts = std::time::SystemTime::now()\n                    .duration_since(std::time::UNIX_EPOCH)\n                    .unwrap()\n                    .as_secs()\n                    .saturating_add(ttl);\n                let ttl_key = format!(\"{:020}:{}:{}\", expiration_ts, table_name, key);\n                ttl_tree\n                    .insert(ttl_key.as_bytes(), \u0026[])\n                    .map_err(|e| StorageError::SledError(e.to_string()))?;\n            }\n\n            // Maintain secondary indexes for this table, if configured\n            let index_meta = self.index_meta_tree()?;\n            for col in \u0026schema.columns {\n                let meta_key = format!(\"{}:{}\", table_name, col.name);\n                let has_index = index_meta\n                    .contains_key(meta_key.as_bytes())\n                    .map_err(|e| StorageError::SledError(e.to_string()))?;\n                if !has_index {\n                    continue;\n                }\n\n                if let Some(col_value) = row.get(\u0026col.name) {\n                    let index_tree = self.index_tree(table_name, \u0026col.name)?;\n                    let index_key = format!(\"{}:{}\", serde_json::to_string(col_value)?, \u0026key);\n                    index_tree\n                        .insert(index_key.as_bytes(), key.as_bytes())\n                        .map_err(|e| StorageError::SledError(e.to_string()))?;\n                }\n            }\n\n            // Accumulate floats for Chimp series (per column)\n            if do_chimp {\n                for col_name in \u0026float_cols {\n                    if let Some(crate::parser::Value::Float(fv)) = row.get(col_name) {\n                        chimp_acc.entry(col_name.clone()).or_default().push(*fv);\n                    }\n                }\n            }\n        }\n\n        wal_tree\n            .flush_async()\n            .await\n            .map_err(|e| StorageError::SledError(e.to_string()))?;\n        tree.flush_async()\n            .await\n            .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n        if let Some(ttl_tree) = ttl_tree {\n            ttl_tree\n                .flush_async()\n                .await\n                .map_err(|e| StorageError::SledError(e.to_string()))?;\n        }\n        // If Chimp enabled, append encoded segments for any accumulated floats per column\n        if do_chimp \u0026\u0026 !chimp_acc.is_empty() {\n            let meta = self.series_meta_tree()?;\n            for (col, vals) in chimp_acc {\n                if vals.is_empty() {\n                    continue;\n                }\n                let enc = chimp::encode_series(\u0026vals);\n                let series = self.series_tree(table_name, \u0026col)?;\n                // Meta key: series:chimp:{table}:{col}:next\n                let meta_key = format!(\"series:chimp:{}:{}:next\", table_name, col);\n                let next_id = match meta.get(meta_key.as_bytes())? {\n                    Some(b) if b.len() == 8 =\u003e {\n                        let mut arr = [0u8; 8];\n                        arr.copy_from_slice(\u0026b);\n                        u64::from_be_bytes(arr)\n                    }\n                    _ =\u003e 0u64,\n                };\n                let new_id = next_id.wrapping_add(1);\n                series\n                    .insert(new_id.to_be_bytes(), enc)\n                    .map_err(|e| StorageError::SledError(e.to_string()))?;\n                meta.insert(meta_key.as_bytes(), \u0026new_id.to_be_bytes())\n                    .map_err(|e| StorageError::SledError(e.to_string()))?;\n                series\n                    .flush_async()\n                    .await\n                    .map_err(|e| StorageError::SledError(e.to_string()))?;\n            }\n            meta.flush_async()\n                .await\n                .map_err(|e| StorageError::SledError(e.to_string()))?;\n        }\n\n        log::debug!(\"Inserted {} rows into table '{}'\", row_count, table_name);\n\n        Ok(())\n    }\n\n    async fn query(\u0026self, table_name: \u0026str, filter: Option\u003cFilter\u003e) -\u003e Result\u003cVec\u003cRow\u003e\u003e {\n        let tree = self.table_tree(table_name)?;\n        let mut results = Vec::new();\n\n        // Prefer secondary index for simple equality filters when available.\n        // If no index or no hits, fall back to full table scan.\n        if let Some(ref f) = filter {\n            if matches!(f.op, FilterOp::Eq) {\n                let index_meta = self.index_meta_tree()?;\n                let meta_key = format!(\"{}:{}\", table_name, f.column);\n                let has_index = index_meta\n                    .contains_key(meta_key.as_bytes())\n                    .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n                if has_index {\n                    if let Ok(index_tree) = self.index_tree(table_name, \u0026f.column) {\n                        let prefix = serde_json::to_string(\u0026f.value)?;\n\n                        for item in index_tree.scan_prefix(prefix.as_bytes()) {\n                            let (_index_key, row_key) =\n                                item.map_err(|e| StorageError::SledError(e.to_string()))?;\n\n                            let cache_key = (table_name.to_string(), row_key.to_vec());\n\n                            // Check cache first\n                            let cached_row = {\n                                let mut cache = self.cache.lock().await;\n                                cache.get(\u0026cache_key).cloned()\n                            };\n\n                            let row = if let Some(row) = cached_row {\n                                row\n                            } else {\n                                // Fallback to storage\n                                let stored = match tree\n                                    .get(\u0026row_key)\n                                    .map_err(|e| StorageError::SledError(e.to_string()))?\n                                {\n                                    Some(v) =\u003e v,\n                                    None =\u003e continue,\n                                };\n                                let value = decompress_row(\u0026stored)?;\n                                let (row, _): (Row, usize) = bincode::decode_from_slice(\n                                    \u0026value,\n                                    bincode::config::standard(),\n                                )?;\n\n                                // Insert into cache\n                                {\n                                    let mut cache = self.cache.lock().await;\n                                    cache.put(cache_key, row.clone());\n                                }\n\n                                row\n                            };\n\n                            // Extra safety: still apply the filter in case of type mismatches\n                            if let Some(ref f) = filter {\n                                if !f.matches(\u0026row) {\n                                    continue;\n                                }\n                            }\n\n                            results.push(row);\n                        }\n\n                        log::debug!(\n                            \"Query (indexed) returned {} rows from table '{}'\",\n                            results.len(),\n                            table_name\n                        );\n\n                        // If the indexed lookup found rows, return them.\n                        if !results.is_empty() {\n                            return Ok(results);\n                        }\n                        // Otherwise, fall through to the full table scan below.\n                    }\n                }\n            }\n        }\n\n        // Fallback: full table scan\n        for item in tree.iter() {\n            let (_key, stored) = item.map_err(|e| StorageError::SledError(e.to_string()))?;\n            let value = decompress_row(\u0026stored)?;\n            let (row, _): (Row, usize) =\n                bincode::decode_from_slice(\u0026value, bincode::config::standard())?;\n\n            if let Some(ref f) = filter {\n                if !f.matches(\u0026row) {\n                    continue;\n                }\n            }\n\n            results.push(row);\n        }\n\n        log::debug!(\n            \"Query returned {} rows from table '{}'\",\n            results.len(),\n            table_name\n        );\n\n        Ok(results)\n    }\n\n    async fn delete(\u0026mut self, table_name: \u0026str, filter: Filter) -\u003e Result\u003cusize\u003e {\n        let tree = self.table_tree(table_name)?;\n        let mut deleted = 0;\n\n        // Discover which columns have indexes for this table (if any)\n        let schema = self\n            .get_schema(table_name)\n            .await?\n            .ok_or_else(|| StorageError::TableNotFound(table_name.to_string()))?;\n        let index_meta = self.index_meta_tree()?;\n        let mut indexed_columns: Vec\u003cString\u003e = Vec::new();\n        for col in \u0026schema.columns {\n            let meta_key = format!(\"{}:{}\", table_name, col.name);\n            let has_index = index_meta\n                .contains_key(meta_key.as_bytes())\n                .map_err(|e| StorageError::SledError(e.to_string()))?;\n            if has_index {\n                indexed_columns.push(col.name.clone());\n            }\n        }\n\n        let mut to_delete = Vec::new();\n        let mut rows_for_index: Vec\u003c(sled::IVec, Row)\u003e = Vec::new();\n        for item in tree.iter() {\n            let (key, stored) = item.map_err(|e| StorageError::SledError(e.to_string()))?;\n            let value = decompress_row(\u0026stored)?;\n            let (row, _): (Row, usize) =\n                bincode::decode_from_slice(\u0026value, bincode::config::standard())?;\n\n            if filter.matches(\u0026row) {\n                to_delete.push(key.clone());\n                if !indexed_columns.is_empty() {\n                    rows_for_index.push((key, row));\n                }\n            }\n        }\n\n        // Remove index entries for the rows being deleted\n        for (key, row) in \u0026rows_for_index {\n            let key_str = String::from_utf8_lossy(key).to_string();\n            for col_name in \u0026indexed_columns {\n                if let Some(col_value) = row.get(col_name) {\n                    let index_tree = self.index_tree(table_name, col_name)?;\n                    let index_key = format!(\"{}:{}\", serde_json::to_string(col_value)?, key_str);\n                    index_tree\n                        .remove(index_key.as_bytes())\n                        .map_err(|e| StorageError::SledError(e.to_string()))?;\n                }\n            }\n        }\n\n        // Invalidate cache entries for deleted rows\n        if !rows_for_index.is_empty() {\n            let table = table_name.to_string();\n            let mut cache = self.cache.lock().await;\n            for (key, _) in \u0026rows_for_index {\n                let cache_key = (table.clone(), key.to_vec());\n                cache.pop(\u0026cache_key);\n            }\n        }\n\n        for key in to_delete {\n            tree.remove(key)?;\n            deleted += 1;\n        }\n\n        tree.flush_async()\n            .await\n            .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n        log::info!(\"Deleted {} rows from table '{}'\", deleted, table_name);\n\n        Ok(deleted)\n    }\n\n    async fn create_index(\u0026mut self, table_name: \u0026str, column: \u0026str) -\u003e Result\u003c()\u003e {\n        let table_tree = self.table_tree(table_name)?;\n        let index_tree = self.index_tree(table_name, column)?;\n\n        // Build the initial index from existing rows\n        for item in table_tree.iter() {\n            let (row_key, stored) = item.map_err(|e| StorageError::SledError(e.to_string()))?;\n            let value = decompress_row(\u0026stored)?;\n            let (row, _): (Row, usize) =\n                bincode::decode_from_slice(\u0026value, bincode::config::standard())?;\n\n            if let Some(col_value) = row.get(column) {\n                let index_key = format!(\n                    \"{}:{}\",\n                    serde_json::to_string(col_value)?,\n                    String::from_utf8_lossy(\u0026row_key)\n                );\n                index_tree.insert(index_key.as_bytes(), row_key)?;\n            }\n        }\n\n        index_tree\n            .flush_async()\n            .await\n            .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n        // Register the index in metadata so future INSERT/DELETE keep it up to date\n        let index_meta = self.index_meta_tree()?;\n        let meta_key = format!(\"{}:{}\", table_name, column);\n        index_meta\n            .insert(meta_key.as_bytes(), \u0026[])\n            .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n        log::info!(\n            \"Created index on column '{}' for table '{}'\",\n            column,\n            table_name\n        );\n\n        Ok(())\n    }\n\n    async fn get_schema(\u0026self, table_name: \u0026str) -\u003e Result\u003cOption\u003cTableSchema\u003e\u003e {\n        let schema_tree = self.schema_tree()?;\n\n        match schema_tree.get(table_name.as_bytes())? {\n            Some(schema_bytes) =\u003e {\n                let (schema, _): (TableSchema, usize) =\n                    bincode::decode_from_slice(\u0026schema_bytes, bincode::config::standard())?;\n                Ok(Some(schema))\n            }\n            None =\u003e Ok(None),\n        }\n    }\n\n    async fn list_tables(\u0026self) -\u003e Result\u003cVec\u003cString\u003e\u003e {\n        let schema_tree = self.schema_tree()?;\n        let mut tables = Vec::new();\n\n        for item in schema_tree.iter() {\n            let (key, _) = item.map_err(|e| StorageError::SledError(e.to_string()))?;\n            let table_name = String::from_utf8_lossy(\u0026key).to_string();\n            tables.push(table_name);\n        }\n\n        Ok(tables)\n    }\n\n    async fn checkpoint(\u0026mut self) -\u003e Result\u003c()\u003e {\n        self.db\n            .flush_async()\n            .await\n            .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n        log::debug!(\"Checkpoint completed for sled storage\");\n        Ok(())\n    }\n\n    async fn close(\u0026mut self) -\u003e Result\u003c()\u003e {\n        self.db\n            .flush_async()\n            .await\n            .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n        log::info!(\"Sled storage engine closed\");\n        Ok(())\n    }\n\n    async fn cleanup_expired(\u0026mut self, now_secs: u64, limit: usize) -\u003e Result\u003cu64\u003e {\n        let ttl_tree = self.ttl_tree()?;\n        let mut to_cleanup: Vec\u003c(sled::IVec, String, String)\u003e = Vec::new();\n\n        for item in ttl_tree.iter() {\n            let (key, _) = item.map_err(|e| StorageError::SledError(e.to_string()))?;\n            let key_str = String::from_utf8_lossy(\u0026key);\n            let mut parts = key_str.splitn(3, ':');\n\n            let ts_str = match parts.next() {\n                Some(s) =\u003e s,\n                None =\u003e continue,\n            };\n            let table_name = match parts.next() {\n                Some(t) =\u003e t.to_string(),\n                None =\u003e continue,\n            };\n            let row_key_str = match parts.next() {\n                Some(r) =\u003e r.to_string(),\n                None =\u003e continue,\n            };\n\n            let expiration_ts: u64 = match ts_str.parse() {\n                Ok(v) =\u003e v,\n                Err(_) =\u003e continue,\n            };\n\n            if expiration_ts \u003e now_secs {\n                break;\n            }\n\n            to_cleanup.push((key.clone(), table_name, row_key_str));\n\n            if to_cleanup.len() \u003e= limit {\n                break;\n            }\n        }\n\n        if to_cleanup.is_empty() {\n            return Ok(0);\n        }\n\n        let mut per_table_indexed: HashMap\u003cString, Vec\u003cString\u003e\u003e = HashMap::new();\n        let index_meta = self.index_meta_tree()?;\n        let mut deleted_rows: u64 = 0;\n\n        for (ttl_key, table_name, row_key_str) in to_cleanup {\n            let table_tree = self.table_tree(\u0026table_name)?;\n            let row_key_bytes = row_key_str.as_bytes();\n\n            let stored = match table_tree\n                .get(row_key_bytes)\n                .map_err(|e| StorageError::SledError(e.to_string()))?\n            {\n                Some(v) =\u003e v,\n                None =\u003e {\n                    ttl_tree\n                        .remove(\u0026ttl_key)\n                        .map_err(|e| StorageError::SledError(e.to_string()))?;\n                    continue;\n                }\n            };\n\n            let value = decompress_row(\u0026stored)?;\n            let (row, _): (Row, usize) =\n                bincode::decode_from_slice(\u0026value, bincode::config::standard())?;\n\n            let indexed_cols = if let Some(cols) = per_table_indexed.get(\u0026table_name) {\n                cols.clone()\n            } else {\n                let schema = match self.get_schema(\u0026table_name).await? {\n                    Some(s) =\u003e s,\n                    None =\u003e {\n                        ttl_tree\n                            .remove(\u0026ttl_key)\n                            .map_err(|e| StorageError::SledError(e.to_string()))?;\n                        continue;\n                    }\n                };\n\n                let mut cols: Vec\u003cString\u003e = Vec::new();\n                for col in \u0026schema.columns {\n                    let meta_key = format!(\"{}:{}\", table_name, col.name);\n                    let has_index = index_meta\n                        .contains_key(meta_key.as_bytes())\n                        .map_err(|e| StorageError::SledError(e.to_string()))?;\n                    if has_index {\n                        cols.push(col.name.clone());\n                    }\n                }\n                per_table_indexed.insert(table_name.clone(), cols.clone());\n                cols\n            };\n\n            if !indexed_cols.is_empty() {\n                for col_name in \u0026indexed_cols {\n                    if let Some(col_value) = row.get(col_name) {\n                        let index_tree = self.index_tree(\u0026table_name, col_name)?;\n                        let index_key =\n                            format!(\"{}:{}\", serde_json::to_string(col_value)?, row_key_str);\n                        index_tree\n                            .remove(index_key.as_bytes())\n                            .map_err(|e| StorageError::SledError(e.to_string()))?;\n                    }\n                }\n            }\n\n            {\n                let mut cache = self.cache.lock().await;\n                let cache_key = (table_name.clone(), row_key_bytes.to_vec());\n                cache.pop(\u0026cache_key);\n            }\n\n            table_tree\n                .remove(row_key_bytes)\n                .map_err(|e| StorageError::SledError(e.to_string()))?;\n            ttl_tree\n                .remove(\u0026ttl_key)\n                .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n            deleted_rows += 1;\n        }\n\n        self.db\n            .flush_async()\n            .await\n            .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n        Ok(deleted_rows)\n    }\n\n    async fn drain_offline_queue(\n        \u0026self,\n        limit: usize,\n    ) -\u003e Result\u003cVec\u003ccrate::storage::offline_queue::PersistentQueuedOperation\u003e\u003e {\n        let mut queue = self.offline_queue.lock().await;\n        queue\n            .drain(limit)\n            .map_err(|e| StorageError::SledError(e.to_string()).into())\n    }\n\n    async fn requeue_offline_ops(\n        \u0026self,\n        ops: Vec\u003ccrate::storage::offline_queue::PersistentQueuedOperation\u003e,\n    ) -\u003e Result\u003c()\u003e {\n        let mut queue = self.offline_queue.lock().await;\n        for op in ops {\n            queue.enqueue(op.timestamp, op.operation)?;\n        }\n        Ok(())\n    }\n\n    async fn apply_operation(\u0026mut self, op: Operation) -\u003e Result\u003c()\u003e {\n        match op {\n            Operation::Insert { table, key, value } =\u003e {\n                let table_tree = self.table_tree(\u0026table)?;\n                table_tree\n                    .insert(key.clone(), value)\n                    .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n                if let Some(schema) = self.get_schema(\u0026table).await? {\n                    if let Some(ttl) = schema.ttl_seconds {\n                        let expiration_ts = std::time::SystemTime::now()\n                            .duration_since(std::time::UNIX_EPOCH)\n                            .unwrap()\n                            .as_secs()\n                            .saturating_add(ttl);\n                        let ttl_tree = self.ttl_tree()?;\n                        let row_key_str = String::from_utf8_lossy(\u0026key).to_string();\n                        let ttl_key = format!(\"{:020}:{}:{}\", expiration_ts, table, row_key_str);\n                        ttl_tree\n                            .insert(ttl_key.as_bytes(), \u0026[])\n                            .map_err(|e| StorageError::SledError(e.to_string()))?;\n                    }\n                }\n            }\n            Operation::Update { table, key, value } =\u003e {\n                let table_tree = self.table_tree(\u0026table)?;\n                table_tree\n                    .insert(key, value)\n                    .map_err(|e| StorageError::SledError(e.to_string()))?;\n            }\n            Operation::Delete { table, key } =\u003e {\n                let table_tree = self.table_tree(\u0026table)?;\n                table_tree\n                    .remove(key)\n                    .map_err(|e| StorageError::SledError(e.to_string()))?;\n            }\n        }\n\n        self.db\n            .flush_async()\n            .await\n            .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n        Ok(())\n    }\n\n    async fn get_lww_ts(\u0026self, table: \u0026str, key: \u0026[u8]) -\u003e Result\u003cOption\u003cHybridTimestamp\u003e\u003e {\n        let tree = self.lww_ts_tree()?;\n        let mut composite = Vec::with_capacity(table.len() + 1 + key.len());\n        composite.extend_from_slice(table.as_bytes());\n        composite.push(0);\n        composite.extend_from_slice(key);\n\n        match tree.get(\u0026composite) {\n            Ok(Some(value)) =\u003e {\n                let (ts, _): (HybridTimestamp, usize) =\n                    bincode::serde::decode_from_slice(\u0026value, bincode::config::standard())\n                        .map_err(|e| StorageError::SledError(e.to_string()))?;\n                Ok(Some(ts))\n            }\n            Ok(None) =\u003e Ok(None),\n            Err(e) =\u003e Err(StorageError::SledError(e.to_string()).into()),\n        }\n    }\n\n    async fn set_lww_ts(\u0026mut self, table: \u0026str, key: \u0026[u8], ts: HybridTimestamp) -\u003e Result\u003c()\u003e {\n        let tree = self.lww_ts_tree()?;\n        let mut composite = Vec::with_capacity(table.len() + 1 + key.len());\n        composite.extend_from_slice(table.as_bytes());\n        composite.push(0);\n        composite.extend_from_slice(key);\n\n        let bytes = bincode::serde::encode_to_vec(ts, bincode::config::standard())\n            .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n        tree.insert(composite, bytes)\n            .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n        Ok(())\n    }\n}\n\nimpl SledEngine {\n    async fn recover_from_wal(\u0026mut self) -\u003e Result\u003c()\u003e {\n        let wal_tree = self.wal_tree()?;\n\n        for item in wal_tree.iter() {\n            let (_key, value) = item.map_err(|e| StorageError::SledError(e.to_string()))?;\n            let (entry, _): (WalEntry, usize) =\n                bincode::serde::decode_from_slice(\u0026value, bincode::config::standard())?;\n\n            match entry.operation {\n                Operation::Insert { table, key, value } =\u003e {\n                    let table_tree = self.table_tree(\u0026table)?;\n                    table_tree\n                        .insert(key, value)\n                        .map_err(|e| StorageError::SledError(e.to_string()))?;\n                }\n                Operation::Update { table, key, value } =\u003e {\n                    let table_tree = self.table_tree(\u0026table)?;\n                    table_tree\n                        .insert(key, value)\n                        .map_err(|e| StorageError::SledError(e.to_string()))?;\n                }\n                Operation::Delete { table, key } =\u003e {\n                    let table_tree = self.table_tree(\u0026table)?;\n                    table_tree\n                        .remove(key)\n                        .map_err(|e| StorageError::SledError(e.to_string()))?;\n                }\n            }\n        }\n\n        self.db\n            .flush_async()\n            .await\n            .map_err(|e| StorageError::SledError(e.to_string()))?;\n\n        log::debug!(\"WAL recovery completed\");\n        Ok(())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::parser::Value;\n    use crate::storage::{Column, DataType, Filter, FilterOp, TableSchema};\n    use tempfile::TempDir;\n\n    #[tokio::test]\n    async fn test_sled_create_table() {\n        let temp_dir = TempDir::new().unwrap();\n        let mut engine = SledEngine::new(temp_dir.path().to_str().unwrap()).unwrap();\n\n        let schema = TableSchema {\n            name: \"users\".to_string(),\n            columns: vec![\n                Column {\n                    name: \"id\".to_string(),\n                    data_type: DataType::Int,\n                },\n                Column {\n                    name: \"name\".to_string(),\n                    data_type: DataType::String,\n                },\n            ],\n            ttl_seconds: None,\n        };\n\n        engine.create_table(\"users\", schema).await.unwrap();\n\n        let retrieved = engine.get_schema(\"users\").await.unwrap().unwrap();\n        assert_eq!(retrieved.columns.len(), 2);\n    }\n\n    #[tokio::test]\n    async fn test_sled_insert_query() {\n        let temp_dir = TempDir::new().unwrap();\n        let mut engine = SledEngine::new(temp_dir.path().to_str().unwrap()).unwrap();\n\n        let schema = TableSchema {\n            name: \"sensors\".to_string(),\n            columns: vec![\n                Column {\n                    name: \"sensor_id\".to_string(),\n                    data_type: DataType::Int,\n                },\n                Column {\n                    name: \"temperature\".to_string(),\n                    data_type: DataType::Float,\n                },\n            ],\n            ttl_seconds: None,\n        };\n\n        engine.create_table(\"sensors\", schema).await.unwrap();\n\n        let mut row = Row::new();\n        row.insert(\"sensor_id\".to_string(), Value::Integer(1));\n        row.insert(\"temperature\".to_string(), Value::Float(25.5));\n\n        engine.insert(\"sensors\", vec![row]).await.unwrap();\n\n        let results = engine.query(\"sensors\", None).await.unwrap();\n        assert_eq!(results.len(), 1);\n    }\n\n    #[tokio::test]\n    async fn test_sled_indexed_query() {\n        let temp_dir = TempDir::new().unwrap();\n        let mut engine = SledEngine::new(temp_dir.path().to_str().unwrap()).unwrap();\n\n        let schema = TableSchema {\n            name: \"sensors\".to_string(),\n            columns: vec![\n                Column {\n                    name: \"sensor_id\".to_string(),\n                    data_type: DataType::Int,\n                },\n                Column {\n                    name: \"temperature\".to_string(),\n                    data_type: DataType::Float,\n                },\n            ],\n            ttl_seconds: None,\n        };\n\n        engine.create_table(\"sensors\", schema).await.unwrap();\n\n        // Insert two rows with different sensor_ids\n        let mut row1 = Row::new();\n        row1.insert(\"sensor_id\".to_string(), Value::Integer(1));\n        row1.insert(\"temperature\".to_string(), Value::Float(25.5));\n\n        let mut row2 = Row::new();\n        row2.insert(\"sensor_id\".to_string(), Value::Integer(2));\n        row2.insert(\"temperature\".to_string(), Value::Float(30.0));\n\n        engine.insert(\"sensors\", vec![row1, row2]).await.unwrap();\n\n        // Create an index on sensor_id\n        engine.create_index(\"sensors\", \"sensor_id\").await.unwrap();\n\n        // Build a filter that should be able to use the index\n        let filter = Filter {\n            column: \"sensor_id\".to_string(),\n            op: FilterOp::Eq,\n            value: Value::Integer(1),\n        };\n\n        let results = engine.query(\"sensors\", Some(filter)).await.unwrap();\n        assert_eq!(results.len(), 1);\n        let row = \u0026results[0];\n        assert_eq!(row.get(\"sensor_id\"), Some(\u0026Value::Integer(1)));\n    }\n\n    #[tokio::test]\n    async fn test_sled_indexed_delete() {\n        let temp_dir = TempDir::new().unwrap();\n        let mut engine = SledEngine::new(temp_dir.path().to_str().unwrap()).unwrap();\n\n        let schema = TableSchema {\n            name: \"sensors\".to_string(),\n            columns: vec![\n                Column {\n                    name: \"sensor_id\".to_string(),\n                    data_type: DataType::Int,\n                },\n                Column {\n                    name: \"temperature\".to_string(),\n                    data_type: DataType::Float,\n                },\n            ],\n            ttl_seconds: None,\n        };\n\n        engine.create_table(\"sensors\", schema).await.unwrap();\n\n        // Insert three rows, two of which share the same sensor_id\n        let mut row1 = Row::new();\n        row1.insert(\"sensor_id\".to_string(), Value::Integer(1));\n        row1.insert(\"temperature\".to_string(), Value::Float(25.5));\n\n        let mut row2 = Row::new();\n        row2.insert(\"sensor_id\".to_string(), Value::Integer(2));\n        row2.insert(\"temperature\".to_string(), Value::Float(30.0));\n\n        let mut row3 = Row::new();\n        row3.insert(\"sensor_id\".to_string(), Value::Integer(1));\n        row3.insert(\"temperature\".to_string(), Value::Float(26.0));\n\n        engine\n            .insert(\"sensors\", vec![row1, row2, row3])\n            .await\n            .unwrap();\n\n        // Create an index on sensor_id\n        engine.create_index(\"sensors\", \"sensor_id\").await.unwrap();\n\n        // Delete all rows with sensor_id = 1\n        let delete_filter = Filter {\n            column: \"sensor_id\".to_string(),\n            op: FilterOp::Eq,\n            value: Value::Integer(1),\n        };\n\n        let deleted = engine.delete(\"sensors\", delete_filter).await.unwrap();\n        assert_eq!(deleted, 2);\n\n        // Query again by sensor_id = 1 using the index; should return no rows\n        let query_filter = Filter {\n            column: \"sensor_id\".to_string(),\n            op: FilterOp::Eq,\n            value: Value::Integer(1),\n        };\n\n        let results = engine.query(\"sensors\", Some(query_filter)).await.unwrap();\n        assert_eq!(results.len(), 0);\n\n        // And sensor_id = 2 should still be present\n        let filter2 = Filter {\n            column: \"sensor_id\".to_string(),\n            op: FilterOp::Eq,\n            value: Value::Integer(2),\n        };\n        let results2 = engine.query(\"sensors\", Some(filter2)).await.unwrap();\n        assert_eq!(results2.len(), 1);\n        let row = \u0026results2[0];\n        assert_eq!(row.get(\"sensor_id\"), Some(\u0026Value::Integer(2)));\n    }\n\n    #[tokio::test]\n    async fn test_sled_ttl_cleanup_with_index() {\n        use std::time::{SystemTime, UNIX_EPOCH};\n\n        let temp_dir = TempDir::new().unwrap();\n        let mut engine = SledEngine::new(temp_dir.path().to_str().unwrap()).unwrap();\n\n        let schema = TableSchema {\n            name: \"sensors_ttl\".to_string(),\n            columns: vec![\n                Column {\n                    name: \"sensor_id\".to_string(),\n                    data_type: DataType::Int,\n                },\n                Column {\n                    name: \"temperature\".to_string(),\n                    data_type: DataType::Float,\n                },\n            ],\n            ttl_seconds: Some(1),\n        };\n\n        engine.create_table(\"sensors_ttl\", schema).await.unwrap();\n\n        // Insert three rows, two of which share the same sensor_id\n        let mut row1 = Row::new();\n        row1.insert(\"sensor_id\".to_string(), Value::Integer(1));\n        row1.insert(\"temperature\".to_string(), Value::Float(25.5));\n\n        let mut row2 = Row::new();\n        row2.insert(\"sensor_id\".to_string(), Value::Integer(2));\n        row2.insert(\"temperature\".to_string(), Value::Float(30.0));\n\n        let mut row3 = Row::new();\n        row3.insert(\"sensor_id\".to_string(), Value::Integer(1));\n        row3.insert(\"temperature\".to_string(), Value::Float(26.0));\n\n        engine\n            .insert(\"sensors_ttl\", vec![row1, row2, row3])\n            .await\n            .unwrap();\n\n        // Create an index on sensor_id so that TTL cleanup must also\n        // maintain secondary index entries and the LRU cache.\n        engine\n            .create_index(\"sensors_ttl\", \"sensor_id\")\n            .await\n            .unwrap();\n\n        // Sanity check: rows are visible before TTL cleanup.\n        let all_before = engine.query(\"sensors_ttl\", None).await.unwrap();\n        assert_eq!(all_before.len(), 3);\n\n        let filter_before = Filter {\n            column: \"sensor_id\".to_string(),\n            op: FilterOp::Eq,\n            value: Value::Integer(1),\n        };\n        let indexed_before = engine\n            .query(\"sensors_ttl\", Some(filter_before))\n            .await\n            .unwrap();\n        assert_eq!(indexed_before.len(), 2);\n\n        // Advance now_secs far beyond the TTL so that all rows are expired.\n        let now_secs = SystemTime::now()\n            .duration_since(UNIX_EPOCH)\n            .unwrap()\n            .as_secs();\n        let cleaned = engine.cleanup_expired(now_secs + 3600, 1000).await.unwrap();\n        assert_eq!(cleaned, 3);\n\n        // After cleanup, no rows should be visible via full scan...\n        let all_after = engine.query(\"sensors_ttl\", None).await.unwrap();\n        assert_eq!(all_after.len(), 0);\n\n        // ...or via the indexed query path.\n        let filter_after = Filter {\n            column: \"sensor_id\".to_string(),\n            op: FilterOp::Eq,\n            value: Value::Integer(1),\n        };\n        let indexed_after = engine\n            .query(\"sensors_ttl\", Some(filter_after))\n            .await\n            .unwrap();\n        assert_eq!(indexed_after.len(), 0);\n    }\n}\n","traces":[{"line":32,"address":[18594833,18592096,18594639],"length":1,"stats":{"Line":5}},{"line":33,"address":[14715474],"length":1,"stats":{"Line":5}},{"line":34,"address":[19850671,19848035,19848106],"length":1,"stats":{"Line":10}},{"line":36,"address":[16266449],"length":1,"stats":{"Line":5}},{"line":37,"address":[14715463],"length":1,"stats":{"Line":5}},{"line":38,"address":[18592464,18592547],"length":1,"stats":{"Line":11}},{"line":39,"address":[16024752,16024663],"length":1,"stats":{"Line":4}},{"line":40,"address":[16120915,16120986],"length":1,"stats":{"Line":4}},{"line":41,"address":[16266982],"length":1,"stats":{"Line":2}},{"line":42,"address":[19850622,19848789],"length":1,"stats":{"Line":0}},{"line":45,"address":[14706823,14706760],"length":1,"stats":{"Line":12}},{"line":48,"address":[12113986,12115996,12114316],"length":1,"stats":{"Line":11}},{"line":50,"address":[14716680,14716593,14716716],"length":1,"stats":{"Line":15}},{"line":52,"address":[14707550,14707846],"length":1,"stats":{"Line":11}},{"line":53,"address":[16236963,16237030],"length":1,"stats":{"Line":12}},{"line":54,"address":[16122166],"length":1,"stats":{"Line":6}},{"line":56,"address":[12115553],"length":1,"stats":{"Line":6}},{"line":57,"address":[16268091],"length":1,"stats":{"Line":6}},{"line":59,"address":[16122275],"length":1,"stats":{"Line":6}},{"line":60,"address":[16268249],"length":1,"stats":{"Line":6}},{"line":64,"address":[16119072],"length":1,"stats":{"Line":5}},{"line":66,"address":[14705102],"length":1,"stats":{"Line":5}},{"line":67,"address":[16125500,16125488],"length":1,"stats":{"Line":5}},{"line":70,"address":[14705344],"length":1,"stats":{"Line":5}},{"line":72,"address":[14714492],"length":1,"stats":{"Line":5}},{"line":73,"address":[12624737,12624720],"length":1,"stats":{"Line":5}},{"line":76,"address":[19850752],"length":1,"stats":{"Line":6}},{"line":79,"address":[16151488,16151500],"length":1,"stats":{"Line":6}},{"line":82,"address":[19846432],"length":1,"stats":{"Line":2}},{"line":84,"address":[12111981],"length":1,"stats":{"Line":2}},{"line":85,"address":[16233960],"length":1,"stats":{"Line":2}},{"line":88,"address":[16119760],"length":1,"stats":{"Line":4}},{"line":90,"address":[19847420],"length":1,"stats":{"Line":4}},{"line":91,"address":[16143136,16143148],"length":1,"stats":{"Line":4}},{"line":95,"address":[16026912],"length":1,"stats":{"Line":3}},{"line":97,"address":[16268924],"length":1,"stats":{"Line":3}},{"line":98,"address":[16123086],"length":1,"stats":{"Line":3}},{"line":101,"address":[16234192],"length":1,"stats":{"Line":1}},{"line":103,"address":[14705292],"length":1,"stats":{"Line":1}},{"line":104,"address":[16142464,16142476],"length":1,"stats":{"Line":1}},{"line":106,"address":[16266096],"length":1,"stats":{"Line":1}},{"line":108,"address":[16266108],"length":1,"stats":{"Line":1}},{"line":109,"address":[18606000,18606012],"length":1,"stats":{"Line":1}},{"line":111,"address":[14705408],"length":1,"stats":{"Line":1}},{"line":113,"address":[14705453],"length":1,"stats":{"Line":1}},{"line":114,"address":[14714808],"length":1,"stats":{"Line":1}},{"line":116,"address":[12112832],"length":1,"stats":{"Line":5}},{"line":117,"address":[16234612],"length":1,"stats":{"Line":5}},{"line":118,"address":[14705723],"length":1,"stats":{"Line":7}},{"line":122,"address":[16023696],"length":1,"stats":{"Line":4}},{"line":123,"address":[16119979],"length":1,"stats":{"Line":4}},{"line":125,"address":[18591657],"length":1,"stats":{"Line":5}},{"line":126,"address":[16023745],"length":1,"stats":{"Line":4}},{"line":127,"address":[18591720],"length":1,"stats":{"Line":4}},{"line":128,"address":[16119951],"length":1,"stats":{"Line":4}},{"line":129,"address":[16119966],"length":1,"stats":{"Line":4}},{"line":134,"address":[14718684,14718678,14718304],"length":1,"stats":{"Line":4}},{"line":137,"address":[18595107,18595019],"length":1,"stats":{"Line":5}},{"line":138,"address":[19850924],"length":1,"stats":{"Line":4}},{"line":139,"address":[16238280],"length":1,"stats":{"Line":4}},{"line":140,"address":[16123375],"length":1,"stats":{"Line":4}},{"line":141,"address":[18595254],"length":1,"stats":{"Line":4}},{"line":144,"address":[16027456],"length":1,"stats":{"Line":4}},{"line":145,"address":[16027506],"length":1,"stats":{"Line":4}},{"line":148,"address":[16123761],"length":1,"stats":{"Line":4}},{"line":149,"address":[16249758,16249744],"length":1,"stats":{"Line":4}},{"line":151,"address":[12116749],"length":1,"stats":{"Line":0}},{"line":157,"address":[16196936,16196856,16197412,16196688,16196788,16197048,16196721],"length":1,"stats":{"Line":24}},{"line":158,"address":[12941046],"length":1,"stats":{"Line":17}},{"line":159,"address":[16326421],"length":1,"stats":{"Line":5}},{"line":162,"address":[16270195],"length":1,"stats":{"Line":21}},{"line":163,"address":[12651584,12649483,12649385],"length":1,"stats":{"Line":10}},{"line":165,"address":[16168229,16170201,16168320],"length":1,"stats":{"Line":12}},{"line":166,"address":[12649916,12651445],"length":1,"stats":{"Line":0}},{"line":169,"address":[18623501,18623585,18625060],"length":1,"stats":{"Line":11}},{"line":170,"address":[12651370,12650200,12650276],"length":1,"stats":{"Line":10}},{"line":172,"address":[16298285,16299055],"length":1,"stats":{"Line":6}},{"line":174,"address":[16152775],"length":1,"stats":{"Line":4}},{"line":180,"address":[16267562],"length":1,"stats":{"Line":5}},{"line":183,"address":[14720303],"length":1,"stats":{"Line":20}},{"line":184,"address":[16320657,16320786,16321425],"length":1,"stats":{"Line":10}},{"line":185,"address":[16206474,16206020,16206115],"length":1,"stats":{"Line":10}},{"line":187,"address":[16352287,16352771,16354306,16354348,16352618,16352700,16353010,16352907,16352133],"length":1,"stats":{"Line":25}},{"line":188,"address":[19933913],"length":1,"stats":{"Line":5}},{"line":189,"address":[14454386],"length":1,"stats":{"Line":15}},{"line":190,"address":[14463730,14463758],"length":1,"stats":{"Line":5}},{"line":192,"address":[16322213],"length":1,"stats":{"Line":5}},{"line":193,"address":[16353317,16353205,16353285,16353588],"length":1,"stats":{"Line":17}},{"line":194,"address":[12703655,12703745,12704548],"length":1,"stats":{"Line":6}},{"line":196,"address":[16322339],"length":1,"stats":{"Line":4}},{"line":199,"address":[18679602,18679298],"length":1,"stats":{"Line":10}},{"line":201,"address":[16322709],"length":1,"stats":{"Line":5}},{"line":202,"address":[19935501],"length":1,"stats":{"Line":5}},{"line":203,"address":[16353961,16353768,16353943],"length":1,"stats":{"Line":3}},{"line":206,"address":[16244032,16224836,16244061],"length":1,"stats":{"Line":3}},{"line":207,"address":[12721612],"length":1,"stats":{"Line":1}},{"line":208,"address":[16227316],"length":1,"stats":{"Line":1}},{"line":212,"address":[16353742,16353802],"length":1,"stats":{"Line":8}},{"line":214,"address":[16322852],"length":1,"stats":{"Line":5}},{"line":215,"address":[16354221,16354153,16358611,16354032],"length":1,"stats":{"Line":20}},{"line":216,"address":[16358898,16358691],"length":1,"stats":{"Line":10}},{"line":217,"address":[12709140,12710537],"length":1,"stats":{"Line":10}},{"line":218,"address":[16329612,16329718],"length":1,"stats":{"Line":0}},{"line":219,"address":[16231411],"length":1,"stats":{"Line":0}},{"line":220,"address":[18686437],"length":1,"stats":{"Line":0}},{"line":222,"address":[16231580],"length":1,"stats":{"Line":0}},{"line":226,"address":[16219632],"length":1,"stats":{"Line":5}},{"line":227,"address":[16118405,16117082],"length":1,"stats":{"Line":4}},{"line":228,"address":[16118356,16117338,16117447],"length":1,"stats":{"Line":8}},{"line":230,"address":[16328812,16328720],"length":1,"stats":{"Line":8}},{"line":232,"address":[16359780],"length":1,"stats":{"Line":4}},{"line":233,"address":[16359854,16359941],"length":1,"stats":{"Line":8}},{"line":234,"address":[16220544],"length":1,"stats":{"Line":4}},{"line":237,"address":[16118161],"length":1,"stats":{"Line":4}},{"line":243,"address":[14373772],"length":1,"stats":{"Line":8}},{"line":244,"address":[18680692,18680616,18689363],"length":1,"stats":{"Line":10}},{"line":247,"address":[18680979],"length":1,"stats":{"Line":4}},{"line":248,"address":[18681137,18689323,18681200],"length":1,"stats":{"Line":8}},{"line":249,"address":[16324884,16324772,16332384,16324535,16324694],"length":1,"stats":{"Line":12}},{"line":250,"address":[18681446,18681614,18681526],"length":1,"stats":{"Line":12}},{"line":251,"address":[16324745,16340688,16324836,16325017,16340706],"length":1,"stats":{"Line":9}},{"line":253,"address":[16332363,16325044],"length":1,"stats":{"Line":5}},{"line":255,"address":[16217157,16216970],"length":1,"stats":{"Line":7}},{"line":256,"address":[16325897,16325812,16325669],"length":1,"stats":{"Line":9}},{"line":257,"address":[19938461],"length":1,"stats":{"Line":3}},{"line":260,"address":[16227770],"length":1,"stats":{"Line":3}},{"line":261,"address":[16210993],"length":1,"stats":{"Line":3}},{"line":262,"address":[16211536,16211718,16211424],"length":1,"stats":{"Line":2}},{"line":263,"address":[12707349,12707454],"length":1,"stats":{"Line":6}},{"line":264,"address":[16372128,16357541,16357360,16372146,16357269],"length":1,"stats":{"Line":4}},{"line":268,"address":[18682487,18689238,18683599],"length":1,"stats":{"Line":8}},{"line":269,"address":[19939683,19939589],"length":1,"stats":{"Line":9}},{"line":270,"address":[18687002,18683965],"length":1,"stats":{"Line":10}},{"line":271,"address":[16221922,16222034,16223843],"length":1,"stats":{"Line":4}},{"line":272,"address":[16119292,16119209],"length":1,"stats":{"Line":8}},{"line":273,"address":[12711395,12711462,12721447,12721424],"length":1,"stats":{"Line":4}},{"line":274,"address":[16119514],"length":1,"stats":{"Line":4}},{"line":278,"address":[12711604,12711709],"length":1,"stats":{"Line":0}},{"line":279,"address":[16232711,16234171,16232832],"length":1,"stats":{"Line":0}},{"line":280,"address":[16362077,16362140,16363190],"length":1,"stats":{"Line":0}},{"line":281,"address":[16120935,16121136,16120823],"length":1,"stats":{"Line":0}},{"line":282,"address":[16216835,16216728],"length":1,"stats":{"Line":0}},{"line":283,"address":[16223372,16223644,16232864,16232882,16223463],"length":1,"stats":{"Line":0}},{"line":288,"address":[16229023],"length":1,"stats":{"Line":4}},{"line":289,"address":[16358118],"length":1,"stats":{"Line":1}},{"line":290,"address":[19940070,19942515],"length":1,"stats":{"Line":2}},{"line":291,"address":[19942689],"length":1,"stats":{"Line":1}},{"line":297,"address":[16121913,16122025,16116762,16122211,16121820,16116820],"length":1,"stats":{"Line":16}},{"line":299,"address":[12943610],"length":1,"stats":{"Line":16}},{"line":300,"address":[16233810,16224553,16224462,16233792],"length":1,"stats":{"Line":4}},{"line":301,"address":[19945862,19945920,19946265,19946377,19946688,19946172],"length":1,"stats":{"Line":16}},{"line":302,"address":[19945885,19945953,19933246,19946008,19946220],"length":1,"stats":{"Line":17}},{"line":303,"address":[18690398,18697904,18690489,18697922],"length":1,"stats":{"Line":4}},{"line":305,"address":[16218790],"length":1,"stats":{"Line":4}},{"line":306,"address":[16235789,16236134,16236041,16236246,16236861],"length":1,"stats":{"Line":6}},{"line":308,"address":[16225509,16225386,16225454,16212067,16225721],"length":1,"stats":{"Line":7}},{"line":309,"address":[18691190,18698384,18698402,18691099],"length":1,"stats":{"Line":2}},{"line":312,"address":[12714685,12715356],"length":1,"stats":{"Line":5}},{"line":313,"address":[19947664,19947262],"length":1,"stats":{"Line":1}},{"line":314,"address":[12715582,12715716,12715749,12716642],"length":1,"stats":{"Line":4}},{"line":315,"address":[16227464,16227700],"length":1,"stats":{"Line":2}},{"line":318,"address":[16125138,16125259],"length":1,"stats":{"Line":2}},{"line":319,"address":[16125293,16127770],"length":1,"stats":{"Line":1}},{"line":321,"address":[16238531],"length":1,"stats":{"Line":1}},{"line":322,"address":[18693737,18693843,18695680],"length":1,"stats":{"Line":2}},{"line":323,"address":[16239095,16239199],"length":1,"stats":{"Line":2}},{"line":324,"address":[19950093],"length":1,"stats":{"Line":1}},{"line":325,"address":[16126420,16126337],"length":1,"stats":{"Line":2}},{"line":326,"address":[16229027],"length":1,"stats":{"Line":1}},{"line":328,"address":[16368174],"length":1,"stats":{"Line":1}},{"line":330,"address":[16239568,16239631],"length":1,"stats":{"Line":2}},{"line":331,"address":[16337917,16338029,16338766,16337839,16337735],"length":1,"stats":{"Line":3}},{"line":332,"address":[18694642,18694759],"length":1,"stats":{"Line":2}},{"line":333,"address":[18694786,18695055,18694877,18697744,18697762],"length":1,"stats":{"Line":2}},{"line":334,"address":[16369687,16369146,16369434,16369322],"length":1,"stats":{"Line":2}},{"line":335,"address":[16233202,16230140,16229962,16233184,16229871],"length":1,"stats":{"Line":2}},{"line":336,"address":[18692344,18692088,18695770,18695527,18695588,18692232],"length":1,"stats":{"Line":4}},{"line":338,"address":[16320552,16334994,16338717,16338657,16335028,16335240],"length":1,"stats":{"Line":5}},{"line":339,"address":[16341826,16341808,16335400,16335309],"length":1,"stats":{"Line":1}},{"line":341,"address":[16370405,16371110,16367004,16366943,16370200,16370293],"length":1,"stats":{"Line":4}},{"line":342,"address":[14463678],"length":1,"stats":{"Line":4}},{"line":343,"address":[16339397,16341986,16341968,16339306],"length":1,"stats":{"Line":1}},{"line":346,"address":[16365384,16370535,16370491],"length":1,"stats":{"Line":15}},{"line":348,"address":[16231081],"length":1,"stats":{"Line":5}},{"line":351,"address":[16299573,16297063,16304487,16307349,16297233,16296816,16296886],"length":1,"stats":{"Line":16}},{"line":352,"address":[19912281,19910032,19910161],"length":1,"stats":{"Line":8}},{"line":353,"address":[16189110],"length":1,"stats":{"Line":4}},{"line":357,"address":[18654554],"length":1,"stats":{"Line":4}},{"line":358,"address":[16297729],"length":1,"stats":{"Line":1}},{"line":359,"address":[16330477,16328785,16328876],"length":1,"stats":{"Line":2}},{"line":360,"address":[16183161,16183259],"length":1,"stats":{"Line":2}},{"line":361,"address":[16200505,16201390,16200393,16200225],"length":1,"stats":{"Line":2}},{"line":362,"address":[16298338,16298443],"length":1,"stats":{"Line":2}},{"line":363,"address":[16307888,16298462,16298553,16307906],"length":1,"stats":{"Line":1}},{"line":365,"address":[16329617],"length":1,"stats":{"Line":1}},{"line":366,"address":[16298706,16298948],"length":1,"stats":{"Line":2}},{"line":367,"address":[18655858,18656351,18655932],"length":1,"stats":{"Line":2}},{"line":369,"address":[18657912,18656233,18656121,18656320],"length":1,"stats":{"Line":4}},{"line":370,"address":[18661699],"length":1,"stats":{"Line":1}},{"line":373,"address":[16206797],"length":1,"stats":{"Line":1}},{"line":377,"address":[14560620],"length":1,"stats":{"Line":3}},{"line":378,"address":[18662365,18662526,18662446],"length":1,"stats":{"Line":3}},{"line":381,"address":[16190860,16190763],"length":1,"stats":{"Line":1}},{"line":382,"address":[16094698],"length":1,"stats":{"Line":0}},{"line":385,"address":[16336808,16336920,16338042,16336745],"length":1,"stats":{"Line":2}},{"line":386,"address":[16305795],"length":1,"stats":{"Line":1}},{"line":387,"address":[16199104,16199122,16197448,16197357],"length":1,"stats":{"Line":1}},{"line":389,"address":[16337026],"length":1,"stats":{"Line":1}},{"line":392,"address":[16208950,16208196,16208073],"length":1,"stats":{"Line":2}},{"line":394,"address":[16208432],"length":1,"stats":{"Line":1}},{"line":395,"address":[16095579],"length":1,"stats":{"Line":1}},{"line":400,"address":[19909850,19919638,19912414,19912380],"length":1,"stats":{"Line":2}},{"line":401,"address":[16185202,16192501,16185044,16185120],"length":1,"stats":{"Line":2}},{"line":404,"address":[16331220],"length":1,"stats":{"Line":1}},{"line":408,"address":[16089408],"length":1,"stats":{"Line":1}},{"line":409,"address":[16202405,16202579],"length":1,"stats":{"Line":2}},{"line":414,"address":[16089498],"length":1,"stats":{"Line":1}},{"line":417,"address":[19914011,19913917,19914147],"length":1,"stats":{"Line":0}},{"line":424,"address":[16332655,16332207],"length":1,"stats":{"Line":2}},{"line":425,"address":[16193245],"length":1,"stats":{"Line":1}},{"line":434,"address":[12679944,12684047,12684151],"length":1,"stats":{"Line":12}},{"line":435,"address":[12689824,12689847,12685067,12686543,12684274],"length":1,"stats":{"Line":8}},{"line":436,"address":[12686500,12685457,12685366],"length":1,"stats":{"Line":8}},{"line":437,"address":[18660854],"length":1,"stats":{"Line":7}},{"line":440,"address":[16304000],"length":1,"stats":{"Line":4}},{"line":441,"address":[16304221,16304053],"length":1,"stats":{"Line":2}},{"line":446,"address":[16205991],"length":1,"stats":{"Line":4}},{"line":449,"address":[16333494],"length":1,"stats":{"Line":2}},{"line":455,"address":[16091308],"length":1,"stats":{"Line":4}},{"line":458,"address":[16097369,16097168,16098138,16108303,16097512,16102413,16097222],"length":1,"stats":{"Line":4}},{"line":459,"address":[16211040,16210648,16210519],"length":1,"stats":{"Line":2}},{"line":460,"address":[16200437],"length":1,"stats":{"Line":1}},{"line":463,"address":[16200448,16201210,16201313,16207940,16200605,16200913,16200995,16207879,16201066],"length":1,"stats":{"Line":5}},{"line":464,"address":[16308916],"length":1,"stats":{"Line":1}},{"line":465,"address":[14462687],"length":1,"stats":{"Line":3}},{"line":466,"address":[19932679,19922465,19922375,19932656],"length":1,"stats":{"Line":1}},{"line":467,"address":[16195042,16195136,16201373],"length":1,"stats":{"Line":2}},{"line":468,"address":[16195293],"length":1,"stats":{"Line":1}},{"line":469,"address":[19923116,19923018],"length":1,"stats":{"Line":2}},{"line":470,"address":[16217497,16212406],"length":1,"stats":{"Line":2}},{"line":471,"address":[19928941,19928743,19928472,19928631],"length":1,"stats":{"Line":2}},{"line":472,"address":[12697394,12697295],"length":1,"stats":{"Line":2}},{"line":473,"address":[16346828,16346919,16350418,16350400],"length":1,"stats":{"Line":1}},{"line":474,"address":[18672967],"length":1,"stats":{"Line":1}},{"line":475,"address":[18673009],"length":1,"stats":{"Line":1}},{"line":479,"address":[16099512],"length":1,"stats":{"Line":1}},{"line":480,"address":[16212524],"length":1,"stats":{"Line":1}},{"line":481,"address":[16099658,16104255,16099856,16099732],"length":1,"stats":{"Line":4}},{"line":482,"address":[16198663,16196091,16200655,16205122,16205104],"length":1,"stats":{"Line":2}},{"line":483,"address":[16315462,16313914,16314005],"length":1,"stats":{"Line":2}},{"line":484,"address":[19928128,19927080,19926969],"length":1,"stats":{"Line":1}},{"line":487,"address":[16206189,16206267],"length":1,"stats":{"Line":2}},{"line":488,"address":[18671660],"length":1,"stats":{"Line":1}},{"line":489,"address":[19927579],"length":1,"stats":{"Line":1}},{"line":490,"address":[16199981],"length":1,"stats":{"Line":1}},{"line":496,"address":[16212964],"length":1,"stats":{"Line":1}},{"line":497,"address":[19924360,19923980],"length":1,"stats":{"Line":2}},{"line":498,"address":[19924521],"length":1,"stats":{"Line":1}},{"line":499,"address":[16203485,16203554],"length":1,"stats":{"Line":2}},{"line":500,"address":[16198616,16197216],"length":1,"stats":{"Line":1}},{"line":501,"address":[16197575,16197512,16198563],"length":1,"stats":{"Line":2}},{"line":502,"address":[16102142,16102030,16102359],"length":1,"stats":{"Line":1}},{"line":503,"address":[18669829,18669912],"length":1,"stats":{"Line":2}},{"line":504,"address":[16215227,16221522,16221504,16215038,16214947],"length":1,"stats":{"Line":2}},{"line":510,"address":[16311278],"length":1,"stats":{"Line":1}},{"line":511,"address":[19924060],"length":1,"stats":{"Line":1}},{"line":512,"address":[14445894],"length":1,"stats":{"Line":2}},{"line":513,"address":[12698255,12698169],"length":1,"stats":{"Line":2}},{"line":514,"address":[16201965,16202824],"length":1,"stats":{"Line":2}},{"line":515,"address":[16348850,16348923],"length":1,"stats":{"Line":2}},{"line":519,"address":[19929697,19930394,19929832,19924094],"length":1,"stats":{"Line":4}},{"line":520,"address":[16202451,16202267,16202781],"length":1,"stats":{"Line":2}},{"line":521,"address":[16348623,16348574],"length":1,"stats":{"Line":1}},{"line":524,"address":[16220104,16219147,16220309,16220197,16221104,16219208],"length":1,"stats":{"Line":4}},{"line":525,"address":[12698774,12698822,12699496,12699701,12690241],"length":1,"stats":{"Line":4}},{"line":526,"address":[16204848,16203354,16203445,16204866],"length":1,"stats":{"Line":1}},{"line":528,"address":[16220477,16220364],"length":1,"stats":{"Line":2}},{"line":530,"address":[18675416],"length":1,"stats":{"Line":1}},{"line":533,"address":[12117279],"length":1,"stats":{"Line":8}},{"line":534,"address":[19872372,19876205,19872200],"length":1,"stats":{"Line":4}},{"line":535,"address":[16048742,16048849,16052387],"length":1,"stats":{"Line":4}},{"line":538,"address":[12643710,12643519,12643606,12646553],"length":1,"stats":{"Line":5}},{"line":539,"address":[16162412,16167408,16167426,16165287,16162241],"length":1,"stats":{"Line":2}},{"line":540,"address":[19873575,19873666,19875993],"length":1,"stats":{"Line":2}},{"line":541,"address":[16163410],"length":1,"stats":{"Line":1}},{"line":544,"address":[16153177,16153090],"length":1,"stats":{"Line":2}},{"line":545,"address":[18618924,18618837],"length":1,"stats":{"Line":2}},{"line":547,"address":[16050697,16050656,16051789],"length":1,"stats":{"Line":2}},{"line":548,"address":[16292961,16292878],"length":1,"stats":{"Line":3}},{"line":550,"address":[16153951,16153840,16154305],"length":1,"stats":{"Line":4}},{"line":554,"address":[16052727,16052637,16049354,16049412,16052839,16054281],"length":1,"stats":{"Line":7}},{"line":556,"address":[14450279],"length":1,"stats":{"Line":8}},{"line":557,"address":[16165735,16165644,16167586,16167568],"length":1,"stats":{"Line":2}},{"line":560,"address":[16052897,16054263],"length":1,"stats":{"Line":2}},{"line":561,"address":[12647579,12647479],"length":1,"stats":{"Line":4}},{"line":562,"address":[16053437,16053549,16054209],"length":1,"stats":{"Line":2}},{"line":563,"address":[16053306,16053377],"length":1,"stats":{"Line":4}},{"line":564,"address":[16149538,16149629,16150450,16150432,16149807],"length":1,"stats":{"Line":4}},{"line":566,"address":[16166642,16166728],"length":1,"stats":{"Line":4}},{"line":572,"address":[16166694],"length":1,"stats":{"Line":2}},{"line":575,"address":[19851635],"length":1,"stats":{"Line":24}},{"line":576,"address":[16254981,16253600,16253716],"length":1,"stats":{"Line":12}},{"line":578,"address":[12637475,12637570],"length":1,"stats":{"Line":12}},{"line":579,"address":[12637756],"length":1,"stats":{"Line":6}},{"line":580,"address":[16285296,16285156],"length":1,"stats":{"Line":11}},{"line":582,"address":[16139731],"length":1,"stats":{"Line":6}},{"line":584,"address":[16254213],"length":1,"stats":{"Line":1}},{"line":588,"address":[18595961],"length":1,"stats":{"Line":0}},{"line":589,"address":[18615947,18614315,18614448],"length":1,"stats":{"Line":0}},{"line":590,"address":[16149218],"length":1,"stats":{"Line":0}},{"line":592,"address":[19870549,19870673,19870481],"length":1,"stats":{"Line":0}},{"line":593,"address":[16161010,16160992,16159948,16160133],"length":1,"stats":{"Line":0}},{"line":594,"address":[16143735,16143792],"length":1,"stats":{"Line":0}},{"line":595,"address":[16258859],"length":1,"stats":{"Line":0}},{"line":598,"address":[12641613],"length":1,"stats":{"Line":0}},{"line":601,"address":[12116889],"length":1,"stats":{"Line":8}},{"line":602,"address":[12633747,12634646,12634213,12634299,12633908,12634118],"length":1,"stats":{"Line":8}},{"line":604,"address":[12946564],"length":1,"stats":{"Line":8}},{"line":605,"address":[16135537,16135622,16136066,16136048],"length":1,"stats":{"Line":2}},{"line":607,"address":[19863365,19863446],"length":1,"stats":{"Line":4}},{"line":608,"address":[12634397],"length":1,"stats":{"Line":2}},{"line":611,"address":[16295553,16295769,16295911,16296639,16295520,16295688,16295620],"length":1,"stats":{"Line":8}},{"line":612,"address":[12678475,12678822,12678294,12677923,12678084,12678389],"length":1,"stats":{"Line":8}},{"line":614,"address":[14461156],"length":1,"stats":{"Line":8}},{"line":615,"address":[16181744,16181318,16181233,16181762],"length":1,"stats":{"Line":2}},{"line":617,"address":[19909061,19909142],"length":1,"stats":{"Line":4}},{"line":618,"address":[12678573],"length":1,"stats":{"Line":2}},{"line":621,"address":[16239471],"length":1,"stats":{"Line":8}},{"line":622,"address":[16066053,16069323,16065886],"length":1,"stats":{"Line":4}},{"line":623,"address":[16168786],"length":1,"stats":{"Line":2}},{"line":625,"address":[12660392,12660496,12660298],"length":1,"stats":{"Line":6}},{"line":626,"address":[19890428,19904002,19893045,19890379,19903984],"length":1,"stats":{"Line":4}},{"line":627,"address":[16309078],"length":1,"stats":{"Line":2}},{"line":628,"address":[16067136,16067231],"length":1,"stats":{"Line":4}},{"line":630,"address":[16278301],"length":1,"stats":{"Line":2}},{"line":631,"address":[12661339],"length":1,"stats":{"Line":2}},{"line":634,"address":[19891291,19891183],"length":1,"stats":{"Line":4}},{"line":635,"address":[19891402,19891338],"length":1,"stats":{"Line":4}},{"line":638,"address":[16309634,16309734],"length":1,"stats":{"Line":4}},{"line":639,"address":[19891557,19891654],"length":1,"stats":{"Line":4}},{"line":643,"address":[19891662,19891722],"length":1,"stats":{"Line":4}},{"line":644,"address":[16279036],"length":1,"stats":{"Line":2}},{"line":648,"address":[16068012],"length":1,"stats":{"Line":2}},{"line":652,"address":[16279065,16279129],"length":1,"stats":{"Line":4}},{"line":654,"address":[16164443],"length":1,"stats":{"Line":2}},{"line":659,"address":[12662502],"length":1,"stats":{"Line":2}},{"line":660,"address":[16171175],"length":1,"stats":{"Line":0}},{"line":663,"address":[16164712],"length":1,"stats":{"Line":2}},{"line":664,"address":[16164764,16164858,16165244],"length":1,"stats":{"Line":4}},{"line":665,"address":[16171463],"length":1,"stats":{"Line":2}},{"line":667,"address":[12665301,12662842,12662961,12663016],"length":1,"stats":{"Line":8}},{"line":668,"address":[16174435,16181069,16174193],"length":1,"stats":{"Line":4}},{"line":669,"address":[16072059],"length":1,"stats":{"Line":2}},{"line":671,"address":[12666123,12666031,12672068,12665959],"length":1,"stats":{"Line":4}},{"line":672,"address":[12665969],"length":1,"stats":{"Line":2}},{"line":673,"address":[16185215,16192992,16193010,16185124],"length":1,"stats":{"Line":2}},{"line":675,"address":[16283473],"length":1,"stats":{"Line":2}},{"line":677,"address":[16283610,16283785,16283673,16283990],"length":1,"stats":{"Line":0}},{"line":678,"address":[19896356],"length":1,"stats":{"Line":0}},{"line":679,"address":[16322546,16314697,16314606,16314886,16322528],"length":1,"stats":{"Line":0}},{"line":684,"address":[16315019,16320395,16314536],"length":1,"stats":{"Line":4}},{"line":685,"address":[16284303,16289377],"length":1,"stats":{"Line":2}},{"line":688,"address":[16186558],"length":1,"stats":{"Line":2}},{"line":689,"address":[12667478,12667556],"length":1,"stats":{"Line":2}},{"line":691,"address":[14567700],"length":1,"stats":{"Line":6}},{"line":692,"address":[16170520],"length":1,"stats":{"Line":2}},{"line":694,"address":[16074550,16075060,16074725,16074613],"length":1,"stats":{"Line":0}},{"line":695,"address":[16074560],"length":1,"stats":{"Line":0}},{"line":696,"address":[16080386,16080368,16074586,16074677,16074866],"length":1,"stats":{"Line":0}},{"line":701,"address":[12668252],"length":1,"stats":{"Line":2}},{"line":702,"address":[18643082,18643174],"length":1,"stats":{"Line":4}},{"line":703,"address":[12669056,12671283],"length":1,"stats":{"Line":4}},{"line":704,"address":[16180623,16180784,16180370,16180511],"length":1,"stats":{"Line":4}},{"line":705,"address":[16190757,16190833],"length":1,"stats":{"Line":4}},{"line":706,"address":[18647522,18645935,18647504,18645844],"length":1,"stats":{"Line":2}},{"line":707,"address":[16180678],"length":1,"stats":{"Line":2}},{"line":708,"address":[16180712],"length":1,"stats":{"Line":1}},{"line":711,"address":[16075538,16075413,16077621,16075461],"length":1,"stats":{"Line":2}},{"line":712,"address":[12669350],"length":1,"stats":{"Line":2}},{"line":715,"address":[16169934,16171849],"length":1,"stats":{"Line":4}},{"line":716,"address":[19899602,19899511],"length":1,"stats":{"Line":2}},{"line":717,"address":[16188896],"length":1,"stats":{"Line":1}},{"line":718,"address":[19901314,19899889],"length":1,"stats":{"Line":1}},{"line":719,"address":[16172586,16173603,16172649],"length":1,"stats":{"Line":2}},{"line":721,"address":[19900982,19901187,19900870],"length":1,"stats":{"Line":1}},{"line":722,"address":[18644905,18644976],"length":1,"stats":{"Line":2}},{"line":723,"address":[16173469,16176816,16173286,16173195,16176834],"length":1,"stats":{"Line":2}},{"line":729,"address":[14567723],"length":1,"stats":{"Line":6}},{"line":730,"address":[12663724,12663646],"length":1,"stats":{"Line":4}},{"line":731,"address":[16182971,16182892],"length":1,"stats":{"Line":4}},{"line":734,"address":[16172871,16172695,16181164,16172759],"length":1,"stats":{"Line":4}},{"line":735,"address":[12664013],"length":1,"stats":{"Line":2}},{"line":736,"address":[16172823,16173012,16182464,16182482,16172732],"length":1,"stats":{"Line":4}},{"line":737,"address":[18638462,18638574,18638399,18646487],"length":1,"stats":{"Line":4}},{"line":738,"address":[16312473],"length":1,"stats":{"Line":2}},{"line":739,"address":[16166718,16175554,16166627,16166907,16175536],"length":1,"stats":{"Line":4}},{"line":741,"address":[16312874,16312806],"length":1,"stats":{"Line":2}},{"line":744,"address":[16167813,16167901,16175102,16175009,16175214,16175423],"length":1,"stats":{"Line":8}},{"line":746,"address":[14597477],"length":1,"stats":{"Line":8}},{"line":747,"address":[12672630,12674023,12672563,12674000],"length":1,"stats":{"Line":2}},{"line":749,"address":[19902925],"length":1,"stats":{"Line":2}},{"line":756,"address":[14568871],"length":1,"stats":{"Line":0}},{"line":757,"address":[16292610],"length":1,"stats":{"Line":0}},{"line":758,"address":[16081646],"length":1,"stats":{"Line":0}},{"line":759,"address":[12675185,12675086,12675168],"length":1,"stats":{"Line":0}},{"line":766,"address":[16178228,16178505,16178401,16178310],"length":1,"stats":{"Line":0}},{"line":767,"address":[16185151,16185385,16185250,16186068],"length":1,"stats":{"Line":0}},{"line":768,"address":[19906946,19906753,19907278],"length":1,"stats":{"Line":0}},{"line":770,"address":[18650956],"length":1,"stats":{"Line":0}},{"line":773,"address":[16153827,16157512,16153552,16153591,16160750,16153729,16155390],"length":1,"stats":{"Line":4}},{"line":774,"address":[16160338],"length":1,"stats":{"Line":1}},{"line":775,"address":[12652128],"length":1,"stats":{"Line":1}},{"line":776,"address":[16268977,16269357,16270384],"length":1,"stats":{"Line":2}},{"line":777,"address":[12653104,12653012,12653532],"length":1,"stats":{"Line":1}},{"line":778,"address":[16300627,16300527],"length":1,"stats":{"Line":2}},{"line":779,"address":[16167282,16167264,16161368,16161277,16161549],"length":1,"stats":{"Line":2}},{"line":781,"address":[12947723],"length":1,"stats":{"Line":3}},{"line":782,"address":[16061896,16061941],"length":1,"stats":{"Line":1}},{"line":783,"address":[12656137,12656233,12656329,12656402],"length":1,"stats":{"Line":0}},{"line":784,"address":[19885860],"length":1,"stats":{"Line":0}},{"line":787,"address":[16062213],"length":1,"stats":{"Line":0}},{"line":788,"address":[19887263,19886022],"length":1,"stats":{"Line":0}},{"line":789,"address":[16158622,16158540],"length":1,"stats":{"Line":0}},{"line":790,"address":[16165228],"length":1,"stats":{"Line":0}},{"line":791,"address":[12657538,12657236,12657328],"length":1,"stats":{"Line":0}},{"line":792,"address":[19886717,19886788],"length":1,"stats":{"Line":0}},{"line":793,"address":[19886912,19888642,19886821,19887090,19888624],"length":1,"stats":{"Line":0}},{"line":797,"address":[16154111],"length":1,"stats":{"Line":0}},{"line":798,"address":[16171027,16173197,16172363],"length":1,"stats":{"Line":0}},{"line":799,"address":[12654426,12654042,12654134],"length":1,"stats":{"Line":0}},{"line":800,"address":[16059604],"length":1,"stats":{"Line":0}},{"line":801,"address":[16059862,16059771,16065186,16065168,16060043],"length":1,"stats":{"Line":0}},{"line":803,"address":[16160713],"length":1,"stats":{"Line":1}},{"line":804,"address":[12654775,12652487,12655446],"length":1,"stats":{"Line":2}},{"line":805,"address":[16163783,16163462,16163574],"length":1,"stats":{"Line":1}},{"line":806,"address":[16156868],"length":1,"stats":{"Line":1}},{"line":807,"address":[16271899,16271990,16276386,16276368,16272171],"length":1,"stats":{"Line":2}},{"line":811,"address":[16160567,16160362,16156300,16160455,16159880,16160710],"length":1,"stats":{"Line":4}},{"line":813,"address":[18201846],"length":1,"stats":{"Line":4}},{"line":814,"address":[16166876,16167602,16166967,16167584],"length":1,"stats":{"Line":1}},{"line":816,"address":[16160614],"length":1,"stats":{"Line":1}},{"line":819,"address":[14719037],"length":1,"stats":{"Line":4}},{"line":820,"address":[16136418,16136537,16138291],"length":1,"stats":{"Line":2}},{"line":821,"address":[19864389,19864320],"length":1,"stats":{"Line":2}},{"line":822,"address":[12635461,12635540],"length":1,"stats":{"Line":2}},{"line":823,"address":[16136966],"length":1,"stats":{"Line":1}},{"line":824,"address":[16040871],"length":1,"stats":{"Line":1}},{"line":826,"address":[16282984,16282905,16283076],"length":1,"stats":{"Line":3}},{"line":827,"address":[16252143],"length":1,"stats":{"Line":1}},{"line":828,"address":[16041367,16041159,16041479,16041300],"length":1,"stats":{"Line":1}},{"line":830,"address":[16253248,16252471,16252380,16253266],"length":1,"stats":{"Line":1}},{"line":831,"address":[16252636],"length":1,"stats":{"Line":1}},{"line":833,"address":[18609112],"length":1,"stats":{"Line":1}},{"line":834,"address":[16153942,16154847],"length":1,"stats":{"Line":0}},{"line":838,"address":[12638769,12640397,12638624,12640287,12638652,12638719,12638853],"length":1,"stats":{"Line":4}},{"line":839,"address":[18612100,18612198,18613720],"length":1,"stats":{"Line":2}},{"line":840,"address":[19868247,19868170],"length":1,"stats":{"Line":2}},{"line":841,"address":[16147251,16147175],"length":1,"stats":{"Line":2}},{"line":842,"address":[16286701],"length":1,"stats":{"Line":1}},{"line":843,"address":[16140862],"length":1,"stats":{"Line":1}},{"line":845,"address":[19868788,19868676,19869474,19868544,19868590],"length":1,"stats":{"Line":3}},{"line":846,"address":[16141001,16142112,16141092,16142130],"length":1,"stats":{"Line":1}},{"line":848,"address":[16147997,16147694,16147885,16148213],"length":1,"stats":{"Line":2}},{"line":849,"address":[16287282,16287824,16287373,16287842,16287550],"length":1,"stats":{"Line":2}},{"line":851,"address":[16148145],"length":1,"stats":{"Line":1}},{"line":856,"address":[14706208,14706216],"length":1,"stats":{"Line":24}},{"line":857,"address":[16143668,16143535,16149354],"length":1,"stats":{"Line":12}},{"line":859,"address":[19854720,19854844,19854653],"length":1,"stats":{"Line":18}},{"line":860,"address":[16242215,16247409,16248944,16242409,16248962],"length":1,"stats":{"Line":0}},{"line":861,"address":[16149254,16144636,16144735],"length":1,"stats":{"Line":0}},{"line":864,"address":[18600119],"length":1,"stats":{"Line":0}},{"line":865,"address":[12627223],"length":1,"stats":{"Line":0}},{"line":866,"address":[16129802,16128503,16128886],"length":1,"stats":{"Line":0}},{"line":867,"address":[18601557,18601185,18601073],"length":1,"stats":{"Line":0}},{"line":868,"address":[16135519],"length":1,"stats":{"Line":0}},{"line":869,"address":[19861218,19856886,19856977,19857158,19861200],"length":1,"stats":{"Line":0}},{"line":871,"address":[16134977],"length":1,"stats":{"Line":0}},{"line":872,"address":[16130173,16130904,16128673],"length":1,"stats":{"Line":0}},{"line":873,"address":[12629668,12629369,12629461],"length":1,"stats":{"Line":0}},{"line":874,"address":[16130343],"length":1,"stats":{"Line":0}},{"line":875,"address":[12629346,12632576,12632599,12629587,12629413],"length":1,"stats":{"Line":0}},{"line":877,"address":[19856347],"length":1,"stats":{"Line":0}},{"line":878,"address":[16035078,16035807,16032667],"length":1,"stats":{"Line":0}},{"line":879,"address":[12630671,12630406,12630314],"length":1,"stats":{"Line":0}},{"line":880,"address":[16277236],"length":1,"stats":{"Line":0}},{"line":881,"address":[16139840,16137931,16138200,16139858,16138022],"length":1,"stats":{"Line":0}},{"line":886,"address":[16127441,16132802,16133004,16132892,16133364,16127360],"length":1,"stats":{"Line":22}},{"line":888,"address":[19854424,19860498,19855054,19860292,19855119],"length":1,"stats":{"Line":22}},{"line":889,"address":[16132865,16132956,16133730,16133712],"length":1,"stats":{"Line":5}},{"line":891,"address":[16149960,16149870],"length":1,"stats":{"Line":10}},{"line":892,"address":[12631874],"length":1,"stats":{"Line":5}}],"covered":420,"coverable":491},{"path":["/","home","azureuser","Documents","Chronos","src","storage","snapshot.rs"],"content":"use std::fs::{self, File};\nuse std::io::{BufReader, BufWriter, Read, Write};\nuse std::path::{Path, PathBuf};\n\nuse anyhow::{anyhow, Result};\n\n/// Binary snapshot format (v1)\n/// Header:\n/// - magic: b\"CHRONOSSNAP\\0\" (12 bytes)\n/// - version: u32 (1)\n/// - created_at_secs: u64\n/// - db_count: u32\n///   For each DB (e.g. \"main\", \"agg_state\"):\n///   - name_len: u16, name bytes (utf-8)\n///   - tree_count: u32\n///     For each tree:\n///     - tree_name_len: u16, tree_name bytes\n///     - entry_count: u64\n///       For each entry:\n///       - key_len: u32, val_len: u32, key bytes, val bytes\n/// - file_count: u32\n///   For each file (e.g. raft/log.bin):\n///   - path_len: u16, path bytes (utf-8, relative)\n///   - content_len: u64\n///   - content bytes\npub const SNAPSHOT_MAGIC: \u0026[u8] = b\"CHRONOSSNAP\\0\"; // 12 bytes\npub const SNAPSHOT_VERSION: u32 = 1;\n\nfn write_u16\u003cW: Write\u003e(w: \u0026mut W, v: u16) -\u003e Result\u003c()\u003e {\n    w.write_all(\u0026v.to_be_bytes()).map_err(Into::into)\n}\nfn write_u32\u003cW: Write\u003e(w: \u0026mut W, v: u32) -\u003e Result\u003c()\u003e {\n    w.write_all(\u0026v.to_be_bytes()).map_err(Into::into)\n}\nfn write_u64\u003cW: Write\u003e(w: \u0026mut W, v: u64) -\u003e Result\u003c()\u003e {\n    w.write_all(\u0026v.to_be_bytes()).map_err(Into::into)\n}\n\nfn read_exact\u003cR: Read\u003e(r: \u0026mut R, buf: \u0026mut [u8]) -\u003e Result\u003c()\u003e {\n    r.read_exact(buf).map_err(Into::into)\n}\nfn read_u16\u003cR: Read\u003e(r: \u0026mut R) -\u003e Result\u003cu16\u003e {\n    let mut b = [0; 2];\n    read_exact(r, \u0026mut b)?;\n    Ok(u16::from_be_bytes(b))\n}\nfn read_u32\u003cR: Read\u003e(r: \u0026mut R) -\u003e Result\u003cu32\u003e {\n    let mut b = [0; 4];\n    read_exact(r, \u0026mut b)?;\n    Ok(u32::from_be_bytes(b))\n}\nfn read_u64\u003cR: Read\u003e(r: \u0026mut R) -\u003e Result\u003cu64\u003e {\n    let mut b = [0; 8];\n    read_exact(r, \u0026mut b)?;\n    Ok(u64::from_be_bytes(b))\n}\n\nfn open_main_db(data_dir: \u0026str) -\u003e Result\u003csled::Db\u003e {\n    let path = Path::new(data_dir);\n    if !path.exists() {\n        fs::create_dir_all(path)?;\n    }\n    sled::open(path).map_err(|e| anyhow!(\"Sled open error: {}\", e))\n}\n\nfn open_agg_db(data_dir: \u0026str) -\u003e Result\u003cOption\u003csled::Db\u003e\u003e {\n    let path = Path::new(data_dir).join(\"agg_state\");\n    if !path.exists() {\n        return Ok(None);\n    }\n    let db = sled::open(path).map_err(|e| anyhow!(\"Sled open error: {}\", e))?;\n    Ok(Some(db))\n}\n\npub fn create_snapshot(data_dir: \u0026str, output_path: \u0026str) -\u003e Result\u003c()\u003e {\n    // Flush best-effort: open DBs and call flush\n    let main_db = open_main_db(data_dir)?;\n    main_db.flush().map_err(|e| anyhow!(\"flush error: {}\", e))?;\n    if let Ok(Some(agg_db)) = open_agg_db(data_dir) {\n        let _ = agg_db.flush();\n    }\n\n    let file = File::create(output_path)?;\n    let mut w = BufWriter::new(file);\n\n    // Header\n    w.write_all(SNAPSHOT_MAGIC)?;\n    write_u32(\u0026mut w, SNAPSHOT_VERSION)?;\n    let created_at = std::time::SystemTime::now()\n        .duration_since(std::time::UNIX_EPOCH)\n        .unwrap_or_default()\n        .as_secs();\n    write_u64(\u0026mut w, created_at)?;\n\n    // Databases: main + optional agg_state\n    let mut dbs: Vec\u003c(\u0026str, sled::Db)\u003e = Vec::new();\n    dbs.push((\"main\", main_db));\n    if let Ok(Some(agg_db)) = open_agg_db(data_dir) {\n        dbs.push((\"agg_state\", agg_db));\n    }\n    write_u32(\u0026mut w, dbs.len() as u32)?;\n\n    for (db_name, db) in dbs.iter() {\n        let name_bytes = db_name.as_bytes();\n        write_u16(\u0026mut w, name_bytes.len() as u16)?;\n        w.write_all(name_bytes)?;\n\n        let tree_names = db.tree_names();\n        // Filter out empty names (defensive)\n        let tree_names: Vec\u003c_\u003e = tree_names.into_iter().filter(|n| !n.is_empty()).collect();\n        write_u32(\u0026mut w, tree_names.len() as u32)?;\n\n        for tn in tree_names {\n            write_u16(\u0026mut w, tn.len() as u16)?;\n            w.write_all(tn.as_ref())?;\n            let tree = db\n                .open_tree(\u0026tn)\n                .map_err(|e| anyhow!(\"open_tree error: {}\", e))?;\n\n            // Count entries (iterating once); alternatively stream with placeholder but keep simple\n            let mut entries: Vec\u003c(Vec\u003cu8\u003e, Vec\u003cu8\u003e)\u003e = Vec::new();\n            for item in tree.iter() {\n                let (k, v) = item.map_err(|e| anyhow!(\"tree iter error: {}\", e))?;\n                entries.push((k.to_vec(), v.to_vec()));\n            }\n            write_u64(\u0026mut w, entries.len() as u64)?;\n            for (k, v) in entries {\n                write_u32(\u0026mut w, k.len() as u32)?;\n                write_u32(\u0026mut w, v.len() as u32)?;\n                w.write_all(\u0026k)?;\n                w.write_all(\u0026v)?;\n            }\n        }\n    }\n\n    // Files (raft log)\n    let raft_path = Path::new(data_dir).join(\"raft\").join(\"log.bin\");\n    let mut file_count: u32 = 0;\n    if raft_path.exists() {\n        file_count += 1;\n    }\n    write_u32(\u0026mut w, file_count)?;\n    if raft_path.exists() {\n        let rel = PathBuf::from(\"raft/log.bin\");\n        let rel_str = rel.to_string_lossy();\n        let bytes = std::fs::read(\u0026raft_path)?;\n        write_u16(\u0026mut w, rel_str.len() as u16)?;\n        w.write_all(rel_str.as_bytes())?;\n        write_u64(\u0026mut w, bytes.len() as u64)?;\n        w.write_all(\u0026bytes)?;\n    }\n\n    w.flush()?;\n    Ok(())\n}\n\npub fn restore_snapshot(data_dir: \u0026str, input_path: \u0026str, force: bool) -\u003e Result\u003c()\u003e {\n    let data_path = Path::new(data_dir);\n    if data_path.exists() {\n        // Check emptiness\n        let mut is_empty = true;\n        if let Ok(mut rd) = fs::read_dir(data_path) {\n            if rd.next().is_some() {\n                is_empty = false;\n            }\n        }\n        if !is_empty {\n            if !force {\n                return Err(anyhow!(\"data_dir is not empty (use --force to overwrite)\"));\n            }\n            fs::remove_dir_all(data_path)?;\n        }\n    }\n    fs::create_dir_all(data_path)?;\n\n    let file = File::open(input_path)?;\n    let mut r = BufReader::new(file);\n\n    // Header\n    let mut magic = [0u8; 12];\n    read_exact(\u0026mut r, \u0026mut magic)?;\n    if magic != SNAPSHOT_MAGIC {\n        return Err(anyhow!(\"invalid snapshot magic\"));\n    }\n    let version = read_u32(\u0026mut r)?;\n    if version != SNAPSHOT_VERSION {\n        return Err(anyhow!(\"unsupported snapshot version: {}\", version));\n    }\n    let _created_at = read_u64(\u0026mut r)?;\n\n    // Databases\n    let db_count = read_u32(\u0026mut r)?;\n    for _ in 0..db_count {\n        let name_len = read_u16(\u0026mut r)? as usize;\n        let mut name_buf = vec![0u8; name_len];\n        read_exact(\u0026mut r, \u0026mut name_buf)?;\n        let db_name = String::from_utf8_lossy(\u0026name_buf).to_string();\n        let db = if db_name == \"main\" {\n            open_main_db(data_dir)?\n        } else if db_name == \"agg_state\" {\n            // ensure directory exists\n            fs::create_dir_all(Path::new(data_dir).join(\"agg_state\"))?;\n            sled::open(Path::new(data_dir).join(\"agg_state\"))\n                .map_err(|e| anyhow!(\"Sled open error: {}\", e))?\n        } else {\n            // Unknown DB label; create a subdir with same name\n            fs::create_dir_all(Path::new(data_dir).join(\u0026db_name))?;\n            sled::open(Path::new(data_dir).join(\u0026db_name))\n                .map_err(|e| anyhow!(\"Sled open error: {}\", e))?\n        };\n\n        let tree_count = read_u32(\u0026mut r)? as usize;\n        for _ in 0..tree_count {\n            let tn_len = read_u16(\u0026mut r)? as usize;\n            let mut tn_buf = vec![0u8; tn_len];\n            read_exact(\u0026mut r, \u0026mut tn_buf)?;\n            let tree = db\n                .open_tree(\u0026tn_buf)\n                .map_err(|e| anyhow!(\"open_tree error: {}\", e))?;\n\n            let entry_count = read_u64(\u0026mut r)? as usize;\n            for _ in 0..entry_count {\n                let k_len = read_u32(\u0026mut r)? as usize;\n                let v_len = read_u32(\u0026mut r)? as usize;\n                let mut k = vec![0u8; k_len];\n                let mut v = vec![0u8; v_len];\n                read_exact(\u0026mut r, \u0026mut k)?;\n                read_exact(\u0026mut r, \u0026mut v)?;\n                tree.insert(k, v)\n                    .map_err(|e| anyhow!(\"tree insert error: {}\", e))?;\n            }\n            tree.flush()\n                .map_err(|e| anyhow!(\"tree flush error: {}\", e))?;\n        }\n        db.flush().map_err(|e| anyhow!(\"db flush error: {}\", e))?;\n    }\n\n    // Files\n    let file_count = read_u32(\u0026mut r)? as usize;\n    for _ in 0..file_count {\n        let p_len = read_u16(\u0026mut r)? as usize;\n        let mut p_buf = vec![0u8; p_len];\n        read_exact(\u0026mut r, \u0026mut p_buf)?;\n        let rel_path = String::from_utf8_lossy(\u0026p_buf).to_string();\n        let len = read_u64(\u0026mut r)? as usize;\n        let mut content = vec![0u8; len];\n        read_exact(\u0026mut r, \u0026mut content)?;\n\n        let target = Path::new(data_dir).join(rel_path);\n        if let Some(parent) = target.parent() {\n            fs::create_dir_all(parent)?;\n        }\n        let mut f = File::create(\u0026target)?;\n        f.write_all(\u0026content)?;\n    }\n\n    // Write storage version marker for on-disk compatibility checks\n    let ver_path = Path::new(data_dir).join(\"STORAGE_VERSION\");\n    let _ = fs::write(ver_path, b\"1\\n\");\n\n    Ok(())\n}\n","traces":[{"line":29,"address":[17046144],"length":1,"stats":{"Line":1}},{"line":30,"address":[14689270],"length":1,"stats":{"Line":1}},{"line":32,"address":[14580864],"length":1,"stats":{"Line":1}},{"line":33,"address":[14719085],"length":1,"stats":{"Line":1}},{"line":35,"address":[14580960],"length":1,"stats":{"Line":1}},{"line":36,"address":[18315552],"length":1,"stats":{"Line":1}},{"line":39,"address":[14569952],"length":1,"stats":{"Line":1}},{"line":40,"address":[14577650],"length":1,"stats":{"Line":1}},{"line":42,"address":[18314768],"length":1,"stats":{"Line":1}},{"line":43,"address":[14491015],"length":1,"stats":{"Line":1}},{"line":44,"address":[14861469],"length":1,"stats":{"Line":1}},{"line":45,"address":[14580339],"length":1,"stats":{"Line":1}},{"line":47,"address":[14589536],"length":1,"stats":{"Line":1}},{"line":48,"address":[14572743],"length":1,"stats":{"Line":1}},{"line":49,"address":[14491229],"length":1,"stats":{"Line":1}},{"line":50,"address":[14688995],"length":1,"stats":{"Line":1}},{"line":52,"address":[14861808],"length":1,"stats":{"Line":1}},{"line":53,"address":[14491390],"length":1,"stats":{"Line":1}},{"line":54,"address":[18315188],"length":1,"stats":{"Line":1}},{"line":55,"address":[14718912],"length":1,"stats":{"Line":1}},{"line":58,"address":[14862864],"length":1,"stats":{"Line":1}},{"line":59,"address":[17613544],"length":1,"stats":{"Line":1}},{"line":60,"address":[14862958],"length":1,"stats":{"Line":1}},{"line":61,"address":[13844929,13845021],"length":1,"stats":{"Line":0}},{"line":63,"address":[14488703,14488688],"length":1,"stats":{"Line":1}},{"line":66,"address":[13844767,13844796,13844192],"length":1,"stats":{"Line":1}},{"line":67,"address":[13844251],"length":1,"stats":{"Line":1}},{"line":68,"address":[13844316,13844384],"length":1,"stats":{"Line":2}},{"line":69,"address":[14862474],"length":1,"stats":{"Line":1}},{"line":71,"address":[14570000,14570015],"length":1,"stats":{"Line":0}},{"line":72,"address":[14862701],"length":1,"stats":{"Line":0}},{"line":75,"address":[14864056,14872938,14863120],"length":1,"stats":{"Line":1}},{"line":77,"address":[13845167],"length":1,"stats":{"Line":1}},{"line":78,"address":[14489136,14489151],"length":1,"stats":{"Line":2}},{"line":79,"address":[17614370,17614442],"length":1,"stats":{"Line":2}},{"line":80,"address":[17614580,17614504],"length":1,"stats":{"Line":0}},{"line":83,"address":[17614759,17623843],"length":1,"stats":{"Line":1}},{"line":84,"address":[17614894],"length":1,"stats":{"Line":1}},{"line":87,"address":[13846385,13855121,13846297],"length":1,"stats":{"Line":2}},{"line":88,"address":[14872801,14864511],"length":1,"stats":{"Line":1}},{"line":89,"address":[13846779,13846643,13846825],"length":1,"stats":{"Line":3}},{"line":90,"address":[17615371],"length":1,"stats":{"Line":1}},{"line":93,"address":[17615513,17623757],"length":1,"stats":{"Line":1}},{"line":96,"address":[17615647],"length":1,"stats":{"Line":1}},{"line":97,"address":[14864972],"length":1,"stats":{"Line":1}},{"line":98,"address":[13847299,13847227],"length":1,"stats":{"Line":2}},{"line":99,"address":[14865331,14865490],"length":1,"stats":{"Line":0}},{"line":101,"address":[13847572,13855045],"length":1,"stats":{"Line":1}},{"line":103,"address":[13851508,13847751],"length":1,"stats":{"Line":2}},{"line":104,"address":[17616694,17619173],"length":1,"stats":{"Line":2}},{"line":105,"address":[14868401,14872726],"length":1,"stats":{"Line":1}},{"line":106,"address":[14872705,14868561],"length":1,"stats":{"Line":1}},{"line":108,"address":[17619525],"length":1,"stats":{"Line":1}},{"line":110,"address":[14587712,14587737],"length":1,"stats":{"Line":3}},{"line":111,"address":[13850961,13854931,13851037],"length":1,"stats":{"Line":2}},{"line":113,"address":[17620055,17619853],"length":1,"stats":{"Line":2}},{"line":114,"address":[17623554,17620138,17620237],"length":1,"stats":{"Line":2}},{"line":115,"address":[13851717,13854864],"length":1,"stats":{"Line":1}},{"line":116,"address":[17620749,17623518,17620660],"length":1,"stats":{"Line":1}},{"line":117,"address":[13851910],"length":1,"stats":{"Line":1}},{"line":118,"address":[14570448,14570463],"length":1,"stats":{"Line":1}},{"line":121,"address":[14869936],"length":1,"stats":{"Line":1}},{"line":122,"address":[14869987,14870180,14870076],"length":1,"stats":{"Line":3}},{"line":123,"address":[17621169,17622742,17623393],"length":1,"stats":{"Line":2}},{"line":124,"address":[14872064,14872135],"length":1,"stats":{"Line":2}},{"line":126,"address":[14870340,14871782],"length":1,"stats":{"Line":1}},{"line":127,"address":[13852925,13852723],"length":1,"stats":{"Line":2}},{"line":128,"address":[14870931,14870788,14871711],"length":1,"stats":{"Line":2}},{"line":129,"address":[17622639,17621989],"length":1,"stats":{"Line":1}},{"line":130,"address":[13853493,13853952],"length":1,"stats":{"Line":1}},{"line":131,"address":[17622335,17622592],"length":1,"stats":{"Line":1}},{"line":137,"address":[13848071],"length":1,"stats":{"Line":1}},{"line":138,"address":[14866262],"length":1,"stats":{"Line":1}},{"line":139,"address":[17617023,17617156],"length":1,"stats":{"Line":1}},{"line":140,"address":[13848486,13848447],"length":1,"stats":{"Line":0}},{"line":142,"address":[14866444,14866347,14868316],"length":1,"stats":{"Line":2}},{"line":143,"address":[14866555],"length":1,"stats":{"Line":1}},{"line":144,"address":[13848729],"length":1,"stats":{"Line":0}},{"line":145,"address":[14866686,14866777],"length":1,"stats":{"Line":0}},{"line":146,"address":[17617538,17619082,17617606],"length":1,"stats":{"Line":0}},{"line":147,"address":[14867017,14868239,14867112],"length":1,"stats":{"Line":0}},{"line":148,"address":[13849369,13850355],"length":1,"stats":{"Line":0}},{"line":149,"address":[14867499,14868203],"length":1,"stats":{"Line":0}},{"line":150,"address":[13849782,13850302],"length":1,"stats":{"Line":0}},{"line":153,"address":[17617371,17618936,17618719],"length":1,"stats":{"Line":2}},{"line":154,"address":[13850155],"length":1,"stats":{"Line":1}},{"line":157,"address":[14873639,14873645,14872976],"length":1,"stats":{"Line":1}},{"line":158,"address":[14873078],"length":1,"stats":{"Line":1}},{"line":159,"address":[13855458],"length":1,"stats":{"Line":1}},{"line":161,"address":[13855562],"length":1,"stats":{"Line":1}},{"line":162,"address":[14873266,14873343],"length":1,"stats":{"Line":2}},{"line":163,"address":[14873452,14873588,14873373],"length":1,"stats":{"Line":2}},{"line":164,"address":[14873580],"length":1,"stats":{"Line":0}},{"line":167,"address":[17624671],"length":1,"stats":{"Line":1}},{"line":168,"address":[17624692],"length":1,"stats":{"Line":0}},{"line":169,"address":[17624698],"length":1,"stats":{"Line":0}},{"line":171,"address":[13856102,13856177],"length":1,"stats":{"Line":0}},{"line":174,"address":[13856216,13855483],"length":1,"stats":{"Line":1}},{"line":176,"address":[17624943],"length":1,"stats":{"Line":1}},{"line":177,"address":[17625065],"length":1,"stats":{"Line":1}},{"line":180,"address":[14874153],"length":1,"stats":{"Line":1}},{"line":181,"address":[13856512,13865846,13856576],"length":1,"stats":{"Line":2}},{"line":182,"address":[13856687],"length":1,"stats":{"Line":1}},{"line":183,"address":[17625428,17634457],"length":1,"stats":{"Line":0}},{"line":185,"address":[14883149,14874470,14874418],"length":1,"stats":{"Line":2}},{"line":186,"address":[14874554],"length":1,"stats":{"Line":1}},{"line":187,"address":[13865614,13856934],"length":1,"stats":{"Line":0}},{"line":189,"address":[17625652,17634273,17625583],"length":1,"stats":{"Line":2}},{"line":192,"address":[14882965,14874783],"length":1,"stats":{"Line":1}},{"line":193,"address":[13857238],"length":1,"stats":{"Line":1}},{"line":194,"address":[17628798,17626024,17634231],"length":1,"stats":{"Line":2}},{"line":195,"address":[13860243],"length":1,"stats":{"Line":1}},{"line":196,"address":[13860374,13860271,13865541],"length":1,"stats":{"Line":2}},{"line":197,"address":[14878069],"length":1,"stats":{"Line":1}},{"line":198,"address":[14879641,14878273],"length":1,"stats":{"Line":2}},{"line":199,"address":[13861994,13865498,13860807],"length":1,"stats":{"Line":2}},{"line":200,"address":[17629496,17630619,17629426],"length":1,"stats":{"Line":0}},{"line":202,"address":[13860889,13861485,13861981],"length":1,"stats":{"Line":0}},{"line":203,"address":[14879208,14879345,14879473,14879382],"length":1,"stats":{"Line":0}},{"line":204,"address":[14717519,14717504],"length":1,"stats":{"Line":0}},{"line":207,"address":[13860846,13860935,13861459],"length":1,"stats":{"Line":0}},{"line":208,"address":[17629796,17629920,17629977,17630093],"length":1,"stats":{"Line":0}},{"line":209,"address":[14588672,14588687],"length":1,"stats":{"Line":0}},{"line":212,"address":[17630857,17634149,17630075],"length":1,"stats":{"Line":2}},{"line":213,"address":[17630970],"length":1,"stats":{"Line":1}},{"line":214,"address":[13865456,13862420,13862764],"length":1,"stats":{"Line":2}},{"line":215,"address":[14880358],"length":1,"stats":{"Line":1}},{"line":216,"address":[17634110,17631581,17631684],"length":1,"stats":{"Line":2}},{"line":217,"address":[17634092,17631904,17631993],"length":1,"stats":{"Line":1}},{"line":218,"address":[14880639],"length":1,"stats":{"Line":1}},{"line":219,"address":[14860991,14860976],"length":1,"stats":{"Line":1}},{"line":221,"address":[17632054,17634049,17632137],"length":1,"stats":{"Line":2}},{"line":222,"address":[14882540,14881052],"length":1,"stats":{"Line":2}},{"line":223,"address":[14881476,14881174,14882741],"length":1,"stats":{"Line":2}},{"line":224,"address":[17634007,17632834],"length":1,"stats":{"Line":1}},{"line":225,"address":[13864290],"length":1,"stats":{"Line":1}},{"line":226,"address":[13864400,13864331],"length":1,"stats":{"Line":2}},{"line":227,"address":[13864408,13864493,13865205],"length":1,"stats":{"Line":2}},{"line":228,"address":[17633862,17633284],"length":1,"stats":{"Line":1}},{"line":229,"address":[17633600,17633670,17633450,17633837],"length":1,"stats":{"Line":2}},{"line":230,"address":[14588224,14588239],"length":1,"stats":{"Line":2}},{"line":232,"address":[14881184,14881430,14881343,14881258],"length":1,"stats":{"Line":2}},{"line":233,"address":[18314559,18314544],"length":1,"stats":{"Line":1}},{"line":235,"address":[18314320,18314335],"length":1,"stats":{"Line":1}},{"line":239,"address":[14875023,14877693],"length":1,"stats":{"Line":1}},{"line":240,"address":[17626170],"length":1,"stats":{"Line":1}},{"line":241,"address":[14875479,14877675,14875257],"length":1,"stats":{"Line":0}},{"line":242,"address":[17626623],"length":1,"stats":{"Line":0}},{"line":243,"address":[14875600,14875703,14877639],"length":1,"stats":{"Line":0}},{"line":244,"address":[13858216],"length":1,"stats":{"Line":0}},{"line":245,"address":[13858433,13859970],"length":1,"stats":{"Line":0}},{"line":246,"address":[14876219],"length":1,"stats":{"Line":0}},{"line":247,"address":[13858642,13859940,13858745],"length":1,"stats":{"Line":0}},{"line":249,"address":[17627567],"length":1,"stats":{"Line":0}},{"line":250,"address":[17627685,17627768],"length":1,"stats":{"Line":0}},{"line":251,"address":[14876815,14876868],"length":1,"stats":{"Line":0}},{"line":253,"address":[13859421,13859900,13859237],"length":1,"stats":{"Line":0}},{"line":254,"address":[14877209,14877114,14877443],"length":1,"stats":{"Line":0}},{"line":258,"address":[13857646],"length":1,"stats":{"Line":1}},{"line":259,"address":[14875358],"length":1,"stats":{"Line":1}},{"line":261,"address":[14875423],"length":1,"stats":{"Line":1}}],"covered":123,"coverable":161},{"path":["/","home","azureuser","Documents","Chronos","src","storage","wal.rs"],"content":"use crate::common::timestamp::HybridTimestamp;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum Operation {\n    Insert {\n        table: String,\n        key: Vec\u003cu8\u003e,\n        value: Vec\u003cu8\u003e,\n    },\n    Update {\n        table: String,\n        key: Vec\u003cu8\u003e,\n        value: Vec\u003cu8\u003e,\n    },\n    Delete {\n        table: String,\n        key: Vec\u003cu8\u003e,\n    },\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct WalEntry {\n    pub sequence: u64,\n    pub timestamp: HybridTimestamp,\n    pub operation: Operation,\n    pub checksum: u32,\n}\n\nimpl WalEntry {\n    pub fn new(\n        sequence: u64,\n        timestamp: HybridTimestamp,\n        operation: Operation,\n        checksum: u32,\n    ) -\u003e Self {\n        Self {\n            sequence,\n            timestamp,\n            operation,\n            checksum,\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn wal_entry_roundtrip_bincode() {\n        let ts = HybridTimestamp {\n            ts: uhlc::HLC::default().new_timestamp(),\n            node_id: 1,\n        };\n\n        let op = Operation::Insert {\n            table: \"t\".to_string(),\n            key: b\"k\".to_vec(),\n            value: b\"v\".to_vec(),\n        };\n\n        let entry = WalEntry::new(1, ts, op, 0);\n\n        let encoded = bincode::serde::encode_to_vec(\u0026entry, bincode::config::standard()).unwrap();\n        let (decoded, _): (WalEntry, usize) =\n            bincode::serde::decode_from_slice(\u0026encoded, bincode::config::standard()).unwrap();\n\n        assert_eq!(decoded.sequence, 1);\n        assert_eq!(decoded.timestamp.node_id, 1);\n        match decoded.operation {\n            Operation::Insert { table, .. } =\u003e assert_eq!(table, \"t\"),\n            _ =\u003e panic!(\"unexpected operation\"),\n        }\n    }\n}\n","traces":[{"line":31,"address":[12360080],"length":1,"stats":{"Line":4}}],"covered":1,"coverable":1},{"path":["/","home","azureuser","Documents","Chronos","tests","chimp_integration.rs"],"content":"use chronos::parser::Value;\nuse chronos::storage::{Column, DataType, Row, SledEngine, StorageEngine, TableSchema};\nuse tempfile::TempDir;\n\n#[tokio::test]\nasync fn chimp_shadow_series_written_and_decodes() {\n    // Enable chimp via env\n    std::env::set_var(\"CHRONOS_CHIMP_ENABLE\", \"1\");\n\n    let temp = TempDir::new().unwrap();\n    let data_dir = temp.path().to_str().unwrap().to_string();\n\n    let mut engine = SledEngine::new(\u0026data_dir).expect(\"engine\");\n    engine.init().await.expect(\"init\");\n\n    let schema = TableSchema {\n        name: \"sensors\".into(),\n        columns: vec![\n            Column {\n                name: \"device_id\".into(),\n                data_type: DataType::Int,\n            },\n            Column {\n                name: \"temp\".into(),\n                data_type: DataType::Float,\n            },\n        ],\n        ttl_seconds: None,\n    };\n    engine\n        .create_table(\"sensors\", schema)\n        .await\n        .expect(\"create\");\n\n    // Insert a few rows\n    for (id, t) in [(1, 10.0_f64), (2, 10.0_f64), (3, 11.5_f64)] {\n        let mut row = Row::new();\n        row.insert(\"device_id\".into(), Value::Integer(id));\n        row.insert(\"temp\".into(), Value::Float(t));\n        engine.insert(\"sensors\", vec![row]).await.expect(\"insert\");\n    }\n\n    // Ensure all data is flushed and release sled lock before opening DB directly\n    engine.checkpoint().await.expect(\"checkpoint\");\n    engine.close().await.expect(\"close\");\n    drop(engine);\n\n    // Read the series shadow tree and decode\n    let db = sled::open(\u0026data_dir).unwrap();\n    let meta = db.open_tree(\"__series_meta__\").unwrap();\n    let series = db.open_tree(\"series:chimp:sensors:temp\").unwrap();\n\n    let next_key = b\"series:chimp:sensors:temp:next\";\n    let next_id = meta\n        .get(next_key)\n        .unwrap()\n        .map(|b| {\n            let mut arr = [0u8; 8];\n            arr.copy_from_slice(\u0026b);\n            u64::from_be_bytes(arr)\n        })\n        .unwrap_or(0);\n\n    assert!(next_id \u003e= 1, \"series next_id should be \u003e= 1\");\n\n    // Scan all segments and decode, ensure values were captured\n    use chronos::storage::compression::chimp::decode_series;\n    let mut decoded = Vec::new();\n    for item in series.iter() {\n        let (_k, v) = item.expect(\"read series seg\");\n        let seg = decode_series(\u0026v).expect(\"decode seg\");\n        decoded.extend(seg);\n    }\n\n    // We inserted 3 temps; since we batch per insert() call, there may be multiple segments,\n    // but total decoded values must be \u003e= 3 and include 10.0 and 11.5\n    assert!(decoded.len() \u003e= 3);\n    assert!(decoded.iter().any(|v| (*v - 10.0).abs() \u003c 1e-12));\n    assert!(decoded.iter().any(|v| (*v - 11.5).abs() \u003c 1e-12));\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","tests","connectivity_monitor.rs"],"content":"use std::net::SocketAddr;\nuse std::sync::Arc;\n\nuse chronos::network::proto::health_service_server::HealthServiceServer;\nuse chronos::network::{ConnectivityMonitor, ConnectivityState, HealthServer};\nuse tokio::sync::RwLock;\nuse tokio_stream::wrappers::TcpListenerStream;\nuse tonic::transport::Server;\n\n#[tokio::test]\nasync fn connectivity_check_once_returns_true_for_healthy_server() {\n    // Start a HealthServer that always reports the current ConnectivityState.\n    let state = Arc::new(RwLock::new(ConnectivityState::Connected));\n    let server = HealthServer::new(Arc::clone(\u0026state));\n\n    let listener = tokio::net::TcpListener::bind(\"127.0.0.1:0\")\n        .await\n        .expect(\"bind listener\");\n    let addr: SocketAddr = listener.local_addr().expect(\"local_addr\");\n    let incoming = TcpListenerStream::new(listener);\n\n    let serve = tokio::spawn(async move {\n        Server::builder()\n            .add_service(HealthServiceServer::new(server))\n            .serve_with_incoming(incoming)\n            .await\n            .expect(\"serve health\");\n    });\n\n    // Give the server a brief moment to start.\n    tokio::time::sleep(std::time::Duration::from_millis(50)).await;\n\n    let ok = ConnectivityMonitor::check_once(\u0026addr.to_string()).await;\n    assert!(ok, \"expected ConnectivityMonitor to report healthy server\");\n\n    // We don't strictly need to shut the server down; aborting is fine for tests.\n    serve.abort();\n}\n\n#[tokio::test]\nasync fn connectivity_check_once_returns_false_for_unreachable_target() {\n    // Port 0 is never a valid remote port; connection should fail deterministically.\n    let ok = ConnectivityMonitor::check_once(\"127.0.0.1:0\").await;\n    assert!(\n        !ok,\n        \"expected ConnectivityMonitor to report unreachable target as false\"\n    );\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","tests","raft_cluster.rs"],"content":"use std::process::{Child, Command, Stdio};\nuse std::time::{Duration, Instant};\n\nuse chronos::network::SqlClient;\nuse rand::Rng;\nuse tempfile::TempDir;\nuse tokio::time::sleep;\n\nconst BIN: \u0026str = env!(\"CARGO_BIN_EXE_chronos\");\n\nasync fn start_node(id: \u0026str, port: u16, peers: \u0026[(\u0026str, u16)], data_dir: \u0026str) -\u003e Child {\n    let mut cmd = Command::new(BIN);\n    cmd.arg(\"node\")\n        .arg(\"--id\")\n        .arg(id)\n        .arg(\"--data-dir\")\n        .arg(data_dir)\n        .arg(\"--address\")\n        .arg(format!(\"127.0.0.1:{}\", port));\n\n    if !peers.is_empty() {\n        let peers_arg = peers\n            .iter()\n            .map(|(peer_id, peer_port)| format!(\"{}=127.0.0.1:{}\", peer_id, peer_port))\n            .collect::\u003cVec\u003c_\u003e\u003e()\n            .join(\",\");\n        cmd.arg(\"--peers\").arg(peers_arg);\n    }\n\n    cmd.env(\"RUST_LOG\", \"chronos=info\")\n        .stdout(Stdio::inherit())\n        .stderr(Stdio::inherit())\n        .spawn()\n        .expect(\"failed to spawn chronos node\")\n}\n\nasync fn find_leader(addrs: \u0026[\u0026str]) -\u003e String {\n    // Retry for a while to allow elections and gRPC servers to settle.\n    for _attempt in 0..20u32 {\n        for addr in addrs {\n            let mut client = SqlClient::new(addr);\n            if client.connect().await.is_err() {\n                continue;\n            }\n\n            // Use CREATE TABLE as a probe:\n            // - followers respond with \"Not the leader\" without touching storage\n            // - the leader either creates the table (success=true) or returns a\n            //   Storage error about the table already existing.\n            match client\n                .execute_sql(\"CREATE TABLE sensors (id INT, temperature FLOAT);\")\n                .await\n            {\n                Ok(resp) =\u003e {\n                    if resp.success\n                        || resp\n                            .error\n                            .to_lowercase()\n                            .contains(\"table 'sensors' already exists\")\n                    {\n                        return addr.to_string();\n                    }\n                }\n                Err(_) =\u003e continue,\n            }\n        }\n\n        sleep(Duration::from_millis(500)).await;\n    }\n\n    panic!(\"no Raft leader found among provided addresses after retries\");\n}\n\nfn is_addr_for_port(addr: \u0026str, port: u16) -\u003e bool {\n    addr.ends_with(\u0026format!(\":{}\", port))\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn three_node_cluster_write_and_failover_persists_data() {\n    let tmp = TempDir::new().expect(\"tempdir\");\n    let data_dir = tmp.path().join(\"cluster\");\n    let data_dir_str = data_dir\n        .to_str()\n        .expect(\"data dir path should be valid UTF-8\");\n\n    // Pick a random base port in a high range to reduce the chance of\n    // collisions with other processes or previous test runs.\n    let mut rng = rand::rng();\n    let base: u16 = 20000 + (rng.random_range(0u16..1000) * 3);\n    let port1: u16 = base;\n    let port2: u16 = base + 1;\n    let port3: u16 = base + 2;\n\n    let mut node1 = start_node(\n        \"node1\",\n        port1,\n        \u0026[(\"node2\", port2), (\"node3\", port3)],\n        data_dir_str,\n    )\n    .await;\n    let mut node2 = start_node(\n        \"node2\",\n        port2,\n        \u0026[(\"node1\", port1), (\"node3\", port3)],\n        data_dir_str,\n    )\n    .await;\n    let mut node3 = start_node(\n        \"node3\",\n        port3,\n        \u0026[(\"node1\", port1), (\"node2\", port2)],\n        data_dir_str,\n    )\n    .await;\n\n    // Give the cluster time to elect a leader and start serving gRPC.\n    sleep(Duration::from_secs(3)).await;\n\n    let addrs = [\n        format!(\"127.0.0.1:{}\", port1),\n        format!(\"127.0.0.1:{}\", port2),\n        format!(\"127.0.0.1:{}\", port3),\n    ];\n    let addr_slices: Vec\u003c\u0026str\u003e = addrs.iter().map(|s| s.as_str()).collect();\n\n    let leader_addr = find_leader(\u0026addr_slices).await;\n\n    // Write some data via the current leader.\n    let mut leader_client = SqlClient::new(\u0026leader_addr);\n    leader_client\n        .connect()\n        .await\n        .expect(\"leader SqlClient connect\");\n\n    leader_client\n        .execute_sql(\"INSERT INTO sensors (id, temperature) VALUES (1, 10.0);\")\n        .await\n        .expect(\"insert 1\");\n    leader_client\n        .execute_sql(\"INSERT INTO sensors (id, temperature) VALUES (2, 20.0);\")\n        .await\n        .expect(\"insert 2\");\n\n    let pre_failover_resp = leader_client\n        .execute_sql(\"SELECT id, temperature FROM sensors;\")\n        .await\n        .expect(\"select before failover\");\n    println!(\n        \"debug: leader {} rows before failover: {}\",\n        leader_addr,\n        pre_failover_resp.rows.len()\n    );\n\n    // Kill the leader process to force a failover.\n    if is_addr_for_port(\u0026leader_addr, port1) {\n        let _ = node1.kill();\n    } else if is_addr_for_port(\u0026leader_addr, port2) {\n        let _ = node2.kill();\n    } else if is_addr_for_port(\u0026leader_addr, port3) {\n        let _ = node3.kill();\n    }\n\n    // Allow time for a new leader election.\n    sleep(Duration::from_secs(5)).await;\n\n    // Find the new leader among the remaining nodes.\n    let remaining: Vec\u003c\u0026str\u003e = addr_slices\n        .into_iter()\n        .filter(|a| *a != leader_addr)\n        .collect();\n\n    let new_leader_addr = find_leader(\u0026remaining).await;\n\n    // Verify that the new leader can read back the data written before failover.\n    let mut client_after = SqlClient::new(\u0026new_leader_addr);\n    client_after\n        .connect()\n        .await\n        .expect(\"new leader SqlClient connect\");\n\n    let resp = client_after\n        .execute_sql(\"SELECT id, temperature FROM sensors;\")\n        .await\n        .expect(\"select after failover\");\n\n    for addr in \u0026remaining {\n        let mut client = SqlClient::new(addr);\n        if let Err(e) = client.connect().await {\n            println!(\"debug: connect to {} failed: {}\", addr, e);\n            continue;\n        }\n        match client\n            .execute_sql(\"SELECT id, temperature FROM sensors;\")\n            .await\n        {\n            Ok(r) =\u003e {\n                println!(\"debug: node {} rows after failover: {}\", addr, r.rows.len());\n            }\n            Err(e) =\u003e {\n                println!(\"debug: select on {} failed: {}\", addr, e);\n            }\n        }\n    }\n\n    assert!(\n        resp.success,\n        \"SELECT failed on new leader: success=false, error= {}\",\n        resp.error\n    );\n    assert!(\n        resp.rows.len() \u003e= 2,\n        \"expected at least 2 rows after failover, got {}\",\n        resp.rows.len()\n    );\n\n    // Best-effort cleanup: kill any remaining nodes.\n    let _ = node1.kill();\n    let _ = node2.kill();\n    let _ = node3.kill();\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn three_node_cluster_failover_mttr_under_60s() {\n    let tmp = TempDir::new().expect(\"tempdir\");\n    let data_dir = tmp.path().join(\"cluster\");\n    let data_dir_str = data_dir\n        .to_str()\n        .expect(\"data dir path should be valid UTF-8\");\n\n    let mut rng = rand::rng();\n    let base: u16 = 24000 + (rng.random_range(0u16..1000) * 3);\n    let port1: u16 = base;\n    let port2: u16 = base + 1;\n    let port3: u16 = base + 2;\n\n    let mut node1 = start_node(\n        \"node1\",\n        port1,\n        \u0026[(\"node2\", port2), (\"node3\", port3)],\n        data_dir_str,\n    )\n    .await;\n    let mut node2 = start_node(\n        \"node2\",\n        port2,\n        \u0026[(\"node1\", port1), (\"node3\", port3)],\n        data_dir_str,\n    )\n    .await;\n    let mut node3 = start_node(\n        \"node3\",\n        port3,\n        \u0026[(\"node1\", port1), (\"node2\", port2)],\n        data_dir_str,\n    )\n    .await;\n\n    sleep(Duration::from_secs(3)).await;\n\n    let addrs = [\n        format!(\"127.0.0.1:{}\", port1),\n        format!(\"127.0.0.1:{}\", port2),\n        format!(\"127.0.0.1:{}\", port3),\n    ];\n    let addr_slices: Vec\u003c\u0026str\u003e = addrs.iter().map(|s| s.as_str()).collect();\n\n    let leader_addr = find_leader(\u0026addr_slices).await;\n\n    let mut leader_client = SqlClient::new(\u0026leader_addr);\n    leader_client\n        .connect()\n        .await\n        .expect(\"leader SqlClient connect\");\n    leader_client\n        .execute_sql(\"INSERT INTO sensors (id, temperature) VALUES (42, 42.0);\")\n        .await\n        .expect(\"initial insert before failover\");\n\n    let start = Instant::now();\n\n    if is_addr_for_port(\u0026leader_addr, port1) {\n        let _ = node1.kill();\n    } else if is_addr_for_port(\u0026leader_addr, port2) {\n        let _ = node2.kill();\n    } else if is_addr_for_port(\u0026leader_addr, port3) {\n        let _ = node3.kill();\n    }\n\n    let remaining: Vec\u003c\u0026str\u003e = addr_slices\n        .iter()\n        .copied()\n        .filter(|a| *a != leader_addr)\n        .collect();\n\n    let new_leader_addr = find_leader(\u0026remaining).await;\n\n    let duration = start.elapsed();\n\n    let mut client_after = SqlClient::new(\u0026new_leader_addr);\n    client_after\n        .connect()\n        .await\n        .expect(\"new leader SqlClient connect\");\n    let resp = client_after\n        .execute_sql(\"SELECT id, temperature FROM sensors;\")\n        .await\n        .expect(\"select after failover for MTTR\");\n\n    assert!(\n        resp.success,\n        \"SELECT failed on new leader after failover: success=false, error={}\",\n        resp.error\n    );\n\n    assert!(\n        duration.as_secs_f64() \u003c 60.0,\n        \"MTTR exceeded 60s: {:.3} seconds\",\n        duration.as_secs_f64()\n    );\n\n    let _ = node1.kill();\n    let _ = node2.kill();\n    let _ = node3.kill();\n}\n\n// Short soak + chaos harness: repeated writes with random follower restarts.\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\n#[ignore]\nasync fn three_node_cluster_soak_and_chaos_smoke() {\n    let tmp = TempDir::new().expect(\"tempdir\");\n    let data_dir = tmp.path().join(\"cluster\");\n    let data_dir_str = data_dir\n        .to_str()\n        .expect(\"data dir path should be valid UTF-8\");\n\n    let mut rng = rand::rng();\n    let base: u16 = 23000 + (rng.random_range(0u16..1000) * 3);\n    let port1: u16 = base;\n    let port2: u16 = base + 1;\n    let port3: u16 = base + 2;\n\n    let mut node1 = start_node(\n        \"node1\",\n        port1,\n        \u0026[(\"node2\", port2), (\"node3\", port3)],\n        data_dir_str,\n    )\n    .await;\n    let mut node2 = start_node(\n        \"node2\",\n        port2,\n        \u0026[(\"node1\", port1), (\"node3\", port3)],\n        data_dir_str,\n    )\n    .await;\n    let mut node3 = start_node(\n        \"node3\",\n        port3,\n        \u0026[(\"node1\", port1), (\"node2\", port2)],\n        data_dir_str,\n    )\n    .await;\n\n    sleep(Duration::from_secs(3)).await;\n\n    let addrs = [\n        format!(\"127.0.0.1:{}\", port1),\n        format!(\"127.0.0.1:{}\", port2),\n        format!(\"127.0.0.1:{}\", port3),\n    ];\n    let addr_slices: Vec\u003c\u0026str\u003e = addrs.iter().map(|s| s.as_str()).collect();\n\n    let test_start = Instant::now();\n\n    // Light-weight soak: 40 iterations of writes + occasional follower restart.\n    for i in 0..40u32 {\n        if test_start.elapsed() \u003e Duration::from_secs(60) {\n            break;\n        }\n        let leader_addr = find_leader(\u0026addr_slices).await;\n\n        let mut client = SqlClient::new(\u0026leader_addr);\n        if client.connect().await.is_err() {\n            // If leader is temporarily unavailable, skip this iteration.\n            sleep(Duration::from_millis(200)).await;\n            continue;\n        }\n\n        let sql = format!(\n            \"INSERT INTO sensors (id, temperature) VALUES ({}, {});\",\n            i + 1,\n            (i + 1) as f64 * 1.0\n        );\n        let _ = client.execute_sql(\u0026sql).await;\n\n        // Simple read sanity check on leader.\n        let resp = client\n            .execute_sql(\"SELECT id, temperature FROM sensors;\")\n            .await\n            .expect(\"select on leader during soak\");\n        assert!(resp.success, \"SELECT failed during soak: {}\", resp.error);\n\n        // Occasionally restart a follower while writes are ongoing.\n        if i % 10 == 3 {\n            let (follower_id, follower_port) = if !is_addr_for_port(\u0026leader_addr, port1) {\n                (\"node1\", port1)\n            } else if !is_addr_for_port(\u0026leader_addr, port2) {\n                (\"node2\", port2)\n            } else {\n                (\"node3\", port3)\n            };\n\n            if follower_id == \"node1\" {\n                let _ = node1.kill();\n                node1 = start_node(\n                    \"node1\",\n                    follower_port,\n                    \u0026[(\"node2\", port2), (\"node3\", port3)],\n                    data_dir_str,\n                )\n                .await;\n            } else if follower_id == \"node2\" {\n                let _ = node2.kill();\n                node2 = start_node(\n                    \"node2\",\n                    follower_port,\n                    \u0026[(\"node1\", port1), (\"node3\", port3)],\n                    data_dir_str,\n                )\n                .await;\n            } else {\n                let _ = node3.kill();\n                node3 = start_node(\n                    \"node3\",\n                    follower_port,\n                    \u0026[(\"node1\", port1), (\"node2\", port2)],\n                    data_dir_str,\n                )\n                .await;\n            }\n\n            // Give the cluster a bit of time to settle after restart.\n            sleep(Duration::from_secs(2)).await;\n        }\n\n        // Small delay between iterations to avoid hammering the cluster too hard.\n        sleep(Duration::from_millis(200)).await;\n    }\n\n    // After the soak loop, ensure the cluster can still answer a SELECT via a leader.\n    let final_leader = find_leader(\u0026addr_slices).await;\n    let mut client = SqlClient::new(\u0026final_leader);\n    client.connect().await.expect(\"final leader connect\");\n    let resp = client\n        .execute_sql(\"SELECT id, temperature FROM sensors;\")\n        .await\n        .expect(\"final select after soak\");\n    assert!(resp.success, \"final SELECT failed: {}\", resp.error);\n\n    let _ = node1.kill();\n    let _ = node2.kill();\n    let _ = node3.kill();\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn three_node_cluster_isolated_node_rejects_writes() {\n    let tmp = TempDir::new().expect(\"tempdir\");\n    let data_dir = tmp.path().join(\"cluster\");\n    let data_dir_str = data_dir\n        .to_str()\n        .expect(\"data dir path should be valid UTF-8\");\n\n    let mut rng = rand::rng();\n    let base: u16 = 22000 + (rng.random_range(0u16..1000) * 3);\n    let port1: u16 = base;\n    let port2: u16 = base + 1;\n    let port3: u16 = base + 2;\n\n    let mut node1 = start_node(\n        \"node1\",\n        port1,\n        \u0026[(\"node2\", port2), (\"node3\", port3)],\n        data_dir_str,\n    )\n    .await;\n    let mut node2 = start_node(\n        \"node2\",\n        port2,\n        \u0026[(\"node1\", port1), (\"node3\", port3)],\n        data_dir_str,\n    )\n    .await;\n    let mut node3 = start_node(\n        \"node3\",\n        port3,\n        \u0026[(\"node1\", port1), (\"node2\", port2)],\n        data_dir_str,\n    )\n    .await;\n\n    sleep(Duration::from_secs(3)).await;\n\n    let addrs = [\n        format!(\"127.0.0.1:{}\", port1),\n        format!(\"127.0.0.1:{}\", port2),\n        format!(\"127.0.0.1:{}\", port3),\n    ];\n    let addr_slices: Vec\u003c\u0026str\u003e = addrs.iter().map(|s| s.as_str()).collect();\n\n    let leader_addr = find_leader(\u0026addr_slices).await;\n\n    let mut others: Vec\u003c\u0026str\u003e = addr_slices\n        .iter()\n        .copied()\n        .filter(|a| *a != leader_addr)\n        .collect();\n    others.sort();\n    let isolated_addr = others[0];\n    let killed_addr = others[1];\n\n    if is_addr_for_port(\u0026leader_addr, port1) {\n        let _ = node1.kill();\n    } else if is_addr_for_port(\u0026leader_addr, port2) {\n        let _ = node2.kill();\n    } else {\n        let _ = node3.kill();\n    }\n\n    if is_addr_for_port(killed_addr, port1) {\n        let _ = node1.kill();\n    } else if is_addr_for_port(killed_addr, port2) {\n        let _ = node2.kill();\n    } else {\n        let _ = node3.kill();\n    }\n\n    sleep(Duration::from_secs(3)).await;\n\n    let mut client = SqlClient::new(isolated_addr);\n    client.connect().await.expect(\"isolated SqlClient connect\");\n\n    let resp = client\n        .execute_sql(\"INSERT INTO sensors (id, temperature) VALUES (99, 99.0);\")\n        .await\n        .expect(\"insert on isolated node\");\n\n    assert!(\n        !resp.success,\n        \"expected write on isolated node to fail, but success=true\"\n    );\n    assert!(\n        resp.error.to_lowercase().contains(\"not the leader\"),\n        \"expected Not the leader error on isolated node, got: {}\",\n        resp.error\n    );\n\n    let _ = node1.kill();\n    let _ = node2.kill();\n    let _ = node3.kill();\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn three_node_cluster_follower_restart_preserves_writes() {\n    let tmp = TempDir::new().expect(\"tempdir\");\n    let data_dir = tmp.path().join(\"cluster\");\n    let data_dir_str = data_dir\n        .to_str()\n        .expect(\"data dir path should be valid UTF-8\");\n\n    let mut rng = rand::rng();\n    let base: u16 = 21000 + (rng.random_range(0u16..1000) * 3);\n    let port1: u16 = base;\n    let port2: u16 = base + 1;\n    let port3: u16 = base + 2;\n\n    let mut node1 = start_node(\n        \"node1\",\n        port1,\n        \u0026[(\"node2\", port2), (\"node3\", port3)],\n        data_dir_str,\n    )\n    .await;\n    let mut node2 = start_node(\n        \"node2\",\n        port2,\n        \u0026[(\"node1\", port1), (\"node3\", port3)],\n        data_dir_str,\n    )\n    .await;\n    let mut node3 = start_node(\n        \"node3\",\n        port3,\n        \u0026[(\"node1\", port1), (\"node2\", port2)],\n        data_dir_str,\n    )\n    .await;\n\n    sleep(Duration::from_secs(3)).await;\n\n    let addrs = [\n        format!(\"127.0.0.1:{}\", port1),\n        format!(\"127.0.0.1:{}\", port2),\n        format!(\"127.0.0.1:{}\", port3),\n    ];\n    let addr_slices: Vec\u003c\u0026str\u003e = addrs.iter().map(|s| s.as_str()).collect();\n\n    let leader_addr = find_leader(\u0026addr_slices).await;\n\n    let mut leader_client = SqlClient::new(\u0026leader_addr);\n    leader_client\n        .connect()\n        .await\n        .expect(\"leader SqlClient connect\");\n\n    leader_client\n        .execute_sql(\"INSERT INTO sensors (id, temperature) VALUES (1, 10.0);\")\n        .await\n        .expect(\"insert 1\");\n    leader_client\n        .execute_sql(\"INSERT INTO sensors (id, temperature) VALUES (2, 20.0);\")\n        .await\n        .expect(\"insert 2\");\n\n    let (follower_id, follower_port) = if !is_addr_for_port(\u0026leader_addr, port1) {\n        (\"node1\", port1)\n    } else if !is_addr_for_port(\u0026leader_addr, port2) {\n        (\"node2\", port2)\n    } else {\n        (\"node3\", port3)\n    };\n\n    if follower_id == \"node1\" {\n        let _ = node1.kill();\n    } else if follower_id == \"node2\" {\n        let _ = node2.kill();\n    } else {\n        let _ = node3.kill();\n    }\n\n    sleep(Duration::from_secs(1)).await;\n\n    leader_client\n        .execute_sql(\"INSERT INTO sensors (id, temperature) VALUES (3, 30.0);\")\n        .await\n        .expect(\"insert 3\");\n    leader_client\n        .execute_sql(\"INSERT INTO sensors (id, temperature) VALUES (4, 40.0);\")\n        .await\n        .expect(\"insert 4\");\n    leader_client\n        .execute_sql(\"INSERT INTO sensors (id, temperature) VALUES (5, 50.0);\")\n        .await\n        .expect(\"insert 5\");\n\n    let restarted = if follower_id == \"node1\" {\n        start_node(\n            \"node1\",\n            follower_port,\n            \u0026[(\"node2\", port2), (\"node3\", port3)],\n            data_dir_str,\n        )\n        .await\n    } else if follower_id == \"node2\" {\n        start_node(\n            \"node2\",\n            follower_port,\n            \u0026[(\"node1\", port1), (\"node3\", port3)],\n            data_dir_str,\n        )\n        .await\n    } else {\n        start_node(\n            \"node3\",\n            follower_port,\n            \u0026[(\"node1\", port1), (\"node2\", port2)],\n            data_dir_str,\n        )\n        .await\n    };\n\n    if follower_id == \"node1\" {\n        node1 = restarted;\n    } else if follower_id == \"node2\" {\n        node2 = restarted;\n    } else {\n        node3 = restarted;\n    }\n\n    sleep(Duration::from_secs(5)).await;\n\n    let new_leader_addr = find_leader(\u0026addr_slices).await;\n\n    let mut client_after = SqlClient::new(\u0026new_leader_addr);\n    client_after\n        .connect()\n        .await\n        .expect(\"new leader SqlClient connect\");\n\n    let resp = client_after\n        .execute_sql(\"SELECT id, temperature FROM sensors;\")\n        .await\n        .expect(\"select after follower restart\");\n\n    assert!(\n        resp.success,\n        \"SELECT failed on leader after follower restart: success=false, error={}\",\n        resp.error\n    );\n    assert!(\n        resp.rows.len() \u003e= 5,\n        \"expected at least 5 rows after follower restart, got {}\",\n        resp.rows.len()\n    );\n\n    let _ = node1.kill();\n    let _ = node2.kill();\n    let _ = node3.kill();\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","tests","raft_log_proptest.rs"],"content":"use chronos::raft::Log;\nuse proptest::prelude::*;\nuse tempfile::TempDir;\n\n#[derive(Debug, Clone)]\nenum LogOp {\n    Append { term: u64 },\n    Truncate { index: u64 },\n}\n\nfn log_op_strategy() -\u003e impl Strategy\u003cValue = LogOp\u003e {\n    prop_oneof![\n        (0u64..10_000).prop_map(|term| LogOp::Append { term }),\n        (0u64..50).prop_map(|index| LogOp::Truncate { index }),\n    ]\n}\n\nproptest! {\n    #[test]\n    fn raft_log_preserves_prefix_and_indices(ops in proptest::collection::vec(log_op_strategy(), 1..50)) {\n        let tmp = TempDir::new().expect(\"tempdir\");\n        let data_dir = tmp.path().to_str().expect(\"utf8\");\n\n        let mut log = Log::new(data_dir);\n        let mut shadow: Vec\u003c(u64, Vec\u003cu8\u003e)\u003e = Vec::new();\n        shadow.push((0, Vec::new()));\n\n        for op in ops {\n            match op {\n                LogOp::Append { term } =\u003e {\n                    let entry = chronos::raft::LogEntry { term, command: Vec::new() };\n                    let _ = log.append(entry);\n                    shadow.push((term, Vec::new()));\n                }\n                LogOp::Truncate { index } =\u003e {\n                    let _ = log.truncate(index);\n                    if index \u003e= 1 \u0026\u0026 (index as usize) \u003c shadow.len() {\n                        shadow.truncate(index as usize + 1);\n                    }\n                }\n            }\n        }\n\n        let last = log.last_index();\n        prop_assert_eq!(last as usize + 1, shadow.len());\n\n        for (idx, (term, _cmd)) in shadow.iter().enumerate() {\n            let idx_u64 = idx as u64;\n            let t = log.term_at(idx_u64).unwrap();\n            prop_assert_eq!(*term, t, \"term mismatch at index {}\", idx_u64);\n            let entry = log.get_entry(idx_u64).unwrap().expect(\"entry must exist\");\n            prop_assert_eq!(*term, entry.term, \"entry.term mismatch at index {}\", idx_u64);\n        }\n\n        for idx in (last+1)..=(last+5) {\n            let entry = log.get_entry(idx).unwrap();\n            prop_assert!(entry.is_none());\n        }\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","tests","snapshot.rs"],"content":"use chronos::parser::Value;\nuse chronos::storage::snapshot::{create_snapshot, restore_snapshot};\nuse chronos::storage::{Column, DataType, Row, SledEngine, StorageEngine, TableSchema};\nuse tempfile::TempDir;\n\n#[tokio::test]\nasync fn snapshot_backup_restore_basic() {\n    // Prepare source data dir\n    let src = TempDir::new().expect(\"tempdir\");\n    let src_dir = src.path().to_str().unwrap().to_string();\n\n    // Create table and insert a row\n    let mut engine = SledEngine::new(\u0026src_dir).expect(\"sled engine\");\n    engine.init().await.expect(\"init\");\n\n    let schema = TableSchema {\n        name: \"sensors\".to_string(),\n        columns: vec![\n            Column {\n                name: \"device_id\".to_string(),\n                data_type: DataType::Int,\n            },\n            Column {\n                name: \"temp\".to_string(),\n                data_type: DataType::Float,\n            },\n        ],\n        ttl_seconds: None,\n    };\n\n    engine\n        .create_table(\"sensors\", schema)\n        .await\n        .expect(\"create table\");\n\n    let mut row = Row::new();\n    row.insert(\"device_id\".to_string(), Value::Integer(42));\n    row.insert(\"temp\".to_string(), Value::Float(21.5));\n\n    engine.insert(\"sensors\", vec![row]).await.expect(\"insert\");\n    // Ensure data is flushed and release locks before snapshot\n    engine.checkpoint().await.expect(\"checkpoint\");\n    engine.close().await.expect(\"close\");\n    drop(engine);\n\n    // Create snapshot file\n    let snap_dir = TempDir::new().expect(\"snapdir\");\n    let snap_path = snap_dir.path().join(\"backup.snap\");\n    create_snapshot(\u0026src_dir, snap_path.to_str().unwrap()).expect(\"create snapshot\");\n\n    // Restore into destination dir\n    let dst = TempDir::new().expect(\"dstdir\");\n    let dst_dir = dst.path().to_str().unwrap().to_string();\n    restore_snapshot(\u0026dst_dir, snap_path.to_str().unwrap(), false).expect(\"restore snapshot\");\n\n    // Open restored engine and verify data\n    let engine2 = SledEngine::new(\u0026dst_dir).expect(\"engine2\");\n    // Query without filter\n    let rows = engine2.query(\"sensors\", None).await.expect(\"query\");\n    assert_eq!(rows.len(), 1);\n    let r = \u0026rows[0];\n    assert_eq!(r.get(\"device_id\"), Some(\u0026Value::Integer(42)));\n    match r.get(\"temp\") {\n        Some(Value::Float(v)) =\u003e assert!((*v - 21.5).abs() \u003c 1e-9),\n        _ =\u003e panic!(\"bad temp\"),\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","tests","sync_lww.rs"],"content":"use std::process::{Child, Command, Stdio};\nuse std::sync::Arc;\nuse std::time::Duration;\n\nuse chronos::common::timestamp::HybridTimestamp;\nuse chronos::executor::Executor;\nuse chronos::network::proto::sync_service_server::SyncService;\nuse chronos::network::proto::{SyncOperation, SyncRequest};\nuse chronos::network::{SqlClient, SyncServer};\nuse chronos::parser::{Parser, Value as SqlValue};\nuse chronos::storage::offline_queue::PersistentQueuedOperation;\nuse chronos::storage::wal::Operation as WalOperation;\nuse chronos::storage::Row as StorageRow;\nuse lz4_flex::block::compress_prepend_size;\nuse rand::Rng;\nuse tempfile::TempDir;\nuse tokio::sync::Mutex as TokioMutex;\nuse tokio::time::sleep;\nuse tonic::Request;\nuse uhlc::HLC;\n\nconst BIN: \u0026str = env!(\"CARGO_BIN_EXE_chronos\");\n\nasync fn start_cloud_node(port: u16, data_dir: \u0026str) -\u003e Child {\n    let mut cmd = Command::new(BIN);\n    cmd.arg(\"node\")\n        .arg(\"--id\")\n        .arg(\"cloud\")\n        .arg(\"--data-dir\")\n        .arg(data_dir)\n        .arg(\"--address\")\n        .arg(format!(\"127.0.0.1:{}\", port))\n        .arg(\"--clean\");\n\n    cmd.env(\"RUST_LOG\", \"chronos=info\")\n        .stdout(Stdio::inherit())\n        .stderr(Stdio::inherit());\n\n    cmd.spawn().expect(\"failed to spawn cloud node\")\n}\n\nasync fn start_edge_node(port: u16, data_dir: \u0026str, sync_target: \u0026str) -\u003e Child {\n    let mut cmd = Command::new(BIN);\n    cmd.arg(\"node\")\n        .arg(\"--id\")\n        .arg(\"edge1\")\n        .arg(\"--data-dir\")\n        .arg(data_dir)\n        .arg(\"--address\")\n        .arg(format!(\"127.0.0.1:{}\", port))\n        .arg(\"--clean\")\n        .arg(\"--sync-target\")\n        .arg(sync_target)\n        .arg(\"--sync-interval-secs\")\n        .arg(\"1\")\n        .arg(\"--sync-batch-size\")\n        .arg(\"100\");\n\n    cmd.env(\"RUST_LOG\", \"chronos=info\")\n        .stdout(Stdio::inherit())\n        .stderr(Stdio::inherit());\n\n    cmd.spawn().expect(\"failed to spawn edge node\")\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn edge_to_cloud_sync_basic_propagates_rows() {\n    let tmp = TempDir::new().expect(\"tempdir\");\n    let data_dir = tmp.path().join(\"sync_cluster_basic\");\n    let data_dir_str = data_dir\n        .to_str()\n        .expect(\"data dir path should be valid UTF-8\");\n\n    let mut rng = rand::rng();\n    let base: u16 = 23000 + (rng.random_range(0u16..1000) * 2);\n    let cloud_port: u16 = base;\n    let edge_port: u16 = base + 1;\n\n    let mut cloud = start_cloud_node(cloud_port, data_dir_str).await;\n\n    // Give cloud node time to start and elect itself as leader (single-node Raft).\n    sleep(Duration::from_secs(3)).await;\n\n    let cloud_addr = format!(\"127.0.0.1:{}\", cloud_port);\n    let sync_target = format!(\"http://{}\", cloud_addr);\n\n    let mut edge = start_edge_node(edge_port, data_dir_str, \u0026sync_target).await;\n\n    // Allow edge node to start and its SyncWorker to begin running.\n    sleep(Duration::from_secs(3)).await;\n\n    let edge_addr = format!(\"127.0.0.1:{}\", edge_port);\n\n    // Write data on the edge node.\n    let mut edge_client = SqlClient::new(\u0026edge_addr);\n    edge_client.connect().await.expect(\"edge SqlClient connect\");\n\n    edge_client\n        .execute_sql(\"CREATE TABLE sensors (sensor_id INT, temperature FLOAT);\")\n        .await\n        .expect(\"create table on edge\");\n\n    let inserts = [(1, 10.0_f64), (2, 20.0_f64), (3, 30.0_f64)];\n\n    for (id, temp) in inserts {\n        let sql = format!(\n            \"INSERT INTO sensors (sensor_id, temperature) VALUES ({}, {});\",\n            id, temp\n        );\n        edge_client.execute_sql(\u0026sql).await.expect(\"insert on edge\");\n    }\n\n    // Wait for the SyncWorker on the edge to drain the offline queue and push\n    // operations to the cloud node.\n    sleep(Duration::from_secs(5)).await;\n\n    // Verify that the cloud node now sees the same rows.\n    let mut cloud_client = SqlClient::new(\u0026cloud_addr);\n    cloud_client\n        .connect()\n        .await\n        .expect(\"cloud SqlClient connect\");\n\n    let mut rows_seen = 0usize;\n    for _ in 0..20u32 {\n        let resp = cloud_client\n            .execute_sql(\"SELECT sensor_id, temperature FROM sensors;\")\n            .await\n            .expect(\"select on cloud\");\n\n        if resp.success \u0026\u0026 resp.rows.len() \u003e= 3 {\n            rows_seen = resp.rows.len();\n            break;\n        }\n\n        sleep(Duration::from_millis(500)).await;\n    }\n\n    assert!(\n        rows_seen \u003e= 3,\n        \"expected at least 3 rows on cloud after sync, got {}\",\n        rows_seen\n    );\n\n    let _ = edge.kill();\n    let _ = cloud.kill();\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn sync_idempotent_replay_same_batch() {\n    let tmp = TempDir::new().expect(\"tempdir\");\n    let data_dir = tmp.path().join(\"sync_idempotent\");\n    let data_dir_str = data_dir\n        .to_str()\n        .expect(\"data dir path should be valid UTF-8\");\n\n    let executor = Executor::new(data_dir_str).await;\n    let executor = Arc::new(TokioMutex::new(executor));\n    let sync_server = SyncServer::new(Arc::clone(\u0026executor));\n\n    let edge_id = \"edge1\".to_string();\n\n    let ts = HybridTimestamp {\n        ts: HLC::default().new_timestamp(),\n        node_id: 1,\n    };\n    let pq = PersistentQueuedOperation {\n        id: 1,\n        timestamp: ts,\n        operation: WalOperation::Insert {\n            table: \"sensors\".to_string(),\n            key: b\"row1\".to_vec(),\n            value: vec![],\n        },\n    };\n    let data = bincode::serde::encode_to_vec(\u0026pq, bincode::config::standard())\n        .expect(\"encode PersistentQueuedOperation\");\n    let op = SyncOperation { id: pq.id, data };\n\n    let req1 = SyncRequest {\n        edge_id: edge_id.clone(),\n        operations: vec![op.clone()],\n    };\n    let resp1 = sync_server\n        .sync(Request::new(req1))\n        .await\n        .expect(\"first sync RPC\")\n        .into_inner();\n    assert_eq!(resp1.applied, 1, \"expected first sync to apply operation\");\n\n    let req2 = SyncRequest {\n        edge_id,\n        operations: vec![op],\n    };\n    let resp2 = sync_server\n        .sync(Request::new(req2))\n        .await\n        .expect(\"second sync RPC\")\n        .into_inner();\n    assert_eq!(\n        resp2.applied, 0,\n        \"replaying same batch should be idempotent (applied=0)\"\n    );\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn sync_restart_persists_cursor_and_skips_old_ids() {\n    let tmp = TempDir::new().expect(\"tempdir\");\n    let data_dir = tmp.path().join(\"sync_restart_cursor\");\n    let data_dir_str = data_dir\n        .to_str()\n        .expect(\"data dir path should be valid UTF-8\");\n\n    let executor1 = Executor::new(data_dir_str).await;\n    let executor1 = Arc::new(TokioMutex::new(executor1));\n    let sync_server1 = SyncServer::new(Arc::clone(\u0026executor1));\n\n    let edge_id = \"edge1\".to_string();\n\n    let ts = HybridTimestamp {\n        ts: HLC::default().new_timestamp(),\n        node_id: 1,\n    };\n\n    let make_pq = |id: u64| PersistentQueuedOperation {\n        id,\n        timestamp: ts,\n        operation: WalOperation::Insert {\n            table: \"sensors\".to_string(),\n            key: format!(\"row{}\", id).into_bytes(),\n            value: vec![],\n        },\n    };\n\n    let ops1: Vec\u003cSyncOperation\u003e = [1u64, 2, 3]\n        .into_iter()\n        .map(|id| {\n            let pq = make_pq(id);\n            let data = bincode::serde::encode_to_vec(\u0026pq, bincode::config::standard())\n                .expect(\"encode PersistentQueuedOperation\");\n            SyncOperation { id: pq.id, data }\n        })\n        .collect();\n\n    let req1 = SyncRequest {\n        edge_id: edge_id.clone(),\n        operations: ops1,\n    };\n    let resp1 = sync_server1\n        .sync(Request::new(req1))\n        .await\n        .expect(\"first sync RPC\")\n        .into_inner();\n    assert_eq!(\n        resp1.applied, 3,\n        \"expected first sync to apply all initial operations\"\n    );\n\n    drop(sync_server1);\n    drop(executor1);\n\n    let executor2 = Executor::new(data_dir_str).await;\n    let executor2 = Arc::new(TokioMutex::new(executor2));\n    let sync_server2 = SyncServer::new(Arc::clone(\u0026executor2));\n\n    let ops2: Vec\u003cSyncOperation\u003e = [1u64, 2, 3, 4]\n        .into_iter()\n        .map(|id| {\n            let pq = make_pq(id);\n            let data = bincode::serde::encode_to_vec(\u0026pq, bincode::config::standard())\n                .expect(\"encode PersistentQueuedOperation\");\n            SyncOperation { id: pq.id, data }\n        })\n        .collect();\n\n    let req2 = SyncRequest {\n        edge_id,\n        operations: ops2,\n    };\n    let resp2 = sync_server2\n        .sync(Request::new(req2))\n        .await\n        .expect(\"second sync RPC\")\n        .into_inner();\n    assert_eq!(\n        resp2.applied, 1,\n        \"after restart, only IDs greater than cursor should be applied\"\n    );\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn sync_delete_propagates_row_removal() {\n    let tmp = TempDir::new().expect(\"tempdir\");\n    let data_dir = tmp.path().join(\"sync_delete\");\n    let data_dir_str = data_dir\n        .to_str()\n        .expect(\"data dir path should be valid UTF-8\");\n\n    let executor = Executor::new(data_dir_str).await;\n    let executor = Arc::new(TokioMutex::new(executor));\n    let sync_server = SyncServer::new(Arc::clone(\u0026executor));\n    let edge_id = \"edge_delete\".to_string();\n\n    {\n        let ast = Parser::parse(\"CREATE TABLE sensors (sensor_id INT, temperature FLOAT);\")\n            .expect(\"parse create table\");\n        let mut exec = executor.lock().await;\n        let _ = exec.execute(ast).await.expect(\"execute create table\");\n    }\n\n    let mut row = StorageRow::new();\n    row.insert(\"sensor_id\".to_string(), SqlValue::Integer(1));\n    row.insert(\"temperature\".to_string(), SqlValue::Float(10.0));\n    let raw = bincode::encode_to_vec(\u0026row, bincode::config::standard()).expect(\"encode row\");\n\n    let mut compressed = compress_prepend_size(\u0026raw);\n    let mut value = Vec::with_capacity(1 + compressed.len());\n    value.push(1);\n    value.append(\u0026mut compressed);\n\n    let hlc = HLC::default();\n    let ts_insert = HybridTimestamp {\n        ts: hlc.new_timestamp(),\n        node_id: 1,\n    };\n    let ts_delete = HybridTimestamp {\n        ts: hlc.new_timestamp(),\n        node_id: 1,\n    };\n\n    let insert_pq = PersistentQueuedOperation {\n        id: 1,\n        timestamp: ts_insert,\n        operation: WalOperation::Insert {\n            table: \"sensors\".to_string(),\n            key: b\"row1\".to_vec(),\n            value: value.clone(),\n        },\n    };\n    let delete_pq = PersistentQueuedOperation {\n        id: 2,\n        timestamp: ts_delete,\n        operation: WalOperation::Delete {\n            table: \"sensors\".to_string(),\n            key: b\"row1\".to_vec(),\n        },\n    };\n\n    let insert_bytes = bincode::serde::encode_to_vec(\u0026insert_pq, bincode::config::standard())\n        .expect(\"encode insert pq\");\n    let delete_bytes = bincode::serde::encode_to_vec(\u0026delete_pq, bincode::config::standard())\n        .expect(\"encode delete pq\");\n\n    let insert_op = SyncOperation {\n        id: insert_pq.id,\n        data: insert_bytes,\n    };\n    let delete_op = SyncOperation {\n        id: delete_pq.id,\n        data: delete_bytes,\n    };\n\n    let req1 = SyncRequest {\n        edge_id: edge_id.clone(),\n        operations: vec![insert_op],\n    };\n    let resp1 = sync_server\n        .sync(Request::new(req1))\n        .await\n        .expect(\"first sync RPC\")\n        .into_inner();\n    assert_eq!(resp1.applied, 1, \"insert should be applied\");\n\n    {\n        let ast =\n            Parser::parse(\"SELECT sensor_id, temperature FROM sensors;\").expect(\"parse select\");\n        let mut exec = executor.lock().await;\n        let res = exec.execute(ast).await.expect(\"execute select\");\n        assert_eq!(res.rows.len(), 1, \"expected 1 row after insert via sync\",);\n    }\n\n    let req2 = SyncRequest {\n        edge_id,\n        operations: vec![delete_op],\n    };\n    let resp2 = sync_server\n        .sync(Request::new(req2))\n        .await\n        .expect(\"second sync RPC\")\n        .into_inner();\n    assert_eq!(resp2.applied, 1, \"delete should be applied\");\n\n    {\n        let ast =\n            Parser::parse(\"SELECT sensor_id, temperature FROM sensors;\").expect(\"parse select\");\n        let mut exec = executor.lock().await;\n        let res = exec.execute(ast).await.expect(\"execute select\");\n        assert_eq!(res.rows.len(), 0, \"expected 0 rows after delete via sync\",);\n    }\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn sync_mixed_batch_applies_only_newer_per_key() {\n    let tmp = TempDir::new().expect(\"tempdir\");\n    let data_dir = tmp.path().join(\"sync_mixed_batch\");\n    let data_dir_str = data_dir\n        .to_str()\n        .expect(\"data dir path should be valid UTF-8\");\n\n    let executor = Executor::new(data_dir_str).await;\n    let executor = Arc::new(TokioMutex::new(executor));\n    let sync_server = SyncServer::new(Arc::clone(\u0026executor));\n    let edge_id = \"edge_mixed\".to_string();\n\n    {\n        let ast = Parser::parse(\"CREATE TABLE sensors (sensor_id INT, temperature FLOAT);\")\n            .expect(\"parse create table\");\n        let mut exec = executor.lock().await;\n        let _ = exec.execute(ast).await.expect(\"execute create table\");\n    }\n\n    let mut row_a_old = StorageRow::new();\n    row_a_old.insert(\"sensor_id\".to_string(), SqlValue::Integer(1));\n    row_a_old.insert(\"temperature\".to_string(), SqlValue::Float(10.0));\n\n    let mut row_a_new = StorageRow::new();\n    row_a_new.insert(\"sensor_id\".to_string(), SqlValue::Integer(1));\n    row_a_new.insert(\"temperature\".to_string(), SqlValue::Float(20.0));\n\n    let mut row_b = StorageRow::new();\n    row_b.insert(\"sensor_id\".to_string(), SqlValue::Integer(2));\n    row_b.insert(\"temperature\".to_string(), SqlValue::Float(15.0));\n\n    let encode_row = |row: \u0026StorageRow| {\n        let raw = bincode::encode_to_vec(row, bincode::config::standard()).expect(\"encode row\");\n        let mut compressed = compress_prepend_size(\u0026raw);\n        let mut value = Vec::with_capacity(1 + compressed.len());\n        value.push(1);\n        value.append(\u0026mut compressed);\n        value\n    };\n\n    let value_a_old = encode_row(\u0026row_a_old);\n    let value_a_new = encode_row(\u0026row_a_new);\n    let value_b = encode_row(\u0026row_b);\n\n    let hlc = HLC::default();\n    let ts_old = HybridTimestamp {\n        ts: hlc.new_timestamp(),\n        node_id: 1,\n    };\n    let ts_new = HybridTimestamp {\n        ts: hlc.new_timestamp(),\n        node_id: 1,\n    };\n    let ts_b = HybridTimestamp {\n        ts: hlc.new_timestamp(),\n        node_id: 1,\n    };\n\n    let pq_new = PersistentQueuedOperation {\n        id: 1,\n        timestamp: ts_new,\n        operation: WalOperation::Insert {\n            table: \"sensors\".to_string(),\n            key: b\"rowA\".to_vec(),\n            value: value_a_new,\n        },\n    };\n    let pq_stale = PersistentQueuedOperation {\n        id: 2,\n        timestamp: ts_old,\n        operation: WalOperation::Insert {\n            table: \"sensors\".to_string(),\n            key: b\"rowA\".to_vec(),\n            value: value_a_old,\n        },\n    };\n    let pq_b = PersistentQueuedOperation {\n        id: 3,\n        timestamp: ts_b,\n        operation: WalOperation::Insert {\n            table: \"sensors\".to_string(),\n            key: b\"rowB\".to_vec(),\n            value: value_b,\n        },\n    };\n\n    let op_new = SyncOperation {\n        id: pq_new.id,\n        data: bincode::serde::encode_to_vec(\u0026pq_new, bincode::config::standard())\n            .expect(\"encode pq_new\"),\n    };\n    let op_stale = SyncOperation {\n        id: pq_stale.id,\n        data: bincode::serde::encode_to_vec(\u0026pq_stale, bincode::config::standard())\n            .expect(\"encode pq_stale\"),\n    };\n    let op_b = SyncOperation {\n        id: pq_b.id,\n        data: bincode::serde::encode_to_vec(\u0026pq_b, bincode::config::standard())\n            .expect(\"encode pq_b\"),\n    };\n\n    let req = SyncRequest {\n        edge_id,\n        operations: vec![op_new, op_stale, op_b],\n    };\n    let resp = sync_server\n        .sync(Request::new(req))\n        .await\n        .expect(\"mixed batch sync RPC\")\n        .into_inner();\n    assert_eq!(\n        resp.applied, 2,\n        \"only newer op for rowA and rowB should be applied (total 2)\",\n    );\n\n    {\n        let ast =\n            Parser::parse(\"SELECT sensor_id, temperature FROM sensors;\").expect(\"parse select\");\n        let mut exec = executor.lock().await;\n        let res = exec.execute(ast).await.expect(\"execute select\");\n        assert_eq!(\n            res.rows.len(),\n            2,\n            \"expected 2 rows (sensor_id=1 and sensor_id=2)\",\n        );\n\n        let mut sensor1_count = 0;\n        let mut sensor1_temp: Option\u003cf64\u003e = None;\n        for row in res.rows {\n            if let (Some(id_val), Some(temp_val)) = (row.first(), row.get(1)) {\n                if let (SqlValue::Integer(id), SqlValue::Float(temp)) = (id_val, temp_val) {\n                    if *id == 1 {\n                        sensor1_count += 1;\n                        sensor1_temp = Some(*temp);\n                    }\n                }\n            }\n        }\n\n        assert_eq!(\n            sensor1_count, 1,\n            \"expected exactly one row for sensor_id=1 after LWW\",\n        );\n        let temp = sensor1_temp.expect(\"sensor_id=1 row missing\");\n        assert!(\n            (temp - 20.0).abs() \u003c f64::EPSILON,\n            \"expected latest temperature 20.0 for sensor_id=1, got {}\",\n            temp\n        );\n    }\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn sync_multi_edge_has_independent_cursors() {\n    let tmp = TempDir::new().expect(\"tempdir\");\n    let data_dir = tmp.path().join(\"sync_multi_edge\");\n    let data_dir_str = data_dir\n        .to_str()\n        .expect(\"data dir path should be valid UTF-8\");\n\n    let executor = Executor::new(data_dir_str).await;\n    let executor = Arc::new(TokioMutex::new(executor));\n    let sync_server = SyncServer::new(Arc::clone(\u0026executor));\n\n    let edge1 = \"edge1\".to_string();\n    let edge2 = \"edge2\".to_string();\n\n    let hlc = HLC::default();\n    let next_ts = || HybridTimestamp {\n        ts: hlc.new_timestamp(),\n        node_id: 1,\n    };\n\n    let make_pq = |edge: \u0026str, id: u64, ts: HybridTimestamp| PersistentQueuedOperation {\n        id,\n        timestamp: ts,\n        operation: WalOperation::Insert {\n            table: \"sensors\".to_string(),\n            key: format!(\"{}_row{}\", edge, id).into_bytes(),\n            value: vec![],\n        },\n    };\n\n    let to_ops = |pqs: Vec\u003cPersistentQueuedOperation\u003e| -\u003e Vec\u003cSyncOperation\u003e {\n        pqs.into_iter()\n            .map(|pq| SyncOperation {\n                id: pq.id,\n                data: bincode::serde::encode_to_vec(\u0026pq, bincode::config::standard())\n                    .expect(\"encode pq\"),\n            })\n            .collect()\n    };\n\n    let ops_edge1_first = to_ops(vec![\n        make_pq(\u0026edge1, 1, next_ts()),\n        make_pq(\u0026edge1, 2, next_ts()),\n        make_pq(\u0026edge1, 3, next_ts()),\n    ]);\n\n    let ops_edge2_first = to_ops(vec![make_pq(\u0026edge2, 1, next_ts())]);\n\n    let req1 = SyncRequest {\n        edge_id: edge1.clone(),\n        operations: ops_edge1_first,\n    };\n    let resp1 = sync_server\n        .sync(Request::new(req1))\n        .await\n        .expect(\"edge1 first sync\")\n        .into_inner();\n    assert_eq!(resp1.applied, 3, \"edge1 should apply 3 ops\");\n\n    let req2 = SyncRequest {\n        edge_id: edge2.clone(),\n        operations: ops_edge2_first,\n    };\n    let resp2 = sync_server\n        .sync(Request::new(req2))\n        .await\n        .expect(\"edge2 first sync\")\n        .into_inner();\n    assert_eq!(resp2.applied, 1, \"edge2 should apply 1 op\");\n\n    let ops_edge2_second = to_ops(vec![\n        make_pq(\u0026edge2, 1, next_ts()),\n        make_pq(\u0026edge2, 2, next_ts()),\n        make_pq(\u0026edge2, 3, next_ts()),\n    ]);\n\n    let req3 = SyncRequest {\n        edge_id: edge2,\n        operations: ops_edge2_second,\n    };\n    let resp3 = sync_server\n        .sync(Request::new(req3))\n        .await\n        .expect(\"edge2 second sync\")\n        .into_inner();\n    assert_eq!(\n        resp3.applied, 2,\n        \"edge2 should apply only new IDs (2 and 3), independent of edge1 cursor\",\n    );\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn sync_large_batch_is_idempotent_and_advances_cursor() {\n    let tmp = TempDir::new().expect(\"tempdir\");\n    let data_dir = tmp.path().join(\"sync_large_batch\");\n    let data_dir_str = data_dir\n        .to_str()\n        .expect(\"data dir path should be valid UTF-8\");\n\n    let executor = Executor::new(data_dir_str).await;\n    let executor = Arc::new(TokioMutex::new(executor));\n    let sync_server = SyncServer::new(Arc::clone(\u0026executor));\n\n    let edge_id = \"edge_large\".to_string();\n    let hlc = HLC::default();\n\n    let mut ops: Vec\u003cSyncOperation\u003e = Vec::new();\n    let batch_size: u64 = 256;\n\n    for id in 1..=batch_size {\n        let ts = HybridTimestamp {\n            ts: hlc.new_timestamp(),\n            node_id: 1,\n        };\n        let pq = PersistentQueuedOperation {\n            id,\n            timestamp: ts,\n            operation: WalOperation::Insert {\n                table: \"sensors\".to_string(),\n                key: format!(\"row{}\", id).into_bytes(),\n                value: vec![],\n            },\n        };\n        let data =\n            bincode::serde::encode_to_vec(\u0026pq, bincode::config::standard()).expect(\"encode pq\");\n        ops.push(SyncOperation { id, data });\n    }\n\n    let req1 = SyncRequest {\n        edge_id: edge_id.clone(),\n        operations: ops.clone(),\n    };\n    let resp1 = sync_server\n        .sync(Request::new(req1))\n        .await\n        .expect(\"large batch first sync\")\n        .into_inner();\n    assert_eq!(\n        resp1.applied, batch_size,\n        \"first large batch should apply all operations\",\n    );\n\n    let req2 = SyncRequest {\n        edge_id,\n        operations: ops,\n    };\n    let resp2 = sync_server\n        .sync(Request::new(req2))\n        .await\n        .expect(\"large batch second sync\")\n        .into_inner();\n    assert_eq!(\n        resp2.applied, 0,\n        \"replaying same large batch should be idempotent (applied=0)\",\n    );\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn edge_to_cloud_lww_conflict_uses_latest_value() {\n    let tmp = TempDir::new().expect(\"tempdir\");\n    let data_dir = tmp.path().join(\"sync_cluster_lww\");\n    let data_dir_str = data_dir\n        .to_str()\n        .expect(\"data dir path should be valid UTF-8\");\n\n    let mut rng = rand::rng();\n    let base: u16 = 24000 + (rng.random_range(0u16..1000) * 2);\n    let cloud_port: u16 = base;\n    let edge_port: u16 = base + 1;\n\n    let mut cloud = start_cloud_node(cloud_port, data_dir_str).await;\n\n    sleep(Duration::from_secs(3)).await;\n\n    let cloud_addr = format!(\"127.0.0.1:{}\", cloud_port);\n    let sync_target = format!(\"http://{}\", cloud_addr);\n\n    let mut edge = start_edge_node(edge_port, data_dir_str, \u0026sync_target).await;\n\n    sleep(Duration::from_secs(3)).await;\n\n    let edge_addr = format!(\"127.0.0.1:{}\", edge_port);\n\n    let mut edge_client = SqlClient::new(\u0026edge_addr);\n    edge_client.connect().await.expect(\"edge SqlClient connect\");\n\n    edge_client\n        .execute_sql(\"CREATE TABLE sensors (sensor_id INT, temperature FLOAT);\")\n        .await\n        .expect(\"create table on edge\");\n\n    // Initial insert for sensor_id=1 with temperature=10.0\n    edge_client\n        .execute_sql(\"INSERT INTO sensors (sensor_id, temperature) VALUES (1, 10.0);\")\n        .await\n        .expect(\"initial insert on edge\");\n\n    // Let this initial value sync to the cloud.\n    sleep(Duration::from_secs(5)).await;\n\n    // Now update sensor_id=1 with a newer temperature value on the edge.\n    edge_client\n        .execute_sql(\"UPDATE sensors SET temperature = 30.0 WHERE sensor_id = 1;\")\n        .await\n        .expect(\"update on edge\");\n\n    let mut edge_found_latest = false;\n    for _ in 0..10u32 {\n        let resp = edge_client\n            .execute_sql(\"SELECT sensor_id, temperature FROM sensors WHERE sensor_id = 1;\")\n            .await\n            .expect(\"select on edge\");\n\n        if resp.success \u0026\u0026 !resp.rows.is_empty() {\n            if let Some(temp_idx) = resp.columns.iter().position(|c| c == \"temperature\") {\n                'outer_edge: for row in \u0026resp.rows {\n                    if let Some(cell) = row.values.get(temp_idx) {\n                        if let Some(inner) = \u0026cell.value {\n                            let val = match inner {\n                                chronos::network::proto::value::Value::FloatValue(f) =\u003e *f,\n                                chronos::network::proto::value::Value::IntValue(i) =\u003e *i as f64,\n                                _ =\u003e continue,\n                            };\n\n                            println!(\"[LWW DEBUG] edge observed temperature={} before sync\", val);\n\n                            if (val - 30.0).abs() \u003c f64::EPSILON {\n                                edge_found_latest = true;\n                                break 'outer_edge;\n                            }\n                        }\n                    }\n                }\n\n                if edge_found_latest {\n                    break;\n                }\n            }\n        }\n\n        sleep(Duration::from_millis(200)).await;\n    }\n\n    assert!(\n        edge_found_latest,\n        \"expected to observe updated temperature 30.0 for sensor_id=1 on edge before sync\"\n    );\n\n    // Allow another sync interval for the updated value to propagate.\n    sleep(Duration::from_secs(5)).await;\n\n    let mut cloud_client = SqlClient::new(\u0026cloud_addr);\n    cloud_client\n        .connect()\n        .await\n        .expect(\"cloud SqlClient connect\");\n\n    let mut found_latest = false;\n    for _ in 0..20u32 {\n        let resp = cloud_client\n            .execute_sql(\"SELECT sensor_id, temperature FROM sensors WHERE sensor_id = 1;\")\n            .await\n            .expect(\"select on cloud\");\n\n        if resp.success \u0026\u0026 !resp.rows.is_empty() {\n            // Debug output to understand what the cloud currently sees.\n            println!(\n                \"[LWW DEBUG] cloud SELECT returned {} rows, columns={:?}\",\n                resp.rows.len(),\n                resp.columns\n            );\n\n            // Find the index of the temperature column, then scan all rows\n            // for a numeric value equal to 30 (accepting either INT or FLOAT\n            // representation depending on how the parser stored it).\n            if let Some(temp_idx) = resp.columns.iter().position(|c| c == \"temperature\") {\n                'outer: for row in \u0026resp.rows {\n                    if let Some(cell) = row.values.get(temp_idx) {\n                        if let Some(inner) = \u0026cell.value {\n                            let val = match inner {\n                                chronos::network::proto::value::Value::FloatValue(f) =\u003e *f,\n                                chronos::network::proto::value::Value::IntValue(i) =\u003e *i as f64,\n                                _ =\u003e {\n                                    println!(\n                                        \"[LWW DEBUG] non-numeric temperature cell: {:?}\",\n                                        inner\n                                    );\n                                    continue;\n                                }\n                            };\n\n                            println!(\"[LWW DEBUG] observed temperature={} on cloud\", val);\n\n                            if (val - 30.0).abs() \u003c f64::EPSILON {\n                                found_latest = true;\n                                break 'outer;\n                            }\n                        }\n                    }\n                }\n\n                if found_latest {\n                    break;\n                }\n            }\n        }\n\n        sleep(Duration::from_millis(500)).await;\n    }\n\n    assert!(\n        found_latest,\n        \"expected to observe temperature 30.0 for sensor_id=1 on cloud after LWW sync\"\n    );\n\n    let _ = edge.kill();\n    let _ = cloud.kill();\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","azureuser","Documents","Chronos","tests","ttl.rs"],"content":"use std::time::{SystemTime, UNIX_EPOCH};\n\nuse chronos::executor::Executor;\nuse chronos::parser::Parser;\nuse tempfile::TempDir;\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 2)]\nasync fn ttl_basic_expiry_removes_rows() {\n    let tmp = TempDir::new().expect(\"tempdir\");\n    let data_dir = tmp.path().join(\"ttl_basic\");\n    let data_dir_str = data_dir\n        .to_str()\n        .expect(\"data dir path should be valid UTF-8\");\n\n    let mut executor = Executor::new(data_dir_str).await;\n\n    // Create a table with a short TTL\n    let ast =\n        Parser::parse(\"CREATE TABLE sensors (sensor_id INT, temperature FLOAT) WITH TTL = 5s;\")\n            .expect(\"parse create table with TTL\");\n    let _ = executor\n        .execute(ast)\n        .await\n        .expect(\"execute create table with TTL\");\n\n    // Insert a single row\n    let ast = Parser::parse(\"INSERT INTO sensors (sensor_id, temperature) VALUES (1, 10.0);\")\n        .expect(\"parse insert\");\n    let _ = executor.execute(ast).await.expect(\"execute insert\");\n\n    // Verify row is present before TTL cleanup\n    let ast = Parser::parse(\"SELECT sensor_id, temperature FROM sensors;\").expect(\"parse select\");\n    let res = executor.execute(ast).await.expect(\"execute select\");\n    assert_eq!(res.rows.len(), 1, \"row should exist before TTL cleanup\");\n\n    // Run TTL cleanup with now_secs far in the future so the row is expired\n    let now_secs = SystemTime::now()\n        .duration_since(UNIX_EPOCH)\n        .expect(\"time went backwards\")\n        .as_secs()\n        .saturating_add(10);\n    let deleted = executor\n        .cleanup_expired(now_secs, 1000)\n        .await\n        .expect(\"cleanup_expired\");\n    assert_eq!(deleted, 1, \"expected 1 row to be deleted by TTL cleanup\");\n\n    // The table should now be empty\n    let ast = Parser::parse(\"SELECT sensor_id, temperature FROM sensors;\")\n        .expect(\"parse select after cleanup\");\n    let res = executor\n        .execute(ast)\n        .await\n        .expect(\"execute select after cleanup\");\n    assert_eq!(res.rows.len(), 0, \"table should be empty after TTL cleanup\");\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 2)]\nasync fn ttl_does_not_affect_tables_without_ttl() {\n    let tmp = TempDir::new().expect(\"tempdir\");\n    let data_dir = tmp.path().join(\"ttl_mixed\");\n    let data_dir_str = data_dir\n        .to_str()\n        .expect(\"data dir path should be valid UTF-8\");\n\n    let mut executor = Executor::new(data_dir_str).await;\n\n    // Table with TTL\n    let ast =\n        Parser::parse(\"CREATE TABLE sensors_ttl (sensor_id INT, temperature FLOAT) WITH TTL = 5s;\")\n            .expect(\"parse create table with TTL\");\n    let _ = executor\n        .execute(ast)\n        .await\n        .expect(\"execute create table with TTL\");\n\n    // Table without TTL\n    let ast = Parser::parse(\"CREATE TABLE sensors_no_ttl (sensor_id INT, temperature FLOAT);\")\n        .expect(\"parse create table without TTL\");\n    let _ = executor\n        .execute(ast)\n        .await\n        .expect(\"execute create table without TTL\");\n\n    // Insert one row into each table\n    let ast = Parser::parse(\"INSERT INTO sensors_ttl (sensor_id, temperature) VALUES (1, 10.0);\")\n        .expect(\"parse insert ttl\");\n    let _ = executor.execute(ast).await.expect(\"execute insert ttl\");\n\n    let ast =\n        Parser::parse(\"INSERT INTO sensors_no_ttl (sensor_id, temperature) VALUES (1, 10.0);\")\n            .expect(\"parse insert no ttl\");\n    let _ = executor.execute(ast).await.expect(\"execute insert no ttl\");\n\n    // Sanity check before cleanup\n    let ast = Parser::parse(\"SELECT sensor_id, temperature FROM sensors_ttl;\")\n        .expect(\"parse select ttl before\");\n    let res = executor\n        .execute(ast)\n        .await\n        .expect(\"execute select ttl before\");\n    assert_eq!(\n        res.rows.len(),\n        1,\n        \"expected 1 row in sensors_ttl before cleanup\",\n    );\n\n    let ast = Parser::parse(\"SELECT sensor_id, temperature FROM sensors_no_ttl;\")\n        .expect(\"parse select no ttl before\");\n    let res = executor\n        .execute(ast)\n        .await\n        .expect(\"execute select no ttl before\");\n    assert_eq!(\n        res.rows.len(),\n        1,\n        \"expected 1 row in sensors_no_ttl before cleanup\",\n    );\n\n    // Run TTL cleanup far in the future\n    let now_secs = SystemTime::now()\n        .duration_since(UNIX_EPOCH)\n        .expect(\"time went backwards\")\n        .as_secs()\n        .saturating_add(10);\n    let deleted = executor\n        .cleanup_expired(now_secs, 1000)\n        .await\n        .expect(\"cleanup_expired\");\n    assert_eq!(\n        deleted, 1,\n        \"expected only the TTL-enabled table row to be deleted\",\n    );\n\n    // TTL table should be empty\n    let ast = Parser::parse(\"SELECT sensor_id, temperature FROM sensors_ttl;\")\n        .expect(\"parse select ttl after\");\n    let res = executor\n        .execute(ast)\n        .await\n        .expect(\"execute select ttl after\");\n    assert_eq!(\n        res.rows.len(),\n        0,\n        \"expected 0 rows in sensors_ttl after cleanup\",\n    );\n\n    // Non-TTL table should still have its row\n    let ast = Parser::parse(\"SELECT sensor_id, temperature FROM sensors_no_ttl;\")\n        .expect(\"parse select no ttl after\");\n    let res = executor\n        .execute(ast)\n        .await\n        .expect(\"execute select no ttl after\");\n    assert_eq!(\n        res.rows.len(),\n        1,\n        \"expected 1 row in sensors_no_ttl after cleanup\",\n    );\n}\n","traces":[],"covered":0,"coverable":0}]};
        var previousData = null;
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      },
    };
  });

  return [...folders, ...files.filter(file => file.path.length === 1)];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener('hashchange', () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.slice(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(
      ({current}) => {
        return {current: [...current, file.path[0]]};
      },
      () => this.updateHash(),
    );
  }

  back(file) {
    this.setState(
      ({current}) => {
        return {current: current.slice(0, current.length - 1)};
      },
      () => this.updateHash(),
    );
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e(
    'div',
    {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e(
      'table',
      {className: 'files-list'},
      e('thead', {className: 'files-list__head'}, e('tr', null, e('th', null, 'Path'), e('th', null, 'Coverage'))),
      e(
        'tbody',
        {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile})),
      ),
    ),
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? (file.covered / file.coverable) * 100 : -1;
  const coverageDelta =
    file.prevRun && (file.covered / file.coverable) * 100 - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'tr',
    {
      className:
        'files-list__file' +
        (coverage >= 0 && coverage < 50 ? ' files-list__file_low' : '') +
        (coverage >= 50 && coverage < 80 ? ' files-list__file_medium' : '') +
        (coverage >= 80 ? ' files-list__file_high' : '') +
        (file.is_folder ? ' files-list__file_folder' : ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e(
      'td',
      null,
      file.covered + ' / ' + file.coverable + (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
    ),
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'}, e(FileHeader, {file, onBack}), e(FileContent, {file}));
}

function FileHeader({file, onBack}) {
  const coverage = (file.covered / file.coverable) * 100;
  const coverageDelta = file.prevRun && coverage - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'div',
    {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e(
      'div',
      {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable + (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
      e('input', {id: 'theme-toggle', type: 'checkbox', hidden: true}),
      e('label', {for: 'theme-toggle', id: 'theme-toggle-label'}, 'ðŸŒ™'),
    ),
  );
}

function FileContent({file}) {
  return e(
    'pre',
    {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e(
        'code',
        {
          className: 'code-line' + (covered ? ' code-line_covered' : '') + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        },
        line,
      );
    }),
  );
}

(function () {
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData &&
    previousData.files.forEach(file => {
      const path = file.path.slice(commonPath.length).join('/');
      prevFilesMap.set(path, file);
    });

  const files = data.files.map(file => {
    const path = file.path.slice(commonPath.length);
    const {covered = 0, coverable = 0} = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: {covered, coverable},
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    },
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));

  const toggle = document.getElementById('theme-toggle');
  const label = document.getElementById('theme-toggle-label');
  label.textContent = 'ðŸŒ™';

  toggle.addEventListener('change', () => {
    if (toggle.checked) {
      document.documentElement.setAttribute('data-theme', 'dark');
      label.textContent = 'â˜€ï¸';
    } else {
      document.documentElement.removeAttribute('data-theme');
      label.textContent = 'ðŸŒ™';
    }
  });
})();
</script>
</body>
</html>